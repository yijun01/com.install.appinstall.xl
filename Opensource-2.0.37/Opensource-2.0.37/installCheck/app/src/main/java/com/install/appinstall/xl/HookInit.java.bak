package com.install.appinstall.xl;

import android.app.Activity;
import android.app.ActivityManager;
import android.app.AlertDialog;
import android.content.ComponentName;
import android.content.ContentProvider;
import android.content.ContentValues;
import android.content.Context;
import android.content.DialogInterface;
import android.content.Intent;
import android.content.pm.ActivityInfo;
import android.content.pm.ApplicationInfo;
import android.content.pm.ConfigurationInfo;
import android.content.pm.PackageInfo;
import android.content.pm.PackageManager;
import android.content.pm.PermissionInfo;
import android.content.pm.ProviderInfo;
import android.content.pm.Signature;
import android.database.Cursor;
import android.database.MatrixCursor;
import android.net.Uri;
import android.os.Build;
import android.os.Bundle;
import android.os.Handler;
import android.os.IBinder;
import android.os.Looper;
import android.util.DisplayMetrics;
import android.view.Gravity;
import android.view.MotionEvent;
import android.view.View;
import android.view.ViewGroup;
import android.view.ViewTreeObserver;
import android.view.Window;
import android.view.WindowManager;
import android.widget.Button;
import android.widget.EditText;
import android.widget.LinearLayout;
import android.widget.ScrollView;
import android.widget.TextView;
import android.widget.Toast;
import de.robv.android.xposed.IXposedHookLoadPackage;
import de.robv.android.xposed.XC_MethodHook;
import de.robv.android.xposed.XC_MethodHook.MethodHookParam;
import de.robv.android.xposed.XC_MethodReplacement;
import de.robv.android.xposed.XposedBridge;
import de.robv.android.xposed.XposedHelpers;
import de.robv.android.xposed.callbacks.XC_LoadPackage.LoadPackageParam;
import java.io.BufferedReader;
import java.io.File;
import java.io.FileInputStream;
import java.io.FileOutputStream;
import java.io.InputStreamReader;
import java.io.OutputStreamWriter;
import java.lang.reflect.Field;
import java.lang.reflect.InvocationTargetException;
import java.lang.reflect.Method;
import java.security.MessageDigest;
import java.util.ArrayList;
import java.util.Arrays;
import java.util.Collections;
import java.util.HashMap;
import java.util.HashSet;
import java.util.Iterator;
import java.util.List;
import java.util.Map;
import java.util.Random;
import java.util.Set;
import org.json.JSONArray;
import org.json.JSONObject;
import android.widget.Spinner;
import android.widget.ArrayAdapter;
import android.text.Html;
import android.webkit.WebView;
import android.webkit.JsResult;

public class HookInit implements IXposedHookLoadPackage {

  private String currentTargetApp = "";
  private static final String MODULE_TAG = "InstallHook";
  private static final ArrayList<String> globalCapturedPackages =
    new ArrayList<>();
  private final ArrayList<String> appCapturedPackages = new ArrayList<>();

private Activity currentResumedActivity = null; //æ‚¬æµ®çª—ç•Œé¢
  private Handler floatingTopHandler; // å®šæ—¶ç½®é¡¶å¤„ç†å™¨
  private TextView currentFloatingView; // å½“å‰æ‚¬æµ®çª—è§†å›¾
  // é…ç½®å­˜å‚¨
  private static final Map<String, Boolean> installStatusMap = new HashMap<>();
  private static final Map<String, Boolean> floatingShownMap = new HashMap<>();
  private static final Map<String, Float> floatingXMap = new HashMap<>();
  private static final Map<String, Float> floatingYMap = new HashMap<>();

  // æ‹¦æˆªé€€å‡ºåŠŸèƒ½é…ç½®
  private static final Map<String, Boolean> blockExitMap = new HashMap<>();
  private static final Map<
    String,
    List<InterceptPattern>
  > interceptPatternsMap = new HashMap<>();
  // ç±»é¡¶éƒ¨æ–°å¢ï¼šé€€å‡ºæ§åˆ¶å˜é‡
  private boolean isExitPending = false; // æ˜¯å¦æœ‰ç­‰å¾…å¤„ç†çš„é€€å‡ºè¯·æ±‚
  private String pendingExitMethod = ""; // ç­‰å¾…å¤„ç†çš„é€€å‡ºæ–¹å¼ï¼ˆSystem.exit()/Process.killProcess()ï¼‰
  private Object pendingExitParam = null; // ç­‰å¾…å¤„ç†çš„é€€å‡ºå‚æ•°
  private int isCurrentlyBlocking;
  private String blockText;
  // åŒå‡»åˆ¤å®šé˜ˆå€¼ï¼ˆå¯è°ƒæ•´ï¼Œé»˜è®¤500æ¯«ç§’ï¼‰
  private static final int DOUBLE_CLICK_THRESHOLD = 500;
  private long lastClickTime = 0; // ä¸Šä¸€æ¬¡ç‚¹å‡»æ—¶é—´
  private AlertDialog statusSwitchDialog; // å•å‡»èœå•å¼¹çª—å¼•ç”¨

// ç”¨æˆ·è‡ªå®šä¹‰åŒ…ååˆ—è¡¨ï¼ˆç‹¬ç«‹å­˜å‚¨ï¼Œé¿å…å†²çªï¼‰
 private static final Map<String, List<String>> userDefinedPackagesMap = new HashMap<>();
 // æ–°å¢ï¼šç”¨æˆ·è‡ªå®šä¹‰æ’é™¤åŒ…ååˆ—è¡¨ï¼ˆç‹¬ç«‹å­˜å‚¨ï¼Œä¸ä¼ªé€ åŒ…ååŒºåˆ†ï¼‰
 private static final Map<String, List<String>> excludedPackagesMap = new HashMap<>();
 
  // ========== å®Œæ•´çš„æ£€æµ‹æƒé™å¸¸é‡åˆ—è¡¨ ==========
  private static final String[] DETECTION_PERMISSIONS = {
    // ç›´æ¥è¯»å–åº”ç”¨åˆ—è¡¨æƒé™
    "android.permission.QUERY_ALL_PACKAGES", // Android 11+ è¯»å–æ‰€æœ‰åŒ…
    "android.permission.GET_PACKAGE_SIZE", // ä½ç‰ˆæœ¬è¯»å–åº”ç”¨åˆ—è¡¨
    // ä½¿ç”¨ç»Ÿè®¡æƒé™
    "android.permission.PACKAGE_USAGE_STATS", // åº”ç”¨ä½¿ç”¨ç»Ÿè®¡
    // ç³»ç»Ÿçº§æƒé™ï¼ˆé€šå¸¸ç”¨äºè®¾å¤‡ç®¡ç†åº”ç”¨ï¼‰
    "android.permission.PACKAGE_VERIFICATION_AGENT", // åŒ…éªŒè¯ä»£ç†
    /*
    // å­˜å‚¨æƒé™
    "android.permission.READ_EXTERNAL_STORAGE", // è¯»å–å¤–éƒ¨å­˜å‚¨
    "android.permission.WRITE_EXTERNAL_STORAGE", // å†™å…¥å¤–éƒ¨å­˜å‚¨

    // å…¶ä»–å¯èƒ½çš„æ£€æµ‹æƒé™
    "android.permission.ACCESS_WIFI_STATE",     // WiFiçŠ¶æ€
    "android.permission.BLUETOOTH",             // è“ç‰™
    "android.permission.INTERNET",              // ç½‘ç»œï¼ˆå¯èƒ½ç”¨äºäº‘ç«¯éªŒè¯ï¼‰

    // æƒé™ç»„ç›¸å…³
    "android.permission-group.STORAGE",         // å­˜å‚¨æƒé™ç»„
    "android.permission-group.PHONE"            // ç”µè¯æƒé™ç»„ï¼ˆæŸäº›åº”ç”¨ä¼šæ£€æµ‹ï¼‰
    */
  };

  // ========== æ™ºèƒ½ä¼ªé€ ç›¸å…³å˜é‡ ==========
  private static final List<QueryPattern> queryPatterns = new ArrayList<>();
  private static final Random random = new Random();

  // æŸ¥è¯¢æ¨¡å¼è®°å½•ç±»
  private static class QueryPattern {

    String targetApp;
    String queriedPackage;
    int flags;
    long timestamp;

    QueryPattern(String targetApp, String queriedPackage, int flags) {
      this.targetApp = targetApp;
      this.queriedPackage = queriedPackage;
      this.flags = flags;
      this.timestamp = System.currentTimeMillis();
    }
  }

  // æ™ºèƒ½ä¼ªé€ ç¼“å­˜ï¼ˆç¡®ä¿åŒä¸€åŒ…å¤šæ¬¡æŸ¥è¯¢è¿”å›ç›¸åŒä¿¡æ¯ï¼‰
  private static final Map<String, String> versionCache = new HashMap<>();
  private static final Map<String, Integer> versionCodeCache = new HashMap<>();
  private static final Map<String, Long> installTimeCache = new HashMap<>();
  private static final Map<String, String> installerCache = new HashMap<>();
  private static final Map<String, String> appNameCache = new HashMap<>();
  // æƒé™ä¼ªé€ map
  private static final Map<String, Boolean> permissionFakeMap = new HashMap<>();

  // æ‹¦æˆªæ¨¡å¼ç±»
  private static class InterceptPattern {

    String patternHash;
    List<String> installedPackages;
    List<String> notInstalledPackages;
    String userChoice; // "intercept" æˆ– "allow"
    int choiceCount;
    long lastDetectedTime;
    boolean silentIntercept;

    InterceptPattern(
      String patternHash,
      List<String> installedPackages,
      List<String> notInstalledPackages
    ) {
      this.patternHash = patternHash;
      this.installedPackages = installedPackages;
      this.notInstalledPackages = notInstalledPackages;
      this.choiceCount = 0;
      this.lastDetectedTime = System.currentTimeMillis();
      this.silentIntercept = false;
    }
  }

  // æ£€æµ‹åˆ°çš„åŒ…åæ•°æ®ç»“æ„
  private static class DetectedPackages {

    List<String> installedPackages;
    List<String> notInstalledPackages;
    String patternHash;

    DetectedPackages() {
      installedPackages = new ArrayList<>();
      notInstalledPackages = new ArrayList<>();
    }
  }


@Override
public void handleLoadPackage(LoadPackageParam lpparam) throws Throwable {


// ========== ğŸš¨ã€WebViewå­çº¿ç¨‹å´©æºƒä¸“æ€ã€‘==========
try {
    // Hook WebView çš„æ‰€æœ‰å­çº¿ç¨‹åˆ›å»ºï¼Œç›´æ¥åæ‰ç©ºæŒ‡é’ˆ
    XposedHelpers.findAndHookMethod(
        "android.webkit.WebView",
        null,
        "onDraw",
        android.graphics.Canvas.class,
        new XC_MethodHook() {
            @Override
            protected void beforeHookedMethod(MethodHookParam param) throws Throwable {
                // ä»€ä¹ˆéƒ½ä¸åšï¼Œåªæ˜¯é˜²æ­¢å´©æºƒ
            }
        }
    );
} catch (Throwable ignored) {}

try {
    // Hook Chromium å†…æ ¸çš„å´©æºƒç‚¹
    XposedHelpers.findAndHookMethod(
        "org.chromium.android_webview.AwContents",
        null,
        "destroy",
        new XC_MethodReplacement() {
            @Override
            protected Object replaceHookedMethod(MethodHookParam param) throws Throwable {
                return null; // é˜²æ­¢é”€æ¯æ—¶å´©æºƒ
            }
        }
    );
} catch (Throwable ignored) {}

// ========== ğŸš¨ã€ç»ˆææš´åŠ›ä¿®å¤ã€‘Hookæ‰€æœ‰Bundleæ–¹æ³•ï¼ˆå¯ç¼–è¯‘ç‰ˆï¼‰==========
try {
    Class<?> bundleClass = Class.forName("android.os.Bundle");
    
    // ä½¿ç”¨ findAndHookMethod é€ä¸ª Hook å…³é”®æ–¹æ³•ï¼Œè€Œä¸æ˜¯ hookAllMethods
    String[] bundleMethods = {
        "getString", "getInt", "getBoolean", "getLong", 
        "getDouble", "getFloat", "getBundle", "getSerializable",
        "getParcelable", "containsKey"
    };
    
    for (final String methodName : bundleMethods) {
        try {
            // Hook å•å‚æ•°ç‰ˆæœ¬
            XposedHelpers.findAndHookMethod(
                bundleClass,
                methodName,
                String.class,
                new XC_MethodHook() {
                    @Override
                    protected void beforeHookedMethod(MethodHookParam param) throws Throwable {
                        if (param.thisObject == null) {
                            setDefaultReturnValue(param);
                            return;
                        }
                        // æ£€æµ‹Bundleæ˜¯å¦å¯ç”¨
                        try {
                            ((Bundle) param.thisObject).hashCode();
                        } catch (Throwable e) {
                            setDefaultReturnValue(param);
                        }
                    }
                    
                    private void setDefaultReturnValue(MethodHookParam param) {
                        if (methodName.equals("getString")) param.setResult("");
                        else if (methodName.equals("getInt")) param.setResult(0);
                        else if (methodName.equals("getBoolean")) param.setResult(false);
                        else if (methodName.equals("getLong")) param.setResult(0L);
                        else if (methodName.equals("getDouble")) param.setResult(0.0);
                        else if (methodName.equals("getFloat")) param.setResult(0.0f);
                        else if (methodName.equals("getBundle")) param.setResult(new Bundle());
                        else param.setResult(null);
                    }
                }
            );
        } catch (Throwable ignored) {}
        
        try {
            // Hook åŒå‚æ•°ç‰ˆæœ¬ï¼ˆå¸¦é»˜è®¤å€¼ï¼‰
            XposedHelpers.findAndHookMethod(
                bundleClass,
                methodName,
                String.class,
                Object.class,
                new XC_MethodHook() {
                    @Override
                    protected void beforeHookedMethod(MethodHookParam param) throws Throwable {
                        if (param.thisObject == null) {
                            param.setResult(param.args[1]);
                            return;
                        }
                        try {
                            Bundle b = (Bundle) param.thisObject;
                            if (!b.containsKey((String) param.args[0])) {
                                param.setResult(param.args[1]);
                            }
                        } catch (Throwable e) {
                            param.setResult(param.args[1]);
                        }
                    }
                }
            );
        } catch (Throwable ignored) {}
    }
    
    // ç‰¹åˆ«å¤„ç† getString(String, String) ç¡®ä¿ä¸‡æ— ä¸€å¤±
    try {
        XposedHelpers.findAndHookMethod(
            bundleClass,
            "getString",
            String.class,
            String.class,
            new XC_MethodHook() {
                @Override
                protected void beforeHookedMethod(MethodHookParam param) throws Throwable {
                    if (param.thisObject == null) {
                        param.setResult(param.args[1]);
                        return;
                    }
                    try {
                        Bundle b = (Bundle) param.thisObject;
                        if (!b.containsKey((String) param.args[0])) {
                            param.setResult(param.args[1]);
                        }
                    } catch (Throwable e) {
                        param.setResult(param.args[1]);
                    }
                }
            }
        );
    } catch (Throwable ignored) {}
    
 //   //XposedBridge.log("[InstallHook] âœ… Bundleæš´åŠ›ä¿®å¤å®Œæˆï¼ˆå¯ç¼–è¯‘ç‰ˆï¼‰");
    
} catch (Throwable e) {
    //XposedBridge.log("[InstallHook] âŒ Bundleæš´åŠ›ä¿®å¤å¤±è´¥: " + e.getMessage());
}

// ========== ğŸš¨ã€å¼ºåˆ¶å…¨å±€å¼‚å¸¸æ•è·ã€‘==========
try {
    // å…ˆè®¾ç½®æˆ‘ä»¬è‡ªå·±çš„Handler
    final Thread.UncaughtExceptionHandler ourHandler = new Thread.UncaughtExceptionHandler() {
        @Override
        public void uncaughtException(Thread t, Throwable e) {
            if (e instanceof NullPointerException) {
                StackTraceElement[] stack = e.getStackTrace();
                if (stack.length > 0) {
                    String className = stack[0].getClassName();
                    if (className.contains("Bundle") || 
                        className.contains("PackageManager") ||
                        className.contains("ContextImpl") ||
                        className.contains("ApplicationPackageManager")) {
                        //XposedBridge.log("[InstallHook] ğŸ’ª æ‹¦æˆªå´©æºƒ: " + className + "." + stack[0].getMethodName());
                        return;
                    }
                }
            }
            // äº¤ç»™ç³»ç»Ÿé»˜è®¤Handler
            Thread.UncaughtExceptionHandler defaultHandler = 
                Thread.getDefaultUncaughtExceptionHandler();
            if (defaultHandler != null && defaultHandler != this) {
                defaultHandler.uncaughtException(t, e);
            }
        }
    };
    
    // è®¾ç½®æˆ‘ä»¬çš„Handler
    Thread.setDefaultUncaughtExceptionHandler(ourHandler);
    
    // Hook setDefaultUncaughtExceptionHandler é˜²æ­¢è¢«è¦†ç›–
    XposedHelpers.findAndHookMethod(
        "java.lang.Thread",
        null,
        "setDefaultUncaughtExceptionHandler",
        Thread.UncaughtExceptionHandler.class,
        new XC_MethodHook() {
            @Override
            protected void beforeHookedMethod(MethodHookParam param) throws Throwable {
                // ä¸å…è®¸è¦†ç›–æˆ‘ä»¬çš„Handler
                //XposedBridge.log("[InstallHook] âš ï¸ é˜»æ­¢åº”ç”¨è®¾ç½®è‡ªå·±çš„å¼‚å¸¸å¤„ç†å™¨");
                param.setResult(null);
            }
        }
    );
    
    //XposedBridge.log("[InstallHook] âœ… å¼ºåˆ¶å…¨å±€å¼‚å¸¸æ•è·å·²å¯ç”¨");
    
} catch (Throwable e) {
    //XposedBridge.log("[InstallHook] âŒ å¼ºåˆ¶å¼‚å¸¸æ•è·å¤±è´¥: " + e.getMessage());
}

    // ========== ğŸš¨ã€ç»ˆæå…œåº•ã€‘ä»»ä½•çº¿ç¨‹çš„ä»»ä½•ç©ºæŒ‡é’ˆéƒ½ä¸å´©æºƒ ==========
try {
    Thread.setDefaultUncaughtExceptionHandler(new Thread.UncaughtExceptionHandler() {
        @Override
        public void uncaughtException(Thread t, Throwable e) {
            // åªå¤„ç†ç©ºæŒ‡é’ˆ
            if (e instanceof NullPointerException) {
                StackTraceElement[] stack = e.getStackTrace();
                if (stack.length > 0) {
                    String className = stack[0].getClassName();
                    // åªè¦æ˜¯æˆ‘ä»¬Hookçš„åŒ…ï¼Œå…¨éƒ¨åæ‰
                    if (className.startsWith("android.os.Bundle") ||
                        className.startsWith("android.content.pm") ||
                        className.startsWith("android.app") ||
                        className.contains("PackageManager")) {
                        
                        //XposedBridge.log("[InstallHook] ğŸ›¡ï¸ æ‹¦æˆªå­çº¿ç¨‹ç©ºæŒ‡é’ˆ: " +   className + "." + stack[0].getMethodName());
                        return; // ä¸å´©æºƒ
                    }
                }
            }
            
            // å…¶ä»–å´©æºƒäº¤ç»™ç³»ç»Ÿ
            Thread.UncaughtExceptionHandler defaultHandler = 
                Thread.getDefaultUncaughtExceptionHandler();
            if (defaultHandler != null && defaultHandler != this) {
                defaultHandler.uncaughtException(t, e);
            }
        }
    });
} catch (Throwable ignored) {}
    
    // ========== ğŸš¨ã€åˆ†èº«æ ¸å¿ƒä¿®å¤1ã€‘è·å–çœŸå®Contextå’ŒClassLoaderï¼ˆå¿…é¡»æœ€å…ˆæ‰§è¡Œï¼‰==========
    Context appContext = null;
    ClassLoader realClassLoader = null;
    String realPackageName = lpparam.packageName; // é»˜è®¤ä½¿ç”¨ä¼ å…¥åŒ…å
    
    try {
        // é€šè¿‡ActivityThreadè·å–å½“å‰åº”ç”¨çš„çœŸå®Context
        appContext = (Context) XposedHelpers.callStaticMethod(
            XposedHelpers.findClass("android.app.ActivityThread", null),
            "currentApplication"
        );
        if (appContext != null) {
            // è·å–çœŸå®çš„ClassLoaderï¼ˆåˆ†èº«çš„classLoaderæ˜¯ä»£ç†ï¼Œå¿…é¡»ç”¨è¿™ä¸ªï¼‰
            realClassLoader = appContext.getClassLoader();
            // è·å–çœŸå®çš„åŒ…åï¼ˆåˆ†èº«ä¼ å…¥çš„æ˜¯åˆ†èº«åŒ…åï¼Œè¿™é‡Œæ˜¯å®¿ä¸»ç¼–è¯‘ï¼‰
            realPackageName = appContext.getPackageName();
            
            //XposedBridge.log("[InstallHook] âœ… è·å–çœŸå®Context: " + realPackageName);
        }
    } catch (Throwable e) {
        //XposedBridge.log("[InstallHook] âŒ è·å–çœŸå®Contextå¤±è´¥: " + e.getMessage());
    }
    
    // é™çº§æ–¹æ¡ˆï¼šå¦‚æœè·å–å¤±è´¥ï¼Œå›é€€ä½¿ç”¨Xposedä¼ å…¥çš„å‚æ•°
    if (realClassLoader == null) {
        realClassLoader = lpparam.classLoader;
    }
    if (appContext == null) {
        try {
            // å°è¯•åˆ›å»ºä»£ç†Context
          //  appContext = createProxyContext(realPackageName);
        } catch (Throwable ignored) {}
    }
    
    // ========== ğŸš¨ã€åˆ†èº«æ ¸å¿ƒä¿®å¤2ã€‘ä¸»åŠ¨ä¿®å¤soè·¯å¾„ï¼ˆä¸ç­‰Application.attachï¼‰==========
    if (appContext != null) {
        try {
            ApplicationInfo ai = appContext.getApplicationInfo();
            if (ai != null) {
                // å¼ºåˆ¶é‡ç½®nativeLibraryDirï¼Œè§¦å‘ç³»ç»Ÿé‡æ–°è®¡ç®—æ­£ç¡®è·¯å¾„
                // åˆ†èº«ç¯å¢ƒä¸‹è¿™ä¸ªå­—æ®µæŒ‡å‘é”™è¯¯è·¯å¾„ï¼Œé‡æ–°setåŒä¸€å€¼ä¼šè§¦å‘é‡æ–°è§£æ
                XposedHelpers.setObjectField(ai, "nativeLibraryDir", ai.nativeLibraryDir);
                //XposedBridge.log("[InstallHook] âœ… åˆ†èº«ä¸»åŠ¨ä¿®å¤.soè·¯å¾„: " + ai.nativeLibraryDir);
            }
        } catch (Throwable e) {
            //XposedBridge.log("[InstallHook] âŒ åˆ†èº«ä¸»åŠ¨ä¿®å¤.soè·¯å¾„å¤±è´¥: " + e.getMessage());
        }
    }
    
    // ========== ğŸš¨ã€åˆ†èº«æ ¸å¿ƒä¿®å¤3ã€‘ä¸»åŠ¨åŠ è½½é…ç½®ï¼ˆä¸ç­‰ä»»ä½•å›è°ƒï¼‰==========
    // å¿…é¡»åœ¨è¿™é‡ŒåŠ è½½ï¼Œå› ä¸ºåˆ†èº«çš„Application.attachæ°¸è¿œä¸ä¼šè§¦å‘
    currentTargetApp = realPackageName;
    try {
        loadConfigFromFile();
        //XposedBridge.log("[InstallHook] âœ… ä¸»åŠ¨åŠ è½½é…ç½®å®Œæˆ: " + currentTargetApp);
    } catch (Throwable e) {
        //XposedBridge.log("[InstallHook] âŒ ä¸»åŠ¨åŠ è½½é…ç½®å¤±è´¥: " + e.getMessage());
        createDefaultConfig();
    }
    
    // ========== è·³è¿‡åˆ†èº«ç³»ç»Ÿç±»/æ ¸å¿ƒç±» ==========
    if (lpparam.packageName.contains("webview") ||
        lpparam.packageName.contains("chromium") ||
        lpparam.packageName.contains("android.") ||
        lpparam.packageName.contains("com.android.") ||
        lpparam.packageName.contains("system") ||
        lpparam.packageName.contains("root")) {
        return;
    }
    
    // ========== Hookæ¨¡å—è‡ªèº«æ¿€æ´»çŠ¶æ€ ==========
    if ("com.install.appinstall.xl".equals(lpparam.packageName)) {
        try {
            XposedHelpers.findAndHookMethod(
                MainActivity.class.getName(),
                lpparam.classLoader,
                "isModuleActivated",
                XC_MethodReplacement.returnConstant(true)
            );
        } catch (Throwable ignored) {}
        return;
    }

    // æ›´æ–°å½“å‰ç›®æ ‡åº”ç”¨ï¼ˆå¯èƒ½å·²è¢«çœŸå®åŒ…åè¦†ç›–ï¼‰
    if (!currentTargetApp.equals(lpparam.packageName)) {
        //XposedBridge.log("[InstallHook] ğŸ“Œ åŒ…åä¿®æ­£: " + lpparam.packageName + " â†’ " + currentTargetApp);
    }

    // è·³è¿‡ç³»ç»Ÿåº”ç”¨
    if (isSystemPackage(currentTargetApp)) {
        //XposedBridge.log("[InstallHook] è·³è¿‡ç³»ç»Ÿåº”ç”¨: " + currentTargetApp);
        return;
    }
    try {
        // ========== åˆå§‹åŒ–é…ç½®çŠ¶æ€ï¼ˆç¡®ä¿é»˜è®¤å€¼ï¼‰==========
        if (!installStatusMap.containsKey(currentTargetApp)) {
            installStatusMap.put(currentTargetApp, true);
        }
        if (!floatingShownMap.containsKey(currentTargetApp)) {
            floatingShownMap.put(currentTargetApp, true);
        }
        if (!blockExitMap.containsKey(currentTargetApp)) {
            blockExitMap.put(currentTargetApp, false);
        }
        if (!permissionFakeMap.containsKey(currentTargetApp)) {
            permissionFakeMap.put(currentTargetApp, true);
        }
        if (!userDefinedPackagesMap.containsKey(currentTargetApp)) {
            userDefinedPackagesMap.put(currentTargetApp, new ArrayList<>());
        }
        if (!excludedPackagesMap.containsKey(currentTargetApp)) {
            excludedPackagesMap.put(currentTargetApp, new ArrayList<>());
        }

        // ========== ğŸš¨ã€åˆ†èº«æ ¸å¿ƒä¿®å¤4ã€‘æ‰€æœ‰Hookæ–¹æ³•å¿…é¡»ä½¿ç”¨çœŸå®ClassLoader ==========
        // ç¬¬1çº§ï¼šåŸºç¡€ç¯å¢ƒå‡†å¤‡ï¼ˆé˜²æ­¢å´©æºƒï¼‰
        hookBundleGetString(realClassLoader);
        hookBundleEmptyInstance(realClassLoader);
        //XposedBridge.log("[InstallHook] âœ… åŸºç¡€ç¯å¢ƒHookå®Œæˆ");

        // ç¬¬2çº§ï¼šæƒé™ä¼ªé€ ï¼ˆå…³é”®é˜²å¾¡ï¼‰
        hookPackageUsageStatsPermission(realClassLoader);
        hookQueryAllPackagesPermission(realClassLoader);
        //XposedBridge.log("[InstallHook] âœ… æƒé™ä¼ªé€ Hookå®Œæˆ");

        // ç¬¬3çº§ï¼šç³»ç»Ÿåº•å±‚Hook
        hookSystemFileRead();
        hookPackageManagerReflect();
        //XposedBridge.log("[InstallHook] âœ… ç³»ç»Ÿåº•å±‚Hookå®Œæˆ");

        // ç¬¬4çº§ï¼šé€€å‡ºæ‹¦æˆªï¼ˆç”¨æˆ·ä½“éªŒä¿éšœï¼‰
        hookExitMethods(realClassLoader);
        hookIndirectExitMethods(realClassLoader);
        hookGlobalExitSources(realClassLoader);
        hookRunnableSystemExit(realClassLoader);
        //XposedBridge.log("[InstallHook] âœ… é€€å‡ºæ‹¦æˆªHookå®Œæˆ");

        // ç¬¬5çº§ï¼šåŒ…ç®¡ç†æ ¸å¿ƒä¼ªé€ ï¼ˆæ•°æ®å±‚ï¼‰
        hookKeyMethods(realClassLoader);
        hookOverloadMethods(realClassLoader);
        hookIsApplicationEnabled(realClassLoader);
        hookCheckPermission(realClassLoader);
        hookGetActivityInfo(realClassLoader);
        //XposedBridge.log("[InstallHook] âœ… åŒ…ç®¡ç†æ ¸å¿ƒHookå®Œæˆ");

        // ç¬¬6çº§ï¼šIntentç›¸å…³ä¼ªé€ ï¼ˆåº”ç”¨å±‚ï¼‰
        hookQueryIntentActivities(realClassLoader);
        hookResolveActivity(realClassLoader);
        hookQueryIntentServices(realClassLoader);
        //XposedBridge.log("[InstallHook] âœ… Intentç›¸å…³Hookå®Œæˆ");

        // ç¬¬7çº§ï¼šå¯åŠ¨æ‹¦æˆª
          /*
      hookGetLaunchIntentForPackage(lpparam.classLoader);
      hookCanStartActivity(lpparam.classLoader);
      */
        hookStartActivity(realClassLoader);
        //XposedBridge.log("[InstallHook] âœ… å¯åŠ¨æ‹¦æˆªHookå®Œæˆ");

        // ç¬¬8çº§ï¼šOkHttpç½‘ç»œå’Œè·¨å¹³å°æ¡†æ¶
        hookOkHttp(realClassLoader);
        hookFlutterPackageInfoPlus(realClassLoader);
        hookFlutterAppInstalledChecker(realClassLoader);
        hookFileSystemInstallCheck(realClassLoader);
        hookReflectInstallCheck(realClassLoader);
        hookFlutterMethodChannelCheck(realClassLoader);
        //XposedBridge.log("[InstallHook] âœ… ç½‘ç»œ/è·¨å¹³å°Hookå®Œæˆ");

      
      // ç¬¬9çº§ï¼šæ–‡ä»¶ç³»ç»Ÿå’Œå‘½ä»¤è¡Œæ£€æµ‹ï¼ˆåº•å±‚æ£€æµ‹ï¼‰
      hookRuntimeExecMethods(lpparam.classLoader);
      hookFileSystemChecks(lpparam.classLoader);
      hookLibDirectoryChecks(lpparam.classLoader);
      
        // ç¬¬10çº§ï¼šUIå’Œç”¨æˆ·ä½“éªŒ
        hookDialogCancelableMethods(realClassLoader);
        hookActivityLifecycle(realClassLoader);
        //XposedBridge.log("[InstallHook] âœ… UIç›¸å…³Hookå®Œæˆ");

        //XposedBridge.log("[InstallHook] ğŸ‰ æ‰€æœ‰Hookæ‰§è¡ŒæˆåŠŸ: " + currentTargetApp);

    } catch (Throwable t) {
        //XposedBridge.log("[InstallHook] âŒ Hookå¤±è´¥: " + t.getMessage());
        t.printStackTrace();
    }
}




  // æ–°å¢ï¼šåˆ¤æ–­æ˜¯å¦ä¸º Flutter åº”ç”¨çš„è¾…åŠ©æ–¹æ³•
  private boolean isFlutterApp(ClassLoader classLoader) {
    try {
      // æ£€æŸ¥ Flutter æ ¸å¿ƒç±»æ˜¯å¦å­˜åœ¨
      Class<?> flutterClass = Class.forName(
        "io.flutter.embedding.engine.FlutterJNI",
        false,
        classLoader
      );
      return flutterClass != null;
    } catch (ClassNotFoundException e) {
      return false;
    }
  }

  // è¿‡æ»¤ç³»ç»Ÿåº”ç”¨
  private boolean isSystemPackage(String packageName) {
    if (packageName == null) {
      return false;
    }

    //è¿‡æ»¤ä¸»æµç³»ç»Ÿ/å‚å•†åŒ…åå‰ç¼€
    String[] systemPackages = {
      // åŸºç¡€ç³»ç»ŸåŒ…
      "android",
      "com.android",
      "com.google.android",
      // åŸæœ‰æ ¸å¿ƒå‚å•†
      "com.qualcomm",
      "com.samsung",
      "com.huawei",
      "com.miui",
      "com.oneplus",
      "com.oppo",
      "com.vivo",
      "com.realme",
      "com.xiaomi",
      "com.meizu",
      "com.google.",
      "system",
      "root",
      "com.google.android.webview",
      "com.google.android.gms",
      // å‚å•†/å­å“ç‰Œ/å›½é™…ç‰ˆ
      "com.asus",
      "com.lenovo",
      "com.zuk",
      "com.motorola",
      "com.nokia",
      "com.honor",
      "com.xiaomi.global",
      "com.oppo.global",
      "com.vivo.global",
      "com.realme.global",
      "com.infinix",
      "com.tecno",
      "com.itel",
      "com.sharp",
      "com.sony",
      "com.lg",
      "com.poco",
      "com.redmi",
      "com.huawei.hwid",
      "com.oppo.nearme",
      "com.vivo.browser",
      "com.heytap",
      "com.coloros",
      "com.flyme",
      "com.mi",
      "com.xiaomi.account",
    };

    // å‰ç¼€åŒ¹é…åˆ¤æ–­
    for (String systemPkg : systemPackages) {
      if (packageName.startsWith(systemPkg)) {
        return true;
      }
    }

    // å…œåº•é€»è¾‘ï¼šé€šè¿‡ ApplicationInfo æ ‡å¿—ä½éªŒè¯
    try {
    
      Context context = (Context) XposedHelpers.callStaticMethod(
        XposedHelpers.findClass("android.app.ActivityThread", null),
        "currentApplication"
      );
      PackageManager pm = context.getPackageManager();
      ApplicationInfo appInfo = pm.getApplicationInfo(packageName, 0);
      return (
        (appInfo.flags &
          (ApplicationInfo.FLAG_SYSTEM |
            ApplicationInfo.FLAG_UPDATED_SYSTEM_APP)) !=
        0
      );
      
    } catch (Throwable t) {
      return false;
    }
  }

  private void log(String message) {
    try {
      // Xposed æ¡†æ¶æ—¥å¿—
      XposedBridge.log(
        "[" + MODULE_TAG + "] [" + currentTargetApp + "] " + message
      );
    } catch (Throwable e) {
      // æ·»åŠ ç³»ç»Ÿ Log
      android.util.Log.d(MODULE_TAG, "[" + currentTargetApp + "] " + message);
    }
  }

  // ========== é…ç½®ç®¡ç†æ–¹æ³• ==========
  private List<String> jsonArrayToStringList(JSONArray array) {
    List<String> list = new ArrayList<>();
    if (array != null) {
      for (int i = 0; i < array.length(); i++) {
        try {
          String item = array.getString(i);
          if (item != null && !item.isEmpty()) {
            list.add(item);
          }
        } catch (Exception e) {
          try {
            Object obj = array.get(i);
            if (obj != null) {
              list.add(obj.toString());
            }
          } catch (Exception ex) {}
        }
      }
    }
    return list;
  }

  // è¾…åŠ©æ–¹æ³•
  private JSONArray stringListToJsonArray(List<String> list) {
    JSONArray array = new JSONArray();
    if (list != null) {
      for (String item : list) {
        if (item != null && !item.isEmpty()) {
          array.put(item);
        }
      }
    }
    return array;
  }

 // ä»æ–‡ä»¶è·¯å¾„åŠ è½½é…ç½®
private void loadConfigFromFile() {
  try {
  
    // é…ç½®æ–‡ä»¶è·¯å¾„ - æŒ‰ä¼˜å…ˆçº§æŸ¥æ‰¾
    String currentPkg = currentTargetApp;  // é€‚é…åˆ†èº«çš„é…ç½®è·¯å¾„
     String[] loadPaths = {
       "/data/data/" + currentPkg + "/files/install_fake_config.json",
       "/data/user/0/" + currentPkg + "/files/install_fake_config.json",
       "/storage/emulated/0/Android/data/" + currentPkg + "/files/install_fake_config.json",
     };
    File configFile = null;
    String foundPath = null;
    // æŒ‰ä¼˜å…ˆçº§æŸ¥æ‰¾å­˜åœ¨çš„é…ç½®æ–‡ä»¶
    for (String filePath : loadPaths) {
      File tempFile = new File(filePath);
      if (tempFile.exists() && tempFile.length() > 0) {
        configFile = tempFile;
        foundPath = filePath;
        break; // æ‰¾åˆ°å°±åœæ­¢
      }
    }
    if (configFile != null && foundPath != null) {
      try {
        FileInputStream fis = new FileInputStream(configFile);
        BufferedReader reader = new BufferedReader(
          new InputStreamReader(fis)
        );
        StringBuilder jsonBuilder = new StringBuilder();
        String line;
        while ((line = reader.readLine()) != null) {
          jsonBuilder.append(line);
        }
        reader.close();
        fis.close();
        String jsonStr = jsonBuilder.toString();
        JSONObject configJson = new JSONObject(jsonStr);
        if (configJson.has(currentTargetApp)) {
          JSONObject appConfig = configJson.getJSONObject(currentTargetApp);
          // åŠ è½½å®‰è£…çŠ¶æ€
          if (appConfig.has("install_status")) {
            boolean status = appConfig.getBoolean("install_status");
            installStatusMap.put(currentTargetApp, status);
          } else {
            installStatusMap.put(currentTargetApp, true);
          }
          // åŠ è½½æ‚¬æµ®çª—æ˜¾ç¤ºçŠ¶æ€
          if (appConfig.has("floating_shown")) {
            boolean shown = appConfig.getBoolean("floating_shown");
            floatingShownMap.put(currentTargetApp, shown);
          } else {
            floatingShownMap.put(currentTargetApp, true);
          }
          // åŠ è½½æ‚¬æµ®çª—ä½ç½®
          if (appConfig.has("floating_x")) {
            String xStr = appConfig.getString("floating_x");
            if (!xStr.equals("null") && !xStr.isEmpty()) {
              try {
                floatingXMap.put(currentTargetApp, Float.parseFloat(xStr));
              } catch (NumberFormatException e) {
                floatingXMap.put(currentTargetApp, null);
              }
            }
          }
          if (appConfig.has("floating_y")) {
            String yStr = appConfig.getString("floating_y");
            if (!yStr.equals("null") && !yStr.isEmpty()) {
              try {
                floatingYMap.put(currentTargetApp, Float.parseFloat(yStr));
              } catch (NumberFormatException e) {
                floatingYMap.put(currentTargetApp, null);
              }
            }
          }
          // åŠ è½½æ‹¦æˆªé€€å‡ºçŠ¶æ€
          if (appConfig.has("block_exit")) {
            boolean blockExit = appConfig.getBoolean("block_exit");
            blockExitMap.put(currentTargetApp, blockExit);
          } else {
            blockExitMap.put(currentTargetApp, false);
          }
          // åŠ è½½æƒé™ä¼ªé€ çŠ¶æ€
          if (appConfig.has("permission_fake")) {
            boolean permissionFake = appConfig.getBoolean("permission_fake");
            permissionFakeMap.put(currentTargetApp, permissionFake);
          } else {
            permissionFakeMap.put(currentTargetApp, true); // é»˜è®¤å¼€å¯
          }
          // åŠ è½½æ‹¦æˆªæ¨¡å¼å†å²
          if (appConfig.has("intercept_patterns")) {
            JSONArray patternsArray = appConfig.getJSONArray(
              "intercept_patterns"
            );
            List<InterceptPattern> patterns = new ArrayList<>();
            for (int i = 0; i < patternsArray.length(); i++) {
              JSONObject patternObj = patternsArray.getJSONObject(i);
              InterceptPattern pattern = new InterceptPattern(
                patternObj.getString("pattern_hash"),
                jsonArrayToStringList(
                  patternObj.getJSONArray("installed_packages")
                ),
                jsonArrayToStringList(
                  patternObj.getJSONArray("not_installed_packages")
                )
              );
              pattern.userChoice = patternObj.optString("user_choice", "");
              pattern.choiceCount = patternObj.optInt("choice_count", 0);
              pattern.lastDetectedTime = patternObj.optLong(
                "last_detected_time",
                System.currentTimeMillis()
              );
              pattern.silentIntercept = patternObj.optBoolean(
                "silent_intercept",
                false
              );
              patterns.add(pattern);
            }
            interceptPatternsMap.put(currentTargetApp, patterns);
          }
          // åŠ è½½å…¨å±€æ•è·åŒ…å
          if (appConfig.has("global_captured_packages")) {
            JSONArray packagesArray = appConfig.getJSONArray(
              "global_captured_packages"
            );
            synchronized (globalCapturedPackages) {
              globalCapturedPackages.clear();
              for (int i = 0; i < packagesArray.length(); i++) {
                String pkg = packagesArray.getString(i);
                if (!globalCapturedPackages.contains(pkg)) {
                  globalCapturedPackages.add(pkg);
                }
              }
            }
          }
          // åŠ è½½ç”¨æˆ·è‡ªå®šä¹‰åŒ…å
          if (appConfig.has("user_defined_packages")) {
            JSONArray userPackagesArray = appConfig.getJSONArray(
              "user_defined_packages"
            );
            List<String> userPackages = jsonArrayToStringList(
              userPackagesArray
            );
            userDefinedPackagesMap.put(currentTargetApp, userPackages);
            // åŒæ­¥åˆ°å…¨å±€æ•è·åŒ…ï¼ˆç¡®ä¿å‚ä¸ä¼ªé€ ï¼‰
            synchronized (globalCapturedPackages) {
              globalCapturedPackages.addAll(userPackages);
            }
            log("åŠ è½½ç”¨æˆ·è‡ªå®šä¹‰ä¼ªé€ åŒ…å: " + userPackages.size() + " ä¸ª");
          } else {
            // æ— ç”¨æˆ·è‡ªå®šä¹‰åŒ…åæ—¶åˆå§‹åŒ–ç©ºåˆ—è¡¨
            userDefinedPackagesMap.put(currentTargetApp, new ArrayList<>());
          }
          // æ–°å¢ï¼šåŠ è½½ç”¨æˆ·è‡ªå®šä¹‰æ’é™¤åŒ…å
          if (appConfig.has("excluded_packages")) {
            JSONArray excludedArray = appConfig.getJSONArray("excluded_packages");
            List<String> excludedPackages = jsonArrayToStringList(excludedArray);
            excludedPackagesMap.put(currentTargetApp, excludedPackages);
            log("åŠ è½½ç”¨æˆ·è‡ªå®šä¹‰æ’é™¤åŒ…å: " + excludedPackages.size() + " ä¸ª");
          } else {
            excludedPackagesMap.put(currentTargetApp, new ArrayList<>());
          }
          // æ¸…ç†å…¨å±€æ•è·åŒ…åçš„é‡å¤æ•°æ®
          synchronized (globalCapturedPackages) {
            globalCapturedPackages.addAll(
              new HashSet<>(
                userDefinedPackagesMap.getOrDefault(
                  currentTargetApp,
                  new ArrayList<>()
                )
              )
            );
          }
          log("âœ… é…ç½®åŠ è½½å®Œæˆ " + foundPath);
        } else {
        //  log("âš ï¸ é…ç½®æ–‡ä»¶ä¸­æ²¡æœ‰å½“å‰åº”ç”¨çš„æ•°æ®ï¼Œåˆ›å»ºé»˜è®¤é…ç½®");
          createDefaultConfig();
        }
      } catch (Throwable e) {
        log("âŒ è¯»å–é…ç½®æ–‡ä»¶å¼‚å¸¸: " + e.getMessage());
        createDefaultConfig();
      }
    } else {
    //  log("âš ï¸ æœªæ‰¾åˆ°é…ç½®æ–‡ä»¶,åˆ›å»ºé»˜è®¤é…ç½®");
      createDefaultConfig();
    }
  } catch (Throwable t) {
    log("âŒ åŠ è½½é…ç½®å¼‚å¸¸: " + t.getMessage());
    createDefaultConfig();
  }
}


  // ä¿å­˜é…ç½®æ–‡ä»¶
private void saveConfigToFile() {
  if (currentTargetApp == null || currentTargetApp.isEmpty()) {
    log("âŒ é…ç½®ä¿å­˜å¤±è´¥ï¼šå½“å‰ç›®æ ‡åº”ç”¨ä¸ºç©º");
    return;
  }
  if (isSystemPackage(currentTargetApp)) {
    log("è·³è¿‡ç³»ç»Ÿé…ç½®: " + currentTargetApp);
    return;
  }
  Boolean status = installStatusMap.get(currentTargetApp);
  if (status == null) {
    log("âŒ é…ç½®ä¿å­˜å¤±è´¥ï¼šæœªè·å–åˆ°åº”ç”¨å®‰è£…çŠ¶æ€");
    return;
  }
  // åŠ¨æ€ä½¿ç”¨å½“å‰è¿è¡ŒåŒ…åï¼ˆåˆ†èº«æ—¶è‡ªåŠ¨ä¸ºåˆ†èº«åŒ…åï¼‰
   String currentPkg = currentTargetApp;
  // æŒ‰ä¼˜å…ˆçº§å°è¯•å¤šä¸ªä¿å­˜è·¯å¾„
  String[] savePaths = {
    "/data/data/" + currentTargetApp + "/files/install_fake_config.json",
    "/data/user/0/" + currentTargetApp + "/files/install_fake_config.json",
    "/storage/emulated/0/Android/data/" +
    currentTargetApp +
    "/files/install_fake_config.json",
  };
  boolean saveSuccess = false;
  String savedPath = null;
  Throwable lastError = null;
  for (String filePath : savePaths) {
    try {
      File configFile = new File(filePath);
      File parentDir = configFile.getParentFile();
      // ç¡®ä¿çˆ¶ç›®å½•å­˜åœ¨
      if (parentDir != null && !parentDir.exists()) {
        boolean mkdirSuccess = parentDir.mkdirs();
        if (!mkdirSuccess) {
          lastError = new Exception("æ— æ³•åˆ›å»ºç›®å½• " + parentDir.getPath());
          log("âŒ é…ç½®ä¿å­˜å¤±è´¥ï¼šæ— æ³•åˆ›å»ºç›®å½• " + parentDir.getPath());
          continue; // å°è¯•ä¸‹ä¸€ä¸ªè·¯å¾„
        }
      }
      // è¯»å–ç°æœ‰é…ç½®ï¼ˆæ— åˆ™åˆ›å»ºæ–°JSONï¼‰
      JSONObject configJson = new JSONObject();
      if (configFile.exists() && configFile.length() > 0) {
        FileInputStream fis = new FileInputStream(configFile);
        BufferedReader reader = new BufferedReader(
          new InputStreamReader(fis)
        );
        StringBuilder jsonBuilder = new StringBuilder();
        String line;
        while ((line = reader.readLine()) != null) {
          jsonBuilder.append(line);
        }
        reader.close();
        fis.close();
        String existingJson = jsonBuilder.toString();
        if (!existingJson.trim().isEmpty()) {
          configJson = new JSONObject(existingJson);
        }
      }
      // ç»„è£…åº”ç”¨é…ç½®æ•°æ®
      Float x = floatingXMap.get(currentTargetApp);
      Float y = floatingYMap.get(currentTargetApp);
      Boolean blockExit = blockExitMap.get(currentTargetApp);
      Boolean permissionFake = permissionFakeMap.get(currentTargetApp);
      JSONObject appConfig = new JSONObject();
      appConfig.put("install_status", status);
      appConfig.put(
        "floating_shown",
        floatingShownMap.getOrDefault(currentTargetApp, true)
      );
      appConfig.put("floating_x", x != null ? String.valueOf(x) : "null");
      appConfig.put("floating_y", y != null ? String.valueOf(y) : "null");
      appConfig.put("block_exit", blockExit != null ? blockExit : false);
      appConfig.put(
        "permission_fake",
        permissionFake != null ? permissionFake : true
      );
      appConfig.put("last_save_time", System.currentTimeMillis());
      appConfig.put("last_save_path", filePath); // è®°å½•ä¿å­˜çš„è·¯å¾„
      // ä¿å­˜ç”¨æˆ·è‡ªå®šä¹‰åŒ…å
      List<String> userPackages = userDefinedPackagesMap.getOrDefault(
        currentTargetApp,
        new ArrayList<>()
      );
      appConfig.put(
        "user_defined_packages",
        stringListToJsonArray(userPackages)
      );
      // æ–°å¢ï¼šä¿å­˜ç”¨æˆ·è‡ªå®šä¹‰æ’é™¤åŒ…å
      List<String> excludedPackages = excludedPackagesMap.getOrDefault(currentTargetApp, new ArrayList<>());
      appConfig.put("excluded_packages", stringListToJsonArray(excludedPackages));
      // ä¿å­˜æ‹¦æˆªæ¨¡å¼å†å²
      List<InterceptPattern> patterns = interceptPatternsMap.get(
        currentTargetApp
      );
      if (patterns != null && !patterns.isEmpty()) {
        JSONArray patternsArray = new JSONArray();
        for (InterceptPattern pattern : patterns) {
          JSONObject patternObj = new JSONObject();
          patternObj.put("pattern_hash", pattern.patternHash);
          patternObj.put(
            "installed_packages",
            stringListToJsonArray(pattern.installedPackages)
          );
          patternObj.put(
            "not_installed_packages",
            stringListToJsonArray(pattern.notInstalledPackages)
          );
          patternObj.put(
            "user_choice",
            pattern.userChoice != null ? pattern.userChoice : ""
          );
          patternObj.put("choice_count", pattern.choiceCount);
          patternObj.put("last_detected_time", pattern.lastDetectedTime);
          patternObj.put("silent_intercept", pattern.silentIntercept);
          patternsArray.put(patternObj);
        }
        appConfig.put("intercept_patterns", patternsArray);
      }
      // ä¿å­˜å…¨å±€æ•è·åŒ…å
      synchronized (globalCapturedPackages) {
        appConfig.put(
          "global_captured_packages",
          stringListToJsonArray(globalCapturedPackages)
        );
      }
      // å†™å…¥é…ç½®æ–‡ä»¶
      configJson.put(currentTargetApp, appConfig);
      String finalJson = configJson.toString(2); // æ ¼å¼åŒ–JSON
      FileOutputStream fos = new FileOutputStream(configFile);
      OutputStreamWriter writer = new OutputStreamWriter(fos, "UTF-8");
      writer.write(finalJson);
      writer.flush();
      writer.close();
      fos.close();
      saveSuccess = true;
      savedPath = filePath;
   //   log("âœ… é…ç½®ä¿å­˜æˆåŠŸ: " + filePath);
      break; // ä¿å­˜æˆåŠŸï¼Œä¸å†å°è¯•å…¶ä»–è·¯å¾„
    } catch (Throwable t) {
      // å½“å‰è·¯å¾„ä¿å­˜å¤±è´¥ï¼Œè®°å½•æ—¥å¿—å¹¶ç»§ç»­å°è¯•ä¸‹ä¸€ä¸ªè·¯å¾„
      lastError = t;
      log("âŒ é…ç½®ä¿å­˜å¼‚å¸¸: " + t.getMessage() + " | è·¯å¾„: " + filePath);
      continue; // ç»§ç»­å°è¯•ä¸‹ä¸€ä¸ªè·¯å¾„
    }
  }
  if (!saveSuccess) {
    if (lastError != null) {
      //    log("âŒ æœ€åé”™è¯¯: " + lastError.getMessage());
    }
  }
}


// åˆ›å»ºé»˜è®¤é…ç½®
private void createDefaultConfig() {
  try {
    installStatusMap.put(currentTargetApp, true);
    floatingShownMap.put(currentTargetApp, true);
    blockExitMap.put(currentTargetApp, false);
    permissionFakeMap.put(currentTargetApp, true);
    interceptPatternsMap.put(
      currentTargetApp,
      new ArrayList<InterceptPattern>()
    );
    // åˆå§‹åŒ–ç”¨æˆ·è‡ªå®šä¹‰åŒ…ååˆ—è¡¨
    userDefinedPackagesMap.put(currentTargetApp, new ArrayList<>());
    // åˆå§‹åŒ–ç”¨æˆ·è‡ªå®šä¹‰æ’é™¤åŒ…ååˆ—è¡¨
    excludedPackagesMap.put(currentTargetApp, new ArrayList<>());
    // log("âœ… åˆ›å»ºé»˜è®¤é…ç½®å®Œæˆ");
  } catch (Throwable t) {
    log("âŒ åˆ›å»ºé»˜è®¤é…ç½®å¼‚å¸¸: " + t.getMessage());
  }
}


  // ========== æ‹¦æˆªé€€å‡ºåŠŸèƒ½æ ¸å¿ƒæ–¹æ³• ==========
  private void hookExitMethods(ClassLoader classLoader) {
    try {
      XposedHelpers.findAndHookMethod(
        "java.lang.System",
        classLoader,
        "exit",
        int.class,
        new XC_MethodHook() {
          @Override
          protected void beforeHookedMethod(MethodHookParam param)
            throws Throwable {
            param.setResult(null); // é˜»æ–­è¿”å›
            param.setThrowable(null);
            log("âœ… æ‹¦æˆªexité€€å‡º");
            // è°ƒç”¨è‡ªå®šä¹‰å¤„ç†é€»è¾‘ï¼ˆå…ˆæ‹¦æˆªåå¼¹çª—ï¼‰
            handleAppExit("System.exit()", param);
          }

          @Override
          protected void afterHookedMethod(MethodHookParam param)
            throws Throwable {
            // ç¦æ­¢æ‰§è¡ŒåŸæ–¹æ³•åçš„é€»è¾‘ï¼Œå½»åº•é˜»æ–­
          }
        }
      );

      // Process.killProcess() åŒæ ·å½»åº•é˜»æ–­
      XposedHelpers.findAndHookMethod(
        "android.os.Process",
        classLoader,
        "killProcess",
        int.class,
        new XC_MethodHook() {
          @Override
          protected void beforeHookedMethod(MethodHookParam param)
            throws Throwable {
            param.setResult(null);
            param.setThrowable(null);
            log("âœ… æ‹¦æˆªé€€å‡ºkillProcess");
            handleAppExit("Process.killProcess()", param);
          }
        }
      );

      // Activity.finish() æ‹¦æˆªé€»è¾‘ä¸å˜ï¼ˆä»…ä¸»Activityï¼‰
      XposedHelpers.findAndHookMethod(
        "android.app.Activity",
        classLoader,
        "finish",
        new XC_MethodHook() {
          @Override
          protected void beforeHookedMethod(MethodHookParam param)
            throws Throwable {
            Activity activity = (Activity) param.thisObject;
            if (isMainActivity(activity)) {
              handleActivityFinish(activity, param);
            }
          }
        }
      );

      log("âœ… æ‹¦æˆªfinishé€€å‡º");
    } catch (Throwable t) {
      log("Hooké€€å‡ºæ–¹æ³•å¤±è´¥: " + t.getMessage());
    }
  }

  // åˆ¤æ–­æ˜¯å¦ä¸ºä¸»Activity
  private boolean isMainActivity(Activity activity) {
    try {
      Intent intent = activity.getIntent();
      if (intent != null) {
        String action = intent.getAction();
        if (Intent.ACTION_MAIN.equals(action)) {
          Set<String> categories = intent.getCategories();
          if (
            categories != null && categories.contains(Intent.CATEGORY_LAUNCHER)
          ) {
            return true;
          }
        }
      }
    } catch (Throwable t) {
      log("åˆ¤æ–­ä¸»Activityå¼‚å¸¸: " + t.getMessage());
    }
    return false;
  }

  // å¤„ç†åº”ç”¨é€€å‡º
  private void handleAppExit(
    final String exitMethod,
    final MethodHookParam param
  ) {
    try {
      Boolean blockExit = blockExitMap.get(currentTargetApp);
      boolean forceIntercept = (blockExit == null);
      if (!forceIntercept && !blockExit) {
        return;
      }

      DetectedPackages detected = analyzeDetectedPackages();
      if (
        detected.installedPackages.isEmpty() &&
        detected.notInstalledPackages.isEmpty()
      ) {
        return;
      }

      // å…œåº•ï¼šä»…åšåº”ç”¨å±‚æ¢å¤ï¼Œä¸é˜»æ–­ System.exit()
      new Handler(Looper.getMainLooper()).post(
        new Runnable() {
          @Override
          public void run() {
            Activity activity = getCurrentActivity();
            if (activity != null && !activity.isFinishing()) {
              // å¼ºåˆ¶æ¢å¤åº”ç”¨å‰å°
              ActivityManager am = (ActivityManager) activity.getSystemService(
                Context.ACTIVITY_SERVICE
              );
              if (am != null) {
                am.moveTaskToFront(
                  activity.getTaskId(),
                  ActivityManager.MOVE_TASK_NO_USER_ACTION
                );
              }
              showSilentToast(activity, "å·²æ‹¦æˆªåº”ç”¨é€€å‡º");
            }
          }
        }
      );

      // ä¿å­˜é…ç½®
      if (forceIntercept) {
        blockExitMap.put(currentTargetApp, true);
        saveConfigToFile();
      }
    } catch (Throwable t) {
      log("å¤„ç†é€€å‡ºæ‹¦æˆªå¼‚å¸¸: " + t.getMessage());
    }
  }

  // å¤„ç†Activityç»“æŸ
  private void handleActivityFinish(
    final Activity activity,
    final MethodHookParam param
  ) {
    try {
      Boolean blockExit = blockExitMap.get(currentTargetApp);
      if (blockExit == null || !blockExit) {
        return;
      }
      DetectedPackages detected = analyzeDetectedPackages();
      if (
        detected.installedPackages.isEmpty() &&
        detected.notInstalledPackages.isEmpty()
      ) {
        return;
      }
      boolean shouldSilentIntercept = checkSilentIntercept(detected);
      if (shouldSilentIntercept) {
        param.setResult(null);
        showSilentInterceptToast(detected);
        log("é™é»˜æ‹¦æˆªActivityé€€å‡º");
        return;
      }

      // åˆ›å»ºå±€éƒ¨finalå˜é‡ï¼Œä¾›åŒ¿åå†…éƒ¨ç±»å¼•ç”¨
      final DetectedPackages finalDetected = detected;
      final Activity finalActivity = activity;
      final MethodHookParam finalParam = param;

      // å¼ºåˆ¶æ˜¾ç¤ºå¼¹çª—
      new Handler(Looper.getMainLooper()).post(
        new Runnable() {
          @Override
          public void run() {
            try {
              if (finalActivity.isFinishing() || finalActivity.isDestroyed()) {
                return;
              }

              // æ„å»ºå¼¹çª—æ¶ˆæ¯
              StringBuilder message = new StringBuilder();
              if (
                !finalDetected.installedPackages.isEmpty() &&
                finalDetected.notInstalledPackages.isEmpty()
              ) {
                message.append("å½“å‰åº”ç”¨æ£€æµ‹åˆ°ä½ å·²å®‰è£…ï¼š\n");
                for (String pkg : finalDetected.installedPackages) {
                  message.append("â€¢ ").append(pkg).append("\n");
                }
              } else if (
                finalDetected.installedPackages.isEmpty() &&
                !finalDetected.notInstalledPackages.isEmpty()
              ) {
                message.append("å½“å‰åº”ç”¨æ£€æµ‹åˆ°ä½ æœªå®‰è£…ï¼š\n");
                for (String pkg : finalDetected.notInstalledPackages) {
                  message.append("â€¢ ").append(pkg).append("\n");
                }
              } else {
                message.append("å½“å‰åº”ç”¨æ£€æµ‹åˆ°ä½ ï¼š\n\n");
                if (!finalDetected.installedPackages.isEmpty()) {
                  message.append("ã€å·²å®‰è£…ã€‘ï¼š\n");
                  for (String pkg : finalDetected.installedPackages) {
                    message.append("â€¢ ").append(pkg).append("\n");
                  }
                  message.append("\n");
                }
                if (!finalDetected.notInstalledPackages.isEmpty()) {
                  message.append("ã€æœªå®‰è£…ã€‘ï¼š\n");
                  for (String pkg : finalDetected.notInstalledPackages) {
                    message.append("â€¢ ").append(pkg).append("\n");
                  }
                }
              }
              message.append("\nå³å°†ç»“æŸé€€å‡ºåº”ç”¨\nè¯·é€‰æ‹©æ˜¯å¦é€€å‡ºï¼Ÿ");

              // åˆ›å»ºå¼¹çª—
              AlertDialog dialog = createBoundedDialog(
                finalActivity,
                "æ‹¦æˆªæé†’",
                message.toString(),
                new String[] { "æ‹¦æˆªé€€å‡º", "ä¸æ‹¦æˆª" },
                new DialogInterface.OnClickListener[] {
                  new DialogInterface.OnClickListener() {
                    @Override
                    public void onClick(DialogInterface dialog, int which) {
                      handleInterceptChoice(finalDetected, "intercept", true);
                      dialog.dismiss();
                      Toast.makeText(
                        finalActivity,
                        "å·²æ‹¦æˆªé€€å‡ºï¼Œåº”ç”¨ç»§ç»­è¿è¡Œ",
                        Toast.LENGTH_SHORT
                      ).show();
                    }
                  },
                  new DialogInterface.OnClickListener() {
                    @Override
                    public void onClick(DialogInterface dialog, int which) {
                      handleInterceptChoice(finalDetected, "allow", false);
                      dialog.dismiss();
                      blockExitMap.put(currentTargetApp, false);
                      saveConfigToFile();
                      try {
                        finalParam.setResult(null);
                        finalActivity.finish();
                      } catch (Throwable t) {
                        log("é‡æ–°ç»“æŸActivityå¼‚å¸¸: " + t.getMessage());
                      }
                      Toast.makeText(
                        finalActivity,
                        "å·²å…è®¸é€€å‡ºï¼Œæ‹¦æˆªåŠŸèƒ½å·²å…³é—­",
                        Toast.LENGTH_SHORT
                      ).show();
                    }
                  },
                }
              );

              // ä»…ä¿ç•™åŸºç¡€é…ç½®
              dialog.setCanceledOnTouchOutside(false);
              dialog.setCancelable(false); // ç¦æ­¢å…³é—­
              dialog.show();

              // åŸºç¡€ç½®é¡¶
              Window window = dialog.getWindow();
              if (window != null) {
                finalActivity.getWindow().getDecorView().bringToFront();
                window.getDecorView().bringToFront();
              }
            } catch (Throwable t) {
              log("æ˜¾ç¤ºActivityé€€å‡ºæ‹¦æˆªå¯¹è¯æ¡†å¼‚å¸¸: " + t.getMessage());
            }
          }
        }
      );

      // é˜»å¡Activityé€€å‡º
      param.setResult(null);
    } catch (Throwable t) {
      log("å¤„ç†Activityç»“æŸå¼‚å¸¸: " + t.getMessage());
    }
  }

 // åˆ†ææ£€æµ‹åˆ°çš„åŒ…åï¼ˆè¿‡æ»¤æ’é™¤åŒ…ï¼Œä¸çº³å…¥ä¼ªé€ åˆ—è¡¨ï¼‰
private DetectedPackages analyzeDetectedPackages() {
  DetectedPackages detected = new DetectedPackages();
  try {
    Boolean currentStatus = installStatusMap.get(currentTargetApp);
    boolean isInstalledMode = currentStatus != null ? currentStatus : true;
    // ç”¨ Set ä¸´æ—¶å­˜å‚¨ï¼Œè‡ªåŠ¨å»é‡
    Set<String> uniqueInstalled = new HashSet<>();
    Set<String> uniqueNotInstalled = new HashSet<>();
    // è·å–ç”¨æˆ·æ‰‹åŠ¨æ’é™¤çš„åŒ…ååˆ—è¡¨ï¼ˆæ ¸å¿ƒè¿‡æ»¤é€»è¾‘ï¼‰
    List<String> excludedPackages = excludedPackagesMap.getOrDefault(currentTargetApp, new ArrayList<>());
    
    synchronized (globalCapturedPackages) {
      for (String pkg : globalCapturedPackages) {
        if (isSystemPackage(pkg)) continue; // è¿‡æ»¤ç³»ç»ŸåŒ…
        if (excludedPackages.contains(pkg)) continue; // è¿‡æ»¤æ’é™¤åŒ…ï¼ˆä¸çº³å…¥ä¼ªé€ ï¼‰
        if (isInstalledMode) {
          uniqueInstalled.add(pkg); // è‡ªåŠ¨å»é‡
        } else {
          uniqueNotInstalled.add(pkg); // è‡ªåŠ¨å»é‡
        }
      }
    }
    // è½¬å­˜å› Listï¼Œä¿æŒåŸæœ‰é€»è¾‘
    detected.installedPackages = new ArrayList<>(uniqueInstalled);
    detected.notInstalledPackages = new ArrayList<>(uniqueNotInstalled);
    // ç”Ÿæˆæ¨¡å¼å“ˆå¸Œ
    detected.patternHash = generatePatternHash(detected);
  } catch (Throwable t) {
    log("åˆ†ææ£€æµ‹åŒ…åå¼‚å¸¸: " + t.getMessage());
  }
  return detected;
}


  // ç”Ÿæˆæ¨¡å¼å“ˆå¸Œ
  private String generatePatternHash(DetectedPackages detected) {
    try {
      List<String> allPackages = new ArrayList<>();
      allPackages.addAll(detected.installedPackages);
      allPackages.add("|");
      allPackages.addAll(detected.notInstalledPackages);
      Collections.sort(allPackages);

      MessageDigest md = MessageDigest.getInstance("MD5");
      for (String pkg : allPackages) {
        md.update(pkg.getBytes());
      }
      byte[] digest = md.digest();

      StringBuilder hexString = new StringBuilder();
      for (byte b : digest) {
        hexString.append(String.format("%02x", b));
      }

      return hexString.toString();
    } catch (Throwable t) {
      log("ç”Ÿæˆæ¨¡å¼å“ˆå¸Œå¼‚å¸¸: " + t.getMessage());
      return "default_hash";
    }
  }

  // æ£€æŸ¥é™é»˜æ‹¦æˆª
  private boolean checkSilentIntercept(DetectedPackages detected) {
    try {
      List<InterceptPattern> patterns = interceptPatternsMap.get(
        currentTargetApp
      );
      if (patterns == null) {
        return false;
      }

      for (InterceptPattern pattern : patterns) {
        if (
          pattern.patternHash.equals(detected.patternHash) &&
          pattern.silentIntercept &&
          pattern.userChoice.equals("intercept")
        ) {
          pattern.lastDetectedTime = System.currentTimeMillis();
          return true;
        }
      }
    } catch (Throwable t) {
      log("æ£€æŸ¥é™é»˜æ‹¦æˆªå¼‚å¸¸: " + t.getMessage());
    }
    return false;
  }

  // æ˜¾ç¤ºé™é»˜æ‹¦æˆªToast
  private void showSilentInterceptToast(DetectedPackages detected) {
    try {
      Activity activity = getCurrentActivity();
      if (activity == null || activity.isFinishing()) {
        return;
      }

      int totalCount =
        detected.installedPackages.size() +
        detected.notInstalledPackages.size();
      String packageNames = "";
      if (totalCount <= 3) {
        List<String> allPackages = new ArrayList<>();
        allPackages.addAll(detected.installedPackages);
        allPackages.addAll(detected.notInstalledPackages);
        packageNames = String.join(", ", allPackages);
      } else {
        packageNames =
          detected.installedPackages.get(0) + " ç­‰" + totalCount + "ä¸ªåº”ç”¨";
      }

      String message =
        "å·²è‡ªåŠ¨æ‹¦æˆªé€€å‡ºï¼ˆåŸºäºå†å²é€‰æ‹©ï¼‰\næ£€æµ‹åˆ°ï¼š" + packageNames;
      Toast.makeText(activity, message, Toast.LENGTH_LONG).show();
    } catch (Throwable t) {
      log("æ˜¾ç¤ºé™é»˜æ‹¦æˆªToastå¼‚å¸¸: " + t.getMessage());
    }
  }

  // ========== æ˜¾ç¤ºé€€å‡ºæ‹¦æˆªå¯¹è¯æ¡† ==========
  private void showExitInterceptDialog(
    final String exitMethod,
    final DetectedPackages detected,
    final MethodHookParam param
  ) {
    try {
      final Activity activity = getCurrentActivity();
      if (activity == null || activity.isFinishing()) {
        return;
      }

      // æ„å»ºå¼¹çª—æ¶ˆæ¯
      StringBuilder message = new StringBuilder();

      if (
        !detected.installedPackages.isEmpty() &&
        detected.notInstalledPackages.isEmpty()
      ) {
        message.append("å½“å‰åº”ç”¨æ£€æµ‹åˆ°ä½ å·²å®‰è£…ï¼š\n");
        for (String pkg : detected.installedPackages) {
          message.append("â€¢ ").append(pkg).append("\n");
        }
      } else if (
        detected.installedPackages.isEmpty() &&
        !detected.notInstalledPackages.isEmpty()
      ) {
        message.append("å½“å‰åº”ç”¨æ£€æµ‹åˆ°ä½ æœªå®‰è£…ï¼š\n");
        for (String pkg : detected.notInstalledPackages) {
          message.append("â€¢ ").append(pkg).append("\n");
        }
      } else {
        message.append("å½“å‰åº”ç”¨æ£€æµ‹åˆ°ä½ ï¼š\n\n");
        if (!detected.installedPackages.isEmpty()) {
          message.append("ã€å·²å®‰è£…ã€‘ï¼š\n");
          for (String pkg : detected.installedPackages) {
            message.append("â€¢ ").append(pkg).append("\n");
          }
          message.append("\n");
        }
        if (!detected.notInstalledPackages.isEmpty()) {
          message.append("ã€æœªå®‰è£…ã€‘ï¼š\n");
          for (String pkg : detected.notInstalledPackages) {
            message.append("â€¢ ").append(pkg).append("\n");
          }
        }
      }

      message.append("\nå³å°†ç»“æŸé€€å‡ºåº”ç”¨\nè¯·é€‰æ‹©æ˜¯å¦é€€å‡ºï¼Ÿ");

      AlertDialog dialog = createBoundedDialog(
        activity,
        "æ‹¦æˆªæé†’",
        message.toString(),
        new String[] { "æ‹¦æˆªé€€å‡º", "ä¸æ‹¦æˆª" },
        new DialogInterface.OnClickListener[] {
          new DialogInterface.OnClickListener() {
            @Override
            public void onClick(DialogInterface dialog, int which) {
              // æ‹¦æˆªé€€å‡º
              handleInterceptChoice(detected, "intercept", true);
              dialog.dismiss();
              Toast.makeText(
                activity,
                "å·²æ‹¦æˆªé€€å‡ºï¼Œåº”ç”¨ç»§ç»­è¿è¡Œ",
                Toast.LENGTH_SHORT
              ).show();
            }
          },
          new DialogInterface.OnClickListener() {
            @Override
            public void onClick(DialogInterface dialog, int which) {
              // ä¸æ‹¦æˆª
              handleInterceptChoice(detected, "allow", false);
              dialog.dismiss();
              blockExitMap.put(currentTargetApp, false);
              saveConfigToFile();

              try {
                param.setResult(null);
                if (exitMethod.equals("System.exit()")) {
                  System.exit((int) param.args[0]);
                } else if (exitMethod.equals("Process.killProcess()")) {
                  android.os.Process.killProcess((int) param.args[0]);
                }
              } catch (Throwable t) {
                log("é‡æ–°é€€å‡ºå¼‚å¸¸: " + t.getMessage());
              }

              Toast.makeText(
                activity,
                "å·²å…è®¸é€€å‡ºï¼Œæ‹¦æˆªåŠŸèƒ½å·²å…³é—­",
                Toast.LENGTH_SHORT
              ).show();
            }
          },
        }
      );

      dialog.show();
    } catch (Throwable t) {
      log("æ˜¾ç¤ºé€€å‡ºæ‹¦æˆªå¯¹è¯æ¡†å¼‚å¸¸: " + t.getMessage());
    }
  }


  // ========== æ˜¾ç¤ºActivityé€€å‡ºæ‹¦æˆªå¯¹è¯æ¡† ==========
  private void showActivityExitInterceptDialog(
    final Activity activity,
    final DetectedPackages detected,
    final MethodHookParam param
  ) {
    try {
      // æ„å»ºå¼¹çª—æ¶ˆæ¯
      StringBuilder message = new StringBuilder();

      if (
        !detected.installedPackages.isEmpty() &&
        detected.notInstalledPackages.isEmpty()
      ) {
        message.append("å½“å‰åº”ç”¨æ£€æµ‹åˆ°ä½ å·²å®‰è£…ï¼š\n");
        for (String pkg : detected.installedPackages) {
          message.append("â€¢ ").append(pkg).append("\n");
        }
      } else if (
        detected.installedPackages.isEmpty() &&
        !detected.notInstalledPackages.isEmpty()
      ) {
        message.append("å½“å‰åº”ç”¨æ£€æµ‹åˆ°ä½ æœªå®‰è£…ï¼š\n");
        for (String pkg : detected.notInstalledPackages) {
          message.append("â€¢ ").append(pkg).append("\n");
        }
      } else {
        message.append("å½“å‰åº”ç”¨æ£€æµ‹åˆ°ä½ ï¼š\n\n");
        if (!detected.installedPackages.isEmpty()) {
          message.append("ã€å·²å®‰è£…ã€‘ï¼š\n");
          for (String pkg : detected.installedPackages) {
            message.append("â€¢ ").append(pkg).append("\n");
          }
          message.append("\n");
        }
        if (!detected.notInstalledPackages.isEmpty()) {
          message.append("ã€æœªå®‰è£…ã€‘ï¼š\n");
          for (String pkg : detected.notInstalledPackages) {
            message.append("â€¢ ").append(pkg).append("\n");
          }
        }
      }

      message.append("\nå³å°†ç»“æŸé€€å‡ºåº”ç”¨\nè¯·é€‰æ‹©æ˜¯å¦é€€å‡ºï¼Ÿ");

      AlertDialog dialog = createBoundedDialog(
        activity,
        "æ‹¦æˆªæé†’",
        message.toString(),
        new String[] { "æ‹¦æˆªé€€å‡º", "ä¸æ‹¦æˆª" },
        new DialogInterface.OnClickListener[] {
          new DialogInterface.OnClickListener() {
            @Override
            public void onClick(DialogInterface dialog, int which) {
              // æ‹¦æˆªé€€å‡º
              handleInterceptChoice(detected, "intercept", true);
              dialog.dismiss();
              Toast.makeText(
                activity,
                "å·²æ‹¦æˆªé€€å‡ºï¼Œåº”ç”¨ç»§ç»­è¿è¡Œ",
                Toast.LENGTH_SHORT
              ).show();
            }
          },
          new DialogInterface.OnClickListener() {
            @Override
            public void onClick(DialogInterface dialog, int which) {
              // ä¸æ‹¦æˆª
              handleInterceptChoice(detected, "allow", false);
              dialog.dismiss();
              blockExitMap.put(currentTargetApp, false);
              saveConfigToFile();

              try {
                param.setResult(null);
                activity.finish();
              } catch (Throwable t) {
                log("é‡æ–°ç»“æŸActivityå¼‚å¸¸: " + t.getMessage());
              }

              Toast.makeText(
                activity,
                "å·²å…è®¸é€€å‡ºï¼Œæ‹¦æˆªåŠŸèƒ½å·²å…³é—­",
                Toast.LENGTH_SHORT
              ).show();
            }
          },
        }
      );

      dialog.show();
    } catch (Throwable t) {
      log("æ˜¾ç¤ºActivityé€€å‡ºæ‹¦æˆªå¯¹è¯æ¡†å¼‚å¸¸: " + t.getMessage());
    }
  }

  // ========== å¤„ç†æ‹¦æˆªé€‰æ‹© ==========
  private void handleInterceptChoice(
    DetectedPackages detected,
    String choice,
    boolean interceptSuccess
  ) {
    try {
      List<InterceptPattern> patterns = interceptPatternsMap.get(
        currentTargetApp
      );
      if (patterns == null) {
        patterns = new ArrayList<>();
        interceptPatternsMap.put(currentTargetApp, patterns);
      }

      InterceptPattern existingPattern = null;
      for (InterceptPattern pattern : patterns) {
        if (pattern.patternHash.equals(detected.patternHash)) {
          existingPattern = pattern;
          break;
        }
      }

      if (existingPattern == null) {
        existingPattern = new InterceptPattern(
          detected.patternHash,
          new ArrayList<>(detected.installedPackages),
          new ArrayList<>(detected.notInstalledPackages)
        );
        patterns.add(existingPattern);
      }

      existingPattern.userChoice = choice;
      existingPattern.choiceCount++;
      existingPattern.lastDetectedTime = System.currentTimeMillis();
      // è¶…è¿‡2æ¬¡åä½ å†è¯¢é—®æ˜¯å¦æ‹¦æˆª
      if (choice.equals("intercept") && existingPattern.choiceCount >= 2) {
        existingPattern.silentIntercept = true;
        log("å¯ç”¨é™é»˜æ‹¦æˆªï¼Œæ¨¡å¼: " + detected.patternHash);
      } else if (choice.equals("allow")) {
        existingPattern.silentIntercept = false;
      }

      saveConfigToFile();

      log(
        "æ‹¦æˆªé€‰æ‹©è®°å½• - æ¨¡å¼: " +
        detected.patternHash +
        ", é€‰æ‹©: " +
        choice +
        ", è®¡æ•°: " +
        existingPattern.choiceCount +
        ", é™é»˜: " +
        existingPattern.silentIntercept
      );
    } catch (Throwable t) {
      log("å¤„ç†æ‹¦æˆªé€‰æ‹©å¼‚å¸¸: " + t.getMessage());
    }
  }

  // ========== æ‚¬æµ®çª—åŠŸèƒ½ ==========
private void hookActivityLifecycle(ClassLoader classLoader) {
    try {
        XposedHelpers.findAndHookMethod(
            "android.app.Activity",
            classLoader,
            "onCreate",
            Bundle.class,
            new XC_MethodHook() {
                @Override
                protected void afterHookedMethod(MethodHookParam param) {
                    try {
                        final Activity activity = (Activity) param.thisObject;
                        final String activityName = activity.getClass().getName();

                        if (activityName.contains("com.android") ||
                            activityName.contains("android.support") ||
                            activityName.contains("androidx.")) {
                            return;
                        }

                        // åŠ è½½æ‚¬æµ®çª—è°ƒç”¨
                        floatingShownMap.put(currentTargetApp, true);
                        
                        new Handler(Looper.getMainLooper()).postDelayed(
                            new Runnable() {
                                @Override
                                public void run() {
                                    try {
                                        showFloatingView(activity);
                                    } catch (Throwable t) {
                                        log("æ˜¾ç¤ºæ‚¬æµ®çª—å¼‚å¸¸: " + t.getMessage());
                                    }
                                }
                            },
                            850
                        );
                    } catch (Throwable t) {
                        log("Activityç”Ÿå‘½å‘¨æœŸHookå¼‚å¸¸: " + t.getMessage());
                    }
                }
            }
        );
        
        // ç›´æ¥é€šè¿‡ Hook onResume å’Œ onPause æ¥è¿½è¸ªå½“å‰Activity
        XposedHelpers.findAndHookMethod(
            "android.app.Activity",
            classLoader,
            "onResume",
            new XC_MethodHook() {
                @Override
                protected void afterHookedMethod(MethodHookParam param) {
                    currentResumedActivity = (Activity) param.thisObject;
                    log("å½“å‰Activity: " + currentResumedActivity.getClass().getName());
                }
            }
        );
        
        XposedHelpers.findAndHookMethod(
            "android.app.Activity",
            classLoader,
            "onPause",
            new XC_MethodHook() {
                @Override
                protected void afterHookedMethod(MethodHookParam param) {
                    if (currentResumedActivity == param.thisObject) {
                        currentResumedActivity = null;
                    }
                }
            }
        );
        
        XposedHelpers.findAndHookMethod(
            "android.app.Activity",
            classLoader,
            "onDestroy",
            new XC_MethodHook() {
                @Override
                protected void afterHookedMethod(MethodHookParam param) {
                    if (currentResumedActivity == param.thisObject) {
                        currentResumedActivity = null;
                    }
                }
            }
        );
        
        //log("âœ… Activityè¿½è¸ªHookå®Œæˆ");
        
    } catch (Throwable t) {
        log("Hook Activityç”Ÿå‘½å‘¨æœŸå¼‚å¸¸: " + t.getMessage());
    }
}

// å®Œå–„ getCurrentActivity æ–¹æ³•
private Activity getCurrentActivity() {
    // è¿”å›å½“å‰è¿½è¸ªçš„Activity
    if (currentResumedActivity != null && 
        !currentResumedActivity.isFinishing() && 
        !currentResumedActivity.isDestroyed()) {
        return currentResumedActivity;
    }
    return null;
}

  // å®Œæ•´çš„ showFloatingView æ–¹æ³•
  private void showFloatingView(final Activity activity) {
    try {
      Boolean shouldShow = floatingShownMap.get(currentTargetApp);
      if (shouldShow == null || !shouldShow) {
        return;
      }
      activity.runOnUiThread(
        new Runnable() {
          @Override
          public void run() {
            try {
              View existingView = activity
                .getWindow()
                .getDecorView()
                .findViewWithTag("install_fake_floating");
              if (existingView != null) {
                return;
              }
              if (activity.isFinishing() || activity.isDestroyed()) {
                return;
              }
              final TextView floatingView = createFloatingView(activity);
              if (floatingView == null) {
                return;
              }
              final ViewGroup decorView = (ViewGroup) activity
                .getWindow()
                .getDecorView();
              if (decorView == null) {
                return;
              }
              ViewGroup.LayoutParams params = new ViewGroup.LayoutParams(
                ViewGroup.LayoutParams.WRAP_CONTENT,
                ViewGroup.LayoutParams.WRAP_CONTENT
              );
              decorView.addView(floatingView, params);
              floatingView.post(
                new Runnable() {
                  @Override
                  public void run() {
                    try {
                      Float savedX = floatingXMap.get(currentTargetApp);
                      Float savedY = floatingYMap.get(currentTargetApp);
                      int screenWidth = decorView.getWidth();
                      int screenHeight = decorView.getHeight();
                      int viewWidth = floatingView.getWidth();
                      int viewHeight = floatingView.getHeight();
                      if (viewWidth == 0) viewWidth = 200;
                      if (viewHeight == 0) viewHeight = 80;
                      float x, y;
                      if (
                        savedX != null &&
                        savedY != null &&
                        savedX >= 0 &&
                        savedY >= 0
                      ) {
                        x = savedX;
                        y = savedY;
                      } else {
                        x = screenWidth - viewWidth - 50;
                        y = 200;
                      }
                      if (screenWidth > 0 && screenHeight > 0) {
                        x = Math.max(
                          10,
                          Math.min(x, screenWidth - viewWidth - 10)
                        );
                        y = Math.max(
                          50,
                          Math.min(y, screenHeight - viewHeight - 100)
                        );
                      }
                      floatingView.setX(x);
                      floatingView.setY(y);
                      floatingXMap.put(currentTargetApp, x);
                      floatingYMap.put(currentTargetApp, y);
                    } catch (Throwable t) {
                      log("è®¾ç½®ä½ç½®å¼‚å¸¸: " + t.getMessage());
                    }
                  }
                }
              );
              // ç½®é¡¶é€»è¾‘-é¡¶å±‚æ˜¾ç¤ºï¼‰
              updateFloatingToTop(activity, floatingView, decorView);
              startå®šæ—¶ç½®é¡¶(activity, decorView);
              hookå¼¹çª—ç›¸å…³æ–¹æ³•(activity, decorView);
            } catch (Throwable t) {
              log("æ·»åŠ æ‚¬æµ®çª—å¼‚å¸¸: " + t.getMessage());
            }
          }
        }
      );
    } catch (Throwable t) {
      log("æ˜¾ç¤ºæ‚¬æµ®çª—å¼‚å¸¸: " + t.getMessage());
    }
  }

  //æ›´æ–°æ‚¬æµ®çª—ç½®é¡¶
  private void updateFloatingToTop(
    Activity activity,
    TextView floatingView,
    ViewGroup decorView
  ) {
    if (activity.isFinishing() || floatingView == null || decorView == null) {
      return;
    }
    // å¼ºåˆ¶ç½®é¡¶ï¼ˆAndroidæ‰€æœ‰ç‰ˆæœ¬å…¼å®¹ï¼‰
    floatingView.bringToFront();
    decorView.updateViewLayout(floatingView, floatingView.getLayoutParams());
    // æå‡å±‚çº§ï¼ˆå…¼å®¹éƒ¨åˆ†å¼¹çª—ï¼‰
    floatingView.setElevation(9999f);
  }

  //å®šæ—¶ç½®é¡¶
  private void startå®šæ—¶ç½®é¡¶(
    final Activity activity,
    final ViewGroup decorView
  ) {
    // åœæ­¢åŸæœ‰å®šæ—¶ä»»åŠ¡
    stopå®šæ—¶ç½®é¡¶();

    floatingTopHandler = new Handler(Looper.getMainLooper());
    // æ¯300msç½®é¡¶ä¸€æ¬¡
    floatingTopHandler.postDelayed(
      new Runnable() {
        @Override
        public void run() {
          try {
            if (activity.isFinishing() || currentFloatingView == null) {
              stopå®šæ—¶ç½®é¡¶();
              return;
            }
            // æ‰§è¡Œç½®é¡¶
            updateFloatingToTop(activity, currentFloatingView, decorView);
            // å¾ªç¯æ‰§è¡Œ
            floatingTopHandler.postDelayed(this, 300);
          } catch (Throwable t) {
            log("å®šæ—¶ç½®é¡¶å¼‚å¸¸ï¼š" + t.getMessage());
          }
        }
      },
      300
    );
  }

  //åœæ­¢å®šæ—¶ç½®é¡¶
  private void stopå®šæ—¶ç½®é¡¶() {
    if (floatingTopHandler != null) {
      floatingTopHandler.removeCallbacksAndMessages(null);
      floatingTopHandler = null;
    }
  }

  // Hookå¼¹çª—ç›¸å…³æ–¹æ³•
  private void hookå¼¹çª—ç›¸å…³æ–¹æ³•(
    final Activity activity,
    final ViewGroup decorView
  ) {
    try {
      // Hook AlertDialog.show()
      Class<?> alertDialogClass = Class.forName("android.app.AlertDialog");
      XposedHelpers.findAndHookMethod(
        alertDialogClass,
        "show",
        new XC_MethodHook() {
          @Override
          protected void afterHookedMethod(MethodHookParam param)
            throws Throwable {
            // å¼¹çª—æ˜¾ç¤ºåï¼Œæ‚¬æµ®çª—ç½®é¡¶
            activity.runOnUiThread(
              new Runnable() {
                @Override
                public void run() {
                  if (currentFloatingView != null) {
                    updateFloatingToTop(
                      activity,
                      currentFloatingView,
                      decorView
                    );
                  }
                }
              }
            );
          }
        }
      );

      // Hook DialogFragment.show()
      hookDialogFragmentShow(
        "androidx.fragment.app.DialogFragment",
        activity,
        decorView
      );
      hookDialogFragmentShow("android.app.DialogFragment", activity, decorView);
    } catch (ClassNotFoundException e) {
      //  log("Hookå¼¹çª—æ–¹æ³•å¤±è´¥ï¼šæœªæ‰¾åˆ°å¯¹åº”ç±»");
    } catch (Throwable t) {
      //    log("Hookå¼¹çª—æ–¹æ³•å¼‚å¸¸ï¼š" + t.getMessage());
    }
  }

  // Hook DialogFragment.show
  private void hookDialogFragmentShow(
    String dialogFragmentClassName,
    final Activity activity,
    final ViewGroup decorView
  ) {
    try {
      Class<?> dialogFragmentClass = Class.forName(dialogFragmentClassName);
      // Hook showæ–¹æ³•
      try {
        XposedHelpers.findAndHookMethod(
          dialogFragmentClass,
          "show",
          Class.forName("androidx.fragment.app.FragmentManager"),
          String.class,
          new XC_MethodHook() {
            @Override
            protected void afterHookedMethod(MethodHookParam param)
              throws Throwable {
              activity.runOnUiThread(
                new Runnable() {
                  @Override
                  public void run() {
                    if (currentFloatingView != null) {
                      updateFloatingToTop(
                        activity,
                        currentFloatingView,
                        decorView
                      );
                    }
                  }
                }
              );
            }
          }
        );
      } catch (NoSuchMethodError e) {
        // å…¼å®¹åŸç”ŸFragmentManager
        XposedHelpers.findAndHookMethod(
          dialogFragmentClass,
          "show",
          Class.forName("android.app.FragmentManager"),
          String.class,
          new XC_MethodHook() {
            @Override
            protected void afterHookedMethod(MethodHookParam param)
              throws Throwable {
              activity.runOnUiThread(
                new Runnable() {
                  @Override
                  public void run() {
                    if (currentFloatingView != null) {
                      updateFloatingToTop(
                        activity,
                        currentFloatingView,
                        decorView
                      );
                    }
                  }
                }
              );
            }
          }
        );
      }
    } catch (ClassNotFoundException | NoSuchMethodError e) {
      // å¿½ç•¥æ— å¯¹åº”ç±»/æ–¹æ³•çš„æƒ…å†µ
    } catch (Throwable t) {
      log("Hook DialogFragmentå¤±è´¥ï¼š" + t.getMessage());
    }
  }

// å¼¹å‡ºæ·»åŠ è‡ªå®šä¹‰åŒ…åå¯¹è¯æ¡†ï¼ˆæœ€ç»ˆç‰ˆï¼šä¿®å¤æç¤ºä¸æ˜¾ç¤º+æ‰¹é‡è¾“å…¥+å…¨å…¼å®¹ï¼‰
private void showAddPackageDialog(final Activity activity) {
  try {
    // æ‰€æœ‰åŒ¿åç±»å¼•ç”¨å˜é‡å£°æ˜ä¸ºfinalï¼Œè§£å†³éfinalæŠ¥é”™
    final String targetApp = currentTargetApp;
    if (!userDefinedPackagesMap.containsKey(targetApp)) {
      userDefinedPackagesMap.put(targetApp, new ArrayList<>());
    }
    final List<String> userPackages = userDefinedPackagesMap.get(targetApp);
    final DisplayMetrics metrics = new DisplayMetrics();
    activity.getWindowManager().getDefaultDisplay().getMetrics(metrics);
    final LinearLayout[] packagesLayoutArr = new LinearLayout[1];
    final EditText[] inputEtArr = new EditText[1];
    
    // 1. é¡¶éƒ¨ï¼šè¾“å…¥æ¡† + ä¸‹æ‹‰é€‰æ‹© + æ·»åŠ æŒ‰é’® æ¨ªå‘å¸ƒå±€ï¼ˆä¿æŒåŸæœ‰é€»è¾‘ä¸å˜ï¼‰
    LinearLayout topLayout = new LinearLayout(activity);
    topLayout.setOrientation(LinearLayout.HORIZONTAL);
    topLayout.setPadding(0, 0, 0, 20); // å¢åŠ åº•éƒ¨å†…è¾¹è·ï¼Œä¸ä¸‹æ–¹åˆ—è¡¨åˆ†éš”
    
    // ========== è¾“å…¥æ¡†ä¼˜åŒ–ï¼ˆä¿æŒåŸæœ‰é€»è¾‘ä¸å˜ï¼‰ ==========
    final EditText inputEt = new EditText(activity);
    inputEt.setHint("è¾“å…¥åŒ…å\n(å¦‚com.a.b.c)");
    inputEt.setPadding(30, 20, 30, 20);
    inputEt.setTextColor(0xFF000000);
    inputEt.setBackgroundColor(0xFFFFFFFF);
    inputEt.setHintTextColor(0xFF999999);
    inputEt.setBackgroundTintMode(null);
    inputEt.setOutlineProvider(null);
    try {
        Class<?> gradientDrawableClass = Class.forName("android.graphics.drawable.GradientDrawable");
        Object etDrawable = gradientDrawableClass.newInstance();
        Method setColorMethod = gradientDrawableClass.getDeclaredMethod("setColor", int.class);
        Method setCornerRadiusMethod = gradientDrawableClass.getDeclaredMethod("setCornerRadius", float.class);
        Method setStrokeMethod = gradientDrawableClass.getDeclaredMethod("setStroke", int.class, int.class);
        
        setColorMethod.invoke(etDrawable, 0xFFFFFFFF);
        setCornerRadiusMethod.invoke(etDrawable, 25f);
        setStrokeMethod.invoke(etDrawable, 2, 0xFFE0E0E0); 
        
        if (Build.VERSION.SDK_INT >= Build.VERSION_CODES.JELLY_BEAN) {
            inputEt.setBackground((android.graphics.drawable.Drawable) etDrawable);
        } else {
            inputEt.setBackgroundDrawable((android.graphics.drawable.Drawable) etDrawable);
        }
    } catch (Exception e) {
        android.graphics.drawable.ShapeDrawable etShape = new android.graphics.drawable.ShapeDrawable();
        etShape.setShape(new android.graphics.drawable.shapes.RoundRectShape(
            new float[]{25f, 25f, 25f, 25f, 25f, 25f, 25f, 25f},
            null, null
        ));
        etShape.getPaint().setColor(0xFFFFFFFF);
        if (Build.VERSION.SDK_INT >= Build.VERSION_CODES.JELLY_BEAN) {
            inputEt.setBackground(etShape);
        } else {
            inputEt.setBackgroundDrawable(etShape);
        }
    }
    LinearLayout.LayoutParams etParams = new LinearLayout.LayoutParams(
        0,
        LinearLayout.LayoutParams.WRAP_CONTENT,
        1
    );
    topLayout.addView(inputEt, etParams);
    inputEtArr[0] = inputEt;
    
    // ========== Spinnerä¼˜åŒ–ï¼ˆä¿æŒåŸæœ‰é€»è¾‘ä¸å˜ï¼‰ ==========
    final Spinner typeSpinner = new Spinner(activity);
    List<String> spinnerItems = new ArrayList<>();
    spinnerItems.add("â—€ æ·»åŠ ä¼ªé€ ");
    spinnerItems.add("â—€ æ’é™¤ä¼ªé€ ");
    ArrayAdapter<String> spinnerAdapter = new ArrayAdapter<String>(activity, android.R.layout.simple_spinner_item, spinnerItems) {
        @Override
        public View getView(int position, View convertView, ViewGroup parent) {
            View view = super.getView(position, convertView, parent);
            TextView tv = (TextView) view;
            tv.setTextColor(0xFF000000);
            tv.setTextSize(14);
            tv.setGravity(Gravity.CENTER);
            tv.setPadding(40, 20, 40, 20);
            return view;
        }
        @Override
        public View getDropDownView(int position, View convertView, ViewGroup parent) {
            View view = super.getDropDownView(position, convertView, parent);
            TextView tv = (TextView) view;
            tv.setTextColor(0xFF000000);
            tv.setTextSize(18);
            tv.setGravity(Gravity.CENTER_VERTICAL);
            tv.setPadding(20, 30, 20, 30);
            tv.setBackgroundResource(android.R.drawable.list_selector_background);
            return view;
        }
    };
    spinnerAdapter.setDropDownViewResource(android.R.layout.simple_spinner_dropdown_item);
    typeSpinner.setAdapter(spinnerAdapter);
    typeSpinner.setSelection(0);
    try {
        Class<?> gradientDrawableClass = Class.forName("android.graphics.drawable.GradientDrawable");
        Object spinnerDrawable = gradientDrawableClass.newInstance();
        Method setColorMethod = gradientDrawableClass.getDeclaredMethod("setColor", int.class);
        Method setCornerRadiusMethod = gradientDrawableClass.getDeclaredMethod("setCornerRadius", float.class);
        Method setStrokeMethod = gradientDrawableClass.getDeclaredMethod("setStroke", int.class, int.class);
        
        setColorMethod.invoke(spinnerDrawable, 0xFFF5F5F5);
        setCornerRadiusMethod.invoke(spinnerDrawable, 25f);
        setStrokeMethod.invoke(spinnerDrawable, 2, 0xFFE0E0E0);
        
        if (Build.VERSION.SDK_INT >= Build.VERSION_CODES.JELLY_BEAN) {
            typeSpinner.setBackground((android.graphics.drawable.Drawable) spinnerDrawable);
        } else {
            typeSpinner.setBackgroundDrawable((android.graphics.drawable.Drawable) spinnerDrawable);
        }
    } catch (Exception e) {
        android.graphics.drawable.ShapeDrawable shapeDrawable = new android.graphics.drawable.ShapeDrawable();
        shapeDrawable.setShape(new android.graphics.drawable.shapes.RoundRectShape(
            new float[]{25f, 25f, 25f, 25f, 25f, 25f, 25f, 25f},
            null, null
        ));
        shapeDrawable.getPaint().setColor(0xFFF5F5F5);
        if (Build.VERSION.SDK_INT >= Build.VERSION_CODES.JELLY_BEAN) {
            typeSpinner.setBackground(shapeDrawable);
        } else {
            typeSpinner.setBackgroundDrawable(shapeDrawable);
        }
    }
    typeSpinner.setPadding(40, 20, 20, 20);
    LinearLayout.LayoutParams spinnerParams = new LinearLayout.LayoutParams(
        LinearLayout.LayoutParams.WRAP_CONTENT,
        LinearLayout.LayoutParams.WRAP_CONTENT
    );
    spinnerParams.leftMargin = 10;
    spinnerParams.width = (int) (activity.getResources().getDisplayMetrics().density * 150);
    topLayout.addView(typeSpinner, spinnerParams);
    
    // ========== æ·»åŠ æŒ‰é’®ï¼ˆä¿æŒåŸæœ‰é€»è¾‘ä¸å˜ï¼‰ ==========
    Button addBtn = new Button(activity);
    addBtn.setText("æ·»åŠ ");
    addBtn.setPadding(40, 20, 40, 20);
    addBtn.setTextColor(0xFFFFFFFF);
    addBtn.setBackgroundTintMode(null);
    addBtn.setOutlineProvider(null);
    try {
      Class<?> gradientDrawableClass = Class.forName("android.graphics.drawable.GradientDrawable");
      Object addBtnDrawable = gradientDrawableClass.newInstance();
      Method setColorMethod = gradientDrawableClass.getDeclaredMethod("setColor", int.class);
      Method setCornerRadiusMethod = gradientDrawableClass.getDeclaredMethod("setCornerRadius", float.class);
      setColorMethod.invoke(addBtnDrawable, 0xAA4CAF50);
      setCornerRadiusMethod.invoke(addBtnDrawable, 25f);
      if (Build.VERSION.SDK_INT >= Build.VERSION_CODES.JELLY_BEAN) {
        addBtn.setBackground((android.graphics.drawable.Drawable) addBtnDrawable);
      } else {
        addBtn.setBackgroundDrawable((android.graphics.drawable.Drawable) addBtnDrawable);
      }
    } catch (Exception e) {
      android.graphics.drawable.ShapeDrawable shapeDrawable = new android.graphics.drawable.ShapeDrawable();
      shapeDrawable.setShape(new android.graphics.drawable.shapes.RoundRectShape(
        new float[] { 25f, 25f, 25f, 25f, 25f, 25f, 25f, 25f },
        null,
        null
      ));
      shapeDrawable.getPaint().setColor(0xAA4CAF50);
      if (Build.VERSION.SDK_INT >= Build.VERSION_CODES.JELLY_BEAN) {
        addBtn.setBackground(shapeDrawable);
      } else {
        addBtn.setBackgroundDrawable(shapeDrawable);
      }
    }
    LinearLayout.LayoutParams btnParams = new LinearLayout.LayoutParams(
      LinearLayout.LayoutParams.WRAP_CONTENT,
      LinearLayout.LayoutParams.WRAP_CONTENT
    );
    btnParams.leftMargin = 15;
    topLayout.addView(addBtn, btnParams);
    
    // 2. ä¸­é—´ï¼šåŒ…ååˆ—è¡¨ï¼ˆé‡ç‚¹ä¿®å¤æç¤ºæ˜¾ç¤ºé—®é¢˜ï¼‰
    final int maxScrollHeight = (int) (metrics.heightPixels * 0.5);
    ScrollView adaptiveScrollView = new ScrollView(activity) {
      @Override
      protected void onMeasure(int widthMeasureSpec, int heightMeasureSpec) {
        heightMeasureSpec = MeasureSpec.makeMeasureSpec(
          maxScrollHeight,
          MeasureSpec.AT_MOST
        );
        super.onMeasure(widthMeasureSpec, heightMeasureSpec);
      }
    };
    adaptiveScrollView.setPadding(0, 0, 0, 0);
    // åŒ…ååˆ—è¡¨å®¹å™¨ï¼ˆå…³é”®ä¿®å¤ï¼šè®¾ç½®èƒŒæ™¯è‰²+å¼ºåˆ¶å‚ç›´æ’åˆ—ï¼‰
    final LinearLayout packagesLayout = new LinearLayout(activity);
    packagesLayout.setOrientation(LinearLayout.VERTICAL);
    packagesLayout.setBackgroundColor(0xFFFFFFFF); // ç™½è‰²èƒŒæ™¯ï¼Œé¿å…é€æ˜è¦†ç›–
    packagesLayout.setPadding(10, 10, 10, 10); // æ•´ä½“å†…è¾¹è·
    adaptiveScrollView.addView(packagesLayout);
    packagesLayoutArr[0] = packagesLayout;

    // åŸæœ‰æç¤ºæ–‡æœ¬ï¼ˆå¼ºåŒ–æ ·å¼ï¼‰
    TextView tipTv = new TextView(activity);
    tipTv.setText("è¯·å‡†ç¡®è¾“å…¥éœ€è¦ä¼ªé€ çš„åŒ…å,å¦åˆ™ä¼ªé€ å¤±æ•ˆ\næ‰¹é‡è¾“å…¥:ä¸€è¡Œä¸€ä¸ªæ¢è¡Œæˆ–ä¸­è‹±æ–‡(é€—å·åˆ†å·)");
    tipTv.setPadding(30, 20, 30, 10); // å¢å¤§ä¸Šä¸‹å†…è¾¹è·
    tipTv.setTextSize(12); // æ”¾å¤§æ–‡å­—
    tipTv.setTextColor(0xFFFF5722); // æ©™è‰²ï¼Œé†’ç›®
    packagesLayout.addView(tipTv);
    packagesLayout.requestLayout(); // å¼ºåˆ¶åˆ·æ–°
/*
    // æ‰¹é‡è¾“å…¥æç¤ºæ–‡æœ¬ï¼ˆå¼ºåŒ–æ ·å¼ï¼‰
    TextView batchTipTv = new TextView(activity);
    batchTipTv.setText("æ‰¹é‡è¾“å…¥æ”¯æŒï¼šæ¢è¡Œã€è‹±æ–‡é€—å·(,)ã€ä¸­æ–‡é€—å·ï¼ˆï¼Œï¼‰ã€è‹±æ–‡åˆ†å·(;)ã€ä¸­æ–‡åˆ†å·ï¼ˆï¼›ï¼‰");
    batchTipTv.setPadding(30, 10, 30, 20); // å¢å¤§ä¸Šä¸‹å†…è¾¹è·
    batchTipTv.setTextSize(11); // æ”¾å¤§æ–‡å­—
    batchTipTv.setTextColor(0xFF2196F3); // è“è‰²ï¼Œè¾¨è¯†åº¦é«˜
    batchTipTv.setGravity(Gravity.START);
    packagesLayout.addView(batchTipTv);
    packagesLayout.requestLayout(); // å¼ºåˆ¶åˆ·æ–°
*/
    // å»¶è¿Ÿåˆ·æ–°åŒ…ååˆ—è¡¨ï¼Œç¡®ä¿æç¤ºå…ˆæ˜¾ç¤º
    new Handler(Looper.getMainLooper()).postDelayed(new Runnable() {
      @Override
      public void run() {
        refreshPackagesLayout(packagesLayout, userPackages, activity);
        packagesLayout.requestLayout(); // æœ€ç»ˆåˆ·æ–°
      }
    }, 100);
    
    // 3. å¯¹è¯æ¡†æ€»å¸ƒå±€ï¼ˆä¿æŒåŸæœ‰é€»è¾‘ï¼Œå¢åŠ æ•´ä½“å†…è¾¹è·ï¼‰
    LinearLayout totalLayout = new LinearLayout(activity);
    totalLayout.setOrientation(LinearLayout.VERTICAL);
    totalLayout.setPadding(20, 20, 20, 20); // å¢å¤§æ•´ä½“å†…è¾¹è·
    totalLayout.setBackgroundColor(0xFFFFFFFF); // æ€»å¸ƒå±€èƒŒæ™¯è‰²
    totalLayout.addView(topLayout);
    totalLayout.addView(
      adaptiveScrollView,
      new LinearLayout.LayoutParams(
        LinearLayout.LayoutParams.MATCH_PARENT,
        LinearLayout.LayoutParams.WRAP_CONTENT
      )
    );
    
    // 4. æ„å»ºå¯¹è¯æ¡†ï¼ˆä¿æŒåŸæœ‰é€»è¾‘ä¸å˜ï¼‰
    final AlertDialog dialog = createBoundedDialog(
      activity,
      "æ·»åŠ è‡ªå®šä¹‰åŒ…å",
      "",
      new String[] { "ä¸€é”®æ¸…ç©º", "ä¿å­˜", "å–æ¶ˆ" },
      new DialogInterface.OnClickListener[] {
        new DialogInterface.OnClickListener() {
          @Override
          public void onClick(DialogInterface dialogInterface, int which) {
            if (userPackages == null || userPackages.isEmpty()) {
              Toast.makeText(activity, "å½“å‰æ— å·²æ·»åŠ åŒ…åï¼Œæ— éœ€æ¸…ç©º", Toast.LENGTH_SHORT).show();
              return;
            }
            AlertDialog confirmDialog = createBoundedDialog(
              activity,
              "ç¡®è®¤æ¸…ç©º",
              "ç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰æ‰‹åŠ¨æ·»åŠ çš„åŒ…åå—ï¼Ÿ<br><br><font color='#F44336'>æ­¤æ“ä½œä¸å¯æ¢å¤ï¼</font>",
              new String[] { "ç¡®è®¤æ¸…ç©º", "å–æ¶ˆ" },
              new DialogInterface.OnClickListener[] {
                new DialogInterface.OnClickListener() {
                  @Override
                  public void onClick(DialogInterface d, int which) {
                    userPackages.clear();
                    excludedPackagesMap.put(targetApp, new ArrayList<>());
                    synchronized (globalCapturedPackages) {
                      globalCapturedPackages.removeAll(userDefinedPackagesMap.get(targetApp));
                    }
                    refreshPackagesLayout(packagesLayoutArr[0], userPackages, activity);
                    Toast.makeText(activity, "âœ… å·²æ¸…ç©ºæ‰€æœ‰æ‰‹åŠ¨æ·»åŠ çš„åŒ…å", Toast.LENGTH_SHORT).show();
                    d.dismiss();
                  }
                },
                new DialogInterface.OnClickListener() {
                  @Override
                  public void onClick(DialogInterface d, int which) {
                    d.dismiss();
                  }
                },
              }
            );
            confirmDialog.show();
          }
        },
        new DialogInterface.OnClickListener() {
          @Override
          public void onClick(DialogInterface dialogInterface, int which) {
            if (userPackages == null || userPackages.isEmpty()) {
              Toast.makeText(activity, "å½“å‰æ— å·²æ·»åŠ åŒ…åï¼Œæ— éœ€ä¿å­˜", Toast.LENGTH_SHORT).show();
              return;
            }
            saveConfigToFile();
            Toast.makeText(activity, "é…ç½®å·²ä¿å­˜", Toast.LENGTH_SHORT).show();
            dialogInterface.dismiss();
          }
        },
        new DialogInterface.OnClickListener() {
          @Override
          public void onClick(DialogInterface dialogInterface, int which) {
            dialogInterface.dismiss();
          }
        },
      },
      totalLayout
    );
    
    // å¯¹è¯æ¡†æ˜¾ç¤ºä¼˜åŒ–ï¼ˆå¼ºåˆ¶è®¾ç½®å¸ƒå±€å‚æ•°ï¼‰
    dialog.setOnShowListener(new DialogInterface.OnShowListener() {
      @Override
      public void onShow(DialogInterface dialogInterface) {
        final Window window = dialog.getWindow();
        if (window != null) {
          WindowManager.LayoutParams params = window.getAttributes();
          params.height = WindowManager.LayoutParams.WRAP_CONTENT;
          params.width = WindowManager.LayoutParams.MATCH_PARENT;
          params.gravity = Gravity.CENTER;
          window.setAttributes(params);
          // å¼ºåˆ¶åˆ·æ–°å¯¹è¯æ¡†å¸ƒå±€
          window.getDecorView().requestLayout();
        }
      }
    });
    
    // 5. æ·»åŠ æŒ‰é’®ç‚¹å‡»äº‹ä»¶ï¼ˆä¿æŒæ‰¹é‡è¾“å…¥é€»è¾‘ä¸å˜ï¼‰
    addBtn.setOnClickListener(
      new View.OnClickListener() {
        @Override
        public void onClick(View v) {
          final String input = inputEt.getText().toString().trim();
          if (input.isEmpty()) {
            Toast.makeText(activity, "è¯·è¾“å…¥æœ‰æ•ˆåŒ…å", Toast.LENGTH_SHORT).show();
            return;
          }

          Set<String> pkgSet = new HashSet<>();
          String[] splits = input.split("[\\n,ï¼Œ;ï¼›]+");
          for (String pkg : splits) {
            String trimmedPkg = pkg.trim();
            if (!trimmedPkg.isEmpty() && isValidPackageName(trimmedPkg)) {
              pkgSet.add(trimmedPkg);
            }
          }

          final List<String> pkgList = new ArrayList<>(pkgSet);
          if (pkgList.isEmpty()) {
            Toast.makeText(activity, "æœªè¯†åˆ«åˆ°æœ‰æ•ˆåŒ…å", Toast.LENGTH_SHORT).show();
            return;
          }

          if (input.contains(" ")) {
            AlertDialog spaceDialog = createBoundedDialog(
              activity,
              "æ£€æµ‹åˆ°ç©ºæ ¼",
              "",
              new String[] { "å»é™¤ç©ºæ ¼", "å¼ºåˆ¶æ·»åŠ " },
              
              new DialogInterface.OnClickListener[] {
                new DialogInterface.OnClickListener() {
                  @Override
                  public void onClick(DialogInterface d, int which) {
                    List<String> processedList = new ArrayList<>();
                    for (String pkg : pkgList) {
                      processedList.add(pkg.replaceAll(" ", ""));
                    }
                    Set<String> processedSet = new HashSet<>(processedList);
                    processedList = new ArrayList<>(processedSet);
                    int selectedType = typeSpinner.getSelectedItemPosition();
                    batchHandlePackageAdd(processedList, userPackages, packagesLayout, activity, selectedType);
                    inputEt.setText("");
                  }
                },
                new DialogInterface.OnClickListener() {
                  @Override
                  public void onClick(DialogInterface d, int which) {
                    int selectedType = typeSpinner.getSelectedItemPosition();
                    batchHandlePackageAdd(pkgList, userPackages, packagesLayout, activity, selectedType);
                    inputEt.setText("");
                  }
                },
              }
            );
            
            spaceDialog.setMessage(Html.fromHtml(
        "åŒ…ååŒ…å«ç©ºæ ¼å¯èƒ½å¯¼è‡´ä¼ªé€ å¤±æ•ˆï¼Œæ˜¯å¦å»é™¤æ‰€æœ‰ç©ºæ ¼ï¼Ÿ<br><br>" +
        "å°†æ·»åŠ  <font color='#FF5722'><b>" + pkgList.size() + "</b></font> ä¸ªåŒ…åã€‚"
    ));
            spaceDialog.show();
            return;
          }

          int selectedType = typeSpinner.getSelectedItemPosition();
          batchHandlePackageAdd(pkgList, userPackages, packagesLayout, activity, selectedType);
          inputEt.setText("");
        }
      }
    );
    
    dialog.show();
  } catch (Throwable t) {
    log("æ˜¾ç¤ºæ·»åŠ åŒ…åå¯¹è¯æ¡†å¼‚å¸¸: " + t.getMessage());
  }
}

// æ‰¹é‡å¤„ç†åŒ…åæ·»åŠ ï¼ˆä¿æŒåŸæœ‰é€»è¾‘ä¸å˜ï¼‰
private void batchHandlePackageAdd(List<String> pkgList, List<String> userPackages, LinearLayout packagesLayout, Activity activity, int selectedType) {
  int successCount = 0;
  synchronized (globalCapturedPackages) {
    List<String> excludedPackages = excludedPackagesMap.getOrDefault(currentTargetApp, new ArrayList<>());
    for (String pkg : pkgList) {
      if (pkg == null || pkg.isEmpty() || !isValidPackageName(pkg)) {
        continue;
      }
      if (userPackages.contains(pkg)) {
        continue;
      }

      if (selectedType == 0) {
        if (excludedPackages.contains(pkg)) {
          excludedPackages.remove(pkg);
        }
        userPackages.add(pkg);
        if (!globalCapturedPackages.contains(pkg)) {
          globalCapturedPackages.add(pkg);
        }
        successCount++;
      } else {
        if (globalCapturedPackages.contains(pkg)) {
          globalCapturedPackages.remove(pkg);
        }
        userPackages.add(pkg);
        excludedPackages.add(pkg);
        excludedPackagesMap.put(currentTargetApp, excludedPackages);
        successCount++;
      }
    }
  }

  refreshPackagesLayout(packagesLayout, userPackages, activity);
  Toast.makeText(
    activity,
    "å¤„ç†å®Œæˆï¼šæˆåŠŸæ·»åŠ  " + successCount + "/" + pkgList.size() + " ä¸ªåŒ…å",
    Toast.LENGTH_LONG
  ).show();
}




// è¾…åŠ©æ–¹æ³•ï¼šå¤„ç†åŒ…åæ·»åŠ ï¼ˆåŒºåˆ†ä¼ªé€ /æ’é™¤ï¼‰
private void handlePackageAdd(String pkg, List<String> userPackages, LinearLayout packagesLayout, Activity activity, int selectedType) {
  // 1. æ ¡éªŒåŒ…åæ ¼å¼
  if (pkg == null || pkg.isEmpty() || !isValidPackageName(pkg)) {
    Toast.makeText(activity, "åŒ…åæ ¼å¼æ— æ•ˆ", Toast.LENGTH_SHORT).show();
    return;
  }
  // 2. åŒæ­¥é”è¦†ç›–å…¨æµç¨‹ï¼ˆé¿å…å¹¶å‘å†²çªï¼‰
  synchronized (globalCapturedPackages) {
    // 3. é”å†…åŒé‡å»é‡æ ¡éªŒï¼ˆç”¨æˆ·åˆ—è¡¨ + å…¨å±€åˆ—è¡¨ï¼‰
    if (userPackages.contains(pkg)) {
      Toast.makeText(activity, "åŒ…åå·²å­˜åœ¨ï¼Œæ— éœ€é‡å¤æ·»åŠ ", Toast.LENGTH_SHORT).show();
      return;
    }
    // 4. æ ¹æ®é€‰æ‹©ç±»å‹å¤„ç†
    List<String> excludedPackages = excludedPackagesMap.getOrDefault(currentTargetApp, new ArrayList<>());
    if (selectedType == 0) { // æ·»åŠ ä¼ªé€ 
      if (excludedPackages.contains(pkg)) {
        excludedPackages.remove(pkg); // ä»æ’é™¤åˆ—è¡¨ç§»é™¤ï¼Œé¿å…å†²çª
      }
      userPackages.add(pkg);
      if (!globalCapturedPackages.contains(pkg)) {
        globalCapturedPackages.add(pkg);
      }
      Toast.makeText(activity, "å·²æ·»åŠ ä¼ªé€ åŒ…åï¼š" + pkg, Toast.LENGTH_SHORT).show();
    } else { // æ’é™¤ä¼ªé€ 
      if (globalCapturedPackages.contains(pkg)) {
        globalCapturedPackages.remove(pkg); // ä»å…¨å±€æ•è·åˆ—è¡¨ç§»é™¤
      }
      userPackages.add(pkg);
      excludedPackages.add(pkg);
      excludedPackagesMap.put(currentTargetApp, excludedPackages);
      Toast.makeText(activity, "å·²æ·»åŠ æ’é™¤åŒ…åï¼š" + pkg, Toast.LENGTH_SHORT).show();
    }
  }
  // 5. åˆ·æ–°åŒ…ååˆ—è¡¨æ˜¾ç¤º
  refreshPackagesLayout(packagesLayout, userPackages, activity);
}

// åˆ·æ–°åŒ…ååˆ—è¡¨ï¼ˆç´§å‡‘å¸ƒå±€ï¼ŒåŒºåˆ†ä¼ªé€ /æ’é™¤ï¼‰
private void refreshPackagesLayout(
  final LinearLayout packagesLayout,
  final List<String> userPackages,
  final Activity activity
) {
  // 1. ç§»é™¤åŸæœ‰æ‰€æœ‰å­è§†å›¾ï¼ˆä¿ç•™æç¤ºæ–‡æœ¬ï¼‰
  for (int i = packagesLayout.getChildCount() - 1; i >= 1; i--) {
    packagesLayout.removeViewAt(i);
  }

  // 2. åˆ†ç¦»ä¼ªé€ åŒ…åå’Œæ’é™¤åŒ…å
  List<String> fakePackages = new ArrayList<>(); // ä¼ªé€ åŒ…ååˆ—è¡¨
  List<String> excludePackages = new ArrayList<>(); // æ’é™¤åŒ…ååˆ—è¡¨
  List<String> excludedGlobal = excludedPackagesMap.getOrDefault(currentTargetApp, new ArrayList<>());
  
  for (String pkg : userPackages) {
    if (excludedGlobal.contains(pkg)) {
      excludePackages.add(pkg); // å±äºæ’é™¤åŒ…ï¼ŒåŠ å…¥æ’é™¤åˆ—è¡¨
    } else {
      fakePackages.add(pkg); // å±äºä¼ªé€ åŒ…ï¼ŒåŠ å…¥ä¼ªé€ åˆ—è¡¨
    }
  }

  // 3. æ˜¾ç¤ºä¼ªé€ åŒ…åï¼ˆä¸Šæ–¹åŒºåŸŸï¼‰
  if (!fakePackages.isEmpty()) {
    // ä¼ªé€ åŒ…æ ‡é¢˜
    TextView fakeTitle = new TextView(activity);
    fakeTitle.setText("ğŸ“Œ ä¼ªé€ åŒ…åï¼ˆ" + fakePackages.size() + "ä¸ªï¼‰");
    fakeTitle.setPadding(30, 15, 30, 10);
    fakeTitle.setTextSize(13);
    fakeTitle.setTextColor(0xFF4CAF50);
    packagesLayout.addView(fakeTitle);

    // æ¸²æŸ“ä¼ªé€ åŒ…åˆ—è¡¨
    for (int i = 0; i < fakePackages.size(); i++) {
      final int pos = userPackages.indexOf(fakePackages.get(i)); // åŸå§‹ç´¢å¼•ï¼ˆç”¨äºåˆ é™¤ï¼‰
      final String pkg = fakePackages.get(i);
      // åŒ…åé¡¹å¸ƒå±€
      LinearLayout itemLayout = new LinearLayout(activity);
      itemLayout.setOrientation(LinearLayout.HORIZONTAL);
      itemLayout.setPadding(30, 8, 30, 8);
      itemLayout.setGravity(Gravity.CENTER_VERTICAL);

      TextView pkgTv = new TextView(activity);
      pkgTv.setText((i + 1) + ". [ä¼ªé€ ] " + pkg); // ä¼ªé€ æ ‡ç­¾
      pkgTv.setPadding(0, 5, 0, 5);
      pkgTv.setTextSize(13);
      pkgTv.setSingleLine(false);
      pkgTv.setMaxLines(2);
      pkgTv.setEllipsize(android.text.TextUtils.TruncateAt.END);
      LinearLayout.LayoutParams pkgParams = new LinearLayout.LayoutParams(0, LinearLayout.LayoutParams.WRAP_CONTENT, 1);
      itemLayout.addView(pkgTv, pkgParams);

      // åˆ é™¤æŒ‰é’®
      Button delBtn = new Button(activity);
      delBtn.setText("åˆ é™¤");
      delBtn.setTextSize(11);
      delBtn.setPadding(20, 5, 20, 5);
      try {
        Class<?> gradientDrawableClass = Class.forName(
          "android.graphics.drawable.GradientDrawable"
        );
        Object delBtnDrawable = gradientDrawableClass.newInstance();
        Method setColorMethod = gradientDrawableClass.getMethod(
          "setColor",
          int.class
        );
        Method setCornerRadiusMethod = gradientDrawableClass.getMethod(
          "setCornerRadius",
          float.class
        );
        setColorMethod.invoke(delBtnDrawable, 0xAAF44336);
        setCornerRadiusMethod.invoke(delBtnDrawable, 25f);
        if (Build.VERSION.SDK_INT >= Build.VERSION_CODES.JELLY_BEAN) {
          delBtn.setBackground(
            (android.graphics.drawable.Drawable) delBtnDrawable
          );
        } else {
          delBtn.setBackgroundDrawable(
            (android.graphics.drawable.Drawable) delBtnDrawable
          );
        }
        delBtn.setTextColor(0xFFFFFFFF);
        delBtn.setBackgroundTintMode(null);
        delBtn.setOutlineProvider(null);
      } catch (Throwable e) {
        android.graphics.drawable.ShapeDrawable shapeDrawable =
          new android.graphics.drawable.ShapeDrawable();
        shapeDrawable.setShape(
          new android.graphics.drawable.shapes.RoundRectShape(
            new float[] { 25f, 25f, 25f, 25f, 25f, 25f, 25f, 25f },
            null,
            null
          )
        );
        shapeDrawable.getPaint().setColor(0xAAF44336);
        if (Build.VERSION.SDK_INT >= Build.VERSION_CODES.JELLY_BEAN) {
          delBtn.setBackground(shapeDrawable);
        } else {
          delBtn.setBackgroundDrawable(shapeDrawable);
        }
      }
      delBtn.setOnClickListener(new View.OnClickListener() {
        @Override
        public void onClick(View v) {
          userPackages.remove(pos);
          List<String> excludedGlobal = excludedPackagesMap.getOrDefault(currentTargetApp, new ArrayList<>());
          excludedGlobal.remove(pkg);
          excludedPackagesMap.put(currentTargetApp, excludedGlobal);
          synchronized (globalCapturedPackages) {
            globalCapturedPackages.remove(pkg);
          }
          refreshPackagesLayout(packagesLayout, userPackages, activity);
          Toast.makeText(activity, "å·²åˆ é™¤ä¼ªé€ åŒ…åï¼š" + pkg, Toast.LENGTH_SHORT).show();
        }
      });
      itemLayout.addView(delBtn);

      packagesLayout.addView(itemLayout);
      // åˆ†å‰²çº¿ï¼ˆä¼ªé€ åŒ…ä¹‹é—´ï¼‰
      if (i != fakePackages.size() - 1) {
        View divider = new View(activity);
        divider.setBackgroundColor(0xFFE0E0E0);
        LinearLayout.LayoutParams dividerParams = new LinearLayout.LayoutParams(LinearLayout.LayoutParams.MATCH_PARENT, 1);
        dividerParams.topMargin = 8;
        packagesLayout.addView(divider, dividerParams);
      }
    }
  }

  // 4. æ·»åŠ åˆ†å‰²çº¿ï¼ˆåŒºåˆ†ä¼ªé€ å’Œæ’é™¤åŒ…ï¼‰
  if (!fakePackages.isEmpty() && !excludePackages.isEmpty()) {
    View mainDivider = new View(activity);
    mainDivider.setBackgroundColor(0xFF999999);
    LinearLayout.LayoutParams dividerParams = new LinearLayout.LayoutParams(LinearLayout.LayoutParams.MATCH_PARENT, 2);
    dividerParams.topMargin = 15;
    dividerParams.bottomMargin = 15;
    packagesLayout.addView(mainDivider, dividerParams);
  }

  // 5. æ˜¾ç¤ºæ’é™¤åŒ…åï¼ˆä¸‹æ–¹åŒºåŸŸï¼‰
  if (!excludePackages.isEmpty()) {
    // æ’é™¤åŒ…æ ‡é¢˜
    TextView excludeTitle = new TextView(activity);
    excludeTitle.setText("âŒ æ’é™¤åŒ…åï¼ˆ" + excludePackages.size() + "ä¸ªï¼‰");
    excludeTitle.setPadding(30, 15, 30, 10);
    excludeTitle.setTextSize(13);
    excludeTitle.setTextColor(0xFFF44336);
    packagesLayout.addView(excludeTitle);

    // æ¸²æŸ“æ’é™¤åŒ…åˆ—è¡¨
    for (int i = 0; i < excludePackages.size(); i++) {
      final int pos = userPackages.indexOf(excludePackages.get(i)); // åŸå§‹ç´¢å¼•ï¼ˆç”¨äºåˆ é™¤ï¼‰
      final String pkg = excludePackages.get(i);
      // åŒ…åé¡¹å¸ƒå±€
      LinearLayout itemLayout = new LinearLayout(activity);
      itemLayout.setOrientation(LinearLayout.HORIZONTAL);
      itemLayout.setPadding(30, 8, 30, 8);
      itemLayout.setGravity(Gravity.CENTER_VERTICAL);

      TextView pkgTv = new TextView(activity);
      pkgTv.setText((i + 1) + ". [æ’é™¤] " + pkg); // æ’é™¤æ ‡ç­¾
      pkgTv.setPadding(0, 5, 0, 5);
      pkgTv.setTextSize(13);
      pkgTv.setSingleLine(false);
      pkgTv.setMaxLines(2);
      pkgTv.setEllipsize(android.text.TextUtils.TruncateAt.END);
      LinearLayout.LayoutParams pkgParams = new LinearLayout.LayoutParams(0, LinearLayout.LayoutParams.WRAP_CONTENT, 1);
      itemLayout.addView(pkgTv, pkgParams);

      // åˆ é™¤æŒ‰é’®
      Button delBtn = new Button(activity);
      delBtn.setText("åˆ é™¤");
      delBtn.setTextSize(11);
      delBtn.setPadding(20, 5, 20, 5);
      try {
        Class<?> gradientDrawableClass = Class.forName(
          "android.graphics.drawable.GradientDrawable"
        );
        Object delBtnDrawable = gradientDrawableClass.newInstance();
        Method setColorMethod = gradientDrawableClass.getMethod(
          "setColor",
          int.class
        );
        Method setCornerRadiusMethod = gradientDrawableClass.getMethod(
          "setCornerRadius",
          float.class
        );
        setColorMethod.invoke(delBtnDrawable, 0xAAF44336);
        setCornerRadiusMethod.invoke(delBtnDrawable, 25f);
        if (Build.VERSION.SDK_INT >= Build.VERSION_CODES.JELLY_BEAN) {
          delBtn.setBackground(
            (android.graphics.drawable.Drawable) delBtnDrawable
          );
        } else {
          delBtn.setBackgroundDrawable(
            (android.graphics.drawable.Drawable) delBtnDrawable
          );
        }
        delBtn.setTextColor(0xFFFFFFFF);
        delBtn.setBackgroundTintMode(null);
        delBtn.setOutlineProvider(null);
      } catch (Throwable e) {
        android.graphics.drawable.ShapeDrawable shapeDrawable =
          new android.graphics.drawable.ShapeDrawable();
        shapeDrawable.setShape(
          new android.graphics.drawable.shapes.RoundRectShape(
            new float[] { 25f, 25f, 25f, 25f, 25f, 25f, 25f, 25f },
            null,
            null
          )
        );
        shapeDrawable.getPaint().setColor(0xAAF44336);
        if (Build.VERSION.SDK_INT >= Build.VERSION_CODES.JELLY_BEAN) {
          delBtn.setBackground(shapeDrawable);
        } else {
          delBtn.setBackgroundDrawable(shapeDrawable);
        }
      }
      delBtn.setOnClickListener(new View.OnClickListener() {
        @Override
        public void onClick(View v) {
          userPackages.remove(pos);
          List<String> excludedGlobal = excludedPackagesMap.getOrDefault(currentTargetApp, new ArrayList<>());
          excludedGlobal.remove(pkg);
          excludedPackagesMap.put(currentTargetApp, excludedGlobal);
          synchronized (globalCapturedPackages) {
            globalCapturedPackages.remove(pkg);
          }
          refreshPackagesLayout(packagesLayout, userPackages, activity);
          Toast.makeText(activity, "å·²åˆ é™¤æ’é™¤åŒ…åï¼š" + pkg, Toast.LENGTH_SHORT).show();
        }
      });
      itemLayout.addView(delBtn);

      packagesLayout.addView(itemLayout);
      // åˆ†å‰²çº¿ï¼ˆæ’é™¤åŒ…ä¹‹é—´ï¼‰
      if (i != excludePackages.size() - 1) {
        View divider = new View(activity);
        divider.setBackgroundColor(0xFFE0E0E0);
        LinearLayout.LayoutParams dividerParams = new LinearLayout.LayoutParams(LinearLayout.LayoutParams.MATCH_PARENT, 1);
        dividerParams.topMargin = 8;
        packagesLayout.addView(divider, dividerParams);
      }
    }
  }

  // 6. ç©ºåˆ—è¡¨æç¤ºï¼ˆæ— ä¼ªé€ +æ— æ’é™¤åŒ…æ—¶ï¼‰
  if (fakePackages.isEmpty() && excludePackages.isEmpty()) {
    TextView emptyTv = new TextView(activity);
    emptyTv.setText("æš‚æ— å·²æ·»åŠ åŒ…å");
    emptyTv.setPadding(30, 15, 30, 15);
    emptyTv.setTextSize(12);
    packagesLayout.addView(emptyTv);
  }
}


  // åŒ…åæ·»åŠ æ–¹æ³•
  private void addPackageToList(
    String pkg,
    List<String> userPackages,
    LinearLayout packagesLayout,
    Activity activity
  ) {
    // 1. å¤ç”¨å·²æœ‰æ–¹æ³•æ ¡éªŒåŒ…åæ ¼å¼ï¼ˆæ— éœ€æ–°å¢ï¼Œç›´æ¥è°ƒç”¨ï¼‰
    if (pkg == null || pkg.isEmpty() || !isValidPackageName(pkg)) {
      Toast.makeText(activity, "åŒ…åæ ¼å¼æ— æ•ˆ", Toast.LENGTH_SHORT).show();
      return;
    }
    // 2. åŒæ­¥é”è¦†ç›–å…¨æµç¨‹ï¼ˆé¿å…å¹¶å‘å†²çªï¼Œæ ¸å¿ƒä¿®å¤ï¼‰
    synchronized (globalCapturedPackages) {
      // 3. é”å†…åŒé‡å»é‡æ ¡éªŒï¼ˆç”¨æˆ·åˆ—è¡¨ + å…¨å±€åˆ—è¡¨ï¼‰
      if (userPackages.contains(pkg) || globalCapturedPackages.contains(pkg)) {
        Toast.makeText(
          activity,
          "åŒ…åå·²å­˜åœ¨ï¼Œæ— éœ€é‡å¤æ·»åŠ ",
          Toast.LENGTH_SHORT
        ).show();
        return;
      }
      // 4. æ— é‡å¤åˆ™åŒæ­¥æ·»åŠ ï¼ˆç¡®ä¿ç”¨æˆ·åˆ—è¡¨å’Œå…¨å±€åˆ—è¡¨ä¸€è‡´ï¼‰
      userPackages.add(pkg);
      globalCapturedPackages.add(pkg);
    }
    // 5. åˆ·æ–°åŒ…ååˆ—è¡¨æ˜¾ç¤º
    refreshPackagesLayout(packagesLayout, userPackages, activity);
    // 6. ä»…æ·»åŠ æˆåŠŸåæç¤ºï¼ˆé¿å…çŸ›ç›¾ï¼‰
    Toast.makeText(activity, "å·²æ·»åŠ ï¼š" + pkg, Toast.LENGTH_SHORT).show();
  }

  // å¸¦åŒ…åçš„æ¸…ç†è¯¢é—®å¼¹çª—ï¼ˆæ”¯æŒé€‰æ‹©æ¸…ç†èŒƒå›´ï¼‰
  private void showClearConfirmDialog(
  final Activity activity,
  final View floatingView
) {
  List<String> userPackages = userDefinedPackagesMap.getOrDefault(
    currentTargetApp,
    new ArrayList<>()
  );
  StringBuilder pkgText = new StringBuilder();
  pkgText.append("æ£€æµ‹åˆ° <font color='#FF5722'><b>" + userPackages.size() + "</b></font> ä¸ªæ‰‹åŠ¨æ·»åŠ çš„åŒ…å<br>"); // æ ‡é¢˜åæ¢è¡Œ
  for (int i = 0; i < userPackages.size(); i++) {
    pkgText
      .append((i + 1))
      .append(". ")
      .append(userPackages.get(i))
      .append("<br>"); // æ¯ä¸ªåŒ…ååæ¢è¡Œ
  }
  pkgText.append(
    "<br>==============<br>" // åˆ†éš”çº¿+æ¢è¡Œ
    + "æ˜¯å¦éœ€è¦åŒæ­¥æ¸…ç©ºï¼Ÿ<br><br>" // æ¢è¡Œ
    + "åŒæ­¥æ¸…ç©ºï¼šæ¸…ç†è‡ªåŠ¨æ•è·åŒ…å+æ‰‹åŠ¨æ·»åŠ åŒ…å <font color='#FF5722'><b>" + userPackages.size() + "</b></font> ä¸ª<br>" // æ¢è¡Œ
    + "å•ç‹¬ç•™ä¸‹ï¼šä»…æ¸…ç©ºè‡ªåŠ¨æ•è·çš„åŒ…å"
  );
 
    AlertDialog dialog = createBoundedDialog(
      activity,
      "æ¸…ç†åŒ…å",
      pkgText.toString(),
      new String[] { "åŒæ­¥æ¸…ç©º", "å•ç‹¬ç•™ä¸‹(" + userPackages.size() + ")", "å–æ¶ˆ" },
      new DialogInterface.OnClickListener[] {
        new DialogInterface.OnClickListener() {
          @Override
          public void onClick(DialogInterface dialog, int which) {
            clearAllPackageLists(activity, floatingView);
            dialog.dismiss();
          }
        },
        new DialogInterface.OnClickListener() {
          @Override
          public void onClick(DialogInterface dialog, int which) {
            clearAutoCapturedPackagesOnly(activity, floatingView);
            dialog.dismiss();
          }
        },
        new DialogInterface.OnClickListener() {
          @Override
          public void onClick(DialogInterface dialog, int which) {
            dialog.dismiss();
          }
        },
      }
    );

    dialog.show();
  }

  // ä»…æ¸…ç†è‡ªåŠ¨æ•è·çš„åŒ…ï¼Œä¿ç•™æ‰‹åŠ¨æ·»åŠ çš„åŒ…
  private void clearAutoCapturedPackagesOnly(
    final Activity activity,
    final View floatingView
  ) {
    try {
      List<String> userPackages = userDefinedPackagesMap.getOrDefault(
        currentTargetApp,
        new ArrayList<>()
      );
      // 1. æ¸…ç©ºå…¨å±€æ•è·åŒ…åˆ—è¡¨ä¸­â€œéæ‰‹åŠ¨æ·»åŠ â€çš„åŒ…ï¼ˆä¿ç•™æ‰‹åŠ¨æ·»åŠ çš„ï¼‰
      synchronized (globalCapturedPackages) {
        Iterator<String> iterator = globalCapturedPackages.iterator();
        while (iterator.hasNext()) {
          String pkg = iterator.next();
          if (!userPackages.contains(pkg)) {
            iterator.remove(); // ä»…ç§»é™¤è‡ªåŠ¨æ•è·çš„åŒ…
          }
        }
      }
      // 2. æ¸…ç©ºå½“å‰åº”ç”¨çš„è‡ªåŠ¨æ•è·åŒ…åˆ—è¡¨
      appCapturedPackages.clear();
      // 3. æ¸…ç©ºæ‹¦æˆªæ¨¡å¼ä¸­â€œéæ‰‹åŠ¨æ·»åŠ â€çš„åŒ…
      List<InterceptPattern> patterns = interceptPatternsMap.get(
        currentTargetApp
      );
      if (patterns != null) {
        for (InterceptPattern pattern : patterns) {
          Iterator<String> installedIt = pattern.installedPackages.iterator();
          while (installedIt.hasNext()) {
            if (!userPackages.contains(installedIt.next())) {
              installedIt.remove();
            }
          }
          Iterator<String> notInstalledIt =
            pattern.notInstalledPackages.iterator();
          while (notInstalledIt.hasNext()) {
            if (!userPackages.contains(notInstalledIt.next())) {
              notInstalledIt.remove();
            }
          }
        }
      }
      // 4. é‡ç½®æ™ºèƒ½ä¼ªé€ ç¼“å­˜ï¼ˆä»…æ¸…ç©ºè‡ªåŠ¨æ•è·åŒ…çš„ç¼“å­˜ï¼‰
      clearAutoCapturedCache(userPackages);
      // 5. ä¿å­˜é…ç½®
      saveConfigToFile();
      showRefreshConfirmDialog(activity, null); //åˆ·æ–°åº”ç”¨
      // 6. æ˜¾ç¤ºæç¤º
      Toast.makeText(
        activity,
        "âœ… ä»…æ¸…ç†è‡ªåŠ¨æ•è·çš„åŒ…ï¼Œä¿ç•™æ‰‹åŠ¨æ·»åŠ çš„åŒ…",
        Toast.LENGTH_LONG
      ).show();
    } catch (Throwable t) {
      log("ä»…æ¸…ç†è‡ªåŠ¨æ•è·åŒ…å¼‚å¸¸: " + t.getMessage());
      Toast.makeText(activity, "æ¸…ç†å¤±è´¥", Toast.LENGTH_SHORT).show();
    }
  }

  // è¾…åŠ©æ–¹æ³•ï¼šä»…æ¸…ç©ºè‡ªåŠ¨æ•è·åŒ…çš„ä¼ªé€ ç¼“å­˜ï¼ˆä¿ç•™æ‰‹åŠ¨æ·»åŠ åŒ…çš„ç¼“å­˜ï¼‰
  private void clearAutoCapturedCache(List<String> userPackages) {
    try {
      // éå†ç¼“å­˜ï¼Œä»…ç§»é™¤éæ‰‹åŠ¨æ·»åŠ çš„åŒ…çš„ç¼“å­˜
      Iterator<Map.Entry<String, String>> versionIt = versionCache
        .entrySet()
        .iterator();
      while (versionIt.hasNext()) {
        if (!userPackages.contains(versionIt.next().getKey())) {
          versionIt.remove();
        }
      }
      Iterator<Map.Entry<String, Integer>> versionCodeIt = versionCodeCache
        .entrySet()
        .iterator();
      while (versionCodeIt.hasNext()) {
        if (!userPackages.contains(versionCodeIt.next().getKey())) {
          versionCodeIt.remove();
        }
      }
      Iterator<Map.Entry<String, Long>> installTimeIt = installTimeCache
        .entrySet()
        .iterator();
      while (installTimeIt.hasNext()) {
        if (!userPackages.contains(installTimeIt.next().getKey())) {
          installTimeIt.remove();
        }
      }
      Iterator<Map.Entry<String, String>> installerIt = installerCache
        .entrySet()
        .iterator();
      while (installerIt.hasNext()) {
        if (!userPackages.contains(installerIt.next().getKey())) {
          installerIt.remove();
        }
      }
      Iterator<Map.Entry<String, String>> appNameIt = appNameCache
        .entrySet()
        .iterator();
      while (appNameIt.hasNext()) {
        if (!userPackages.contains(appNameIt.next().getKey())) {
          appNameIt.remove();
        }
      }
      // æ¸…ç©ºæŸ¥è¯¢æ¨¡å¼è®°å½•
      queryPatterns.clear();
    } catch (Throwable t) {
      log("æ¸…ç†è‡ªåŠ¨æ•è·ç¼“å­˜å¼‚å¸¸: " + t.getMessage());
    }
  }

  // åˆ›å»ºæ ‡è¯†
  private TextView createFloatingView(final Activity activity) {
    try {
      final TextView floatingView = new TextView(activity);
      floatingView.setTag("install_fake_floating");
      Boolean currentStatus = installStatusMap.get(currentTargetApp);
      final boolean status = currentStatus != null ? currentStatus : true;
      String statusText = status ? "å·²å®‰è£…" : "æœªå®‰è£…";
      // è·å–æ‹¦æˆªçŠ¶æ€æ ‡è¯†
      boolean isBlockingExit = blockExitMap.getOrDefault(
        currentTargetApp,
        false
      );
      String blockText = isBlockingExit ? "[æ‹¦æˆª]" : "";
      floatingView.setText("ä¼ªé€ å®‰è£…(" + statusText + ")" + blockText);
      floatingView.setTextSize(14);
      floatingView.setTextColor(0xFFFFFFFF);
      if (status) {
        floatingView.setBackgroundColor(0xAA4CAF50);
      } else {
        floatingView.setBackgroundColor(0xAAF44336);
      }
      floatingView.setPadding(25, 15, 25, 15);
      floatingView.setGravity(Gravity.CENTER);
      try {
        Class<?> gradientDrawableClass = Class.forName(
          "android.graphics.drawable.GradientDrawable"
        );
        Object gradientDrawable = gradientDrawableClass.newInstance();
        Method setColorMethod = gradientDrawableClass.getMethod(
          "setColor",
          int.class
        );
        Method setCornerRadiusMethod = gradientDrawableClass.getMethod(
          "setCornerRadius",
          float.class
        );
        setColorMethod.invoke(
          gradientDrawable,
          status ? 0xAA4CAF50 : 0xAAF44336
        );
        setCornerRadiusMethod.invoke(gradientDrawable, 25f);
        floatingView.setBackground(
          (android.graphics.drawable.Drawable) gradientDrawable
        );
      } catch (Throwable e) {
        log("è®¾ç½®åœ†è§’èƒŒæ™¯å¤±è´¥: " + e.getMessage());
      }
      floatingView.setOnTouchListener(
        new View.OnTouchListener() {
          private float startX, startY;
          private float initialX, initialY;
          private boolean isDragging = false;
          private boolean longPressTriggered = false;
          private final int DRAG_THRESHOLD = 50; //æ‹–åŠ¨æŠ–åŠ¨
          private final long LONG_PRESS_TIME = 300; //é•¿æŒ‰è§¦å‘æ—¶é—´
          private Handler longPressHandler;

          // åŒå‡»æ£€æµ‹ç›¸å…³å˜é‡
          private long firstClickTime = 0;
          private int clickCount = 0;
          private Handler clickHandler = new Handler();
          private static final int DOUBLE_CLICK_DELAY = 300; //åŒ¹é…å•å‡»è§¦å‘æ—¶é—´

          // æ–°å¢ï¼šæ ‡è®°å½“å‰æ˜¯å¦æ­£åœ¨å¤„ç†å•å‡»
          private boolean isClickHandled = false;

          @Override
          public boolean onTouch(final View v, MotionEvent event) {
            try {
              switch (event.getAction()) {
                case MotionEvent.ACTION_DOWN:
                  startX = event.getRawX();
                  startY = event.getRawY();
                  initialX = v.getX();
                  initialY = v.getY();
                  isDragging = false;
                  longPressTriggered = false;
                  isClickHandled = false; // é‡ç½®æ ‡è®°

                  // åŒå‡»æ£€æµ‹é€»è¾‘
                  long currentTime = System.currentTimeMillis();
                  if (currentTime - firstClickTime < DOUBLE_CLICK_THRESHOLD) {
                    clickCount++;
                    // ç§»é™¤ä¹‹å‰çš„å•å‡»ä»»åŠ¡
                    clickHandler.removeCallbacksAndMessages(null);
                    isClickHandled = false;

                    if (clickCount == 2) {
                      // åŒå‡»è§¦å‘
                      clickCount = 0;
                      firstClickTime = 0;
                      // å¼¹å‡ºæ·»åŠ åŒ…åå¯¹è¯æ¡†
                      showAddPackageDialog(activity);
                      return true;
                    }
                  } else {
                    clickCount = 1;
                    firstClickTime = currentTime;
                  }

                  // å»¶è¿Ÿæ‰§è¡Œå•å‡»ï¼ˆç»™åŒå‡»ç•™æ—¶é—´ï¼‰
                  clickHandler.postDelayed(
                    new Runnable() {
                      @Override
                      public void run() {
                        // å…³é”®ï¼šåªæœ‰ä¸æ˜¯é•¿æŒ‰ã€æ‹–æ‹½ï¼Œä¸”å•å‡»æœªè¢«å¤„ç†æ—¶æ‰æ‰§è¡Œ
                        if (
                          clickCount == 1 &&
                          !longPressTriggered &&
                          !isDragging &&
                          !isClickHandled
                        ) {
                          isClickHandled = true;
                          showStatusSwitchDialog(activity, floatingView);
                          clickCount = 0;
                          firstClickTime = 0;
                        }
                      }
                    },
                    DOUBLE_CLICK_DELAY
                  );

                  // é•¿æŒ‰æ£€æµ‹
                  longPressHandler = new Handler();
                  longPressHandler.postDelayed(
                    new Runnable() {
                      @Override
                      public void run() {
                        // å…³é”®ï¼šé•¿æŒ‰è§¦å‘æ—¶ï¼Œå–æ¶ˆå•å‡»ä»»åŠ¡å¹¶æ ‡è®°
                        clickHandler.removeCallbacksAndMessages(null);
                        longPressTriggered = true;
                        isClickHandled = true; // æ ‡è®°å•å‡»å·²è¢«å¤„ç†
                        clickCount = 0;
                        firstClickTime = 0;
                        // å‡è®¾å•å‡»èœå•å¼¹çª—æ˜¯é€šè¿‡ showStatusSwitchDialog æ˜¾ç¤ºçš„ï¼Œéœ€æŒæœ‰å…¶å¼•ç”¨
                        if (
                          statusSwitchDialog != null &&
                          statusSwitchDialog.isShowing()
                        ) {
                          statusSwitchDialog.dismiss();
                          statusSwitchDialog = null; // é‡ç½®å¼•ç”¨
                        }
                        showHideDialog(activity, v);
                      }
                    },
                    LONG_PRESS_TIME
                  );
                  return true;
                case MotionEvent.ACTION_MOVE:
                  float deltaX = Math.abs(event.getRawX() - startX);
                  float deltaY = Math.abs(event.getRawY() - startY);

                  if (
                    !isDragging &&
                    (deltaX > DRAG_THRESHOLD || deltaY > DRAG_THRESHOLD)
                  ) {
                    isDragging = true;
                    // æ‹–æ‹½æ—¶å–æ¶ˆæ‰€æœ‰æ£€æµ‹å¹¶æ ‡è®°
                    clickHandler.removeCallbacksAndMessages(null);
                    if (longPressHandler != null) {
                      longPressHandler.removeCallbacksAndMessages(null);
                    }
                    isClickHandled = true; // æ ‡è®°å•å‡»å·²è¢«å¤„ç†
                    clickCount = 0;
                    firstClickTime = 0;
                  }

                  if (isDragging) {
                    float newX = initialX + (event.getRawX() - startX);
                    float newY = initialY + (event.getRawY() - startY);
                    ViewGroup decorView = (ViewGroup) activity
                      .getWindow()
                      .getDecorView();
                    int screenWidth = decorView.getWidth();
                    int screenHeight = decorView.getHeight();
                    int viewWidth = v.getWidth();
                    int viewHeight = v.getHeight();
                    newX = Math.max(
                      10,
                      Math.min(newX, screenWidth - viewWidth - 10)
                    );
                    newY = Math.max(
                      50,
                      Math.min(newY, screenHeight - viewHeight - 100)
                    );
                    v.setX(newX);
                    v.setY(newY);
                    floatingXMap.put(currentTargetApp, newX);
                    floatingYMap.put(currentTargetApp, newY);
                  }
                  return true;
                case MotionEvent.ACTION_UP:
                  // æ¸…ç†é•¿æŒ‰å¤„ç†å™¨
                  if (longPressHandler != null) {
                    longPressHandler.removeCallbacksAndMessages(null);
                  }

                  // å¦‚æœé•¿æŒ‰å·²è§¦å‘ï¼Œç¡®ä¿å•å‡»ä¸ä¼šæ‰§è¡Œ
                  if (longPressTriggered) {
                    clickHandler.removeCallbacksAndMessages(null);
                    isClickHandled = true;
                  }

                  floatingXMap.put(currentTargetApp, v.getX());
                  floatingYMap.put(currentTargetApp, v.getY());
                  saveConfigToFile();

                  // é‡ç½®çŠ¶æ€ï¼ˆä¿ç•™isClickHandledç›´åˆ°ä¸‹ä¸€æ¬¡ACTION_DOWNï¼‰
                  isDragging = false;
                  return true;
                case MotionEvent.ACTION_CANCEL:
                  // æ¸…ç†æ‰€æœ‰å¤„ç†å™¨å’ŒçŠ¶æ€
                  clickHandler.removeCallbacksAndMessages(null);
                  if (longPressHandler != null) {
                    longPressHandler.removeCallbacksAndMessages(null);
                  }
                  isDragging = false;
                  longPressTriggered = false;
                  isClickHandled = true; // æ ‡è®°ä¸ºå·²å¤„ç†ï¼Œé˜²æ­¢åç»­æ‰§è¡Œ
                  clickCount = 0;
                  firstClickTime = 0;
                  return true;
              }
            } catch (Throwable t) {
              log("è§¦æ‘¸å¤„ç†å¼‚å¸¸: " + t.getMessage());
            }
            return true;
          }

          // çŠ¶æ€åˆ‡æ¢å¯¹è¯æ¡†ï¼ˆç»†åˆ†è‡ªå®šä¹‰åŒ…ååŒºåŸŸ+é¢œè‰²åŒºåˆ†ï¼‰
private void showStatusSwitchDialog(
    final Activity activity,
    final TextView floatingView
) {
  try {
    activity.runOnUiThread(
      new Runnable() {
        @Override
        public void run() {
          try {
            Boolean currentStatus = installStatusMap.get(
              currentTargetApp
            );
            final boolean status = currentStatus != null
              ? currentStatus
              : true;
            // è·å–æ£€æµ‹åˆ°çš„åŒ…ä¿¡æ¯ï¼ˆå·²è¿‡æ»¤æ’é™¤åŒ…ï¼‰
            DetectedPackages detected = analyzeDetectedPackages();
            // è®¡ç®—æ€»é¡¹æ•°ï¼ˆä»…ä¼ªé€ åŒ…ï¼Œä¸å«æ’é™¤åŒ…ï¼‰
            int totalPackages =
              detected.installedPackages.size() +
              detected.notInstalledPackages.size();
            // æ„å»ºè¯¦ç»†æ¶ˆæ¯ï¼ŒåŒ…å«æ£€æµ‹åˆ°çš„åŒ…åˆ—è¡¨ï¼ˆæ”¯æŒHTMLé¢œè‰²ï¼‰
            StringBuilder messageBuilder = new StringBuilder();
            messageBuilder
              .append("å½“å‰çŠ¶æ€: ")
              .append(status ? "<font color='#4CAF50'>ã€å·²å®‰è£…ã€‘</font>" : "<font color='#F44336'>ã€æœªå®‰è£…ã€‘</font>")
              .append("<br>"); // æ–°å¢æ¢è¡Œ
            if (totalPackages > 0) {
              messageBuilder
                .append("æ•è·åº”ç”¨æ€»ç´¯è®¡ï¼š<font color='#FF5722'><b>")
                .append(totalPackages)
                .append("</b></font><br><br>"); // æ–°å¢æ¢è¡Œ
              if (!detected.installedPackages.isEmpty()) {
                messageBuilder
                  .append("âœ… ä¼ªé€ å·²å®‰è£…çš„åŒ…(")
                  .append(detected.installedPackages.size())
                  .append("é¡¹):<br>");
                for (String pkg : detected.installedPackages) {
                  messageBuilder
                    .append("+ ")
                    .append(pkg)
                    .append("<br>"); // æ¯é¡¹åæ¢è¡Œ
                }
                messageBuilder.append("<br>"); // åˆ—è¡¨ç»“æŸåæ¢è¡Œ
              }
              if (!detected.notInstalledPackages.isEmpty()) {
                messageBuilder
                  .append("âŒ ä¼ªé€ æœªå®‰è£…çš„åŒ…(")
                  .append(detected.notInstalledPackages.size())
                  .append("é¡¹):<br>");
                for (String pkg : detected.notInstalledPackages) {
                  messageBuilder
                    .append("- ")
                    .append(pkg)
                    .append("<br>"); // æ¯é¡¹åæ¢è¡Œ
                }
                messageBuilder.append("<br>"); // åˆ—è¡¨ç»“æŸåæ¢è¡Œ
              }
            } else {
              messageBuilder.append(
                "ğŸ“Š å½“å‰åº”ç”¨ æœªæ£€æµ‹ åˆ°ä»»ä½•åŒ…<br><br>"
              ); // æ–°å¢æ¢è¡Œ
            }
            // æ‹†åˆ†ä¸º2ä¸ªç‹¬ç«‹åŒºåŸŸæ˜¾ç¤ºç”¨æˆ·è‡ªå®šä¹‰åŒ…åï¼ˆå¸¦é¢œè‰²åŒºåˆ†ï¼‰
            List<String> userPackages = userDefinedPackagesMap.getOrDefault(
              currentTargetApp,
              new ArrayList<>()
            );
            // å…³é”®ï¼šè¡¥å……å˜é‡å®šä¹‰ï¼ˆä¹‹å‰ç¼ºå¤±å¯¼è‡´æŠ¥é”™ï¼‰
            List<String> excludedPackages = excludedPackagesMap.getOrDefault(currentTargetApp, new ArrayList<>());
            List<String> userFakePackages = new ArrayList<>();
            for (String pkg : userPackages) {
              if (!excludedPackages.contains(pkg)) {
                userFakePackages.add(pkg);
              }
            }
            // 1. æ‰‹åŠ¨æ·»åŠ çš„ä¼ªé€ åŒ…åï¼ˆè¿‡æ»¤æ‰å·²æ’é™¤çš„åŒ…ï¼‰- ç»¿è‰²æ ‡é¢˜
            if (!userFakePackages.isEmpty()) {
              // ç»¿è‰²æ ‡é¢˜ï¼ˆHTMLæ ¼å¼ï¼‰
              messageBuilder
                .append("<font color='#4CAF50'>â£ï¸ æ‰‹åŠ¨æ·»åŠ çš„ä¼ªé€ åŒ…å(")
                .append(userFakePackages.size())
                .append("é¡¹):</font><br>");
              for (String pkg : userFakePackages) {
                messageBuilder.append("â˜† ").append(pkg).append("<br>");
              }
              messageBuilder.append("<br>");
            }
            // 2. æ‰‹åŠ¨æ·»åŠ çš„æ’é™¤åŒ…å - çº¢è‰²æ ‡é¢˜
            if (!excludedPackages.isEmpty()) {
              // çº¢è‰²æ ‡é¢˜ï¼ˆHTMLæ ¼å¼ï¼‰
              messageBuilder
                .append("<font color='#F44336'>âŒ æ‰‹åŠ¨æ·»åŠ çš„æ’é™¤åŒ…å(")
                .append(excludedPackages.size())
                .append("é¡¹):</font><br>");
              for (String pkg : excludedPackages) {
                messageBuilder.append("â˜† ").append(pkg).append("<br>");
              }
              messageBuilder.append("<br>");
            }
            messageBuilder.append("è¯·é€‰æ‹©è¦åˆ‡æ¢çš„çŠ¶æ€:");
            // åˆ›å»ºè¾¹ç•Œå®‰å…¨çš„å¯¹è¯æ¡†
            AlertDialog dialog = createBoundedDialog(
              activity,
              "é…ç½®åˆ‡æ¢å®‰è£…çŠ¶æ€-(å°æ·‹)",
              messageBuilder.toString(),
              new String[] {
                "åˆ‡æ¢ä¸ºå·²å®‰è£…",
                "åˆ‡æ¢ä¸ºæœªå®‰è£…",
                "é…ç½®æ›´å¤šåŠŸèƒ½",
              },
              new DialogInterface.OnClickListener[] {
                new DialogInterface.OnClickListener() {
                  @Override
                  public void onClick(
                    DialogInterface dialogInterface,
                    int which
                  ) {
                    if (!status) {
                      handleStatusSwitch(
                        activity,
                        floatingView,
                        true
                      );
                      dialogInterface.dismiss();
                    } else {
                      Toast.makeText(
                        activity,
                        "å½“å‰å·²æ˜¯å·²å®‰è£…çŠ¶æ€",
                        Toast.LENGTH_SHORT
                      ).show();
                    }
                  }
                },
                new DialogInterface.OnClickListener() {
                  @Override
                  public void onClick(
                    DialogInterface dialogInterface,
                    int which
                  ) {
                    if (status) {
                      handleStatusSwitch(
                        activity,
                        floatingView,
                        false
                      );
                      dialogInterface.dismiss();
                    } else {
                      Toast.makeText(
                        activity,
                        "å½“å‰å·²æ˜¯æœªå®‰è£…çŠ¶æ€",
                        Toast.LENGTH_SHORT
                      ).show();
                    }
                  }
                },
                new DialogInterface.OnClickListener() {
                  @Override
                  public void onClick(
                    DialogInterface dialogInterface,
                    int which
                  ) {
                    dialogInterface.dismiss();
                    //æ˜¾ç¤ºæ›´å¤šåŠŸèƒ½é…ç½®å¼¹çª—
                    showMoreFunctionsDialog(activity, floatingView);
                  }
                },
              }
            );
            statusSwitchDialog = dialog; //é•¿æŒ‰éšè—å¼¹çª—
            dialog.show();
          } catch (Throwable t) {
            log("æ˜¾ç¤ºçŠ¶æ€åˆ‡æ¢å¯¹è¯æ¡†å¼‚å¸¸: " + t.getMessage());
            // å¤‡ç”¨å¯¹è¯æ¡†
            showFallbackDialog(activity, floatingView, status);
          }
        }
      }
    );
  } catch (Throwable t) {
    log("æ˜¾ç¤ºçŠ¶æ€åˆ‡æ¢å¯¹è¯æ¡†å¼‚å¸¸: " + t.getMessage());
  }
}



          // ========== æ˜¾ç¤ºæ›´å¤šåŠŸèƒ½é…ç½®å¯¹è¯æ¡† ==========
          private void showMoreFunctionsDialog(
  final Activity activity,
  final TextView floatingView
) {
  try {
    // è·å–å½“å‰çŠ¶æ€
    final boolean isBlockingExit = blockExitMap.getOrDefault(
      currentTargetApp,
      false
    );
    final Boolean currentPermissionFake = permissionFakeMap.get(
      currentTargetApp
    );
    final boolean permissionFakeEnabled = currentPermissionFake !=
      null
      ? currentPermissionFake
      : true;
    // æ„å»ºæ¶ˆæ¯å†…å®¹ï¼ˆæ·»åŠ æ¢è¡Œåˆ†éš”ï¼‰
    StringBuilder messageBuilder = new StringBuilder();
    messageBuilder.append("å½“å‰åŠŸèƒ½çŠ¶æ€ï¼š<br><br>"); // æ ‡é¢˜åæ¢è¡Œ
    messageBuilder.append("1. é€€å‡ºæ‹¦æˆªï¼š");
    messageBuilder.append(isBlockingExit ? "âœ… å¼€å¯" : "âŒ å…³é—­");
    messageBuilder.append("<br>   - æ‹¦æˆªåº”ç”¨å› æ£€æµ‹åˆ°ä¼ªé€ åŒ…è€Œé€€å‡º<br><br>"); // åŠŸèƒ½è¯´æ˜æ¢è¡Œ+ç©ºè¡Œ
    messageBuilder.append("2. æƒé™ä¼ªé€ ï¼š");
    messageBuilder.append(
      permissionFakeEnabled ? "âœ… å¼€å¯" : "âŒ å…³é—­"
    );
    messageBuilder.append("<br>   - ä¼ªé€ åº”ç”¨æ£€æµ‹æƒé™ä¸ºå·²æˆæƒ<br>"); // æ¢è¡Œ
    messageBuilder.append("   - å¦‚è¯»å–åº”ç”¨åˆ—è¡¨ã€ä½¿ç”¨ç»Ÿè®¡æƒé™<br><br>"); // æ¢è¡Œ+ç©ºè¡Œ
    messageBuilder.append("è¯·é€‰æ‹©è¦é…ç½®çš„åŠŸèƒ½ï¼š");

              // åˆ›å»ºå¯¹è¯æ¡†
              AlertDialog dialog = createBoundedDialog(
                activity,
                "æ›´å¤šåŠŸèƒ½é…ç½®",
                messageBuilder.toString(),
                new String[] {
                  isBlockingExit ? "å…³é—­é€€å‡ºæ‹¦æˆª" : "å¼€å¯é€€å‡ºæ‹¦æˆª",
                  permissionFakeEnabled ? "å…³é—­æƒé™ä¼ªé€ " : "å¼€å¯æƒé™ä¼ªé€ ",
                  "å–æ¶ˆ",
                },
                new DialogInterface.OnClickListener[] {
                  new DialogInterface.OnClickListener() {
                    @Override
                    public void onClick(DialogInterface dialog, int which) {
                      // åˆ‡æ¢é€€å‡ºæ‹¦æˆªåŠŸèƒ½
                      toggleBlockExit(activity, floatingView, !isBlockingExit);
                      dialog.dismiss();
                    }
                  },
                  new DialogInterface.OnClickListener() {
                    @Override
                    public void onClick(DialogInterface dialog, int which) {
                      // åˆ‡æ¢æƒé™ä¼ªé€ åŠŸèƒ½
                      togglePermissionFake(
                        activity,
                        floatingView,
                        !permissionFakeEnabled
                      );
                      dialog.dismiss();
                    }
                  },
                  new DialogInterface.OnClickListener() {
                    @Override
                    public void onClick(DialogInterface dialog, int which) {
                      dialog.dismiss();
                    }
                  },
                }
              );

              dialog.show();
            } catch (Throwable t) {
              log("æ˜¾ç¤ºæ›´å¤šåŠŸèƒ½å¯¹è¯æ¡†å¼‚å¸¸: " + t.getMessage());
              Toast.makeText(
                activity,
                "æ˜¾ç¤ºåŠŸèƒ½é…ç½®å¤±è´¥",
                Toast.LENGTH_SHORT
              ).show();
            }
          }

          // ========== åˆ‡æ¢æƒé™ä¼ªé€ åŠŸèƒ½ ==========
          private void togglePermissionFake(
            final Activity activity,
            final TextView floatingView,
            final boolean enable
          ) {
            try {
              permissionFakeMap.put(currentTargetApp, enable);
              saveConfigToFile();
              //å¼ºåˆ¶é‡æ–°æ‰§è¡Œæƒé™Hooké€»è¾‘ï¼ˆç«‹å³æ›´æ–°æ‹¦æˆªè§„åˆ™ï¼‰
              reHookPermissionMethods(activity.getClassLoader());
              //æ¸…ç©ºç›®æ ‡åº”ç”¨çš„æƒé™ç¼“å­˜ï¼ˆå…¼å®¹ç³»ç»Ÿå’Œåº”ç”¨å±‚ç¼“å­˜ï¼‰
              clearPermissionCache(activity);
              //å‘é€å¹¿æ’­é€šçŸ¥åº”ç”¨æƒé™å˜åŒ–ï¼ˆè§¦å‘éƒ¨åˆ†åº”ç”¨é‡æŸ¥è¯¢ï¼‰
              sendPermissionChangeBroadcast(activity);

              String message = enable
                ? "âœ… æƒé™ä¼ªé€ åŠŸèƒ½å·²å¼€å¯\næ— éœ€é‡å¯ï¼Œåˆ·æ–°åç«‹å³ç”Ÿæ•ˆï¼"
                : "âŒ æƒé™ä¼ªé€ åŠŸèƒ½å·²å…³é—­\næ— éœ€é‡å¯ï¼Œåˆ·æ–°åç«‹å³ç”Ÿæ•ˆï¼";
              Toast.makeText(activity, message, Toast.LENGTH_LONG).show();
              // log("æƒé™ä¼ªé€ åŠŸèƒ½: " + (enable ? "å¼€å¯" : "å…³é—­") + "ï¼ˆå·²å¼ºåˆ¶åˆ·æ–°ï¼‰");

              showPermissionFakeRefreshPrompt(activity, enable);
            } catch (Throwable t) {
              log("åˆ‡æ¢æƒé™ä¼ªé€ å¼‚å¸¸: " + t.getMessage());
              Toast.makeText(
                activity,
                "åˆ‡æ¢å¤±è´¥ï¼ˆéœ€é‡å¯åº”ç”¨ç”Ÿæ•ˆï¼‰",
                Toast.LENGTH_SHORT
              ).show();
            }
          }

          // é‡æ–°æ‰§è¡Œæƒé™Hookï¼Œç«‹å³åº”ç”¨æ–°çš„ä¼ªé€ çŠ¶æ€
          private void reHookPermissionMethods(ClassLoader classLoader) {
            try {
              // é‡æ–°Hookæ‰€æœ‰æƒé™ç›¸å…³æ–¹æ³•
              hookQueryAllPackagesPermission(classLoader);
              hookPackageUsageStatsPermission(classLoader);
              hookBasicPermissionChecks(classLoader);

              // Hook ContextWrapperçš„checkSelfPermissionï¼ˆåº”ç”¨è‡ªæŸ¥æƒé™çš„æ ¸å¿ƒæ–¹æ³•ï¼‰
              try {
                XposedHelpers.findAndHookMethod(
                  "android.content.ContextWrapper",
                  classLoader,
                  "checkSelfPermission",
                  String.class,
                  new XC_MethodHook() {
                    @Override
                    protected void beforeHookedMethod(MethodHookParam param)
                      throws Throwable {
                      Boolean shouldFakePermission = permissionFakeMap.get(
                        currentTargetApp
                      );
                      boolean fakeEnabled = shouldFakePermission != null
                        ? shouldFakePermission
                        : true;
                      if (!fakeEnabled) return;

                      String permission = (String) param.args[0];
                      if (
                        Arrays.asList(DETECTION_PERMISSIONS).contains(
                          permission
                        )
                      ) {
                        param.setResult(PackageManager.PERMISSION_GRANTED);
                      }
                    }
                  }
                );
              } catch (Throwable t) {
                //    log("é‡æ–°Hook ContextWrapperæƒé™å¤±è´¥: " + t.getMessage());
              }
              //   log("âœ… æƒé™Hooké€»è¾‘å·²é‡æ–°åŠ è½½ï¼Œç«‹å³ç”Ÿæ•ˆ");
            } catch (Throwable t) {
              log("é‡æ–°Hookæƒé™æ–¹æ³•å¤±è´¥: " + t.getMessage());
            }
          }

          // æ¸…ç©ºç³»ç»Ÿ+åº”ç”¨å±‚çš„æƒé™æŸ¥è¯¢ç¼“å­˜
          private void clearPermissionCache(Context context) {
            try {
              // 1. æ¸…ç©ºPackageManagerç³»ç»Ÿç¼“å­˜
              PackageManager pm = context.getPackageManager();
              try {
                // æ¸…ç©ºé¦–é€‰æ´»åŠ¨ç¼“å­˜ï¼ˆå½±å“æƒé™ç›¸å…³ç»„ä»¶æŸ¥è¯¢ï¼‰
                Method clearPreferredMethod =
                  PackageManager.class.getDeclaredMethod(
                      "clearPackagePreferredActivities",
                      String.class
                    );
                clearPreferredMethod.setAccessible(true);
                clearPreferredMethod.invoke(pm, currentTargetApp);
              } catch (Throwable t) {
                log("æ¸…ç©ºPackageManagerç¼“å­˜å¤±è´¥: " + t.getMessage());
              }

              // æ¸…ç©ºåº”ç”¨è‡ªèº«çš„å†…å­˜ç¼“å­˜
              try {
                Class<?> appClass = Class.forName(
                  context.getPackageName() + ".App"
                );
                Field cacheField = appClass.getDeclaredField(
                  "sPermissionCache"
                );
                cacheField.setAccessible(true);
                Object cache = cacheField.get(null);
                if (cache instanceof Map) {
                  ((Map<?, ?>) cache).clear();
                  //    log("âœ… æ¸…ç©ºåº”ç”¨æƒé™å†…å­˜ç¼“å­˜");
                }
              } catch (Throwable t) {
                // å¿½ç•¥æ— ç¼“å­˜ç±»çš„æƒ…å†µï¼ˆå¤§éƒ¨åˆ†åº”ç”¨æ— æ­¤ç¼“å­˜ï¼‰
              }

              // æ¸…ç©ºAndroidXæƒé™ç¼“å­˜
              try {
                Class<?> permissionCacheClass = Class.forName(
                  "androidx.core.content.PermissionChecker"
                );
                Field sPermissionCacheField =
                  permissionCacheClass.getDeclaredField("sPermissionCache");
                sPermissionCacheField.setAccessible(true);
                Object cache = sPermissionCacheField.get(null);
                if (cache instanceof Map) {
                  ((Map<?, ?>) cache).clear();
                  //    log("âœ… æ¸…ç©ºAndroidXæƒé™ç¼“å­˜");
                }
              } catch (Throwable t) {
                // å¿½ç•¥æ— AndroidXçš„æƒ…å†µ
              }
            } catch (Throwable t) {
              log("æ¸…ç©ºæƒé™ç¼“å­˜å¼‚å¸¸: " + t.getMessage());
            }
          }

          // å‘é€ç³»ç»Ÿå¹¿æ’­ï¼Œé€šçŸ¥åº”ç”¨æƒé™çŠ¶æ€å˜åŒ–
          private void sendPermissionChangeBroadcast(Context context) {
            try {
              // å‘é€ç³»ç»Ÿæƒé™å˜åŒ–å¹¿æ’­
              Intent broadcastIntent = new Intent();
              broadcastIntent.setAction(
                "android.intent.action.PACKAGE_PERMISSION_CHANGED"
              );
              broadcastIntent.setData(Uri.parse("package:" + currentTargetApp));
              broadcastIntent.addFlags(Intent.FLAG_RECEIVER_REGISTERED_ONLY);
              context.sendBroadcast(broadcastIntent);

              // é¢å¤–å‘é€è‡ªå®šä¹‰å¹¿æ’­
              Intent customIntent = new Intent();
              customIntent.setAction(
                "com.install.appinstall.xl.PERMISSION_CHANGED"
              );
              customIntent.putExtra("packageName", currentTargetApp);
              context.sendBroadcast(customIntent);
              //   log("âœ… å‘é€æƒé™å˜åŒ–å¹¿æ’­ï¼Œè§¦å‘åº”ç”¨é‡æŸ¥è¯¢");
            } catch (Throwable t) {
              log("å‘é€æƒé™å¹¿æ’­å¼‚å¸¸: " + t.getMessage());
            }
          }

          // ========== æ˜¾ç¤ºæƒé™ä¼ªé€ åˆ·æ–°æç¤º ==========
          private void showPermissionFakeRefreshPrompt(
  final Activity activity,
  final boolean enabled
) {
  try {
    String title = enabled ? "æƒé™ä¼ªé€ å·²å¼€å¯" : "æƒé™ä¼ªé€ å·²å…³é—­";
    String message = enabled
      ? "âœ… <font color='#4CAF50'>æƒé™ä¼ªé€ åŠŸèƒ½å·²å¼€å¯</font><br><br>" +
        "åŠŸèƒ½æ•ˆæœï¼š<br>" +
        "â€¢ è¯»å–åº”ç”¨åˆ—è¡¨æƒé™æ—¶è¿”å›è™šå‡å·²æˆæƒ<br>" +
        "â€¢ éƒ¨åˆ†åº”ç”¨å¯èƒ½éœ€è¦é‡å¯æˆ–æ— æ•ˆ<br><br>" +
        "æ˜¯å¦ç«‹å³åˆ·æ–°åº”ç”¨ä½¿è®¾ç½®ç”Ÿæ•ˆï¼Ÿ"
      : "âŒ <font color='#F44336'>æƒé™ä¼ªé€ åŠŸèƒ½å·²å…³é—­</font><br><br>" +
        "åŠŸèƒ½æ•ˆæœï¼š<br>" +
        "â€¢ è¯»å–åº”ç”¨åˆ—è¡¨æƒé™æ—¶è¿”å›çœŸå®çŠ¶æ€<br>" +
        "â€¢ (æ¯”å¦‚å½“å‰åº”ç”¨æ²¡æœ‰â€œæˆæƒâ€,åº”ç”¨èƒ½æ£€æµ‹åˆ°)<br><br>" +
        "â€¢ éƒ¨åˆ†åº”ç”¨å¯èƒ½å› æ­¤æ‹’ç»è¿è¡Œæˆ–æ— æ•ˆ<br>" +
        "æ˜¯å¦ç«‹å³åˆ·æ–°åº”ç”¨ä½¿è®¾ç½®ç”Ÿæ•ˆï¼Ÿ";


              AlertDialog dialog = createBoundedDialog(
                activity,
                title,
                message,
                new String[] { "ç«‹å³åˆ·æ–°", "ç¨å" },
                new DialogInterface.OnClickListener[] {
                  new DialogInterface.OnClickListener() {
                    @Override
                    public void onClick(DialogInterface dialog, int which) {
                      refreshApplication(activity);
                    }
                  },
                  new DialogInterface.OnClickListener() {
                    @Override
                    public void onClick(DialogInterface dialog, int which) {
                      dialog.dismiss();
                    }
                  },
                }
              );

              dialog.show();
            } catch (Throwable t) {
              log("æ˜¾ç¤ºæƒé™ä¼ªé€ åˆ·æ–°æç¤ºå¼‚å¸¸: " + t.getMessage());
            }
          }

          // å¤‡ç”¨å¯¹è¯æ¡†
          private void showFallbackDialog(
            final Activity activity,
            final TextView floatingView,
            final boolean status
          ) {
            try {
              String[] items = {
                "åˆ‡æ¢ä¸ºå·²å®‰è£…" + (status ? " (å½“å‰)" : ""),
                "åˆ‡æ¢ä¸ºæœªå®‰è£…" + (!status ? " (å½“å‰)" : ""),
                "é…ç½®æ‹¦æˆªé€€å‡º",
              };
              new AlertDialog.Builder(activity)
                .setTitle("åˆ‡æ¢å®‰è£…çŠ¶æ€")
                .setItems(
                  items,
                  new DialogInterface.OnClickListener() {
                    @Override
                    public void onClick(DialogInterface dialog, int which) {
                      switch (which) {
                        case 0:
                          if (!status) {
                            handleStatusSwitch(activity, floatingView, true);
                          }
                          break;
                        case 1:
                          if (status) {
                            handleStatusSwitch(activity, floatingView, false);
                          }
                          break;
                        case 2:
                          showRefreshConfirmDialog(activity, null);
                          break;
                      }
                      dialog.dismiss();
                    }
                  }
                )
                .setNegativeButton("å–æ¶ˆ", null)
                .show();
            } catch (Throwable t) {
              log("æ˜¾ç¤ºå¤‡ç”¨å¯¹è¯æ¡†å¼‚å¸¸: " + t.getMessage());
              // æœ€ç»ˆå…œåº•ï¼šç›´æ¥åˆ‡æ¢çŠ¶æ€ï¼ˆæ— å¯¹è¯æ¡†ï¼‰
              handleStatusSwitch(activity, floatingView, !status);
            }
          }
        }
      );
      return floatingView;
    } catch (Throwable t) {
      log("åˆ›å»ºæ‚¬æµ®çª—è§†å›¾å¼‚å¸¸: " + t.getMessage());
      return null;
    }
  }



  // ========== ç‚¹å‡»èœå• ==========
  private void showClickMenu(
    final Activity activity,
    final TextView floatingView
  ) {
    try {
      Boolean currentStatus = installStatusMap.get(currentTargetApp);
      final boolean status = currentStatus != null ? currentStatus : true;

      Boolean blockExit = blockExitMap.get(currentTargetApp);
      final boolean isBlockingExit = blockExit != null ? blockExit : false;

      // æ„å»ºæŒ‰é’®æ–‡æœ¬ï¼ˆå»æ‰åˆ·æ–°æŒ‰é’®ï¼‰
      final String btn1Text = "åˆ‡æ¢ä¸ºå·²å®‰è£…" + (status ? " (å½“å‰)" : "");
      final String btn2Text = "åˆ‡æ¢ä¸ºæœªå®‰è£…" + (!status ? " (å½“å‰)" : "");
      final String btn3Text = isBlockingExit
        ? "å…³é—­æ‹¦æˆªé€€å‡º (å·²å¼€å¯)"
        : "å¼€å¯æ‹¦æˆªé€€å‡º (å·²å…³é—­)";

      // åˆ›å»ºå¸¦æœ‰ä¸‰ä¸ªæŒ‰é’®çš„å¯¹è¯æ¡†
      AlertDialog dialog = new AlertDialog.Builder(activity)
        .setTitle("æ‚¬æµ®çª—èœå•")
        .setMessage("å½“å‰åº”ç”¨: " + currentTargetApp)
        .setPositiveButton(
          btn1Text,
          new DialogInterface.OnClickListener() {
            @Override
            public void onClick(DialogInterface dialog, int which) {
              if (!status) {
                handleStatusSwitch(activity, floatingView, true);
              } else {
                Toast.makeText(
                  activity,
                  "å½“å‰å·²æ˜¯å·²å®‰è£…çŠ¶æ€",
                  Toast.LENGTH_SHORT
                ).show();
              }
            }
          }
        )
        .setNegativeButton(
          btn2Text,
          new DialogInterface.OnClickListener() {
            @Override
            public void onClick(DialogInterface dialog, int which) {
              if (status) {
                handleStatusSwitch(activity, floatingView, false);
              } else {
                Toast.makeText(
                  activity,
                  "å½“å‰å·²æ˜¯æœªå®‰è£…çŠ¶æ€",
                  Toast.LENGTH_SHORT
                ).show();
              }
            }
          }
        )
        .setNeutralButton(
          btn3Text,
          new DialogInterface.OnClickListener() {
            @Override
            public void onClick(DialogInterface dialog, int which) {
              toggleBlockExit(activity, floatingView, !isBlockingExit);
            }
          }
        )
        .create();

      // æ˜¾ç¤ºå¯¹è¯æ¡†
      dialog.show();

      // è®¾ç½®å¯¹è¯æ¡†çª—å£å±æ€§
      Window window = dialog.getWindow();
      if (window != null) {
        WindowManager.LayoutParams params = window.getAttributes();
        params.width = WindowManager.LayoutParams.MATCH_PARENT;
        params.height = WindowManager.LayoutParams.WRAP_CONTENT;
        params.gravity = Gravity.CENTER;
        window.setAttributes(params);
      }
    } catch (Throwable t) {
      log("æ˜¾ç¤ºç‚¹å‡»èœå•å¼‚å¸¸: " + t.getMessage());

      // ç®€å•å›é€€æ–¹æ¡ˆ
      try {
        Toast.makeText(
          activity,
          "æ˜¾ç¤ºèœå•å¤±è´¥ï¼Œè¯·é‡è¯•",
          Toast.LENGTH_SHORT
        ).show();
      } catch (Throwable e) {
        log("æ˜¾ç¤ºToastä¹Ÿå¤±è´¥: " + e.getMessage());
      }
    }
  }

  // ========== åˆ‡æ¢æ‹¦æˆªé€€å‡ºåŠŸèƒ½ ==========
  private void toggleBlockExit(
    final Activity activity,
    final TextView floatingView,
    final boolean enable
  ) {
    try {
      blockExitMap.put(currentTargetApp, enable);
      saveConfigToFile();

      if (floatingView != null) {
        Boolean currentStatus = installStatusMap.get(currentTargetApp);
        boolean status = currentStatus != null ? currentStatus : true;
        String statusText = status ? "å·²å®‰è£…" : "æœªå®‰è£…";
        String blockText = enable ? "[æ‹¦æˆª]" : "";
        floatingView.setText("ä¼ªé€ å®‰è£…(" + statusText + ")" + blockText);
      }

      String message = enable
        ? "âœ… æ‹¦æˆªé€€å‡ºåŠŸèƒ½å·²å¼€å¯\nåº”ç”¨å› æ£€æµ‹åˆ°ä¼ªé€ åŒ…é€€å‡ºæ—¶ä¼šè¢«æ‹¦æˆª"
        : "âŒ æ‹¦æˆªé€€å‡ºåŠŸèƒ½å·²å…³é—­\nåº”ç”¨å¯æ­£å¸¸é€€å‡º";
      Toast.makeText(activity, message, Toast.LENGTH_LONG).show();
      log("æ‹¦æˆªé€€å‡ºåŠŸèƒ½: " + (enable ? "å¼€å¯" : "å…³é—­"));

      // æ˜¾ç¤ºåˆ·æ–°æç¤º
      showBlockExitRefreshPrompt(activity, enable);
    } catch (Throwable t) {
      log("åˆ‡æ¢æ‹¦æˆªé€€å‡ºå¼‚å¸¸: " + t.getMessage());
      Toast.makeText(activity, "åˆ‡æ¢å¤±è´¥", Toast.LENGTH_SHORT).show();
    }
  }

  // ========== æ˜¾ç¤ºé€€å‡ºæ‹¦æˆªåˆ·æ–°æç¤º ==========
  private void showBlockExitRefreshPrompt(
  final Activity activity,
  final boolean enabled
) {
  try {
    String title = enabled ? "é€€å‡ºæ‹¦æˆªå·²å¼€å¯" : "é€€å‡ºæ‹¦æˆªå·²å…³é—­";
    String message = enabled
      ? "âœ… <font color='#4CAF50'>é€€å‡ºæ‹¦æˆªåŠŸèƒ½å·²å¼€å¯</font><br><br>" +
        "åŠŸèƒ½æ•ˆæœï¼š<br>" +
        "â€¢ åº”ç”¨å› æ£€æµ‹åˆ°ä¼ªé€ åŒ…è€Œé€€å‡ºæ—¶ä¼šè¢«æ‹¦æˆª<br>" +
        "â€¢ ä¼šå¼¹å‡ºæç¤ºè¯¢é—®æ˜¯å¦å…è®¸é€€å‡º<br><br>" +
        "â€¢ å¯è®¾ç½®é™é»˜æ‹¦æˆªï¼ˆä¸å†è¯¢é—®ï¼‰<br>" +
        "ä¸å†è¯¢é—®ï¼šå½“åº”ç”¨æ²¡æœ‰æ–°çš„æ£€æµ‹åŒ…æ—¶ï¼Œä½ é€‰æ‹©ç›¸åŒåŠŸèƒ½2æ¬¡åè‡ªåŠ¨æ‹¦æˆª<br>" +
        "(æ¯”å¦‚ä½ é€‰æ‹©äº†2æ¬¡æ‹¦æˆªåŠŸèƒ½ï¼Œåº”ç”¨æ²¡æœ‰æ›´æ–°åŒ…åå°±ä¼šæ‹¦æˆªé€€å‡º)<br>" +
        "æ¯å½“æœ‰æ›´æ–°æ—¶å°†ä½œåºŸ,ç›´åˆ°æ²¡æœ‰æ›´æ–°ã€‚éƒ¨åˆ†åº”ç”¨é€€å‡ºæ‹¦æˆªå¯èƒ½å¤±æ•ˆ<br><br>" +
        "æ˜¯å¦ç«‹å³åˆ·æ–°åº”ç”¨ä½¿è®¾ç½®ç”Ÿæ•ˆï¼Ÿ"
      : "âŒ <font color='#F44336'>é€€å‡ºæ‹¦æˆªåŠŸèƒ½å·²å…³é—­</font><br><br>" +
        "åŠŸèƒ½æ•ˆæœï¼š<br>" +
        "â€¢ åº”ç”¨å¯æ­£å¸¸é€€å‡º<br>" +
        "â€¢ æœ¬æ¬¡ä¸å†æ‹¦æˆªä»»ä½•é€€å‡ºè¡Œä¸º<br><br>" +
        "é™é»˜é€‰æ‹©ï¼šå½“åº”ç”¨æ²¡æœ‰æ–°çš„æ£€æµ‹åŒ…æ—¶ï¼Œä½ é€‰æ‹©ç›¸åŒåŠŸèƒ½2æ¬¡åè‡ªåŠ¨æ”¾è¡Œ<br>" +
        "(æ¯”å¦‚ä½ é€‰æ‹©äº†2æ¬¡ä¸æ‹¦æˆªåŠŸèƒ½ï¼Œåº”ç”¨æ²¡æœ‰æ›´æ–°åŒ…åå°±ä¼šæ”¾è¡Œé€€å‡º)<br>" +
        "æ¯å½“æœ‰æ›´æ–°æ—¶å°†ä½œåºŸ,ç›´åˆ°æ²¡æœ‰æ›´æ–°ã€‚éƒ¨åˆ†åº”ç”¨é€€å‡ºæ‹¦æˆªå¯èƒ½å¤±æ•ˆ<br><br>" +
        "æ˜¯å¦ç«‹å³åˆ·æ–°åº”ç”¨ä½¿è®¾ç½®ç”Ÿæ•ˆï¼Ÿ";
        
      AlertDialog dialog = createBoundedDialog(
        activity,
        title,
        message,
        new String[] { "ç«‹å³åˆ·æ–°", "ç¨å" },
        new DialogInterface.OnClickListener[] {
          new DialogInterface.OnClickListener() {
            @Override
            public void onClick(DialogInterface dialog, int which) {
              refreshApplication(activity);
            }
          },
          new DialogInterface.OnClickListener() {
            @Override
            public void onClick(DialogInterface dialog, int which) {
              dialog.dismiss();
            }
          },
        }
      );

      dialog.show();
    } catch (Throwable t) {
      log("æ˜¾ç¤ºé€€å‡ºæ‹¦æˆªåˆ·æ–°æç¤ºå¼‚å¸¸: " + t.getMessage());
    }
  }

// ========== éšè—å¯¹è¯æ¡† ==========
private void showHideDialog(
    final Activity activity,
    final View floatingView
) {
    try {
        String message = "ã€éšè—ã€‘éšè—æœ¬æ¬¡åº”ç”¨å†…çš„æ‚¬æµ®çª—æ˜¾ç¤ºåŠŸèƒ½<br>" +
                        "<font color='#F44336'>éšè—åå°†åœ¨åº”ç”¨é‡å¯æ—¶æ¢å¤æ˜¾ç¤º</font><br><br>" +
                        "â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”<br><br>" +
                        "ã€æ¸…ç†åŒ…åˆ—è¡¨ã€‘" +
                        "â€¢æ¸…ç†è‡ªåŠ¨æ•è·/æ·»åŠ çš„åŒ…åæ•°æ®<br>" +
                        "<font color='#F44336'>æ¸…ç†åå°†é‡æ–°è·å–è‡ªåŠ¨æ•è·çš„æ–°æ•°æ®</font>";
        AlertDialog dialog = createBoundedDialog(
            activity,
            "æ‚¬æµ®çª—è®¾ç½®",
            message,  // ä½¿ç”¨HTMLæ ¼å¼çš„æ¶ˆæ¯
            new String[] { "éšè—", "æ¸…ç†åŒ…åˆ—è¡¨", "å–æ¶ˆ" },
            new DialogInterface.OnClickListener[] {
                new DialogInterface.OnClickListener() {
                    @Override
                    public void onClick(DialogInterface dialog, int which) {
                        try {
                            if (floatingView != null) {
                                ViewGroup parent = (ViewGroup) floatingView.getParent();
                                if (parent != null) {
                                    parent.removeView(floatingView);
                                }
                            }
                            floatingShownMap.put(currentTargetApp, false);
                            currentFloatingView = null;
                            stopå®šæ—¶ç½®é¡¶();
                          //  saveConfigToFile();  // âš ï¸ ä¿å­˜åé‡å¯ä¸æ¢å¤ï¼
                            
                            // ========== æ˜¾ç¤ºæç¤º ==========
                            Toast.makeText(
                                activity,
                                "âœ… æ‚¬æµ®çª—å·²éšè—\né‡å¯åº”ç”¨åé‡æ–°æ˜¾ç¤º",
                                Toast.LENGTH_LONG
                            ).show();
                        } catch (Throwable t) {
                            log("âŒ éšè—æ‚¬æµ®çª—å¼‚å¸¸: " + t.getMessage());
                            Toast.makeText(activity, "éšè—å¤±è´¥", Toast.LENGTH_SHORT).show();
                        }
                    }
                },
                new DialogInterface.OnClickListener() {
                    @Override
                    public void onClick(DialogInterface dialog, int which) {
                        dialog.dismiss();
                        List<String> userPackages = userDefinedPackagesMap.getOrDefault(
                            currentTargetApp,
                            new ArrayList<>()
                        );
                        if (userPackages.isEmpty()) {
                            clearAllPackageLists(activity, floatingView);
                        } else {
                            showClearConfirmDialog(activity, floatingView);
                        }
                    }
                },
                new DialogInterface.OnClickListener() {
                    @Override
                    public void onClick(DialogInterface dialog, int which) {
                        dialog.dismiss();  // å–æ¶ˆ
                    }
                },
            }
        );
        
        dialog.show();
        
    } catch (Throwable t) {
        log("âŒ æ˜¾ç¤ºéšè—å¯¹è¯æ¡†å¼‚å¸¸: " + t.getMessage());
    }
}


  // ========== æ¸…ç†æ‰€æœ‰åŒ…åˆ—è¡¨ ==========
// æ¸…ç†æ‰€æœ‰åŒ…åˆ—è¡¨ï¼ˆè‡ªåŠ¨æ•è·+æ‰‹åŠ¨æ·»åŠ +æ’é™¤åŒ…ï¼‰
private void clearAllPackageLists(
  final Activity activity,
  final View floatingView
) {
  try {
    // 1. æ¸…ç©ºå…¨å±€æ•è·åŒ…åˆ—è¡¨
    synchronized (globalCapturedPackages) {
      globalCapturedPackages.clear();
    }
    // 2. æ¸…ç©ºå½“å‰åº”ç”¨çš„æ•è·åŒ…åˆ—è¡¨
    appCapturedPackages.clear();
    // 3. æ¸…ç©ºæ‹¦æˆªæ¨¡å¼ä¸­çš„åŒ…åˆ—è¡¨
    List<InterceptPattern> patterns = interceptPatternsMap.get(
      currentTargetApp
    );
    if (patterns != null) {
      for (InterceptPattern pattern : patterns) {
        pattern.installedPackages.clear();
        pattern.notInstalledPackages.clear();
      }
    }
    // 4. æ¸…ç©ºç”¨æˆ·æ‰‹åŠ¨æ·»åŠ çš„åŒ…åˆ—è¡¨ï¼ˆä¼ªé€ åŒ…ï¼‰
    userDefinedPackagesMap.put(currentTargetApp, new ArrayList<>());
    // æ–°å¢ï¼š5. æ˜¾å¼æ¸…ç©ºæ‰‹åŠ¨æ·»åŠ çš„æ’é™¤åŒ…åˆ—è¡¨ï¼ˆå…³é”®ä¿®æ”¹ï¼‰
    excludedPackagesMap.put(currentTargetApp, new ArrayList<>());
    // 6. é‡ç½®æ™ºèƒ½ä¼ªé€ ç¼“å­˜
    clearSmartFakeCache();
    // 7. ä¿å­˜é…ç½®åˆ°æ–‡ä»¶ï¼ˆç¡®ä¿æ¸…ç©ºçŠ¶æ€æŒä¹…åŒ–ï¼‰
    saveConfigToFile();
    // 8. æ˜¾ç¤ºæ¸…ç†æˆåŠŸçš„æç¤º
    activity.runOnUiThread(new Runnable() {
            @Override
            public void run() {
                try {
                    String message = "<b>âœ… æ¸…ç†å®Œæˆ</b><br>" +
                                   "â€¢ å·²æ¸…ç©ºå…¨å±€åŒ…åˆ—è¡¨<br>" +
                                   "â€¢ å·²æ¸…ç©ºå½“å‰åº”ç”¨åŒ…åˆ—è¡¨<br>" +
                                   "â€¢ å·²æ¸…ç©ºç”¨æˆ·è‡ªå®šä¹‰åŒ…å<br>" +
                                   "â€¢ å·²é‡ç½®ä¼ªé€ ç¼“å­˜<br>" +
                                   "â€¢ é…ç½®å·²ä¿å­˜";
                    
                    Toast toast = Toast.makeText(activity, "", Toast.LENGTH_LONG);
                    TextView tv = new TextView(activity);
                    tv.setText(Html.fromHtml(message));
                    tv.setGravity(Gravity.CENTER);
                    tv.setPadding(40, 30, 40, 30);
                    tv.setTextSize(16);
                    tv.setTextColor(0xFF000000);
                    tv.setBackgroundColor(0xAAFFFFFF);
                    toast.setView(tv);
                    toast.setGravity(Gravity.CENTER, 0, 400);
                    toast.show();
                    if (floatingView != null) {
                        showRefreshConfirmDialog(activity, null); //æ˜¾ç¤ºå¼¹çª—
                    }
                } catch (Throwable t) {
                    log("æ˜¾ç¤ºæ¸…ç†æˆåŠŸæç¤ºå¼‚å¸¸: " + t.getMessage());
                    // å…œåº•Toast
                    Toast.makeText(activity, "âœ… æ¸…ç†å®Œæˆ", Toast.LENGTH_SHORT).show();
                }
            }
        });
  } catch (Throwable t) {
    log("æ¸…ç†åŒ…åˆ—è¡¨å¼‚å¸¸: " + t.getMessage());
    activity.runOnUiThread(
      new Runnable() {
        @Override
        public void run() {
          Toast.makeText(activity, "æ¸…ç†å¤±è´¥", Toast.LENGTH_SHORT).show();
        }
      }
    );
  }
}



  // ========== æ¸…ç†æ™ºèƒ½ä¼ªé€ ç¼“å­˜çš„æ–¹æ³• ==========
  private void clearSmartFakeCache() {
    try {
      versionCache.clear();
      versionCodeCache.clear();
      installTimeCache.clear();
      installerCache.clear();
      appNameCache.clear();
      queryPatterns.clear();
      // log("âœ… å·²æ¸…ç†æ™ºèƒ½ä¼ªé€ ç¼“å­˜");
    } catch (Throwable t) {
      log("æ¸…ç†æ™ºèƒ½ä¼ªé€ ç¼“å­˜å¼‚å¸¸: " + t.getMessage());
    }
  }

// è¾¹ç•Œå®‰å…¨çš„å¯¹è¯æ¡†åˆ›å»ºæ–¹æ³•ï¼ˆæ”¯æŒè‡ªå®šä¹‰è§†å›¾+HTMLæ¶ˆæ¯é¢œè‰²ï¼‰
private AlertDialog createBoundedDialog(
  final Activity activity,
  String title,
  String message,
  String[] buttonTexts,
  DialogInterface.OnClickListener[] listeners
) {
  return createBoundedDialog(
    activity,
    title,
    message,
    buttonTexts,
    listeners,
    null
  );
}

// é‡è½½ç‰ˆæœ¬ï¼šæ”¯æŒè‡ªå®šä¹‰è§†å›¾+HTMLæ¶ˆæ¯é¢œè‰²
private AlertDialog createBoundedDialog(
  final Activity activity,
  String title,
  String message,
  String[] buttonTexts,
  DialogInterface.OnClickListener[] listeners,
  final View customView
) {
  AlertDialog.Builder builder = new AlertDialog.Builder(
    activity,
    AlertDialog.THEME_DEVICE_DEFAULT_LIGHT
  ).setTitle(title);
  // å¤„ç†æ¶ˆæ¯æˆ–è‡ªå®šä¹‰è§†å›¾ï¼ˆæ”¯æŒHTMLé¢œè‰²ï¼‰
  if (customView != null) {
    // ä½¿ç”¨è‡ªå®šä¹‰è§†å›¾
    builder.setView(customView);
  } else if (message != null && !message.isEmpty()) {
    // æ”¯æŒHTMLæ ¼å¼æ¶ˆæ¯ï¼ˆç”¨äºé¢œè‰²æ˜¾ç¤ºï¼‰
    if (Build.VERSION.SDK_INT >= Build.VERSION_CODES.N) {
      builder.setMessage(Html.fromHtml(message, Html.FROM_HTML_MODE_LEGACY));
    } else {
      builder.setMessage(Html.fromHtml(message));
    }
  }
  // æŒ‰é’®é…ç½®
  if (buttonTexts.length >= 1 && listeners.length >= 1) {
    builder.setPositiveButton(buttonTexts[0], listeners[0]);
  }
  if (buttonTexts.length >= 2 && listeners.length >= 2) {
    builder.setNegativeButton(buttonTexts[1], listeners[1]);
  }
  if (buttonTexts.length >= 3 && listeners.length >= 3) {
    builder.setNeutralButton(buttonTexts[2], listeners[2]);
  }
  final AlertDialog dialog = builder.create();
  // è®¾ç½®å¯¹è¯æ¡†æ˜¾ç¤ºæ—¶çš„å±æ€§
  dialog.setOnShowListener(
    new DialogInterface.OnShowListener() {
      @Override
      public void onShow(DialogInterface dialogInterface) {
        try {
          Window window = dialog.getWindow();
          if (window != null) {
            WindowManager.LayoutParams params = window.getAttributes();
            // åŸºç¡€å±‚çº§æå‡
            params.flags |= WindowManager.LayoutParams.FLAG_LAYOUT_IN_SCREEN;
            params.flags |= WindowManager.LayoutParams.FLAG_KEEP_SCREEN_ON;
            // ä½ç½®å’Œå¤§å°
            final DisplayMetrics metrics = new DisplayMetrics();
            activity
              .getWindowManager()
              .getDefaultDisplay()
              .getMetrics(metrics);
            // æ ¹æ®æ˜¯å¦æœ‰è‡ªå®šä¹‰è§†å›¾è°ƒæ•´å¤§å°
            if (customView != null) {
              // è‡ªå®šä¹‰è§†å›¾æ—¶ä½¿ç”¨åŒ…è£¹å†…å®¹
              params.width = WindowManager.LayoutParams.WRAP_CONTENT;
              params.height = WindowManager.LayoutParams.WRAP_CONTENT;
            } else {
              // æ–‡æœ¬æ¶ˆæ¯æ—¶ä½¿ç”¨MATCH_PARENT
              params.width = WindowManager.LayoutParams.MATCH_PARENT;
              params.height = WindowManager.LayoutParams.WRAP_CONTENT;
            }
            params.gravity = Gravity.CENTER;
            params.horizontalMargin = 0.25f; // 25%è¾¹è·
            // å¼±æš—åŒ–
            window.addFlags(WindowManager.LayoutParams.FLAG_DIM_BEHIND);
            params.dimAmount = 0.6f; // 60%æš—åŒ–ï¼Œç¡®ä¿å¼¹çª—å¯è§
            // å®‰å…¨ç½®é¡¶
            window.setAttributes(params);
            window.getDecorView().bringToFront();
            activity.getWindow().getDecorView().bringToFront();
            // å¯¹äºè‡ªå®šä¹‰è§†å›¾ï¼Œå¯èƒ½éœ€è¦é¢å¤–å¤„ç†
            if (customView != null) {
              // è®¾ç½®æœ€å¤§é«˜åº¦ï¼ˆé¿å…è¶…å‡ºå±å¹•ï¼‰
              final View contentView = window.findViewById(
                android.R.id.content
              );
              if (contentView != null) {
                contentView.post(
                  new Runnable() {
                    @Override
                    public void run() {
                      int maxHeight = (metrics.heightPixels * 70) / 100; // å±å¹•é«˜åº¦çš„70%
                      if (contentView.getHeight() > maxHeight) {
                        LinearLayout.LayoutParams lp =
                          new LinearLayout.LayoutParams(
                            LinearLayout.LayoutParams.MATCH_PARENT,
                            maxHeight
                          );
                        contentView.setLayoutParams(lp);
                      }
                    }
                  }
                );
              }
            }
          }
        } catch (Throwable t) {
          log("è®¾ç½®å¯¹è¯æ¡†å¼‚å¸¸: " + t.getMessage());
          // å…œåº•ï¼šå¼ºåˆ¶æ˜¾ç¤ºå¼¹çª—
          dialog.show();
        }
      }
    }
  );
  // å…è®¸å¤–éƒ¨ç‚¹å‡»å…³é—­ï¼ˆä½†ä¿ç•™é»˜è®¤è¡Œä¸ºï¼‰
  dialog.setCanceledOnTouchOutside(true);
  dialog.setCancelable(true);
  return dialog;
}


  // ========== çŠ¶æ€åˆ‡æ¢å¤„ç†æ–¹æ³• ==========
  private void handleStatusSwitch(
    Activity activity,
    TextView floatingView,
    boolean newStatus
  ) {
    try {
      // 1. æ›´æ–°å†…å­˜çŠ¶æ€
      installStatusMap.put(currentTargetApp, newStatus);

      // 2.åŒæ­¥è·å–æ‹¦æˆªçŠ¶æ€ï¼Œæ‹¼æ¥å®Œæ•´æ–‡æœ¬
      String statusText = newStatus ? "å·²å®‰è£…" : "æœªå®‰è£…";
      boolean isBlockingExit = blockExitMap.getOrDefault(
        currentTargetApp,
        false
      ); // è·å–å½“å‰æ‹¦æˆªçŠ¶æ€
      String blockText = isBlockingExit ? "[æ‹¦æˆª]" : ""; // æ‹¦æˆªæ ‡è¯†

      // 3. æ›´æ–°æ‚¬æµ®çª—æ˜¾ç¤º
      if (floatingView != null) {
        floatingView.setText("ä¼ªé€ å®‰è£…(" + statusText + ")" + blockText); // å®‰è£…çŠ¶æ€+æ‹¦æˆªæ ‡è¯†
        floatingView.setBackgroundColor(newStatus ? 0xAA4CAF50 : 0xAAF44336);
      }

      // 4. ä¿å­˜åˆ°æ–‡ä»¶
      saveConfigToFile();

      // 5. æ˜¾ç¤ºæç¤º
      String message = "å·²åˆ‡æ¢ä¸º" + statusText + "çŠ¶æ€";
      Toast.makeText(activity, message, Toast.LENGTH_SHORT).show();

      // 6. æ˜¾ç¤ºåˆ·æ–°æç¤º
      showRefreshPrompt(activity, message);
    } catch (Throwable t) {
      log("å¤„ç†çŠ¶æ€åˆ‡æ¢å¼‚å¸¸: " + t.getMessage());
      Toast.makeText(activity, "åˆ‡æ¢å¤±è´¥", Toast.LENGTH_SHORT).show();
    }
  }

  // ========== åˆ·æ–°åŠŸèƒ½ ==========
  private void showRefreshPrompt(
  final Activity activity,
  final String message
) {
  try {
    AlertDialog dialog = createBoundedDialog(
      activity,
      "çŠ¶æ€åˆ‡æ¢æˆåŠŸ",
      message + "<br><br>æ˜¯å¦ç«‹å³åˆ·æ–°åº”ç”¨ä½¿çŠ¶æ€ç”Ÿæ•ˆï¼Ÿ", // æ–°å¢ç©ºè¡Œ
      new String[] { "ç«‹å³åˆ·æ–°", "ç¨å" },
        new DialogInterface.OnClickListener[] {
          new DialogInterface.OnClickListener() {
            @Override
            public void onClick(DialogInterface dialog, int which) {
              refreshApplication(activity);
            }
          },
          new DialogInterface.OnClickListener() {
            @Override
            public void onClick(DialogInterface dialog, int which) {
              dialog.dismiss();
            }
          },
        }
      );

      dialog.show();
    } catch (Throwable t) {
      log("æ˜¾ç¤ºåˆ·æ–°æç¤ºå¼‚å¸¸: " + t.getMessage());
    }
  }

//åˆ·æ–°å¼¹çª—
  private void showRefreshConfirmDialog(final Activity activity, final String customMessage) {
    if (activity == null || activity.isFinishing()) return;
    
    try {
        String message;
        if (customMessage != null && !customMessage.isEmpty()) {
            message = customMessage + "<br><br>æ˜¯å¦ç«‹å³åˆ·æ–°åº”ç”¨ä½¿é…ç½®ç”Ÿæ•ˆï¼Ÿ";
        } else {
            message = "è¿™å°†é‡æ–°åŠ è½½é…ç½®æ–‡ä»¶å¹¶æ›´æ–°æ˜¾ç¤ºï¼Œ<br>" +
                     "ä½¿çŠ¶æ€åˆ‡æ¢ç«‹å³ç”Ÿæ•ˆã€‚<br><br>" +
                     "ç¡®å®šè¦åˆ·æ–°å—ï¼Ÿ";
        }
        
        AlertDialog dialog = createBoundedDialog(
            activity,
            "åˆ·æ–°åº”ç”¨",
            message,
            new String[]{"ç«‹å³åˆ·æ–°", "å–æ¶ˆ"},
            new DialogInterface.OnClickListener[]{
                new DialogInterface.OnClickListener() {
                    @Override
                    public void onClick(DialogInterface dialog, int which) {
                        refreshApplication(activity);
                    }
                },
                new DialogInterface.OnClickListener() {
                    @Override
                    public void onClick(DialogInterface dialog, int which) {
                        dialog.dismiss();
                    }
                }
            }
        );
        
        dialog.show();
        
    } catch (Throwable t) {
        log("æ˜¾ç¤ºåˆ·æ–°å¯¹è¯æ¡†å¼‚å¸¸: " + t.getMessage());
    }
}

  private void refreshApplication(final Activity activity) {
    try {
     // appCapturedPackages.clear();
      installStatusMap.remove(currentTargetApp);
      floatingShownMap.remove(currentTargetApp);
      loadConfigFromFile();
      updateFloatingView(activity);

      activity.runOnUiThread(new Runnable() {
            @Override
            public void run() {
                try {
                    Boolean currentStatus = installStatusMap.get(currentTargetApp);
                    String statusText = "æœªçŸ¥";
                    if (currentStatus != null) {
                        statusText = currentStatus ? "å·²å®‰è£…" : "æœªå®‰è£…";
                    }
                    String toastMessage = "âœ… åˆ·æ–°å®Œæˆ<br>å½“å‰çŠ¶æ€: " + statusText;
                    
                    // ä½¿ç”¨è‡ªå®šä¹‰Toastæ˜¾ç¤ºHTML
                    Toast toast = Toast.makeText(activity, "", Toast.LENGTH_SHORT);
                    TextView tv = new TextView(activity);
                    tv.setText(Html.fromHtml(toastMessage));
                    tv.setGravity(Gravity.CENTER);
                    tv.setPadding(30, 20, 30, 20);
                    tv.setTextSize(16);
                    tv.setTextColor(0xFF000000);
                    tv.setBackgroundColor(0xAAFFFFFF);
                    toast.setView(tv);
                    toast.setGravity(Gravity.CENTER, 0, 400);
                    toast.show();
                  //  log("åˆ·æ–°æˆåŠŸï¼Œå½“å‰çŠ¶æ€: " + statusText);
                } catch (Throwable e) {
                    // å…œåº•æ–¹æ¡ˆ
                    Boolean currentStatus = installStatusMap.get(currentTargetApp);
                    String statusText = currentStatus != null ? 
                        (currentStatus ? "å·²å®‰è£…" : "æœªå®‰è£…") : "æœªçŸ¥";
                    Toast.makeText(activity, "åˆ·æ–°å®Œæˆ\nå½“å‰çŠ¶æ€: " + statusText, 
                        Toast.LENGTH_SHORT).show();
                }
            }
        });
    } catch (Throwable t) {
      log("åˆ·æ–°åº”ç”¨å¼‚å¸¸: " + t.getMessage());
      activity.runOnUiThread(
        new Runnable() {
          @Override
          public void run() {
            Toast.makeText(activity, "åˆ·æ–°å¤±è´¥", Toast.LENGTH_SHORT).show();
          }
        }
      );
    }
  }

  // æ›´æ–°æ‚¬æµ®çª—æ˜¾ç¤º
  private void updateFloatingView(final Activity activity) {
    try {
      activity.runOnUiThread(
        new Runnable() {
          @Override
          public void run() {
            try {
              View existingView = activity
                .getWindow()
                .getDecorView()
                .findViewWithTag("install_fake_floating");
              if (existingView instanceof TextView) {
                TextView floatingView = (TextView) existingView;
                // 1. è·å–å®‰è£…çŠ¶æ€å’Œæ‹¦æˆªçŠ¶æ€
                Boolean currentStatus = installStatusMap.get(currentTargetApp);
                boolean status = currentStatus != null ? currentStatus : true;
                String statusText = status ? "å·²å®‰è£…" : "æœªå®‰è£…";
                boolean isBlockingExit = blockExitMap.getOrDefault(
                  currentTargetApp,
                  false
                );
                String blockText = isBlockingExit ? "[æ‹¦æˆª]" : "";

                // 2. æ›´æ–°æ–‡æœ¬å’ŒèƒŒæ™¯è‰²
                floatingView.setText(
                  "ä¼ªé€ å®‰è£…(" + statusText + ")" + blockText
                );
                int bgColor = status ? 0xAA4CAF50 : 0xAAF44336;
                floatingView.setBackgroundColor(bgColor);

                // 3. æ ¸å¿ƒä¿®å¤ï¼šåŒæ­¥æ¢å¤åœ†è§’èƒŒæ™¯
                try {
                  Class<?> gradientDrawableClass = Class.forName(
                    "android.graphics.drawable.GradientDrawable"
                  );
                  Object gradientDrawable = gradientDrawableClass.newInstance();
                  // è®¾ç½®èƒŒæ™¯è‰²ï¼ˆä¸ä¸Šé¢ä¸€è‡´ï¼‰
                  Method setColorMethod = gradientDrawableClass.getMethod(
                    "setColor",
                    int.class
                  );
                  setColorMethod.invoke(gradientDrawable, bgColor);
                  // è®¾ç½®åœ†è§’åŠå¾„ï¼ˆ25fä¸åˆ›å»ºæ—¶ä¸€è‡´ï¼‰
                  Method setCornerRadiusMethod =
                    gradientDrawableClass.getMethod(
                      "setCornerRadius",
                      float.class
                    );
                  setCornerRadiusMethod.invoke(gradientDrawable, 25f);
                  // åº”ç”¨èƒŒæ™¯
                  floatingView.setBackground(
                    (android.graphics.drawable.Drawable) gradientDrawable
                  );
                } catch (Throwable e) {
                  log("æ›´æ–°åœ†è§’èƒŒæ™¯å¤±è´¥: " + e.getMessage());
                  // å…œåº•ï¼šå³ä½¿åœ†è§’è®¾ç½®å¤±è´¥ï¼Œä¹Ÿä¸å½±å“æ ¸å¿ƒåŠŸèƒ½
                  floatingView.setBackgroundColor(bgColor);
                }
              }
            } catch (Throwable t) {
              log("æ›´æ–°æ‚¬æµ®çª—å¼‚å¸¸: " + t.getMessage());
            }
          }
        }
      );
    } catch (Throwable t) {
      log("æ›´æ–°æ‚¬æµ®çª—æ˜¾ç¤ºå¼‚å¸¸: " + t.getMessage());
    }
  }

  // å…¨å±€é˜»æ–­æ‰€æœ‰é—´æ¥è°ƒç”¨ System.exit() çš„åœºæ™¯
  private void hookIndirectExitMethods(ClassLoader classLoader) {
    try {
      // 1. Hook åå°„è°ƒç”¨ System.exit()
      XposedHelpers.findAndHookMethod(
        "java.lang.reflect.Method",
        classLoader,
        "invoke",
        Object.class,
        Object[].class,
        new XC_MethodHook() {
          @Override
          protected void beforeHookedMethod(MethodHookParam param)
            throws Throwable {
            Method method = (Method) param.thisObject;
            if (
              method.getDeclaringClass().getName().equals("java.lang.System") &&
              method.getName().equals("exit")
            ) {
              param.setResult(null);
              param.setThrowable(null);
              log("âœ… æ‹¦æˆªåå°„exité€€å‡º");
              handleAppExit("åå°„è°ƒç”¨ System.exit()", param);
            }
          }
        }
      );

      // 2. Hook Runtime.exit()
      XposedHelpers.findAndHookMethod(
        "java.lang.Runtime",
        classLoader,
        "exit",
        int.class,
        new XC_MethodHook() {
          @Override
          protected void beforeHookedMethod(MethodHookParam param)
            throws Throwable {
            param.setResult(null);
            param.setThrowable(null);
            //    log("âœ… é˜»æ–­ Runtime.exit()");
            handleAppExit("Runtime.exit()", param);
          }
        }
      );

      // 3. Hook å¯èƒ½è§¦å‘é€€å‡ºçš„JNIç›¸å…³æ–¹æ³•
      XposedHelpers.findAndHookMethod(
        "java.lang.System",
        classLoader,
        "loadLibrary",
        String.class,
        new XC_MethodHook() {
          @Override
          protected void afterHookedMethod(MethodHookParam param)
            throws Throwable {
            String libName = (String) param.args[0];
            if (
              libName.contains("native") ||
              libName.contains("exit") ||
              libName.contains("kill")
            ) {
              //         log("âš ï¸  æ£€æµ‹åˆ°å¯èƒ½è§¦å‘é€€å‡ºçš„Nativeåº“åŠ è½½: " + libName);
            }
          }
        }
      );
      //   log("âœ… æˆåŠŸHookæ‰€æœ‰é—´æ¥é€€å‡ºæ–¹æ³•");
    } catch (Throwable t) {
      log("Hooké—´æ¥é€€å‡ºæ–¹æ³•å¤±è´¥: " + t.getMessage());
    }
  }

  // é€šç”¨é€€å‡ºæºå¤´æ‹¦æˆª
  private void hookGlobalExitSources(ClassLoader classLoader) {
    try {
      // æ‹¦æˆªé€€å‡ºæŒ‰é’®ç‚¹å‡»
      XposedHelpers.findAndHookMethod(
        "android.view.View",
        classLoader,
        "performClick",
        new XC_MethodHook() {
          @Override
          protected void beforeHookedMethod(
            XC_MethodHook.MethodHookParam param
          ) throws Throwable {
            View view = (View) param.thisObject;
            Context context = view.getContext();
            if (context instanceof Activity) {
              Activity activity = (Activity) context;
              DetectedPackages detected = analyzeDetectedPackages();
              if (
                !detected.installedPackages.isEmpty() ||
                !detected.notInstalledPackages.isEmpty()
              ) {
                String viewText = "";
                if (view instanceof TextView) {
                  CharSequence charSeq = ((TextView) view).getText();
                  viewText = charSeq != null
                    ? charSeq.toString().toLowerCase()
                    : "";
                }
                if (
                  viewText.contains("é€€å‡º") ||
                  viewText.contains("å…³é—­") ||
                  viewText.contains("exit") ||
                  viewText.contains("quit")
                ) {
                  param.setResult(false);
                  //         log("âœ… é€šç”¨æ‹¦æˆªï¼šé€€å‡ºæŒ‰é’®ç‚¹å‡»");
                  showSilentToast(activity, "å·²æ‹¦æˆªé€€å‡º");
                }
              }
            }
          }
        }
      );

      // åœºæ™¯2ï¼šæ‹¦æˆªå¸¦é€€å‡ºå…³é”®è¯çš„ Handler.post
      XposedHelpers.findAndHookMethod(
        "android.os.Handler",
        classLoader,
        "post",
        Runnable.class,
        new XC_MethodHook() {
          @Override
          protected void beforeHookedMethod(
            XC_MethodHook.MethodHookParam param
          ) throws Throwable {
            Runnable runnable = (Runnable) param.args[0];
            String runnableStr = runnable.toString().toLowerCase();
            if (
              runnableStr.contains("exit") ||
              runnableStr.contains("kill") ||
              runnableStr.contains("finish")
            ) {
              DetectedPackages detected = analyzeDetectedPackages();
              if (
                !detected.installedPackages.isEmpty() ||
                !detected.notInstalledPackages.isEmpty()
              ) {
                param.setResult(false);
                //              log("âœ… é€šç”¨æ‹¦æˆªï¼šé€€å‡ºé€»è¾‘ Runnable");
              }
            }
          }
        }
      );

      // åœºæ™¯3ï¼šæ‹¦æˆªActivityå¯åŠ¨åç›´æ¥é€€å‡º
      XposedHelpers.findAndHookMethod(
        "android.app.Activity",
        classLoader,
        "onResume",
        new XC_MethodHook() {
          @Override
          protected void beforeHookedMethod(
            XC_MethodHook.MethodHookParam param
          ) throws Throwable {
            Activity activity = (Activity) param.thisObject;
            ActivityManager am = (ActivityManager) activity.getSystemService(
              Context.ACTIVITY_SERVICE
            );
            if (am != null) {
              List<ActivityManager.RunningTaskInfo> tasks = am.getRunningTasks(
                1
              );
              if (
                !tasks.isEmpty() &&
                tasks
                  .get(0)
                  .topActivity.getPackageName()
                  .equals(currentTargetApp)
              ) {
                DetectedPackages detected = analyzeDetectedPackages();
                if (
                  !detected.installedPackages.isEmpty() ||
                  !detected.notInstalledPackages.isEmpty()
                ) {
                  //               log("âœ… é€šç”¨æ‹¦æˆªï¼šActivity å¯åŠ¨åç›´æ¥é€€å‡º");
                }
              }
            }
          }
        }
      );

      // åœºæ™¯4ï¼šæ‹¦æˆªå¯ç–‘æ£€æµ‹çº¿ç¨‹
      XposedHelpers.findAndHookMethod(
        "java.lang.Thread",
        classLoader,
        "run",
        new XC_MethodHook() {
          @Override
          protected void beforeHookedMethod(
            XC_MethodHook.MethodHookParam param
          ) throws Throwable {
            Thread thread = (Thread) param.thisObject;
            String threadName = thread.getName().toLowerCase();
            if (
              threadName.contains("check") ||
              threadName.contains("detect") ||
              threadName.contains("exit")
            ) {
              DetectedPackages detected = analyzeDetectedPackages();
              if (
                !detected.installedPackages.isEmpty() ||
                !detected.notInstalledPackages.isEmpty()
              ) {
                //            log("âš ï¸  æ£€æµ‹åˆ°å¯ç–‘æ£€æµ‹çº¿ç¨‹ï¼š" + threadName);
              }
            }
          }
        }
      );

      // åœºæ™¯5ï¼šæ‹¦æˆªRunnableå†…éƒ¨çš„ System.exit()
      hookRunnableSystemExit(classLoader);
      //   log("âœ… é€šç”¨é€€å‡ºæºå¤´æ‹¦æˆªåˆå§‹åŒ–å®Œæˆ");
    } catch (Throwable t) {
      log("é€€å‡ºæ‹¦æˆªåˆå§‹åŒ–å¤±è´¥: " + t.getMessage());
    }
  }

  // æ‹¦æˆªæ‰€æœ‰ Runnable å†…éƒ¨è°ƒç”¨çš„ System.exit()
  private void hookRunnableSystemExit(ClassLoader classLoader) {
    try {
      XposedHelpers.findAndHookMethod(
        "java.lang.Runnable",
        classLoader,
        "run",
        new XC_MethodHook() {
          @Override
          protected void beforeHookedMethod(
            final XC_MethodHook.MethodHookParam param
          ) throws Throwable {
            // æ£€æµ‹å½“å‰åº”ç”¨æ˜¯å¦æœ‰ä¼ªé€ åŒ…ï¼ˆæœ‰åˆ™å¼€å¯æ‹¦æˆªï¼‰
            DetectedPackages detected = analyzeDetectedPackages();
            if (
              detected.installedPackages.isEmpty() &&
              detected.notInstalledPackages.isEmpty()
            ) {
              return; // æ— ä¼ªé€ åŒ…ï¼Œæ”¾è¡Œ
            }

            // æ ¸å¿ƒï¼šä¸´æ—¶Hook System.exit()ï¼Œé˜»æ–­Runnableå†…éƒ¨è°ƒç”¨
            XC_MethodHook exitHook = new XC_MethodHook() {
              @Override
              protected void beforeHookedMethod(
                XC_MethodHook.MethodHookParam exitParam
              ) throws Throwable {
                // å½»åº•é˜»æ–­ System.exit()
                exitParam.setResult(null);
                exitParam.setThrowable(null);
                //     log("âœ… æ‹¦æˆªå¼‚æ­¥Runnableå†…éƒ¨çš„ System.exit()");
                // æ˜¾ç¤ºæç¤º
                new Handler(Looper.getMainLooper()).post(
                  new Runnable() {
                    @Override
                    public void run() {
                      Activity activity = getCurrentActivity();
                      if (activity != null) {
                        showSilentToast(activity, "å·²æ‹¦æˆªå¼‚æ­¥é€€å‡º");
                      }
                    }
                  }
                );
              }
            };

            // ä¸´æ—¶Hook System.exit() æ–¹æ³•
            Method exitMethod = Class.forName("java.lang.System").getMethod(
              "exit",
              int.class
            );
            XposedBridge.hookMethod(exitMethod, exitHook);

            // æ ¸å¿ƒå…¼å®¹ï¼šç”¨åå°„æ‰§è¡ŒåŸRunnableçš„ run() æ–¹æ³•ï¼Œé¿å¼€Xposed API
            try {
              Runnable originalRunnable = (Runnable) param.thisObject;
              originalRunnable.run(); // ç›´æ¥æ‰§è¡ŒåŸé€»è¾‘ï¼Œä¸ä¾èµ–Xposed API
            } catch (Throwable t) {
              log("æ‰§è¡ŒåŸRunnableå¼‚å¸¸: " + t.getMessage());
            } finally {
              // å¸è½½ä¸´æ—¶Hookï¼Œé¿å…å†…å­˜æ³„æ¼
              XposedBridge.unhookMethod(exitMethod, exitHook);
            }

            // é˜»æ–­åŸæ–¹æ³•åç»­æ‰§è¡Œï¼Œé¿å…é‡å¤è°ƒç”¨
            param.setResult(null);
          }
        }
      );
      //      log("âœ… å¼‚æ­¥Runnableå†…éƒ¨é€€å‡ºæ‹¦æˆªåˆå§‹åŒ–å®Œæˆ");
    } catch (Throwable t) {
      // log("Hook å†…éƒ¨exitå¤±è´¥: " + t.getMessage());
    }
  }

  // é™é»˜æç¤ºï¼ˆä¸ä¾èµ–å¼¹çª—ï¼Œå…¼å®¹ç³»ç»Ÿå¼ºåˆ¶é€€å‡ºåœºæ™¯ï¼‰
  private void showSilentToast(Activity activity, String message) {
    try {
      if (activity == null || activity.isFinishing()) {
        return;
      }
      // ä½¿ç”¨ç³»ç»Ÿ Toastï¼Œé¿å…è¢«åº”ç”¨å†…å¼¹çª—è¦†ç›–
      Toast toast = Toast.makeText(activity, message, Toast.LENGTH_SHORT);
      toast.setGravity(Gravity.CENTER, 0, 0);
      toast.show();
    } catch (Throwable t) {
      // å…œåº•ï¼šä½¿ç”¨ç³»ç»Ÿæ—¥å¿—æç¤º
      log("âš ï¸  æç¤ºå¤±è´¥ï¼š" + message);
    }
  }

  // ========== æƒé™ä¼ªé€ æ ¸å¿ƒæ–¹æ³• ==========
  private void hookQueryAllPackagesPermission(ClassLoader classLoader) {
    try {
      // 1. æ‹¦æˆªæ™®é€šæƒé™æ£€æŸ¥
      XposedHelpers.findAndHookMethod(
        "android.app.ApplicationPackageManager",
        classLoader,
        "checkPermission",
        String.class, // æƒé™å
        String.class, // åº”ç”¨åŒ…å
        new XC_MethodHook() {
          @Override
          protected void beforeHookedMethod(MethodHookParam param)
            throws Throwable {
            Boolean shouldFakePermission = permissionFakeMap.get(
              currentTargetApp
            );
            boolean fakeEnabled = shouldFakePermission != null
              ? shouldFakePermission
              : true;
            if (!fakeEnabled) return;

            String permission = (String) param.args[0];
            String targetPackage = (String) param.args[1];
            if (
              targetPackage != null &&
              targetPackage.equals(currentTargetApp) &&
              Arrays.asList(DETECTION_PERMISSIONS).contains(permission)
            ) {
              param.setResult(PackageManager.PERMISSION_GRANTED);
              return;
            }
          }
        }
      );

      // 2. æ‹¦æˆªAndroid 13+ é¢„æ£€æµ‹æƒé™ï¼ˆcheckPermissionForPreflightï¼‰
      try {
        XposedHelpers.findAndHookMethod(
          "android.app.ApplicationPackageManager",
          classLoader,
          "checkPermissionForPreflight",
          String.class,
          String.class,
          int.class,
          new XC_MethodHook() {
            @Override
            protected void beforeHookedMethod(MethodHookParam param)
              throws Throwable {
              Boolean shouldFakePermission = permissionFakeMap.get(
                currentTargetApp
              );
              boolean fakeEnabled = shouldFakePermission != null
                ? shouldFakePermission
                : true;
              if (!fakeEnabled) return;

              String permission = (String) param.args[0];
              String targetPackage = (String) param.args[1];
              if (
                targetPackage != null &&
                targetPackage.equals(currentTargetApp) &&
                Arrays.asList(DETECTION_PERMISSIONS).contains(permission)
              ) {
                param.setResult(PackageManager.PERMISSION_GRANTED);
              }
            }
          }
        );
      } catch (NoSuchMethodError e) {
        // Android 13ä»¥ä¸‹æ— æ­¤æ–¹æ³•ï¼Œå¿½ç•¥
      }

      // 3. æ‹¦æˆª ContextWrapper.checkSelfPermissionï¼ˆåº”ç”¨è‡ªæŸ¥æƒé™ï¼‰
      try {
        XposedHelpers.findAndHookMethod(
          "android.content.ContextWrapper",
          classLoader,
          "checkSelfPermission",
          String.class,
          new XC_MethodHook() {
            @Override
            protected void beforeHookedMethod(MethodHookParam param)
              throws Throwable {
              Boolean shouldFakePermission = permissionFakeMap.get(
                currentTargetApp
              );
              boolean fakeEnabled = shouldFakePermission != null
                ? shouldFakePermission
                : true;
              if (!fakeEnabled) return;

              String permission = (String) param.args[0];
              if (Arrays.asList(DETECTION_PERMISSIONS).contains(permission)) {
                param.setResult(PackageManager.PERMISSION_GRANTED);
              }
            }
          }
        );
      } catch (Throwable t) {
        // å…œåº•ï¼šHook ContextImpl.checkSelfPermission
        try {
          XposedHelpers.findAndHookMethod(
            "android.app.ContextImpl",
            classLoader,
            "checkSelfPermission",
            String.class,
            new XC_MethodHook() {
              @Override
              protected void beforeHookedMethod(MethodHookParam param)
                throws Throwable {
                Boolean shouldFakePermission = permissionFakeMap.get(
                  currentTargetApp
                );
                boolean fakeEnabled = shouldFakePermission != null
                  ? shouldFakePermission
                  : true;
                if (!fakeEnabled) return;

                String permission = (String) param.args[0];
                if (Arrays.asList(DETECTION_PERMISSIONS).contains(permission)) {
                  param.setResult(PackageManager.PERMISSION_GRANTED);
                }
              }
            }
          );
        } catch (Throwable e) {
          log("Hook ContextImpl.checkSelfPermissionå¤±è´¥: " + e.getMessage());
        }
      }

      // 4. Hook PackageManager.checkPermission æ‰€æœ‰é‡è½½ç‰ˆæœ¬ï¼ˆå…œåº•ï¼‰
      try {
        Class<?> packageManagerClass = XposedHelpers.findClass(
          "android.app.ApplicationPackageManager",
          classLoader
        );
        XposedBridge.hookAllMethods(
          packageManagerClass,
          "checkPermission",
          new XC_MethodHook() {
            @Override
            protected void beforeHookedMethod(MethodHookParam param)
              throws Throwable {
              Boolean shouldFakePermission = permissionFakeMap.get(
                currentTargetApp
              );
              boolean fakeEnabled = shouldFakePermission != null
                ? shouldFakePermission
                : true;
              if (!fakeEnabled) return;

              String permission = null;
              String targetPackage = null;
              for (Object arg : param.args) {
                if (arg instanceof String) {
                  if (
                    permission == null &&
                    Arrays.asList(DETECTION_PERMISSIONS).contains(arg)
                  ) {
                    permission = (String) arg;
                  } else if (
                    targetPackage == null &&
                    !Arrays.asList(DETECTION_PERMISSIONS).contains(arg)
                  ) {
                    targetPackage = (String) arg;
                  }
                }
              }
              if (
                permission != null &&
                targetPackage != null &&
                targetPackage.equals(currentTargetApp)
              ) {
                param.setResult(PackageManager.PERMISSION_GRANTED);
              }
            }
          }
        );
      } catch (Throwable t) {
        log("Hook PackageManager.checkPermissioné‡è½½å¤±è´¥: " + t.getMessage());
      }

      // 5. æ‹¦æˆª AndroidX PackageManagerCompatï¼ˆå…¼å®¹åº“ï¼‰
      try {
        Class<?> packageManagerCompatClass = XposedHelpers.findClassIfExists(
          "androidx.core.content.PackageManagerCompat",
          classLoader
        );
        if (packageManagerCompatClass != null) {
          XposedBridge.hookAllMethods(
            packageManagerCompatClass,
            "checkPermission",
            new XC_MethodHook() {
              @Override
              protected void beforeHookedMethod(MethodHookParam param)
                throws Throwable {
                Boolean shouldFakePermission = permissionFakeMap.get(
                  currentTargetApp
                );
                boolean fakeEnabled = shouldFakePermission != null
                  ? shouldFakePermission
                  : true;
                if (!fakeEnabled) return;

                for (Object arg : param.args) {
                  if (
                    arg instanceof String &&
                    Arrays.asList(DETECTION_PERMISSIONS).contains(arg)
                  ) {
                    param.setResult(PackageManager.PERMISSION_GRANTED);
                    break;
                  }
                }
              }
            }
          );
        }
      } catch (Throwable t) {
        // å¿½ç•¥æ— AndroidXçš„æƒ…å†µ
      }

      // 6. æ‹¦æˆª ActivityManager.checkPermissionï¼ˆç³»ç»ŸæœåŠ¡çº§æŸ¥è¯¢ï¼‰
      try {
        Class<?> amClass = XposedHelpers.findClass(
          "android.app.ActivityManager",
          classLoader
        );
        // å…ˆåˆ¤æ–­æ–¹æ³•æ˜¯å¦å­˜åœ¨
        Method checkPermMethod = null;
        try {
          checkPermMethod = amClass.getDeclaredMethod(
            "checkPermission",
            String.class,
            int.class,
            int.class
          );
        } catch (NoSuchMethodException e) {
          //    log("ActivityManageræ— checkPermissionæ–¹æ³•ï¼Œè·³è¿‡Hook");
          return;
        }
        // æ–¹æ³•å­˜åœ¨æ—¶æ‰Hook
        XposedBridge.hookMethod(
          checkPermMethod,
          new XC_MethodHook() {
            @Override
            protected void beforeHookedMethod(MethodHookParam param)
              throws Throwable {
              Boolean shouldFakePermission = permissionFakeMap.get(
                currentTargetApp
              );
              boolean fakeEnabled = shouldFakePermission != null
                ? shouldFakePermission
                : true;
              if (!fakeEnabled) return;

              String permission = (String) param.args[0];
              if (Arrays.asList(DETECTION_PERMISSIONS).contains(permission)) {
                param.setResult(PackageManager.PERMISSION_GRANTED);
              }
            }
          }
        );
      } catch (Throwable t) {
        log("Hook ActivityManager.checkPermissionå¤±è´¥: " + t.getMessage());
      }

      // 7. æ‹¦æˆª PackageManager.getPermissionInfoï¼ˆæƒé™ä¿¡æ¯æŸ¥è¯¢ï¼‰
      try {
        XposedHelpers.findAndHookMethod(
          "android.app.ApplicationPackageManager",
          classLoader,
          "getPermissionInfo",
          String.class,
          int.class,
          new XC_MethodHook() {
            @Override
            protected void beforeHookedMethod(MethodHookParam param)
              throws Throwable {
              Boolean shouldFakePermission = permissionFakeMap.get(
                currentTargetApp
              );
              boolean fakeEnabled = shouldFakePermission != null
                ? shouldFakePermission
                : true;
              if (!fakeEnabled) return;

              String permissionName = (String) param.args[0];
              if (
                Arrays.asList(DETECTION_PERMISSIONS).contains(permissionName)
              ) {
                try {
                  Class<?> permissionInfoClass = Class.forName(
                    "android.content.pm.PermissionInfo"
                  );
                  Object fakePermissionInfo = permissionInfoClass.newInstance();
                  XposedHelpers.setObjectField(
                    fakePermissionInfo,
                    "name",
                    permissionName
                  );
                  XposedHelpers.setObjectField(
                    fakePermissionInfo,
                    "packageName",
                    currentTargetApp
                  );
                  XposedHelpers.setIntField(
                    fakePermissionInfo,
                    "protectionLevel",
                    XposedHelpers.getStaticIntField(
                      Class.forName("android.content.pm.PermissionInfo"),
                      "PROTECTION_NORMAL"
                    )
                  );
                  XposedHelpers.setIntField(fakePermissionInfo, "flags", 0);
                  param.setResult(fakePermissionInfo);
                } catch (Throwable e) {
                  log("ä¼ªé€ PermissionInfoå¤±è´¥: " + e.getMessage());
                }
              }
            }
          }
        );
      } catch (Throwable t) {
        log("Hook getPermissionInfoå¤±è´¥: " + t.getMessage());
      }
      //   log("âœ… æ‰€æœ‰æ£€æµ‹æƒé™Hookåˆå§‹åŒ–å®Œæˆï¼ˆæ”¯æŒå³æ—¶ç”Ÿæ•ˆï¼‰");
    } catch (Throwable t) {
      log("âŒ Hookæ£€æµ‹æƒé™å¤±è´¥: " + t.getMessage());
      // åŸºç¡€å…œåº•Hook
      try {
        hookBasicPermissionChecks(classLoader);
      } catch (Throwable t2) {
        log("åŸºç¡€æƒé™å…œåº•Hookå¤±è´¥: " + t2.getMessage());
      }
    }
  }

  // ========== åŸºç¡€æƒé™æ£€æŸ¥Hook ==========
  private void hookBasicPermissionChecks(ClassLoader classLoader) {
    try {
      // æœ€åŸºæœ¬çš„æƒé™æ£€æŸ¥Hook
      XposedHelpers.findAndHookMethod(
        "android.app.ContextImpl",
        classLoader,
        "checkPermission",
        String.class,
        int.class,
        int.class,
        new XC_MethodHook() {
          @Override
          protected void beforeHookedMethod(MethodHookParam param)
            throws Throwable {
            // æ£€æŸ¥æƒé™ä¼ªé€ é…ç½®
            Boolean shouldFakePermission = permissionFakeMap.get(
              currentTargetApp
            );
            boolean fakePermissionEnabled = shouldFakePermission != null
              ? shouldFakePermission
              : true;

            if (!fakePermissionEnabled) {
              return;
            }

            String permission = (String) param.args[0];
            if (Arrays.asList(DETECTION_PERMISSIONS).contains(permission)) {
              param.setResult(PackageManager.PERMISSION_GRANTED);
              // log("ã€å…œåº•æƒé™ä¼ªé€ ã€‘ContextImpl.checkPermission -> æˆäºˆæƒé™: " +
              // permission);
            }
          }
        }
      );
      // log("âœ… åŸºç¡€æƒé™HookæˆåŠŸï¼ˆæ ¹æ®é…ç½®ï¼‰");
    } catch (Throwable t) {
      // å¿½ç•¥é”™è¯¯
    }
  }

  // ==========  PACKAGE_USAGE_STATS æƒé™ä¼ªé€  ==========
  private void hookPackageUsageStatsPermission(ClassLoader classLoader) {
    try {
      // æ£€æŸ¥æƒé™ä¼ªé€ é…ç½®
      Boolean shouldFakePermission = permissionFakeMap.get(currentTargetApp);
      boolean fakePermissionEnabled = shouldFakePermission != null
        ? shouldFakePermission
        : true;

      if (!fakePermissionEnabled) {
        // log("ã€æƒé™ä¼ªé€ ã€‘PACKAGE_USAGE_STATS æƒé™ä¼ªé€ å·²å…³é—­ï¼Œè·³è¿‡Hook");
        return;
      }

      // 1. æ‹¦æˆªqueryUsageStatsæ–¹æ³•
      XposedHelpers.findAndHookMethod(
        "android.app.usage.UsageStatsManager",
        classLoader,
        "queryUsageStats",
        int.class,
        long.class,
        long.class,
        new XC_MethodHook() {
          @Override
          protected void beforeHookedMethod(MethodHookParam param)
            throws Throwable {
            // å†æ¬¡æ£€æŸ¥æƒé™ä¼ªé€ çŠ¶æ€
            Boolean shouldFake = permissionFakeMap.get(currentTargetApp);
            if (shouldFake != null && !shouldFake) {
              return; // å¦‚æœå·²å…³é—­ï¼Œä¸ä¼ªé€ 
            }

            List<Object> fakeList = new ArrayList<>();
            synchronized (globalCapturedPackages) {
              for (String pkg : globalCapturedPackages) {
                try {
                  Class<?> usageStatsClass = Class.forName(
                    "android.app.usage.UsageStats"
                  );
                  Object stats = usageStatsClass.newInstance();
                  XposedHelpers.setObjectField(stats, "mPackageName", pkg);
                  XposedHelpers.setLongField(
                    stats,
                    "mTotalTimeInForeground",
                    3600000L
                  );
                  fakeList.add(stats);
                } catch (Exception e) {
                  // å¿½ç•¥åˆ›å»ºå¤±è´¥çš„åŒ…
                }
              }
            }
            param.setResult(fakeList);
          }
        }
      );

      // 2. æ‹¦æˆªgetUsageStatsForPackageæ–¹æ³•
      XposedHelpers.findAndHookMethod(
        "android.app.usage.UsageStatsManager",
        classLoader,
        "getUsageStatsForPackage",
        String.class,
        long.class,
        long.class,
        new XC_MethodHook() {
          @Override
          protected void beforeHookedMethod(MethodHookParam param)
            throws Throwable {
            // å†æ¬¡æ£€æŸ¥æƒé™ä¼ªé€ çŠ¶æ€
            Boolean shouldFake = permissionFakeMap.get(currentTargetApp);
            if (shouldFake != null && !shouldFake) {
              return; // å¦‚æœå·²å…³é—­ï¼Œä¸ä¼ªé€ 
            }

            String pkg = (String) param.args[0];
            List<Object> fakeList = new ArrayList<>();

            synchronized (globalCapturedPackages) {
              if (globalCapturedPackages.contains(pkg)) {
                try {
                  Class<?> usageStatsClass = Class.forName(
                    "android.app.usage.UsageStats"
                  );
                  Object stats = usageStatsClass.newInstance();
                  XposedHelpers.setObjectField(stats, "mPackageName", pkg);
                  XposedHelpers.setLongField(
                    stats,
                    "mTotalTimeInForeground",
                    3600000L
                  );
                  fakeList.add(stats);
                } catch (Exception e) {
                  // å¿½ç•¥åˆ›å»ºå¤±è´¥
                }
              }
            }
            param.setResult(fakeList);
          }
        }
      );
      // log("âœ… PACKAGE_USAGE_STATSæƒé™Hookå®Œæˆ");
    } catch (Throwable t) {
      // å¿½ç•¥é”™è¯¯
    }
  }

  // ========== å¼¹çª—å–æ¶ˆHookæ–¹æ³• ==========
  private void hookDialogCancelableMethods(ClassLoader classLoader) {
    try {
      // 1. Hook Dialog.setCancelable() æ–¹æ³•
      XposedHelpers.findAndHookMethod(
        "android.app.Dialog",
        classLoader,
        "setCancelable",
        boolean.class,
        new XC_MethodHook() {
          @Override
          protected void beforeHookedMethod(MethodHookParam param)
            throws Throwable {
            try {
              boolean originalCancelable = param.args[0];

              // è·å–å½“å‰Activityä¸Šä¸‹æ–‡
              Context context = null;
              try {
                context = (Context) XposedHelpers.getObjectField(
                  param.thisObject,
                  "mContext"
                );
              } catch (Throwable e) {
                try {
                  context = (Context) XposedHelpers.getObjectField(
                    param.thisObject,
                    "context"
                  );
                } catch (Throwable e2) {
                  // å°è¯•å…¶ä»–å­—æ®µå
                  try {
                    context = (Context) XposedHelpers.callMethod(
                      param.thisObject,
                      "getContext"
                    );
                  } catch (Throwable e3) {
                    log("æ— æ³•è·å–Dialogä¸Šä¸‹æ–‡");
                  }
                }
              }

              // æ£€æŸ¥æ˜¯å¦ä¸ºå½“å‰ç›®æ ‡åº”ç”¨
              if (context != null) {
                String packageName = context.getPackageName();
                if (packageName.equals(currentTargetApp)) {
                  // å¼ºåˆ¶è®¾ç½®ä¸ºå¯å–æ¶ˆ
                  param.args[0] = true;
                  //   log("âœ… å¼ºåˆ¶è®¾ç½®Dialogå¯å–æ¶ˆï¼ŒåŸçŠ¶æ€: " + originalCancelable);

                  // å¯é€‰ï¼šè®°å½•å“ªä¸ªActivityæˆ–ç±»è°ƒç”¨äº†æ­¤æ–¹æ³•
                  String dialogClassName = param.thisObject
                    .getClass()
                    .getName();
                  String callerStackTrace = getSimpleStackTrace(10);
                  //    log("Dialogç±»: " + dialogClassName + "ï¼Œè°ƒç”¨æ ˆ: " +
                  // callerStackTrace);
                }
              }
            } catch (Throwable t) {
              log("Hook Dialogå¼‚å¸¸: " + t.getMessage());
            }
          }
        }
      );

      // 2. Hook Dialog.setCanceledOnTouchOutside() æ–¹æ³•
      XposedHelpers.findAndHookMethod(
        "android.app.Dialog",
        classLoader,
        "setCanceledOnTouchOutside",
        boolean.class,
        new XC_MethodHook() {
          @Override
          protected void beforeHookedMethod(MethodHookParam param)
            throws Throwable {
            try {
              boolean originalCanceledOnTouchOutside = (boolean) param.args[0];

              // å¼ºåˆ¶å…è®¸å¤–éƒ¨ç‚¹å‡»å–æ¶ˆ
              param.args[0] = true;
              //   log("âœ… å¼ºåˆ¶è®¾ç½®Dialogå¯å¤–éƒ¨ç‚¹å‡»å–æ¶ˆï¼ŒåŸçŠ¶æ€: " +
              // originalCanceledOnTouchOutside);
            } catch (Throwable t) {
              log("Hook Dialogå¼‚å¸¸: " + t.getMessage());
            }
          }
        }
      );

      // 3. Hook AlertDialog.Builder.setCancelable() æ–¹æ³•
      XposedHelpers.findAndHookMethod(
        "android.app.AlertDialog$Builder",
        classLoader,
        "setCancelable",
        boolean.class,
        new XC_MethodHook() {
          @Override
          protected void beforeHookedMethod(MethodHookParam param)
            throws Throwable {
            try {
              boolean originalCancelable = (boolean) param.args[0];

              // å¼ºåˆ¶è®¾ç½®ä¸ºå¯å–æ¶ˆ
              param.args[0] = true;
              //   log("âœ… å¼ºåˆ¶è®¾ç½®AlertDialog.Builderå¯å–æ¶ˆï¼ŒåŸçŠ¶æ€: " + originalCancelable);
            } catch (Throwable t) {
              log("Hook AlertDialogå¼‚å¸¸: " + t.getMessage());
            }
          }
        }
      );

      // 4. Hook Dialogçš„show()æ–¹æ³•
      XposedHelpers.findAndHookMethod(
        "android.app.Dialog",
        classLoader,
        "show",
        new XC_MethodHook() {
          @Override
          protected void beforeHookedMethod(MethodHookParam param)
            throws Throwable {
            try {
              Object dialog = param.thisObject;
              // è®¾ç½®å¯å–æ¶ˆ
              XposedHelpers.callMethod(dialog, "setCancelable", true);
              // è®¾ç½®å¯å¤–éƒ¨ç‚¹å‡»å–æ¶ˆ
              XposedHelpers.callMethod(
                dialog,
                "setCanceledOnTouchOutside",
                true
              );
              //  log("âœ… ç¡®ä¿Dialogæ˜¾ç¤ºæ—¶å¯å–æ¶ˆ");
            } catch (Throwable t) {
              log("Hook Dialog.showå¼‚å¸¸: " + t.getMessage());
            }
          }
        }
      );

      // 5. Hook AlertDialogçš„create()æ–¹æ³•
      XposedHelpers.findAndHookMethod(
        "android.app.AlertDialog$Builder",
        classLoader,
        "create",
        new XC_MethodHook() {
          @Override
          protected void afterHookedMethod(MethodHookParam param)
            throws Throwable {
            try {
              Object dialog = param.getResult();
              if (dialog != null) {
                // ç¡®ä¿åˆ›å»ºçš„Dialogå¯å–æ¶ˆ
                XposedHelpers.callMethod(dialog, "setCancelable", true);
                XposedHelpers.callMethod(
                  dialog,
                  "setCanceledOnTouchOutside",
                  true
                );
                //    log("âœ… ç¡®ä¿AlertDialog.create()åˆ›å»ºçš„Dialogå¯å–æ¶ˆ");
              }
            } catch (Throwable t) {
              log("Hook AlertDialogå¼‚å¸¸: " + t.getMessage());
            }
          }
        }
      );

      // 6. Hook ProgressDialog
      try {
        XposedHelpers.findAndHookMethod(
          "android.app.ProgressDialog",
          classLoader,
          "setCancelable",
          boolean.class,
          new XC_MethodHook() {
            @Override
            protected void beforeHookedMethod(MethodHookParam param)
              throws Throwable {
              param.args[0] = true;
              //   log("âœ… å¼ºåˆ¶è®¾ç½®ProgressDialogå¯å–æ¶ˆ");
            }
          }
        );
      } catch (Throwable t) {
        // ProgressDialogå¯èƒ½åœ¨è¾ƒé«˜APIç‰ˆæœ¬ä¸­ä¸å­˜åœ¨
      }

      // 7. Hook DialogFragment
      hookDialogFragmentMethods(classLoader);
      // 8. Hook AndroidX DialogFragment
      hookAndroidXDialogFragmentMethods(classLoader);
      //  log("âœ… å¼¹çª—å–æ¶ˆHookå®Œæˆ");

    } catch (Throwable t) {
      log("âŒ Hookå¼¹çª—å–æ¶ˆæ–¹æ³•å¤±è´¥: " + t.getMessage());
    }
  }

  // ========== DialogFragment Hookæ–¹æ³• ==========
  private void hookDialogFragmentMethods(ClassLoader classLoader) {
    try {
      Class<?> dialogFragmentClass = Class.forName(
        "android.app.DialogFragment",
        false,
        classLoader
      );

      // Hook DialogFragmentçš„onCreateDialogæ–¹æ³•
      XposedHelpers.findAndHookMethod(
        dialogFragmentClass,
        "onCreateDialog",
        Bundle.class,
        new XC_MethodHook() {
          @Override
          protected void afterHookedMethod(MethodHookParam param)
            throws Throwable {
            try {
              Object dialog = param.getResult();
              if (dialog != null) {
                // è®¾ç½®Dialogå¯å–æ¶ˆ
                XposedHelpers.callMethod(dialog, "setCancelable", true);
                XposedHelpers.callMethod(
                  dialog,
                  "setCanceledOnTouchOutside",
                  true
                );

                // è®¾ç½®DialogFragmentæœ¬èº«å¯å–æ¶ˆ
                Object dialogFragment = param.thisObject;
                XposedHelpers.callMethod(dialogFragment, "setCancelable", true);
                //    log("âœ… è®¾ç½®DialogFragmentåˆ›å»ºçš„Dialogå¯å–æ¶ˆ");
              }
            } catch (Throwable t) {
              //    log("Hook DialogFragment.onCreateDialogå¼‚å¸¸: " +
              // t.getMessage());
            }
          }
        }
      );

      // Hook DialogFragmentçš„setCancelableæ–¹æ³•
      XposedHelpers.findAndHookMethod(
        dialogFragmentClass,
        "setCancelable",
        boolean.class,
        new XC_MethodHook() {
          @Override
          protected void beforeHookedMethod(MethodHookParam param)
            throws Throwable {
            // å¼ºåˆ¶è®¾ç½®ä¸ºå¯å–æ¶ˆ
            param.args[0] = true;
            //     log("âœ… å¼ºåˆ¶è®¾ç½®DialogFragmentå¯å–æ¶ˆ");
          }
        }
      );
    } catch (ClassNotFoundException e) {
      // DialogFragmentç±»ä¸å­˜åœ¨ï¼Œè·³è¿‡
    } catch (Throwable t) {
      //    log("Hook DialogFragmentæ–¹æ³•å¤±è´¥: " + t.getMessage());
    }
  }

  // ========== AndroidX DialogFragment Hookæ–¹æ³• ==========
  private void hookAndroidXDialogFragmentMethods(ClassLoader classLoader) {
    try {
      Class<?> dialogFragmentClass = Class.forName(
        "androidx.fragment.app.DialogFragment",
        false,
        classLoader
      );

      // Hook AndroidX DialogFragmentçš„onCreateDialogæ–¹æ³•
      XposedHelpers.findAndHookMethod(
        dialogFragmentClass,
        "onCreateDialog",
        Bundle.class,
        new XC_MethodHook() {
          @Override
          protected void afterHookedMethod(MethodHookParam param)
            throws Throwable {
            try {
              Object dialog = param.getResult();
              if (dialog != null) {
                // è®¾ç½®Dialogå¯å–æ¶ˆ
                XposedHelpers.callMethod(dialog, "setCancelable", true);
                XposedHelpers.callMethod(
                  dialog,
                  "setCanceledOnTouchOutside",
                  true
                );

                // è®¾ç½®DialogFragmentæœ¬èº«å¯å–æ¶ˆ
                Object dialogFragment = param.thisObject;
                XposedHelpers.callMethod(dialogFragment, "setCancelable", true);
                //    log("âœ… è®¾ç½®AndroidX DialogFragmentåˆ›å»ºçš„Dialogå¯å–æ¶ˆ");
              }
            } catch (Throwable t) {
              log("Hook AndroidX å¼‚å¸¸: " + t.getMessage());
            }
          }
        }
      );

      // Hook AndroidX DialogFragmentçš„setCancelableæ–¹æ³•
      XposedHelpers.findAndHookMethod(
        dialogFragmentClass,
        "setCancelable",
        boolean.class,
        new XC_MethodHook() {
          @Override
          protected void beforeHookedMethod(MethodHookParam param)
            throws Throwable {
            // å¼ºåˆ¶è®¾ç½®ä¸ºå¯å–æ¶ˆ
            param.args[0] = true;
            // log("âœ… å¼ºåˆ¶è®¾ç½®AndroidX DialogFragmentå¯å–æ¶ˆ");
          }
        }
      );
    } catch (ClassNotFoundException e) {
      // AndroidX DialogFragmentç±»ä¸å­˜åœ¨ï¼Œè·³è¿‡
    } catch (Throwable t) {
      log("Hook AndroidX Dialogæ–¹æ³•å¤±è´¥: " + t.getMessage());
    }
  }

  // ========== è·å–è°ƒç”¨æ ˆæ–¹æ³• ==========
  private String getSimpleStackTrace(int maxDepth) {
    try {
      StackTraceElement[] stackTrace = Thread.currentThread().getStackTrace();
      StringBuilder sb = new StringBuilder();

      int startIndex = Math.min(3, stackTrace.length); // è·³è¿‡å‰å‡ ä¸ªå†…éƒ¨æ–¹æ³•
      int endIndex = Math.min(startIndex + maxDepth, stackTrace.length);

      for (int i = startIndex; i < endIndex; i++) {
        StackTraceElement element = stackTrace[i];
        String className = element.getClassName();
        String methodName = element.getMethodName();
        int lineNumber = element.getLineNumber();

        // ç®€åŒ–ç±»å
        if (className.contains(".")) {
          className = className.substring(className.lastIndexOf('.') + 1);
        }

        sb
          .append(className)
          .append(".")
          .append(methodName)
          .append(":")
          .append(lineNumber);

        if (i < endIndex - 1) {
          sb.append(" â† ");
        }
      }

      return sb.toString();
    } catch (Throwable t) {
      return "æ— æ³•è·å–è°ƒç”¨æ ˆ";
    }
  }

  // ========== æ ¸å¿ƒHookæ–¹æ³• ==========
  private void hookKeyMethods(ClassLoader classLoader) {
    try {
    
     hookGetPackageInfo(classLoader);
      hookGetApplicationInfo(classLoader);
      hookGetInstalledPackages(classLoader);
      hookGetInstalledApplications(classLoader);
      
    } catch (Throwable t) {
      log("Hookå…³é”®æ–¹æ³•å¤±è´¥: " + t);
    }
  }

  // ========== æ™ºèƒ½ä¼ªé€ æ ¸å¿ƒæ–¹æ³•==========
  // 1. è®°å½•æŸ¥è¯¢æ¨¡å¼
  private void recordQueryPattern(String packageName, int flags) {
    try {
      queryPatterns.add(new QueryPattern(currentTargetApp, packageName, flags));
      // ä¿æŒæœ€è¿‘500æ¡è®°å½•
      if (queryPatterns.size() > 500) {
        queryPatterns.remove(0);
      }
    } catch (Throwable t) {
      // é™é»˜å¤±è´¥
    }
  }

  // 2. å®‰å…¨è®¾ç½®installerPackageNameï¼ˆå…¼å®¹ä¸åŒAndroidç‰ˆæœ¬ï¼‰
  private void setInstallerPackageNameSafe(PackageInfo pi, String installer) {
    try {
      // åªä½¿ç”¨XposedHelpers
      XposedHelpers.setObjectField(pi, "installerPackageName", installer);
    } catch (Throwable t) {
      // å¦‚æœå¤±è´¥ï¼Œå°è¯•åœ¨ApplicationInfo.metaDataä¸­å­˜å‚¨
      try {
        if (pi.applicationInfo != null && installer != null) {
          if (pi.applicationInfo.metaData == null) {
            pi.applicationInfo.metaData = new Bundle();
          }
          pi.applicationInfo.metaData.putString("installer_source", installer);
        }
      } catch (Throwable t2) {
        // å®Œå…¨å¤±è´¥ï¼Œè®°å½•æ—¥å¿—
        // log("âš ï¸ æ— æ³•è®¾ç½®installerPackageNameï¼ŒAndroidç‰ˆæœ¬å¯èƒ½è¿‡ä½: " + Build.VERSION.SDK_INT);
      }
    }
  }

  // 3. æ™ºèƒ½ç‰ˆæœ¬å·ç”Ÿæˆå™¨
  private String generateSmartVersion(String packageName) {
    if (versionCache.containsKey(packageName)) {
      return versionCache.get(packageName);
    }

    if (packageName == null || packageName.isEmpty()) {
      String defaultVersion = "1.0.0";
      versionCache.put("", defaultVersion);
      return defaultVersion;
    }

    // åŸºäºåŒ…åhashç”Ÿæˆç¡®å®šæ€§ç‰ˆæœ¬
    int hash = Math.abs(packageName.hashCode());
    String version;

    // æ ¹æ®åŒ…åé•¿åº¦å†³å®šç‰ˆæœ¬æ ¼å¼
    int nameLength = packageName.length();

    if (nameLength < 15) {
      // çŸ­åŒ…åï¼šç®€å•ç‰ˆæœ¬ x.x
      int major = (hash % 5) + 1; // 1-5
      int minor = (hash / 7) % 20; // 0-19
      version = String.format("%d.%d", major, minor);
    } else if (nameLength < 25) {
      // ä¸­ç­‰åŒ…åï¼šæ ‡å‡†ç‰ˆæœ¬ x.x.x
      int major = (hash % 8) + 1; // 1-8
      int minor = (hash / 13) % 30; // 0-29
      int patch = (hash / 29) % 100; // 0-99
      version = String.format("%d.%d.%d", major, minor, patch);
    } else {
      // é•¿åŒ…åï¼šè¯¦ç»†ç‰ˆæœ¬ x.x.x.x
      int major = (hash % 4) + 1; // 1-4
      int minor = (hash / 17) % 10; // 0-9
      int patch = (hash / 31) % 50; // 0-49
      int build = (hash / 53) % 10; // 0-9
      version = String.format("%d.%d.%d.%d", major, minor, patch, build);
    }

    versionCache.put(packageName, version);
    return version;
  }

  // 4. æ™ºèƒ½ç‰ˆæœ¬ç ç”Ÿæˆå™¨
  private int generateSmartVersionCode(String packageName, String versionName) {
    if (versionCodeCache.containsKey(packageName)) {
      return versionCodeCache.get(packageName);
    }

    int versionCode;
    int hash = Math.abs(packageName.hashCode());

    try {
      // å°è¯•ä»ç‰ˆæœ¬å·æå–æ•°å­—
      String cleanVersion = versionName.replaceAll("[^0-9.]", "");
      String[] parts = cleanVersion.split("\\.");

      if (parts.length >= 2) {
        // ä»ç‰ˆæœ¬å·ç”Ÿæˆï¼šä¾‹å¦‚ 2.1.3 -> 2013
        int code = 0;
        for (int i = 0; i < Math.min(parts.length, 3); i++) {
          try {
            int num = Integer.parseInt(parts[i]) % 100;
            code = code * 100 + num;
          } catch (NumberFormatException e) {
            code = code * 100 + ((hash >> (i * 8)) % 100);
          }
        }
        // åˆå§‹å†…éƒ¨ç‰ˆæœ¬å·1000èµ·ã€‚æ”¹ä¸º1èµ·
        versionCode = Math.max(Math.abs(code), 1);
      } else {
        // ç”Ÿæˆéšæœºç‰ˆæœ¬ç  1000-9999 æ”¹ä¸º1-9000
        versionCode = 1 + (hash % 9000);
      }
    } catch (Exception e) {
      versionCode = 1 + random.nextInt(9000);
    }

    versionCodeCache.put(packageName, versionCode);
    return versionCode;
  }

  // 5. æ™ºèƒ½å®‰è£…æ—¶é—´ç”Ÿæˆå™¨
  private long generateSmartInstallTime(String packageName) {
    if (installTimeCache.containsKey(packageName)) {
      return installTimeCache.get(packageName);
    }

    int hash = Math.abs(packageName.hashCode());

    // å®‰è£…æ—¶é—´ï¼š3ä¸ªæœˆåˆ°2å¹´å‰æ”¹ä¸º9å¤©-72å¤©
    long twoYearsAgo =
      System.currentTimeMillis() - (1000L * 60 * 60 * 24 * 36 * 2);
    long threeMonthsAgo =
      System.currentTimeMillis() - (1000L * 60 * 60 * 24 * 3 * 3);

    // ä½¿ç”¨åŒ…åhashç¡®å®šæ—¶é—´
    long timeRange = twoYearsAgo - threeMonthsAgo;
    long timeOffset = hash % timeRange;
    long installTime = twoYearsAgo - timeOffset;

    installTimeCache.put(packageName, installTime);
    return installTime;
  }

  // 6. æ™ºèƒ½æ›´æ–°æ—¶é—´ç”Ÿæˆå™¨
  private long generateSmartUpdateTime(String packageName, long installTime) {
    int hash = Math.abs(packageName.hashCode());

    // æ›´æ–°æ—¶é—´åœ¨å®‰è£…å7-180å¤©
    long daysAfter = 7 + (hash % 174); // 7-180å¤©
    return installTime + (1000L * 60 * 60 * 24 * daysAfter);
  }

  // 7. æ™ºèƒ½å®‰è£…æ¥æºç”Ÿæˆå™¨
  private String generateSmartInstaller(String packageName) {
    if (installerCache.containsKey(packageName)) {
      return installerCache.get(packageName);
    }

    if (packageName == null) {
      return null;
    }

    int hash = Math.abs(packageName.hashCode());
    String installer;

    switch (hash % 11) { // 0-10å…±11ç§å¯èƒ½
      case 0:
        installer = "com.android.vending";
        break; // Google Play
      case 1:
        installer = "com.tencent.android.qqdownloader";
        break; // åº”ç”¨å®
      case 2:
        installer = "com.xiaomi.market";
        break; // å°ç±³å•†åº—
      case 3:
        installer = "com.huawei.appmarket";
        break; // åä¸ºå•†åº—
      case 4:
        installer = "com.oppo.market";
        break; // OPPOå•†åº—
      case 5:
        installer = "com.vivo.appstore";
        break; // VIVOå•†åº—
      case 6:
        installer = "com.baidu.appsearch";
        break; // ç™¾åº¦
      case 7:
        installer = "com.wandoujia.phoenix2";
        break; // è±Œè±†èš
      case 8:
        installer = "com.meizu.mstore";
        break; // é­…æ—
      case 9:
        installer = "com.samsung.android.app.smartswitch";
        break; // ä¸‰æ˜Ÿ
      case 10:
        installer = null;
        break; // æµè§ˆå™¨/ä¾§è½½
      default:
        installer = null;
      //æ— æ¥æº
    }

    installerCache.put(packageName, installer);
    return installer;
  }

  // 8. æ™ºèƒ½åº”ç”¨åç§°ç”Ÿæˆå™¨
  private String generateSmartAppName(String packageName) {
    if (packageName == null || packageName.length() < 2) {
      return "ä¼ªé€ App";
    }

    // ç¼“å­˜æ£€æŸ¥
    if (appNameCache.containsKey(packageName)) {
      return appNameCache.get(packageName);
    }

    // ç®—æ³•ï¼šä»åŒ…åæå–æœ‰æ„ä¹‰çš„åç§°
    String appName;

    // 1. å°è¯•æå–æœ€åä¸€ä¸ªæœ‰æ„ä¹‰çš„éƒ¨åˆ†
    String[] parts = packageName.split("\\.");
    String candidate = "";

    for (int i = parts.length - 1; i >= 0; i--) {
      if (
        parts[i].length() > 2 &&
        !parts[i].matches("com|org|net|io|co|app|android|mobile|plus")
      ) {
        candidate = parts[i];
        break;
      }
    }

    // 2. å¦‚æœæ²¡æ‰¾åˆ°æœ‰æ„ä¹‰çš„éƒ¨åˆ†ï¼Œç”¨æœ€åä¸€ä¸ª
    if (candidate.isEmpty() && parts.length > 0) {
      candidate = parts[parts.length - 1];
    }

    // 3. è½¬æ¢æ ¼å¼
    if (candidate.length() > 0) {
      StringBuilder nameBuilder = new StringBuilder();
      // é¦–å­—æ¯å¤§å†™
      nameBuilder.append(Character.toUpperCase(candidate.charAt(0)));

      // å¤„ç†åç»­å­—ç¬¦
      for (int i = 1; i < candidate.length(); i++) {
        char c = candidate.charAt(i);
        char prev = candidate.charAt(i - 1);

        // åœ¨æ•°å­—å‰ã€å¤§å†™å­—æ¯å‰ã€ä¸‹åˆ’çº¿åæ·»åŠ ç©ºæ ¼
        if (
          Character.isDigit(c) &&
          !Character.isDigit(prev) &&
          prev != ' ' &&
          i > 1
        ) {
          nameBuilder.append(" ").append(c);
        }
        // å¤§å†™å­—æ¯å‰æ·»åŠ ç©ºæ ¼ï¼ˆé©¼å³°è½¬æ¢ï¼‰
        else if (
          Character.isUpperCase(c) &&
          !Character.isUpperCase(prev) &&
          prev != ' ' &&
          i > 1
        ) {
          nameBuilder.append(" ").append(c);
        }
        // ä¸‹åˆ’çº¿æˆ–è¿å­—ç¬¦è½¬æ¢ä¸ºç©ºæ ¼
        else if (c == '_' || c == '-') {
          nameBuilder.append(" ");
        } else {
          nameBuilder.append(c);
        }
      }

      appName = nameBuilder.toString();
    } else {
      appName = "Application";
    }

    // 4. æ¸…ç†å¤šä½™ç©ºæ ¼
    appName = appName.trim().replaceAll("\\s+", " ");

    // 5. ç¡®ä¿ä¸ä¸ºç©º
    if (appName.isEmpty()) {
      appName = "ä¼ªé€ App";
    }

    appNameCache.put(packageName, appName);
    return appName;
  }

  // 9. æ™ºèƒ½ApplicationInfoç”Ÿæˆå™¨
  private ApplicationInfo createSmartApplicationInfo(
    String packageName,
    int flags
  ) {
    ApplicationInfo ai = new ApplicationInfo();
    ai.packageName = packageName;

    // åº”ç”¨åç§°
    ai.name = generateSmartAppName(packageName);

    // åŸºæœ¬æ ‡å¿—
    ai.flags = ApplicationInfo.FLAG_INSTALLED;
    ai.enabled = true;
    ai.targetSdkVersion = Build.VERSION.SDK_INT;

    // æ™ºèƒ½è·¯å¾„
    int suffix = (Math.abs(packageName.hashCode()) % 5) + 1;
    ai.sourceDir =
      "/data/app/" + packageName.replace('.', '-') + "-" + suffix + "/base.apk";
    ai.publicSourceDir = ai.sourceDir;
    ai.dataDir = "/data/data/" + packageName;
    ai.nativeLibraryDir = ai.dataDir + "/lib";

    // æ™ºèƒ½UIDï¼ˆåŸºäºåŒ…åhashï¼‰
    ai.uid = 10000 + (Math.abs(packageName.hashCode()) % 50000);

    // å¯é€‰æ ‡å¿—ï¼ˆæ ¹æ®flagsï¼‰
    try {
      if ((flags & ApplicationInfo.FLAG_SYSTEM) != 0) {
        ai.flags |= ApplicationInfo.FLAG_SYSTEM;
      }
      if ((flags & ApplicationInfo.FLAG_DEBUGGABLE) != 0) {
        ai.flags |= ApplicationInfo.FLAG_DEBUGGABLE;
      }
    } catch (Throwable t) {
      // å¿½ç•¥æ ‡å¿—è®¾ç½®é”™è¯¯
    }

    return ai;
  }

  // 10. è§£ç flagsï¼ˆç”¨äºæ—¥å¿—ï¼‰
  private String decodeFlags(int flags) {
    List<String> needs = new ArrayList<>();

    if ((flags & PackageManager.GET_META_DATA) != 0) needs.add("ç‰ˆæœ¬");
    if ((flags & PackageManager.GET_ACTIVITIES) != 0) needs.add("Activities");
    if ((flags & PackageManager.GET_SERVICES) != 0) needs.add("Services");
    if ((flags & PackageManager.GET_RECEIVERS) != 0) needs.add("Receivers");
    if ((flags & PackageManager.GET_PROVIDERS) != 0) needs.add("Providers");
    if ((flags & PackageManager.GET_PERMISSIONS) != 0) needs.add("æƒé™");
    if ((flags & PackageManager.GET_SIGNATURES) != 0) needs.add("ç­¾å");

    return needs.isEmpty() ? "åŸºæœ¬ä¿¡æ¯" : String.join("+", needs);
  }

  // 11. ä¸»æ–¹æ³•ï¼šæ™ºèƒ½ä¼ªé€ PackageInfo
  private PackageInfo createSmartFakePackageInfo(
    String packageName,
    int flags
  ) {
    try {
      // è®°å½•è¿™æ¬¡æŸ¥è¯¢
      recordQueryPattern(packageName, flags);

      PackageInfo pi = new PackageInfo();
      pi.packageName = packageName;

      // ========== æŒ‰ flags æä¾›ä¿¡æ¯ ==========
      // 1. ç‰ˆæœ¬ä¿¡æ¯
      pi.versionName = generateSmartVersion(packageName);
      pi.versionCode = generateSmartVersionCode(packageName, pi.versionName);

      // 2. æ—¶é—´ä¿¡æ¯
      pi.firstInstallTime = generateSmartInstallTime(packageName);
      pi.lastUpdateTime = generateSmartUpdateTime(
        packageName,
        pi.firstInstallTime
      );

      // 3. å®‰è£…æ¥æºï¼ˆå®‰å…¨è®¾ç½®ï¼‰
      setInstallerPackageNameSafe(pi, generateSmartInstaller(packageName));

      // 4. ApplicationInfo
      pi.applicationInfo = createSmartApplicationInfo(packageName, flags);

      // 5. å…¶ä»–æŒ‰éœ€å­—æ®µ
      if ((flags & PackageManager.GET_ACTIVITIES) != 0) {
        pi.activities = createFakeActivities(packageName);
      }

      if ((flags & PackageManager.GET_SERVICES) != 0) {
        pi.services = createFakeServices(packageName);
      }

      if ((flags & PackageManager.GET_RECEIVERS) != 0) {
        pi.receivers = createFakeReceivers(packageName);
      }

      if ((flags & PackageManager.GET_PROVIDERS) != 0) {
        pi.providers = createFakeProviders(packageName);
      }

      if ((flags & PackageManager.GET_PERMISSIONS) != 0) {
        pi.permissions = createFakePermissions(packageName);
      }

      if ((flags & PackageManager.GET_SIGNATURES) != 0) {
        pi.signatures = createFakeSignatures(packageName);
      }

      // 6. ç©ºå­—æ®µå®‰å…¨å¤„ç†
      try {
        if (
          (flags & PackageManager.GET_CONFIGURATIONS) != 0 &&
          pi.configPreferences == null
        ) {
          pi.configPreferences = new ConfigurationInfo[0];
        }
      } catch (NoSuchFieldError e) {
        // å¿½ç•¥ä¸å­˜åœ¨çš„å­—æ®µ
      }

      if ((flags & PackageManager.GET_GIDS) != 0 && pi.gids == null) {
        pi.gids = new int[0];
      }
      /*
            // æ—¥å¿—è®°å½•
            log("ğŸ”§ æ™ºèƒ½ä¼ªé€ : " + packageName +
                " v" + pi.versionName +
                " (" + pi.versionCode + ")" +
                " éœ€è¦å­—æ®µ: " + decodeFlags(flags));
            */
      return pi;
    } catch (Throwable e) {
      log("æ™ºèƒ½ä¼ªé€ å¤±è´¥: " + packageName + " - " + e.getMessage());
      // å…œåº•ï¼šè¿”å›ç®€å•ä¼ªé€ 
      return createSimpleFakePackageInfo(packageName);
    }
  }

  // ========== è¾…åŠ©ä¼ªé€ æ–¹æ³• ==========
  // 1. åˆ›å»ºä¼ªé€ Activities
  private ActivityInfo[] createFakeActivities(String packageName) {
    try {
      ActivityInfo[] activities = new ActivityInfo[1];
      Object activityInfo = createFakeActivityInfo(
        packageName,
        packageName + ".MainActivity"
      );
      activities[0] = (ActivityInfo) activityInfo;
      return activities;
    } catch (Throwable e) {
      return new ActivityInfo[0];
    }
  }

  // 2. åˆ›å»ºä¼ªé€ Services
  private android.content.pm.ServiceInfo[] createFakeServices(
    String packageName
  ) {
    try {
      Class<?> serviceInfoClass = Class.forName(
        "android.content.pm.ServiceInfo"
      );
      Object serviceInfo = serviceInfoClass.newInstance();

      XposedHelpers.setObjectField(serviceInfo, "packageName", packageName);
      XposedHelpers.setObjectField(
        serviceInfo,
        "name",
        packageName + ".MyService"
      );
      XposedHelpers.setBooleanField(serviceInfo, "enabled", true);
      XposedHelpers.setBooleanField(serviceInfo, "exported", false);

      android.content.pm.ServiceInfo[] services =
        new android.content.pm.ServiceInfo[1];
      services[0] = (android.content.pm.ServiceInfo) serviceInfo;
      return services;
    } catch (Throwable e) {
      return new android.content.pm.ServiceInfo[0];
    }
  }

  // 3. åˆ›å»ºä¼ªé€ Receivers
  private ActivityInfo[] createFakeReceivers(String packageName) {
    return new ActivityInfo[0];
  }

  // 4. åˆ›å»ºä¼ªé€ Providers
  private ProviderInfo[] createFakeProviders(String packageName) {
    return new ProviderInfo[0];
  }

  // 5. åˆ›å»ºä¼ªé€ Permissions
  private PermissionInfo[] createFakePermissions(String packageName) {
    return new PermissionInfo[0];
  }

  // 6. åˆ›å»ºä¼ªé€ Signatures
  private Signature[] createFakeSignatures(String packageName) {
    try {
      // ç”Ÿæˆä¼ªéšæœºç­¾åï¼ˆåŸºäºåŒ…åï¼‰
      byte[] sigBytes = new byte[256];
      byte[] pkgBytes = packageName.getBytes("UTF-8");

      for (int i = 0; i < sigBytes.length; i++) {
        if (i < pkgBytes.length) {
          sigBytes[i] = (byte) (pkgBytes[i] ^ (i % 256));
        } else {
          sigBytes[i] = (byte) (packageName.hashCode() >> ((i % 4) * 8));
        }
      }

      Signature[] signatures = new Signature[1];
      signatures[0] = new Signature(sigBytes);
      return signatures;
    } catch (Throwable e) {
      return new Signature[0];
    }
  }

  // 7. å…œåº•æ–¹æ³•ï¼šç®€å•ä¼ªé€ ï¼ˆä¿æŒåŸæœ‰ï¼‰
  private PackageInfo createSimpleFakePackageInfo(String packageName) {
    try {
      PackageInfo pi = new PackageInfo();
      pi.packageName = packageName != null
        ? packageName
        : "fake.package.default";

      pi.versionName = "1.0.0";
      pi.versionCode = 1;
      pi.firstInstallTime = System.currentTimeMillis() - 86400000L;
      pi.lastUpdateTime = System.currentTimeMillis();

      try {
        setInstallerPackageNameSafe(pi, "com.android.vending");
      } catch (Throwable t) {
        // å¿½ç•¥
      }

      try {
        pi.applicationInfo = createFakeApplicationInfo(packageName);
      } catch (Throwable e) {
        ApplicationInfo ai = new ApplicationInfo();
        ai.packageName = packageName;
        ai.flags = ApplicationInfo.FLAG_INSTALLED;
        ai.enabled = true;
        pi.applicationInfo = ai;
      }

      return pi;
    } catch (Throwable e) {
      log("ç®€å•ä¼ªé€ å¤±è´¥: " + e.getMessage());
      return null;
    }
  }

/*
  private void hookGetPackageInfo(ClassLoader classLoader) {
    try {
      XposedHelpers.findAndHookMethod(
        "android.app.ApplicationPackageManager",
        classLoader,
        "getPackageInfo",
        String.class,
        int.class,
        new XC_MethodHook() {
          @Override
          protected void beforeHookedMethod(MethodHookParam param)
            throws Throwable {
            String packageName = (String) param.args[0];
            int flags = (int) param.args[1];
            /*
             if (packageName == null) return;
                    // ========== ğŸŸ¢ 1. å”¯ä¸€æ”¾è¡Œæ¡ä»¶ï¼šè‡ªå·±æŸ¥è‡ªå·± ==========
                    if (packageName.equals(currentTargetApp)) {
                        return;
                    }ä¸‹é¢å·²æœ‰â†“
                    */
                    /*
            if (packageName != null && !packageName.equals(currentTargetApp)) {
              // ç³»ç»ŸåŒ…ç›´æ¥æ”¾è¡Œï¼Œèµ°ç³»ç»ŸçœŸå®æŸ¥è¯¢é€»è¾‘
              if (
                isSystemCorePackage(packageName) ||
                packageName.contains("webview") ||
                packageName.contains("chromium")
              ) {
                log("âœ… è·³è¿‡ç³»ç»ŸåŒ…æŸ¥è¯¢: " + packageName);
                return;
              }
              
              
              // Android 11+ PACKAGE_QUERY_FLAGS æƒé™ä¼ªé€ 
              boolean isAndroid11Plus =
                Build.VERSION.SDK_INT >= Build.VERSION_CODES.R;
              int packageQueryFlags = 0;
              if (isAndroid11Plus) {
                try {
                  // åå°„è·å– PACKAGE_QUERY_FLAGS
                  Field flagsField =
                    PackageManager.class.getDeclaredField(
                        "PACKAGE_QUERY_FLAGS"
                      );
                  flagsField.setAccessible(true);
                  packageQueryFlags = flagsField.getInt(null);
                } catch (NoSuchFieldException | IllegalAccessException e) {
                  // æç«¯æƒ…å†µï¼šå­—æ®µä¸å­˜åœ¨ï¼Œè·³è¿‡è¯¥é€»è¾‘
                  //      log("ã€æƒé™ä¼ªé€ ã€‘Android 11+ åå°„è·å– PACKAGE_QUERY_FLAGS å¤±è´¥: " + e.getMessage());
                }
              }

              // ä»… Android 11+ ä¸”è·å–åˆ°å­—æ®µæ—¶ï¼Œæ‰å¤„ç†æƒé™ä¼ªé€ 
              if (
                isAndroid11Plus &&
                packageQueryFlags != 0 &&
                (flags & packageQueryFlags) != 0
              ) {
                Boolean shouldFakePermission = permissionFakeMap.get(
                  currentTargetApp
                );
                boolean fakeEnabled = shouldFakePermission != null
                  ? shouldFakePermission
                  : true;

                if (fakeEnabled) {
                  // ä¼ªé€ æˆæƒï¼šè¿”å›ç©ºå®‰å…¨PackageInfoï¼Œé¿å…ç³»ç»Ÿè¿”å›æƒé™ä¸è¶³
                  param.setResult(createEmptyPackageInfo(packageName));
                  //   log("ã€æƒé™ä¼ªé€ ã€‘Android 11+ PACKAGE_QUERY_FLAGS -> æˆäºˆæƒé™ï¼ˆä¼ªé€ çŠ¶æ€ï¼šå¼€å¯ï¼‰");
                  return;
                } else {
                  // log("ã€æƒé™ä¼ªé€ ã€‘Android 11+ PACKAGE_QUERY_FLAGS -> è¿”å›çœŸå®çŠ¶æ€ï¼ˆä¼ªé€ çŠ¶æ€ï¼šå…³é—­ï¼‰");
                }
              }

              // å®‰è£…çŠ¶æ€
              Boolean status = installStatusMap.get(currentTargetApp);
              boolean shouldReturnInstalled = status != null ? status : true;

              if (!shouldReturnInstalled) {
                try {
                
                  // æŠ›å‡ºç³»ç»ŸåŸç”Ÿå¼‚å¸¸
                  param.setThrowable(
                    new PackageManager.NameNotFoundException(
                      "Package " + packageName + " not found"
                    )
                  );
                  
                } catch (Throwable e) {
                  // å…œåº•ï¼šè¿”å›æ— æœ‰æ•ˆä¿¡æ¯çš„ç©ºå®ä¾‹
                  PackageInfo emptyPkg = new PackageInfo();
                  emptyPkg.packageName = packageName != null
                    ? packageName
                    : "xl.null.package.yhzl";
                  emptyPkg.versionName = null;
                  emptyPkg.versionCode = -1;
                  emptyPkg.applicationInfo = null;
                  emptyPkg.firstInstallTime = 0;
                  emptyPkg.lastUpdateTime = 0;
                  param.setResult(emptyPkg);
                  log("ã€æœªå®‰è£…ã€‘å…œåº•è¿”å›ç©ºå®ä¾‹: " + packageName);
                }
                return;
              }
              
              // å·²å®‰è£…ï¼šå¯ç”¨æ™ºèƒ½ä¼ªé€ 
              synchronized (globalCapturedPackages) {
                if (!globalCapturedPackages.contains(packageName)) {
                  globalCapturedPackages.add(packageName);
                  saveConfigToFile();
                }
              }
              
              if (!appCapturedPackages.contains(packageName)) {
                appCapturedPackages.add(packageName);
              }
              log(
                "å…¨å±€æ•è·åˆ—è¡¨(" +
                globalCapturedPackages.size() +
                "): " +
                globalCapturedPackages.toString()
              );
              Object fakeResult = createSmartFakePackageInfo(
                packageName,
                flags
              );
              if (fakeResult != null) {
                param.setResult(fakeResult);
                log("ã€å·²å®‰è£…ã€‘æ™ºèƒ½ä¼ªé€ æˆåŠŸ: " + packageName);
                if (!blockExitMap.getOrDefault(currentTargetApp, false)) {
                 // blockExitMap.put(currentTargetApp, true); //å¯é€‰è‡ªåŠ¨å¼€å¯æ‹¦æˆªé€€å‡º
                //  log("âš ï¸ æ£€æµ‹åˆ°ä¼ªé€ åŒ…ï¼Œè‡ªåŠ¨å¼€å¯æ‹¦æˆªé€€å‡º");
                }
              }
            }
            
          }
        }
      );
    } catch (Throwable t) {
      log("Hook getPackageInfoå¤±è´¥: " + t.getMessage());
    }
  }
*/

private void hookGetPackageInfo(ClassLoader classLoader) {
    try {
        XposedHelpers.findAndHookMethod(
            "android.app.ApplicationPackageManager",
            classLoader,
            "getPackageInfo",
            String.class,
            int.class,
            new XC_MethodHook() {
                @Override
                protected void beforeHookedMethod(MethodHookParam param)
                    throws Throwable {
                    String packageName = (String) param.args[0];
                    int flags = (int) param.args[1];
                    
                    if (packageName == null) return;
                    
                    // ========== 1. è‡ªå·±æŸ¥è‡ªå·±ï¼Œç›´æ¥æ”¾è¡Œ ==========
                    if (packageName.equals(currentTargetApp)) {
                        return;
                    }
                    
                    // ========== 2. ç³»ç»ŸåŒ…ç›´æ¥æ”¾è¡Œ ==========
                    if (isSystemCorePackage(packageName)) {
                        return;
                    }
                    
                    // ========== 3. ğŸŸ¢ æ ¸å¿ƒä¿®å¤ï¼šæ— æ¡ä»¶æ•è·åŒ…åï¼ˆåŒæ­¥ä¿å­˜ï¼‰ ==========
                    boolean isNewCapture = false;
                    synchronized (globalCapturedPackages) {
                        if (!globalCapturedPackages.contains(packageName)) {
                            globalCapturedPackages.add(packageName);
                            isNewCapture = true;
                            // âœ… ç›´æ¥åŒæ­¥ä¿å­˜ï¼Œæœ€ç¨³å®šï¼
                            saveConfigToFile();
                        }
                    }
                    if (!appCapturedPackages.contains(packageName)) {
                        appCapturedPackages.add(packageName);
                    }
                    
                    if (isNewCapture) {
                      //  log("ã€åŒ…åæ•è·ã€‘" + packageName + " (å½“å‰çŠ¶æ€: " + (installStatusMap.getOrDefault(currentTargetApp, true) ? "å·²å®‰è£…" : "æœªå®‰è£…") + ")");
                    }
                    
                    // ========== 4. æ ¹æ®å®‰è£…çŠ¶æ€å¤„ç†è¿”å›å€¼ ==========
                    Boolean status = installStatusMap.get(currentTargetApp);
                    boolean shouldReturnInstalled = status != null ? status : true;
                    
                    if (!shouldReturnInstalled) {
                        // ğŸŸ¢ æœªå®‰è£…çŠ¶æ€ï¼šè¿”å›åŒ…ä¸å­˜åœ¨ï¼ˆä½†åŒ…åå·²æ•è·å¹¶ä¿å­˜ï¼‰
                        try {
                            param.setThrowable(
                                new PackageManager.NameNotFoundException(
                                    "Package " + packageName + " not found"
                                )
                            );
                        } catch (Throwable e) {
                            PackageInfo emptyPkg = new PackageInfo();
                            emptyPkg.packageName = packageName;
                            emptyPkg.versionName = null;
                            emptyPkg.versionCode = -1;
                            emptyPkg.applicationInfo = null;
                            emptyPkg.firstInstallTime = 0;
                            emptyPkg.lastUpdateTime = 0;
                            param.setResult(emptyPkg);
                        }
                        return;
                    }
                    log("å…¨å±€æ•è·åˆ—è¡¨(" + globalCapturedPackages.size() +"): " + globalCapturedPackages.toString());
                    // ========== 5. å·²å®‰è£…çŠ¶æ€ï¼šè¿”å›ä¼ªé€ ä¿¡æ¯ ==========
                    Object fakeResult = createSmartFakePackageInfo(packageName, flags);
                    if (fakeResult != null) {
                        param.setResult(fakeResult);
                        log("ã€å·²å®‰è£…ã€‘æ™ºèƒ½ä¼ªé€ : " + packageName);
                        if (!blockExitMap.getOrDefault(currentTargetApp, false)) {
                      // blockExitMap.put(currentTargetApp, true); //å¯é€‰è‡ªåŠ¨å¼€å¯æ‹¦æˆªé€€å‡º
                       //  log("âš ï¸ æ£€æµ‹åˆ°ä¼ªé€ åŒ…ï¼Œè‡ªåŠ¨å¼€å¯æ‹¦æˆªé€€å‡º");
                       }
                    }
                }
            }
        );
       // log("âœ… Hook getPackageInfoæˆåŠŸï¼ˆåŒæ­¥ä¿å­˜ç‰ˆï¼‰");
    } catch (Throwable t) {
        log("âŒ Hook getPackageInfoå¤±è´¥: " + t.getMessage());
    }
}

  // åˆ›å»ºç©ºå®‰å…¨PackageInfoï¼ˆç”¨äºAndroid 11+æƒé™ä¼ªé€ ï¼‰
  private PackageInfo createEmptyPackageInfo(String packageName) {
    PackageInfo emptyPkg = new PackageInfo();
    emptyPkg.packageName = packageName != null ? packageName : "fake.package";
    emptyPkg.versionName = "";
    emptyPkg.versionCode = 0;
    emptyPkg.applicationInfo = new ApplicationInfo();
    emptyPkg.applicationInfo.packageName = emptyPkg.packageName;
    return emptyPkg;
  }



 // è¿‡æ»¤ç³»ç»Ÿæ ¸å¿ƒåŒ…+å‚å•†æ ¸å¿ƒåŒ…+ç”¨æˆ·æ’é™¤åŒ…
private boolean isSystemCorePackage(String packageName) {
  // å…ˆå¤„ç†ç²¾ç¡®åŒ¹é…çš„æ ¸å¿ƒåŒ…ï¼ˆandroidã€rootã€systemï¼‰
  if (
    packageName.equals("android") ||
    packageName.equals("root") ||
    packageName.equals("system")
  ) {
    return true;
  }
  // ç³»ç»Ÿæ ¸å¿ƒåŒ… + ä¸»æµå‚å•†æ ¸å¿ƒåŒ… + å‚å•†/å­å“ç‰Œ
  boolean isSystemOrManufacturer =
    packageName.startsWith("com.android.") ||
    packageName.startsWith("com.google.android.") ||
    packageName.startsWith("android.") ||
    packageName.equals("com.google.android.webview") ||
    packageName.equals("com.google.android.gms") ||
    packageName.equals("com.heytap.openid") ||
    packageName.equals("com.google.android.packageinstaller") ||
    // æ ¸å¿ƒå‚å•†
    packageName.startsWith("com.qualcomm") ||
    packageName.startsWith("com.samsung") ||
    packageName.startsWith("com.huawei") ||
    packageName.startsWith("com.miui") ||
    packageName.startsWith("com.oneplus") ||
    packageName.startsWith("com.oppo") ||
    packageName.startsWith("com.vivo") ||
    packageName.startsWith("com.realme") ||
    packageName.startsWith("com.xiaomi") ||
    packageName.startsWith("com.meizu") ||
    // å‚å•†/å­å“ç‰Œç”Ÿæ€
    packageName.startsWith("com.asus") || // åç¡•
    packageName.startsWith("com.lenovo") || // è”æƒ³
    packageName.startsWith("com.zuk") || // zukï¼ˆè”æƒ³å­å“ç‰Œï¼‰
    packageName.startsWith("com.motorola") || // æ‘©æ‰˜ç½—æ‹‰
    packageName.startsWith("com.nokia") || // è¯ºåŸºäºš
    packageName.startsWith("com.honor") || // è£è€€ï¼ˆåŸåä¸ºå­å“ç‰Œï¼Œç°å·²ç‹¬ç«‹ï¼‰
    packageName.startsWith("com.xiaomi.global") || // å°ç±³å›½é™…ç‰ˆ
    packageName.startsWith("com.oppo.global") || // OPPOå›½é™…ç‰ˆ
    packageName.startsWith("com.vivo.global") || // VIVOå›½é™…ç‰ˆ
    packageName.startsWith("com.realme.global") || // realmeå›½é™…ç‰ˆ
    packageName.startsWith("com.infinix") || // ä¼ éŸ³Infinix
    packageName.startsWith("com.tecno") || // ä¼ éŸ³Tecno
    packageName.startsWith("com.itel") || // ä¼ éŸ³Itel
    packageName.startsWith("com.sharp") || // å¤æ™®
    packageName.startsWith("com.sony") || // ç´¢å°¼
    packageName.startsWith("com.lg") || // LG
    packageName.startsWith("com.poco") || // å°ç±³POCOï¼ˆå­å“ç‰Œï¼‰
    packageName.startsWith("com.redmi") || // å°ç±³Redmiï¼ˆå­å“ç‰Œï¼‰
    packageName.startsWith("com.huawei.hwid") || // åä¸ºè´¦å·æ ¸å¿ƒåŒ…
    packageName.startsWith("com.oppo.nearme") || // OPPOåº”ç”¨å•†åº—æ ¸å¿ƒåŒ…
    packageName.startsWith("com.vivo.browser") || // VIVOæµè§ˆå™¨æ ¸å¿ƒåŒ…
    packageName.startsWith("com.heytap") || // ä¸€åŠ /OPPO æ¬¢å¤ªç”Ÿæ€
    packageName.startsWith("com.coloros") || // OPPO ColorOSæ ¸å¿ƒ
    packageName.startsWith("com.flyme") || // é­…æ—Flymeæ ¸å¿ƒ
    packageName.startsWith("com.mi") || // å°ç±³ç”Ÿæ€æ ¸å¿ƒï¼ˆéƒ¨åˆ†åŒ…å‰ç¼€ï¼‰
    packageName.startsWith("com.xiaomi.account"); // å°ç±³è´¦å·æ ¸å¿ƒ
  // æ ¸å¿ƒåº“ç›¸å…³åŒ…
  boolean isCoreLibRelated =
    packageName.contains("webview") ||
    packageName.contains("jiagu") ||
    packageName.contains("c++_shared") ||
    packageName.contains("breakpad") ||
    packageName.contains("monochrome") ||
    packageName.contains("vendor") || // å‚å•†åº•å±‚åº“
    packageName.contains("chipset") || // èŠ¯ç‰‡ç›¸å…³åº“
    packageName.contains("modem") || // è°ƒåˆ¶è§£è°ƒå™¨ç›¸å…³
    packageName.contains("radio") || // å°„é¢‘ç›¸å…³
    packageName.contains("firmware"); // å›ºä»¶ç›¸å…³
  /*
  List<String> excludedPackages = excludedPackagesMap.getOrDefault(currentTargetApp, new ArrayList<>());
  if (excludedPackages.contains(packageName)) {
    return true; 
  }
*/
  // æ–°å¢ï¼šæ£€æŸ¥æ˜¯å¦ä¸ºç”¨æˆ·æ‰‹åŠ¨æ’é™¤çš„åŒ…å
List<String> excludedPackages = excludedPackagesMap.getOrDefault(currentTargetApp, new ArrayList<>());
if (excludedPackages.contains(packageName) || 
    (packageName != null && (
        packageName.startsWith("io.va.exposed") ||          // VAExposed
        packageName.startsWith("com.excean.dualaid") ||      // å¾®åŒå¼€åˆ†èº«
        packageName.startsWith("com.qihoo.magic") ||         // åˆ†èº«å¤§å¸ˆ(360)
        packageName.startsWith("info.red.virtual") ||        // æ‚Ÿç©ºåˆ†èº«
        packageName.startsWith("com.bly.dkplat") ||          // å°Xåˆ†èº«
        packageName.startsWith("dkplugin.") ||          // å°Xåˆ†èº«åˆ†å‡ºçš„åŒ…åå‰ç¼€
        packageName.startsWith("com.pengyou.cloneapp") ||   // å°Xåˆ†èº«å›½é™…ç‰ˆ/Clone App
        packageName.startsWith("com.jy.x.separation.manager") || // å›¢å›¢åˆ†èº«
        packageName.startsWith("com.dong.multirun") ||       // Multi Run
        packageName.startsWith("com.excelliance.dualaid") || // åŒå¼€åŠ©æ‰‹
        packageName.startsWith("com.lbe.parallel") ||        // å¹³è¡Œç©ºé—´
        packageName.startsWith("com.parallel.space") ||      // å¹³è¡Œç©ºé—´å›½é™…ç‰ˆ
        packageName.startsWith("com.chaozhijian.multiopen")  // å¤šå¼€åˆ†èº«
    ))) {
    return true; // çº³å…¥æ’é™¤èŒƒå›´ï¼Œè·³è¿‡æ‰€æœ‰ä¼ªé€ /Hook
}


  return isSystemOrManufacturer || isCoreLibRelated;
}


private void hookGetApplicationInfo(ClassLoader classLoader) {
    try {
        XposedHelpers.findAndHookMethod(
            "android.app.ApplicationPackageManager",
            classLoader,
            "getApplicationInfo",
            String.class,
            int.class,
            new XC_MethodHook() {
                @Override
                protected void beforeHookedMethod(MethodHookParam param)
                    throws Throwable {
                    String packageName = (String) param.args[0];
                    int flags = (int) param.args[1];
                    
                    if (packageName == null) return;
                    
                    // ========== 1. è‡ªå·±æŸ¥è‡ªå·±ï¼Œç›´æ¥æ”¾è¡Œ ==========
                    if (packageName.equals(currentTargetApp)) {
                        return;
                    }
                    
                    // ========== 2. ç³»ç»ŸåŒ…ç›´æ¥æ”¾è¡Œ ==========
                    if (isSystemCorePackage(packageName)) {
                        return;
                    }
                    
                    // ========== 3. ğŸŸ¢ æ ¸å¿ƒä¿®å¤ï¼šæ— æ¡ä»¶æ•è·åŒ…åï¼ˆåŒæ­¥ä¿å­˜ï¼‰ ==========
                    boolean isNewCapture = false;
                    synchronized (globalCapturedPackages) {
                        if (!globalCapturedPackages.contains(packageName)) {
                            globalCapturedPackages.add(packageName);
                            isNewCapture = true;
                            // âœ… ç›´æ¥åŒæ­¥ä¿å­˜ï¼Œæœ€ç¨³å®šï¼
                            saveConfigToFile();
                        }
                    }
                    if (!appCapturedPackages.contains(packageName)) {
                        appCapturedPackages.add(packageName);
                    }
                    
                    if (isNewCapture) {
                      //  log("ã€åº”ç”¨ä¿¡æ¯æ•è·ã€‘" + packageName + " (å½“å‰çŠ¶æ€: " +   (installStatusMap.getOrDefault(currentTargetApp, true) ? "å·²å®‰è£…" : "æœªå®‰è£…") + ")");
                    }
                    
                    // ========== 4. æ ¹æ®å®‰è£…çŠ¶æ€å¤„ç†è¿”å›å€¼ ==========
                    Boolean status = installStatusMap.get(currentTargetApp);
                    boolean shouldReturnInstalled = status != null ? status : true;
                    
                    if (!shouldReturnInstalled) {
                        // ğŸŸ¢ æœªå®‰è£…çŠ¶æ€ï¼šè¿”å›åŒ…ä¸å­˜åœ¨
                        try {
                            param.setThrowable(
                                new PackageManager.NameNotFoundException(
                                    "Package " + packageName + " not found"
                                )
                            );
                            log(
                    "ã€æœªå®‰è£…ã€‘è¿”å›æœªå®‰è£…: " + packageName +"(å…³é—­æ™ºèƒ½ä¼ªé€ )"
                  );
                        } catch (Throwable e) {
                            ApplicationInfo emptyAppInfo = new ApplicationInfo();
                            emptyAppInfo.packageName = packageName;
                            emptyAppInfo.name = null;
                            emptyAppInfo.flags = 0;
                            emptyAppInfo.enabled = false;
                            emptyAppInfo.sourceDir = null;
                            emptyAppInfo.dataDir = null;
                            emptyAppInfo.nativeLibraryDir = null;
                            emptyAppInfo.uid = -1;
                            emptyAppInfo.targetSdkVersion = -1;
                            param.setResult(emptyAppInfo);
                        }
                        return;
                    }
                  // log("å…¨å±€æ•è·åˆ—è¡¨(" + globalCapturedPackages.size() +"): " + globalCapturedPackages.toString());
                    // ========== 5. å·²å®‰è£…çŠ¶æ€ï¼šè¿”å›ä¼ªé€ ä¿¡æ¯ ==========
                    Object fakeResult = createSmartApplicationInfo(packageName, flags);
                    if (fakeResult != null) {
                        param.setResult(fakeResult);
                       // log("ã€å·²å®‰è£…çŠ¶æ€ã€‘æ™ºèƒ½ä¼ªé€ åº”ç”¨ä¿¡æ¯: " + packageName);
                    } else {
                        param.setResult(createFakeApplicationInfo(packageName));
                    }
                }
            }
        );
      //  log("âœ… Hook getApplicationInfoæˆåŠŸï¼ˆåŒæ­¥ä¿å­˜ç‰ˆï¼‰");
    } catch (Throwable t) {
        log("âŒ Hook getApplicationInfoå¤±è´¥: " + t.getMessage());
    }
}

  private void hookGetInstalledPackages(ClassLoader classLoader) {
    try {
      XposedHelpers.findAndHookMethod(
        "android.app.ApplicationPackageManager",
        classLoader,
        "getInstalledPackages",
        int.class,
        new XC_MethodHook() {
          @Override
          protected void beforeHookedMethod(MethodHookParam param)
            throws Throwable {
            Boolean shouldFakePermission = permissionFakeMap.get(
              currentTargetApp
            );
            boolean fakeEnabled = shouldFakePermission != null
              ? shouldFakePermission
              : true;
            if (!fakeEnabled) return;

            // Android 11+ï¼šä¼ªé€ QUERY_ALL_PACKAGESæƒé™ï¼Œè¿”å›å®Œæ•´åˆ—è¡¨
            if (Build.VERSION.SDK_INT >= Build.VERSION_CODES.R) {
              List<PackageInfo> fakeList = new ArrayList<>();
              synchronized (globalCapturedPackages) {
                for (String pkg : globalCapturedPackages) {
                  fakeList.add(createSmartFakePackageInfo(pkg, param.args[0]));
                }
              }
              param.setResult(fakeList);
              //    log("ã€æƒé™ä¼ªé€ ã€‘getInstalledPackages -> è¿”å›ä¼ªé€ åˆ—è¡¨ï¼ˆAndroid 11+ï¼‰");
              return;
            }

            // ä½ç‰ˆæœ¬
            Boolean status = installStatusMap.get(currentTargetApp);
            boolean shouldReturnInstalled = status != null ? status : true;
            if (!shouldReturnInstalled) {
              param.setResult(new ArrayList<PackageInfo>());
              return;
            }
            List<PackageInfo> fakeList = new ArrayList<>();
            synchronized (globalCapturedPackages) {
              for (String pkg : globalCapturedPackages) {
                fakeList.add(createSmartFakePackageInfo(pkg, param.args[0]));
              }
            }
            param.setResult(fakeList);
          }
        }
      );
    } catch (Throwable t) {
      log("Hook getInstalledPackageså¤±è´¥: " + t.getMessage());
    }
  }

  private void hookGetInstalledApplications(ClassLoader classLoader) {
    try {
      XposedHelpers.findAndHookMethod(
        "android.app.ApplicationPackageManager",
        classLoader,
        "getInstalledApplications",
        int.class,
        new XC_MethodHook() {
          @Override
          protected void beforeHookedMethod(MethodHookParam param)
            throws Throwable {
            Boolean status = installStatusMap.get(currentTargetApp);
            boolean shouldReturnInstalled = status != null ? status : true;
            if (!shouldReturnInstalled) {
              // æœªå®‰è£…ï¼šå…³é—­æ™ºèƒ½ä¼ªé€ ï¼Œè¿”å›ç³»ç»ŸçœŸå®ç³»ç»Ÿåº”ç”¨åˆ—è¡¨
              return;
            }
            // å·²å®‰è£…ï¼šå¯ç”¨æ™ºèƒ½ä¼ªé€ ï¼Œè¿”å›ä¼ªé€ åº”ç”¨åˆ—è¡¨
            List<ApplicationInfo> fakeList = new ArrayList<>();
            synchronized (globalCapturedPackages) {
              for (String pkg : globalCapturedPackages) {
                ApplicationInfo ai = createSmartApplicationInfo(
                  pkg,
                  param.args[0]
                );
                if (ai != null) {
                  fakeList.add(ai);
                }
              }
            }
            param.setResult(fakeList);
          }
        }
      );
    } catch (Throwable t) {
      log("Hook getInstalledApplicationså¤±è´¥: " + t.getMessage());
    }
  }

  // å…œåº•æ–¹æ³•
  private PackageInfo createFakePackageInfo(String packageName) {
    // ç°åœ¨è°ƒç”¨æ™ºèƒ½ä¼ªé€ ï¼Œä½¿ç”¨é»˜è®¤flags
    return createSmartFakePackageInfo(
      packageName,
      PackageManager.GET_META_DATA
    );
  }

  // å…œåº•æ–¹æ³•ï¼‰
  private ApplicationInfo createFakeApplicationInfo(String packageName) {
    return createSmartApplicationInfo(packageName, 0);
  }

  // ä¼˜åŒ–createFakeIntentï¼šç¡®ä¿ComponentNameéç©º
  private Intent createFakeIntent(String packageName) {
    Intent fakeIntent = new Intent(Intent.ACTION_MAIN);
    fakeIntent.addCategory(Intent.CATEGORY_LAUNCHER);
    fakeIntent.setPackage(
      packageName != null ? packageName : "fake.package.default"
    );
    // ç¡®ä¿ComponentNameéç©ºï¼Œé¿å…ç›®æ ‡åº”ç”¨è·å–æ—¶å´©æºƒ
    String className = packageName != null
      ? packageName + ".MainActivity"
      : "fake.package.default.MainActivity";
    fakeIntent.setComponent(
      new ComponentName(fakeIntent.getPackage(), className)
    );
    fakeIntent.setFlags(Intent.FLAG_ACTIVITY_NEW_TASK);
    return fakeIntent;
  }

  private String extractPackageName(Object[] args) {
    if (args == null || args.length == 0) {
      return null;
    }

    for (Object arg : args) {
      if (arg instanceof String) {
        String str = (String) arg;
        if (isValidPackageName(str)) {
          return str;
        }
      }
    }

    for (Object arg : args) {
      if (arg instanceof Intent) {
        Intent intent = (Intent) arg;
        String pkg = intent.getPackage();
        if (isValidPackageName(pkg)) {
          return pkg;
        }
        ComponentName cn = intent.getComponent();
        if (cn != null) {
          pkg = cn.getPackageName();
          if (isValidPackageName(pkg)) {
            return pkg;
          }
        }
      }
    }

    for (Object arg : args) {
      if (arg instanceof ComponentName) {
        ComponentName cn = (ComponentName) arg;
        String pkg = cn.getPackageName();
        if (isValidPackageName(pkg)) {
          return pkg;
        }
      }
    }

    return null;
  }

  private boolean isValidPackageName(String str) {
    if (str == null || str.length() < 3 || !str.contains(".")) {
      return false;
    }
    return !str.startsWith("/") && !str.contains("://");
  }

//Hook Bundle.getString
private void hookBundleGetString(ClassLoader classLoader) {
    try {
        Class<?> bundleClass = Class.forName("android.os.Bundle", false, classLoader);
        
        XposedBridge.hookAllMethods(
            bundleClass,
            "getString",
            new XC_MethodHook() {
                @Override
                protected void beforeHookedMethod(MethodHookParam param) throws Throwable {
                    // ========== ğŸš¨ã€æ ¸å¿ƒä¿®å¤1ã€‘thisObjectä¸ºç©º ==========
                    if (param.thisObject == null) {
                        // è¿”å›é»˜è®¤å€¼
                        if (param.args.length >= 2) {
                            param.setResult(param.args[1]);
                        } else {
                            param.setResult("");
                        }
                        return;
                    }
                    
                    Bundle bundle = (Bundle) param.thisObject;
                    
                    // ========== ğŸš¨ã€æ ¸å¿ƒä¿®å¤2ã€‘Bundleå·²è¢«GCæˆ–éæ³•çŠ¶æ€ ==========
                    try {
                        // å”¯ä¸€å®‰å…¨çš„æ£€æµ‹ï¼šhashCode() ä¼šæŠ›å¼‚å¸¸å¦‚æœå¯¹è±¡å·²é”€æ¯
                        int hash = bundle.hashCode();
                    } catch (Throwable e) {
                        // Bundleå·²ä¸å¯ç”¨ï¼Œè¿”å›é»˜è®¤å€¼
                        if (param.args.length >= 2) {
                            param.setResult(param.args[1]);
                        } else {
                            param.setResult("");
                        }
                        return;
                    }
                    
                    // ========== ğŸš¨ã€æ ¸å¿ƒä¿®å¤3ã€‘keyä¸å­˜åœ¨ ==========
                    if (param.args.length >= 1) {
                        String key = (String) param.args[0];
                        if (!bundle.containsKey(key)) {
                            if (param.args.length >= 2) {
                                param.setResult(param.args[1]);
                            } else {
                                param.setResult("");
                            }
                            return;
                        }
                    }
                }
                
                @Override
                protected void afterHookedMethod(MethodHookParam param) throws Throwable {
                    // ========== ğŸš¨ã€æ ¸å¿ƒä¿®å¤4ã€‘è¿”å›å€¼ä¸ºç©º ==========
                    if (param.getResult() == null) {
                        if (param.args.length >= 2) {
                            param.setResult(param.args[1]);
                        } else {
                            param.setResult("");
                        }
                    }
                }
            }
        );
        
        // ========== ğŸš¨ã€æ ¸å¿ƒä¿®å¤5ã€‘é¢å¤–ä¿®å¤ getString(String key, String defaultValue) ==========
        try {
            XposedHelpers.findAndHookMethod(
                bundleClass,
                "getString",
                String.class,
                String.class,
                new XC_MethodHook() {
                    @Override
                    protected void beforeHookedMethod(MethodHookParam param) throws Throwable {
                        if (param.thisObject == null) {
                            param.setResult(param.args[1]); // è¿”å›é»˜è®¤å€¼
                            return;
                        }
                        
                        Bundle bundle = (Bundle) param.thisObject;
                        try {
                            bundle.hashCode(); // æ£€æµ‹æ˜¯å¦å¯ç”¨
                        } catch (Throwable e) {
                            param.setResult(param.args[1]);
                            return;
                        }
                        
                        String key = (String) param.args[0];
                        if (!bundle.containsKey(key)) {
                            param.setResult(param.args[1]);
                        }
                    }
                }
            );
        } catch (Throwable ignored) {}
        
        //XposedBridge.log("[InstallHook] âœ… Bundle.getString Hookå®Œæˆï¼ˆç©ºæŒ‡é’ˆé˜²æŠ¤ï¼‰");
        
    } catch (Throwable t) {
        //XposedBridge.log("[InstallHook] âŒ Hook Bundle.getStringå¤±è´¥: " + t.getMessage());
    }
}

  // åº•å±‚Hook Bundleç±»ï¼Œæ‹¦æˆªæ‰€æœ‰ç©ºå®ä¾‹çš„æ–¹æ³•è°ƒç”¨
  private void hookBundleEmptyInstance(ClassLoader classLoader) {
    try {
        Class<?> bundleClass = Class.forName("android.os.Bundle", false, classLoader);
        
        // Hookæ„é€ å‡½æ•°
        XposedHelpers.findAndHookConstructor(
            bundleClass,
            new XC_MethodHook() {
                @Override
                protected void afterHookedMethod(MethodHookParam param) {
                    // æ„é€ å‡ºæ¥çš„Bundleä¸å¯èƒ½ä¸ºnullï¼Œä½†é˜²æ­¢åå°„å¼‚å¸¸
                    if (param.getResult() == null) return;
                    
                    Bundle bundle = (Bundle) param.getResult();
                    try {
                        // åŠ ä¸ªæ ‡è®°å­—æ®µï¼Œä½†ä¸ä¾èµ–å®ƒ
                        bundle.putBoolean("__hook_protected", true);
                    } catch (Throwable ignored) {}
                }
            }
        );
        
        // Hookæ‰€æœ‰å¯èƒ½å´©æºƒçš„æ–¹æ³•
        String[] methods = {"getString", "getInt", "getBoolean", "getLong", 
                           "getDouble", "getFloat", "getBundle", "getSerializable",
                           "getParcelable", "getParcelableArrayList", "getStringArrayList",
                           "getIntegerArrayList", "getBooleanArray", "containsKey"};
        
        for (String methodName : methods) {
            try {
                // å…ˆHookå•å‚æ•°ç‰ˆæœ¬
                XposedHelpers.findAndHookMethod(
                    bundleClass,
                    methodName,
                    String.class,
                    new XC_MethodHook() {
                        @Override
                        protected void beforeHookedMethod(MethodHookParam param) throws Throwable {
                            // ========== ğŸš¨ ç»Ÿä¸€ç©ºæŒ‡é’ˆä¿æŠ¤ ==========
                            if (param.thisObject == null) {
                                setDefaultReturnValue(param);
                                return;
                            }
                            
                            // æ£€æµ‹Bundleæ˜¯å¦å¯ç”¨
                            Bundle bundle = (Bundle) param.thisObject;
                            try {
                                bundle.hashCode();
                            } catch (Throwable e) {
                                setDefaultReturnValue(param);
                            }
                        }
                        
                        private void setDefaultReturnValue(MethodHookParam param) {
                            if (param.method instanceof Method) {
                                Class<?> returnType = ((Method) param.method).getReturnType();
                                if (returnType == String.class) param.setResult("");
                                else if (returnType == int.class) param.setResult(0);
                                else if (returnType == long.class) param.setResult(0L);
                                else if (returnType == boolean.class) param.setResult(false);
                                else if (returnType == double.class) param.setResult(0.0);
                                else if (returnType == float.class) param.setResult(0.0f);
                                else param.setResult(null);
                            }
                        }
                    }
                );
            } catch (Throwable ignored) {}
            
            try {
                // HookåŒå‚æ•°ç‰ˆæœ¬ï¼ˆå¸¦é»˜è®¤å€¼ï¼‰
                XposedHelpers.findAndHookMethod(
                    bundleClass,
                    methodName,
                    String.class,
                    Object.class,
                    new XC_MethodHook() {
                        @Override
                        protected void beforeHookedMethod(MethodHookParam param) throws Throwable {
                            if (param.thisObject == null) {
                                param.setResult(param.args[1]); // è¿”å›é»˜è®¤å€¼
                                return;
                            }
                            
                            Bundle bundle = (Bundle) param.thisObject;
                            try {
                                bundle.hashCode();
                            } catch (Throwable e) {
                                param.setResult(param.args[1]);
                                return;
                            }
                            
                            String key = (String) param.args[0];
                            if (!bundle.containsKey(key)) {
                                param.setResult(param.args[1]);
                            }
                        }
                    }
                );
            } catch (Throwable ignored) {}
        }
        
        //XposedBridge.log("[InstallHook] âœ… Bundleç©ºå®ä¾‹é˜²æŠ¤å®Œæˆ");
        
    } catch (Throwable t) {
        //XposedBridge.log("[InstallHook] âŒ Hook Bundleå¤±è´¥: " + t.getMessage());
    }
}

  // ========== é‡è½½æ–¹æ³•Hook ==========
  private void hookOverloadMethods(ClassLoader classLoader) {
    try {
      XposedHelpers.findAndHookMethod(
        "android.app.ApplicationPackageManager",
        classLoader,
        "getPackageInfo",
        String.class,
        int.class,
        int.class,
        new XC_MethodHook() {
          @Override
          protected void beforeHookedMethod(MethodHookParam param)
            throws Throwable {
            String packageName = extractPackageName(param.args);
            if (packageName != null && !packageName.equals(currentTargetApp)) {
              Boolean status = installStatusMap.get(currentTargetApp);
              boolean shouldReturnInstalled = status != null ? status : true;

              if (!shouldReturnInstalled) {
                param.setResult(null);
                return;
              }

              synchronized (globalCapturedPackages) {
                if (!globalCapturedPackages.contains(packageName)) {
                  globalCapturedPackages.add(packageName);
                }
              }

              Object fakeResult = createFakePackageInfo(packageName);
              if (fakeResult != null) {
                param.setResult(fakeResult);
              }
            }
          }
        }
      );

      // Hook getApplicationInfoé‡è½½ç‰ˆ
      XposedHelpers.findAndHookMethod(
        "android.app.ApplicationPackageManager",
        classLoader,
        "getApplicationInfo",
        String.class,
        int.class,
        int.class,
        new XC_MethodHook() {
          @Override
          protected void beforeHookedMethod(MethodHookParam param)
            throws Throwable {
            String packageName = extractPackageName(param.args);
            if (packageName != null && !packageName.equals(currentTargetApp)) {
              Boolean status = installStatusMap.get(currentTargetApp);
              boolean shouldReturnInstalled = status != null ? status : true;

              if (!shouldReturnInstalled) {
                param.setResult(null);
                return;
              }

              synchronized (globalCapturedPackages) {
                if (!globalCapturedPackages.contains(packageName)) {
                  globalCapturedPackages.add(packageName);
                }
              }

              Object fakeResult = createFakeApplicationInfo(packageName);
              if (fakeResult != null) {
                param.setResult(fakeResult);
              }
            }
          }
        }
      );

      // Hook getInstalledPackagesé‡è½½ç‰ˆ
      XposedHelpers.findAndHookMethod(
        "android.app.ApplicationPackageManager",
        classLoader,
        "getInstalledPackages",
        int.class,
        int.class,
        new XC_MethodHook() {
          @Override
          protected void beforeHookedMethod(MethodHookParam param)
            throws Throwable {
            Boolean status = installStatusMap.get(currentTargetApp);
            boolean shouldReturnInstalled = status != null ? status : true;

            if (!shouldReturnInstalled) {
              param.setResult(new ArrayList<PackageInfo>());
              return;
            }

            List<PackageInfo> fakeList = new ArrayList<>();
            synchronized (globalCapturedPackages) {
              for (String pkg : globalCapturedPackages) {
                PackageInfo pi = createFakePackageInfo(pkg);
                if (pi != null) {
                  fakeList.add(pi);
                }
              }
            }

            param.setResult(fakeList);
          }
        }
      );

      // Hook getInstalledApplicationsé‡è½½ç‰ˆ
      XposedHelpers.findAndHookMethod(
        "android.app.ApplicationPackageManager",
        classLoader,
        "getInstalledApplications",
        int.class,
        int.class,
        new XC_MethodHook() {
          @Override
          protected void beforeHookedMethod(MethodHookParam param)
            throws Throwable {
            Boolean status = installStatusMap.get(currentTargetApp);
            boolean shouldReturnInstalled = status != null ? status : true;

            if (!shouldReturnInstalled) {
              param.setResult(new ArrayList<ApplicationInfo>());
              return;
            }

            List<ApplicationInfo> fakeList = new ArrayList<>();
            synchronized (globalCapturedPackages) {
              for (String pkg : globalCapturedPackages) {
                ApplicationInfo ai = createFakeApplicationInfo(pkg);
                if (ai != null) {
                  fakeList.add(ai);
                }
              }
            }

            param.setResult(fakeList);
          }
        }
      );
    } catch (Throwable t) {
      //    log("Hooké‡è½½æ–¹æ³•å¤±è´¥: " + t.getMessage());
    }
  }

  private void hookSystemFileRead() {
    try {
      XposedHelpers.findAndHookMethod(
        "java.io.FileInputStream",
        null,
        "FileInputStream",
        String.class,
        new XC_MethodHook() {
          @Override
          protected void beforeHookedMethod(MethodHookParam param)
            throws Throwable {
            String filePath = (String) param.args[0];
            if (
              filePath.contains("/data/system/packages.xml") ||
              filePath.contains("/data/system/packages.list") ||
              filePath.contains("com.android.settings/databases/apps.db")
            ) {
              param.setThrowable(new SecurityException("æƒé™ä¸è¶³ï¼Œæ— æ³•è¯»å–"));
            }
          }
        }
      );
    } catch (Throwable t) {
      //    log("Hookæ–‡ä»¶è¯»å–å¤±è´¥: " + t.getMessage());
    }
  }
  
  
// è®©åˆ†èº«é‡Œçš„åº”ç”¨èƒ½æ­£ç¡®åŠ è½½ .so æ–‡ä»¶ï¼ˆå…œåº•æ–¹æ¡ˆï¼‰
private void hookSoPathInApp(ClassLoader classLoader) {
    try {
        XposedHelpers.findAndHookMethod(
            "android.app.Application",
            classLoader,
            "attach",
            Context.class,
            new XC_MethodHook() {
                @Override
                protected void afterHookedMethod(MethodHookParam param) {
                    try {
                        Context context = (Context) param.args[0];
                        ApplicationInfo ai = context.getApplicationInfo();
                        // å·²ç»ä¿®å¤è¿‡çš„å°±ä¸é‡å¤logäº†
                        XposedHelpers.setObjectField(ai, "nativeLibraryDir", ai.nativeLibraryDir);
                    } catch (Throwable ignored) {}
                }
            }
        );
    } catch (Throwable ignored) {}
}




  private void hookPackageManagerReflect() {
    try {
        XposedHelpers.findAndHookMethod(
            "java.lang.Class",
            null,
            "getMethod",
            String.class,
            Class[].class,
            new XC_MethodHook() {
                @Override
                protected void beforeHookedMethod(MethodHookParam param) throws Throwable {
                    try {
                        if (!(param.thisObject instanceof Class)) {
                            return;
                        }

                        Class<?> targetClass = (Class<?>) param.thisObject;
                        String methodName = (String) param.args[0];

                        // ä»…è¿‡æ»¤ PackageManager ç›¸å…³ç±»çš„æ•æ„Ÿæ–¹æ³•ï¼ˆä¸åŒºåˆ†åˆ†èº«/æ™®é€šåº”ç”¨ï¼‰
                        boolean isPackageManagerRelated =
                                targetClass.getName().equals("android.content.pm.PackageManager") ||
                                targetClass.getName().equals("android.app.ApplicationPackageManager") ||
                                targetClass.getName().contains("PackageManager");

                        boolean isSensitiveMethod =
                                methodName.contains("getPackageInfoAsUser") ||
                                methodName.contains("getApplicationInfoAsUser") ||
                                methodName.contains("getInstalledPackagesAsUser") ||
                                methodName.contains("getInstalledApplicationsAsUser") ||
                                methodName.contains("hidden") ||
                                methodName.contains("internal") ||
                                methodName.contains("AsUser");

                        if (isPackageManagerRelated && isSensitiveMethod) {
                            // æ ¸å¿ƒé€»è¾‘ï¼šä¸åˆ¤æ–­æ˜¯å¦ä¸ºåˆ†èº«ï¼Œç›´æ¥å°è¯•é˜»æ–­ï¼Œå¼‚å¸¸åˆ™æ”¾è¡Œ
                            try {
                                // å°è¯•è·å–å½“å‰åº”ç”¨ä¸Šä¸‹æ–‡ï¼ˆä»…ä½œå…¼å®¹æ ¡éªŒï¼Œå¤±è´¥ä¸å½±å“ï¼‰
                                Context context = (Context) XposedHelpers.callStaticMethod(
                                        XposedHelpers.findClass("android.app.ActivityThread", null),
                                        "currentApplication"
                                );
                                // æ— å¼‚å¸¸åˆ™é˜»æ–­æ•æ„Ÿæ–¹æ³•ï¼ˆæ™®é€šåº”ç”¨åœºæ™¯ï¼‰
                                param.setResult(null);
                              //  log("âœ… æ‹¦æˆª PackageManager æ•æ„Ÿåå°„æ–¹æ³•: " + methodName);
                            } catch (Throwable e) {
                                // ä»»ä½•å¼‚å¸¸ï¼ˆåˆ†èº«æƒé™ä¸è¶³ã€ä¸Šä¸‹æ–‡è·å–å¤±è´¥ç­‰ï¼‰ï¼Œç›´æ¥æ”¾è¡Œ
                             //   log("âš ï¸ æ‰§è¡Œæ‹¦æˆªå¤±è´¥ï¼ˆå¯èƒ½æ˜¯åˆ†èº«ç¯å¢ƒï¼‰ï¼Œè·³è¿‡ Hook: " + e.getMessage());
                            }
                        }
                    } catch (Throwable t) {
                        // å¤–å±‚å…œåº•æ•è·ï¼Œç»å¯¹é¿å…å½±å“åº”ç”¨è¿è¡Œ
                        log("åå°„ Hook å…¨å±€å¼‚å¸¸: " + t.getMessage());
                    }
                }
            }
        );
    //    log("âœ… æˆåŠŸHook PackageManager åå°„ç›‘æ§ï¼ˆå…¼å®¹ä»»æ„åˆ†èº«/åŒ…å/UIDï¼‰");
    } catch (Throwable t) {
        log("Hookåå°„ç›‘æ§åˆå§‹åŒ–å¤±è´¥: " + t.getMessage());
    }
}



  // ========== PackageManageræ‰©å±•æ–¹æ³• ==========
  private void hookIsApplicationEnabled(ClassLoader classLoader) {
    try {
      // ç”¨ hookAllMethods å…¼å®¹æ–¹æ³•ç­¾åå·®å¼‚
      XposedBridge.hookAllMethods(
        XposedHelpers.findClass(
          "android.app.ApplicationPackageManager",
          classLoader
        ),
        "isApplicationEnabled",
        new XC_MethodHook() {
          @Override
          protected void beforeHookedMethod(MethodHookParam param)
            throws Throwable {
            // åªå¤„ç†1ä¸ªå‚æ•°çš„æƒ…å†µï¼ˆString packageNameï¼‰
            if (param.args.length == 1 && param.args[0] instanceof String) {
              String packageName = (String) param.args[0];
              if (
                packageName != null && !packageName.equals(currentTargetApp)
              ) {
                Boolean status = installStatusMap.get(currentTargetApp);
                boolean shouldReturnInstalled = status != null ? status : true;
                if (!shouldReturnInstalled) {
                  param.setResult(false);
                  return;
                }
                boolean isCaptured = false;
                synchronized (globalCapturedPackages) {
                  isCaptured = globalCapturedPackages.contains(packageName);
                }
                if (isCaptured) {
                  param.setResult(true);
                }
              }
            }
          }
        }
      );
      //  log("âœ… æˆåŠŸHook isApplicationEnabledï¼ˆå…¼å®¹æ‰€æœ‰ç‰ˆæœ¬ï¼‰");
    } catch (Throwable t) {
      log("Hook isApplicationEnabledå¤±è´¥: " + t.getMessage());
    }
  }

  private void hookCheckPermission(ClassLoader classLoader) {
    try {
      // 1. Hook PackageManager.checkPermissionï¼ˆç³»ç»Ÿçº§æƒé™æŸ¥è¯¢ï¼‰
      XposedHelpers.findAndHookMethod(
        "android.app.ApplicationPackageManager",
        classLoader,
        "checkPermission",
        String.class,
        String.class,
        new XC_MethodHook() {
          @Override
          protected void beforeHookedMethod(MethodHookParam param)
            throws Throwable {
            String permName = (String) param.args[0];
            String packageName = (String) param.args[1];
            if (packageName != null && !packageName.equals(currentTargetApp)) {
              Boolean shouldFakePermission = permissionFakeMap.get(
                currentTargetApp
              );
              boolean fakeEnabled = shouldFakePermission != null
                ? shouldFakePermission
                : true;
              if (
                fakeEnabled &&
                Arrays.asList(DETECTION_PERMISSIONS).contains(permName)
              ) {
                param.setResult(PackageManager.PERMISSION_GRANTED);
                return;
              }
            }
          }
        }
      );

      // 2. Hook ContextWrapper.checkSelfPermissionï¼ˆåº”ç”¨è‡ªæŸ¥æ ¸å¿ƒè·¯å¾„ï¼‰
      try {
        XposedHelpers.findAndHookMethod(
          "android.content.ContextWrapper",
          classLoader,
          "checkSelfPermission",
          String.class,
          new XC_MethodHook() {
            @Override
            protected void beforeHookedMethod(MethodHookParam param)
              throws Throwable {
              String permName = (String) param.args[0];
              Boolean shouldFakePermission = permissionFakeMap.get(
                currentTargetApp
              );
              boolean fakeEnabled = shouldFakePermission != null
                ? shouldFakePermission
                : true;
              if (
                fakeEnabled &&
                Arrays.asList(DETECTION_PERMISSIONS).contains(permName)
              ) {
                param.setResult(PackageManager.PERMISSION_GRANTED);
                //  log("ã€æƒé™ä¼ªé€ ã€‘ContextWrapper.checkSelfPermission -> æˆäºˆæƒé™: " + permName);
                return;
              }
            }
          }
        );
      } catch (Throwable t) {
        // å…œåº•ï¼šHook ContextImpl.checkSelfPermission
        try {
          XposedHelpers.findAndHookMethod(
            "android.app.ContextImpl",
            classLoader,
            "checkSelfPermission",
            String.class,
            new XC_MethodHook() {
              @Override
              protected void beforeHookedMethod(MethodHookParam param)
                throws Throwable {
                String permName = (String) param.args[0];
                Boolean shouldFakePermission = permissionFakeMap.get(
                  currentTargetApp
                );
                boolean fakeEnabled = shouldFakePermission != null
                  ? shouldFakePermission
                  : true;
                if (
                  fakeEnabled &&
                  Arrays.asList(DETECTION_PERMISSIONS).contains(permName)
                ) {
                  param.setResult(PackageManager.PERMISSION_GRANTED);
                  //  log("ã€æƒé™ä¼ªé€ ã€‘ContextImpl.checkSelfPermission -> æˆäºˆæƒé™: " + permName);
                  return;
                }
              }
            }
          );
        } catch (Throwable e) {
          log("Hook ContextImpl.checkSelfPermissionå¤±è´¥: " + e.getMessage());
        }
      }

      // 3. Hook AndroidX PermissionChecker
      try {
        Class<?> permissionCheckerClass = XposedHelpers.findClassIfExists(
          "androidx.core.content.PermissionChecker",
          classLoader
        );
        if (permissionCheckerClass != null) {
          XposedBridge.hookAllMethods(
            permissionCheckerClass,
            "checkSelfPermission",
            new XC_MethodHook() {
              @Override
              protected void beforeHookedMethod(MethodHookParam param)
                throws Throwable {
                String targetPerm = null;
                // éå†å‚æ•°æ‰¾åˆ°æƒé™åï¼ˆé€‚é…ä¸åŒå‚æ•°é¡ºåºï¼‰
                for (Object arg : param.args) {
                  if (
                    arg instanceof String &&
                    Arrays.asList(DETECTION_PERMISSIONS).contains(arg)
                  ) {
                    targetPerm = (String) arg;
                    break;
                  }
                }
                if (targetPerm != null) {
                  Boolean shouldFakePermission = permissionFakeMap.get(
                    currentTargetApp
                  );
                  boolean fakeEnabled = shouldFakePermission != null
                    ? shouldFakePermission
                    : true;
                  if (fakeEnabled) {
                    param.setResult(PackageManager.PERMISSION_GRANTED);
                    //    log("ã€æƒé™ä¼ªé€ ã€‘AndroidX.PermissionChecker -> æˆäºˆæƒé™: " + targetPerm);
                    return;
                  }
                }
              }
            }
          );
        }
      } catch (Throwable t) {
        log("Hook AndroidX PermissionCheckerå¤±è´¥: " + t.getMessage());
      }
      //     log("âœ… æƒé™æ£€æŸ¥Hookåˆå§‹åŒ–å®Œæˆï¼ˆè¦†ç›–ç³»ç»Ÿ+åº”ç”¨+AndroidXï¼‰");
    } catch (Throwable t) {
      log("Hook checkPermissionå¤±è´¥: " + t.getMessage());
    }
  }

  private void hookGetActivityInfo(ClassLoader classLoader) {
    try {
      XposedHelpers.findAndHookMethod(
        "android.app.ApplicationPackageManager",
        classLoader,
        "getActivityInfo",
        ComponentName.class,
        int.class,
        new XC_MethodHook() {
          @Override
          protected void beforeHookedMethod(MethodHookParam param)
            throws Throwable {
            ComponentName component = (ComponentName) param.args[0];
            if (component != null) {
              String packageName = component.getPackageName();

              if (
                packageName != null && !packageName.equals(currentTargetApp)
              ) {
                Boolean status = installStatusMap.get(currentTargetApp);
                boolean shouldReturnInstalled = status != null ? status : true;

                if (!shouldReturnInstalled) {
                  param.setResult(null);
                  return;
                }

                Object fakeActivityInfo = createFakeActivityInfo(
                  packageName,
                  component.getClassName()
                );
                if (fakeActivityInfo != null) {
                  param.setResult(fakeActivityInfo);
                }
              }
            }
          }
        }
      );
    } catch (Throwable t) {
      log("Hook getActivityInfoå¤±è´¥: " + t.getMessage());
    }
  }

  private Object createFakeActivityInfo(String packageName, String className) {
    try {
      Class<?> activityInfoClass = Class.forName(
        "android.content.pm.ActivityInfo"
      );
      Object activityInfo = activityInfoClass.newInstance();

      XposedHelpers.setObjectField(activityInfo, "packageName", packageName);
      XposedHelpers.setObjectField(activityInfo, "name", className);
      XposedHelpers.setObjectField(activityInfo, "enabled", true);
      XposedHelpers.setObjectField(activityInfo, "exported", true);
      XposedHelpers.setIntField(activityInfo, "flags", 0);
      XposedHelpers.setIntField(activityInfo, "theme", 0);
      XposedHelpers.setIntField(activityInfo, "uiOptions", 0);

      ApplicationInfo appInfo = createFakeApplicationInfo(packageName);
      XposedHelpers.setObjectField(activityInfo, "applicationInfo", appInfo);

      return activityInfo;
    } catch (Throwable e) {
      return null;
    }
  }

  // ========== Intentç›¸å…³æ–¹æ³• ==========
  private void hookQueryIntentActivities(ClassLoader classLoader) {
    try {
      XposedBridge.hookAllMethods(
        XposedHelpers.findClass(
          "android.app.ApplicationPackageManager",
          classLoader
        ),
        "queryIntentActivities",
        new XC_MethodHook() {
          @Override
          protected void beforeHookedMethod(MethodHookParam param)
            throws Throwable {
            try {
              // æå–Intentå‚æ•°ï¼ˆå…¼å®¹å‚æ•°ä½ç½®å˜åŒ–ï¼Œéå†æ‰¾åˆ°Intentç±»å‹ï¼‰
              Intent intent = null;
              for (Object arg : param.args) {
                if (arg instanceof Intent) {
                  intent = (Intent) arg;
                  break;
                }
              }

              if (intent == null) {
                //          log("ã€queryIntentActivitiesã€‘æœªæ‰¾åˆ°Intentå‚æ•°ï¼Œè·³è¿‡Hook");
                return;
              }
              // ä»Intentä¸­æå–ç›®æ ‡åŒ…å
              String targetPackage = extractPackageFromIntent(intent);
              if (
                targetPackage != null && !targetPackage.equals(currentTargetApp)
              ) {
                // ç»Ÿä¸€å¤„ç†IntentæŸ¥è¯¢
                handleIntentQueryForIntentHook(
                  param,
                  targetPackage,
                  "queryIntentActivitiesï¼ˆå…¼å®¹ç‰ˆï¼‰"
                );
              }
            } catch (Throwable t) {
              //         log("ã€queryIntentActivities Hookå¼‚å¸¸ã€‘" + t.getMessage());
            }
          }
        }
      );
      // 2. é¢å¤–Hook Android 11+ æ–°å¢çš„ queryIntentActivitiesAsUser æ–¹æ³•
      try {
        XposedBridge.hookAllMethods(
          XposedHelpers.findClass(
            "android.app.ApplicationPackageManager",
            classLoader
          ),
          "queryIntentActivitiesAsUser",
          new XC_MethodHook() {
            @Override
            protected void beforeHookedMethod(MethodHookParam param)
              throws Throwable {
              try {
                // æå–Intentå‚æ•°ï¼ˆå…¼å®¹å‚æ•°ä½ç½®å˜åŒ–ï¼‰
                Intent intent = null;
                for (Object arg : param.args) {
                  if (arg instanceof Intent) {
                    intent = (Intent) arg;
                    break;
                  }
                }
                if (intent == null) {
                  //
                  // log("ã€queryIntentActivitiesAsUserã€‘æœªæ‰¾åˆ°Intentå‚æ•°ï¼Œè·³è¿‡Hook");
                  return;
                }
                String targetPackage = extractPackageFromIntent(intent);
                if (
                  targetPackage != null &&
                  !targetPackage.equals(currentTargetApp)
                ) {
                  handleIntentQueryForIntentHook(
                    param,
                    targetPackage,
                    "queryIntentActivitiesAsUserï¼ˆå…¼å®¹ç‰ˆï¼‰"
                  );
                }
              } catch (Throwable t) {
                log(
                  "ã€queryIntentActivitiesAsUser Hookå¼‚å¸¸ã€‘" + t.getMessage()
                );
              }
            }
          }
        );
        //     log("âœ… æˆåŠŸHook queryIntentActivitiesAsUserï¼ˆAndroid 11+é€‚é…ï¼‰");
      } catch (Throwable e) {
        // ä½ç‰ˆæœ¬Androidæ— æ­¤æ–¹æ³•ï¼Œå¿½ç•¥ï¼ˆä¸å½±å“æ ¸å¿ƒåŠŸèƒ½ï¼‰
        //       log("âš ï¸  è®¾å¤‡ä¸æ”¯æŒqueryIntentActivitiesAsUserï¼Œè·³è¿‡Hook");
      }
      //    log("âœ… æˆåŠŸHook queryIntentActivitiesï¼ˆå…¼å®¹æ‰€æœ‰é‡è½½ç‰ˆæœ¬+Android 11+ï¼‰");
    } catch (Throwable t) {
      log("Hook queryIntentActivitieså¤±è´¥: " + t.getMessage());
    }
  }

  private void hookResolveActivity(ClassLoader classLoader) {
    try {
      XposedHelpers.findAndHookMethod(
        "android.app.ApplicationPackageManager",
        classLoader,
        "resolveActivity",
        Intent.class,
        int.class,
        new XC_MethodHook() {
          @Override
          protected void beforeHookedMethod(MethodHookParam param)
            throws Throwable {
            Intent intent = (Intent) param.args[0];
            if (intent == null) {
              //   log("âš ï¸  ç©ºIntentï¼Œè·³è¿‡ResolveActivity Hook");
              return;
            }
            String targetPackage = extractPackageFromIntent(intent);
            if (
              targetPackage != null && !targetPackage.equals(currentTargetApp)
            ) {
              Boolean status = installStatusMap.get(currentTargetApp);
              boolean shouldReturnInstalled = status != null ? status : true;
              if (!shouldReturnInstalled) {
                // æœªå®‰è£…ï¼šè¿”å›ç©ºå®‰å…¨ResolveInfoï¼Œé¿å…è·³è½¬å´©æºƒ
                Class<?> resolveInfoClass = Class.forName(
                  "android.content.pm.ResolveInfo"
                );
                Object emptyResolveInfo = resolveInfoClass.newInstance();
                // è®¾ç½®æ— æ•ˆæ ‡è®°ï¼Œè®©ç›®æ ‡åº”ç”¨è¯†åˆ«ä¸ºâ€œæ— åŒ¹é…Activityâ€
                XposedHelpers.setIntField(emptyResolveInfo, "priority", -1);
                XposedHelpers.setIntField(emptyResolveInfo, "match", 0);
                XposedHelpers.setBooleanField(
                  emptyResolveInfo,
                  "isDefault",
                  false
                );

                param.setResult(emptyResolveInfo);
                //    log("ã€æœªå®‰è£…çŠ¶æ€ã€‘è¿”å›å®‰å…¨ç©ºResolveInfo: " + targetPackage);
                return;
              }
              // å·²å®‰è£…ï¼šåŸæœ‰é€»è¾‘ä¸å˜
              boolean isCaptured = false;
              synchronized (globalCapturedPackages) {
                isCaptured = globalCapturedPackages.contains(targetPackage);
              }
              if (isCaptured) {
                Object fakeResolveInfo = createFakeResolveInfo(targetPackage);
                if (fakeResolveInfo != null) {
                  param.setResult(fakeResolveInfo);
                }
              }
            }
          }
        }
      );
    } catch (Throwable t) {
      log("Hook resolveActivityå¤±è´¥: " + t.getMessage());
    }
  }

  private void hookQueryIntentServices(ClassLoader classLoader) {
    try {
      XposedHelpers.findAndHookMethod(
        "android.app.ApplicationPackageManager",
        classLoader,
        "queryIntentServices",
        Intent.class,
        int.class,
        new XC_MethodHook() {
          @Override
          protected void beforeHookedMethod(MethodHookParam param)
            throws Throwable {
            Intent intent = (Intent) param.args[0];
            if (intent == null) {
              //          log("âš ï¸  ç©ºIntentï¼Œè·³è¿‡ResolveActivity Hook");
              return;
            }

            String targetPackage = extractPackageFromIntent(intent);
            if (
              targetPackage != null && !targetPackage.equals(currentTargetApp)
            ) {
              handleIntentQueryForIntentHook(
                param,
                targetPackage,
                "queryIntentServices"
              );
            }
          }
        }
      );
    } catch (Throwable t) {
      log("Hook queryIntentServiceså¤±è´¥: " + t.getMessage());
    }
  }

  // ç»Ÿä¸€çš„IntentæŸ¥è¯¢å¤„ç†æ–¹æ³•
  private void handleIntentQueryForIntentHook(
    MethodHookParam param,
    String targetPackage,
    String methodName
  ) {
    try {
      Boolean status = installStatusMap.get(currentTargetApp);
      boolean shouldReturnInstalled = status != null ? status : true;

      if (!shouldReturnInstalled) {
        param.setResult(new ArrayList<>());
        return;
      }

      boolean isCaptured = false;
      synchronized (globalCapturedPackages) {
        isCaptured = globalCapturedPackages.contains(targetPackage);
      }

      if (isCaptured) {
        List<Object> fakeList = new ArrayList<>();
        Object fakeResolveInfo = createFakeResolveInfo(targetPackage);
        if (fakeResolveInfo != null) {
          fakeList.add(fakeResolveInfo);
          param.setResult(fakeList);
        }
      }
    } catch (Throwable t) {}
  }

  // ä»Intentä¸­æå–åŒ…å
  private String extractPackageFromIntent(Intent intent) {
    if (intent == null) {
      //        log("âš ï¸  ç©ºIntentï¼Œè·³è¿‡ResolveActivity Hook");
      return null;
    }

    String packageName = intent.getPackage();
    if (packageName != null && isValidPackageName(packageName)) {
      return packageName;
    }

    ComponentName component = intent.getComponent();
    if (component != null) {
      packageName = component.getPackageName();
      if (isValidPackageName(packageName)) {
        return packageName;
      }
    }

    Uri data = intent.getData();
    if (data != null) {
      String scheme = data.getScheme();
      if ("package".equals(scheme)) {
        String schemeSpecificPart = data.getSchemeSpecificPart();
        if (isValidPackageName(schemeSpecificPart)) {
          return schemeSpecificPart;
        }
      }
    }

    return null;
  }

  // åˆ›å»ºä¼ªé€ çš„ResolveInfo
  private Object createFakeResolveInfo(String packageName) {
    try {
      Class<?> resolveInfoClass = Class.forName(
        "android.content.pm.ResolveInfo"
      );
      Object resolveInfo = resolveInfoClass.newInstance();

      XposedHelpers.setIntField(resolveInfo, "priority", 0);
      XposedHelpers.setIntField(resolveInfo, "preferredOrder", 0);
      XposedHelpers.setIntField(resolveInfo, "match", 0x00000000);
      XposedHelpers.setBooleanField(resolveInfo, "isDefault", false);

      Object activityInfo = createFakeActivityInfo(
        packageName,
        packageName + ".MainActivity"
      );
      if (activityInfo != null) {
        XposedHelpers.setObjectField(resolveInfo, "activityInfo", activityInfo);
      }

      try {
        XposedHelpers.setObjectField(
          resolveInfo,
          "nonLocalizedLabel",
          "App: " + packageName
        );
      } catch (Throwable e) {}

      return resolveInfo;
    } catch (Throwable e) {
      return null;
    }
  }

  // ========== å‘½ä»¤è¡Œæ£€æµ‹æ‹¦æˆª ==========
  private void hookRuntimeExecMethods(ClassLoader classLoader) {
    try {
      XposedHelpers.findAndHookMethod(
        "java.lang.Runtime",
        classLoader,
        "exec",
        String.class,
        new XC_MethodHook() {
          @Override
          protected void beforeHookedMethod(MethodHookParam param)
            throws Throwable {
            String command = (String) param.args[0];
            handleCommandLineDetection(param, command, "exec(String)");
          }
        }
      );

      XposedHelpers.findAndHookMethod(
        "java.lang.Runtime",
        classLoader,
        "exec",
        String[].class,
        new XC_MethodHook() {
          @Override
          protected void beforeHookedMethod(MethodHookParam param)
            throws Throwable {
            String[] commands = (String[]) param.args[0];
            if (commands != null && commands.length > 0) {
              StringBuilder cmdBuilder = new StringBuilder();
              for (String cmd : commands) {
                cmdBuilder.append(cmd).append(" ");
              }
              String command = cmdBuilder.toString().trim();
              handleCommandLineDetection(param, command, "exec(String[])");
            }
          }
        }
      );

      XposedHelpers.findAndHookMethod(
        "java.lang.Runtime",
        classLoader,
        "exec",
        String.class,
        String[].class,
        new XC_MethodHook() {
          @Override
          protected void beforeHookedMethod(MethodHookParam param)
            throws Throwable {
            String command = (String) param.args[0];
            handleCommandLineDetection(
              param,
              command,
              "exec(String, String[])"
            );
          }
        }
      );

      XposedHelpers.findAndHookMethod(
        "java.lang.Runtime",
        classLoader,
        "exec",
        String[].class,
        String[].class,
        new XC_MethodHook() {
          @Override
          protected void beforeHookedMethod(MethodHookParam param)
            throws Throwable {
            String[] commands = (String[]) param.args[0];
            if (commands != null && commands.length > 0) {
              StringBuilder cmdBuilder = new StringBuilder();
              for (String cmd : commands) {
                cmdBuilder.append(cmd).append(" ");
              }
              String command = cmdBuilder.toString().trim();
              handleCommandLineDetection(
                param,
                command,
                "exec(String[], String[])"
              );
            }
          }
        }
      );
    } catch (Throwable t) {
      log("Hook Runtime.execå¤±è´¥: " + t.getMessage());
    }
  }

  // å¤„ç†å‘½ä»¤è¡Œæ£€æµ‹
  private void handleCommandLineDetection(
    MethodHookParam param,
    String command,
    String methodName
  ) {
    if (command == null) return;

    String lowerCommand = command.toLowerCase();

    if (isPackageDetectionCommand(lowerCommand)) {
      Boolean status = installStatusMap.get(currentTargetApp);
      boolean shouldReturnInstalled = status != null ? status : true;

      Object fakeProcess = createFakeProcess(command, shouldReturnInstalled);
      if (fakeProcess != null) {
        param.setResult(fakeProcess);
      }
    }
  }

  // åˆ¤æ–­æ˜¯å¦ä¸ºåŒ…æ£€æµ‹å‘½ä»¤
  private boolean isPackageDetectionCommand(String command) {
    if (command == null) return false;
    String lowerCommand = command.toLowerCase();
    if (command.contains("pm ") || command.startsWith("pm ")) {
      return (
        command.contains("list packages") ||
        command.contains("path ") ||
        command.contains("dump ") ||
        command.contains("clear ") ||
        command.contains("install ") ||
        command.contains("uninstall ") ||
        command.contains("enable ") ||
        command.contains("disable ")
      );
    }

    // 2. æ‰©å±•dumpsyså‘½ä»¤æ‹¦æˆª
    if (command.contains("dumpsys ")) {
      return (
        command.contains("dumpsys package") ||
        command.contains("dumpsys activity") ||
        command.contains("dumpsys meminfo") ||
        command.contains("dumpsys package --check") ||
        command.contains("dumpsys package --verify") ||
        command.contains("dumpsys package --brief")
      );
    }

    // 3. æ‰©å±•cmdå‘½ä»¤æ‹¦æˆªï¼ˆAndroid 11+ï¼‰
    if (
      command.contains("cmd package ") || command.startsWith("cmd package ")
    ) {
      return (
        command.contains("list") ||
        command.contains("path") ||
        command.contains("dump") ||
        command.contains("--check") ||
        command.contains("--verify")
      );
    }

    if (
      command.contains("ls ") ||
      command.contains("find ") ||
      command.contains("cat ")
    ) {
      return (
        command.contains("/data/app/") ||
        command.contains("/system/app/") ||
        command.contains("/system/priv-app/") ||
        command.contains("/vendor/app/") ||
        command.contains("/product/app/") ||
        command.contains("/data/data/") ||
        command.contains("/proc/") ||
        command.contains("packages.xml") ||
        command.contains("packages.list") ||
        command.contains("packages_cache.xml")
      );
    }

    if (command.contains("getprop")) {
      return (
        command.contains("package") ||
        command.contains("app") ||
        command.contains("install")
      );
    }

    if (command.contains("ps ") || command.startsWith("ps")) {
      return (
        command.contains("| grep ") ||
        command.contains("com.") ||
        command.contains("-A") ||
        command.contains("-a")
      );
    }

    if (command.contains("which ") || command.contains("whereis ")) {
      return (
        command.contains("pm") ||
        command.contains("dumpsys") ||
        command.contains("getprop")
      );
    }

    return false;
  }

  // åˆ›å»ºä¼ªé€ çš„Processå¯¹è±¡
  private Object createFakeProcess(
    final String command,
    final boolean shouldReturnInstalled
  ) {
    try {
      final ClassLoader classLoader = getClass().getClassLoader();
      final Class<?> processClass = Class.forName("java.lang.Process");

      final String fakeOutput = generateFakeCommandOutput(
        command,
        shouldReturnInstalled
      );

      return java.lang.reflect.Proxy.newProxyInstance(
        classLoader,
        new Class<?>[] { processClass },
        new java.lang.reflect.InvocationHandler() {
          @Override
          public Object invoke(Object proxy, Method method, Object[] args)
            throws Throwable {
            String methodName = method.getName();

            switch (methodName) {
              case "getInputStream":
                return new java.io.ByteArrayInputStream(
                  fakeOutput.getBytes("UTF-8")
                );
              case "getErrorStream":
                return new java.io.ByteArrayInputStream(new byte[0]);
              case "getOutputStream":
                return new java.io.OutputStream() {
                  @Override
                  public void write(int b) {}
                };
              case "waitFor":
                return 0;
              case "exitValue":
                return 0;
              case "destroy":
                return null;
              case "toString":
                return "FakeProcess[cmd=" + command + "]";
              default:
                if (method.getReturnType() == boolean.class) {
                  return false;
                } else if (method.getReturnType() == int.class) {
                  return 0;
                } else if (method.getReturnType() == long.class) {
                  return 0L;
                }
                return null;
            }
          }
        }
      );
    } catch (Throwable e) {
      return null;
    }
  }

  // ç”Ÿæˆä¼ªé€ çš„å‘½ä»¤è¡Œè¾“å‡º
  private String generateFakeCommandOutput(
    String command,
    boolean shouldReturnInstalled
  ) {
    if (!shouldReturnInstalled) {
      if (command.contains("pm list packages")) {
        return "";
      } else if (command.contains("pm path ")) {
        return "Error: package not found";
      } else if (command.contains("dumpsys package ")) {
        return "No package found";
      }
      return "";
    }

    String lowerCommand = command.toLowerCase();

    if (lowerCommand.contains("pm list packages")) {
      StringBuilder output = new StringBuilder();
      synchronized (globalCapturedPackages) {
        for (String pkg : globalCapturedPackages) {
          output.append("package:").append(pkg).append("\n");
        }
      }
      return output.toString();
    } else if (lowerCommand.contains("pm path ")) {
      String targetPackage = extractPackageFromCommand(command);
      if (targetPackage != null) {
        synchronized (globalCapturedPackages) {
          if (globalCapturedPackages.contains(targetPackage)) {
            return (
              "package:/data/app/" +
              targetPackage.replace('.', '-') +
              "-1/base.apk\n"
            );
          }
        }
      }
      return "Error: package not found";
    } else if (lowerCommand.contains("dumpsys package ")) {
      String targetPackage = extractPackageFromCommand(command);
      if (targetPackage != null) {
        synchronized (globalCapturedPackages) {
          if (globalCapturedPackages.contains(targetPackage)) {
            return generateFakeDumpsysOutput(targetPackage);
          }
        }
      }
      return "No package found for: " + targetPackage;
    } else if (
      lowerCommand.contains("ls ") && lowerCommand.contains("/data/app/")
    ) {
      StringBuilder output = new StringBuilder();
      synchronized (globalCapturedPackages) {
        for (String pkg : globalCapturedPackages) {
          String dirName = pkg.replace('.', '-') + "-1";
          output.append(dirName).append("\n");
        }
      }
      return output.toString();
    } else if (
      lowerCommand.contains("cat ") && lowerCommand.contains("packages.xml")
    ) {
      return generateFakePackagesXml();
    } else if (lowerCommand.contains("ps ") || command.startsWith("ps")) {
      return generateFakePsOutput();
    } else if (lowerCommand.contains("getprop")) {
      return (
        "[ro.build.version.sdk]: [28]\n" +
        "[ro.product.brand]: [google]\n" +
        "[ro.product.model]: [Pixel 3]\n"
      );
    }

    return "";
  }

  // ä»å‘½ä»¤ä¸­æå–åŒ…å
  private String extractPackageFromCommand(String command) {
    java.util.regex.Pattern pattern = java.util.regex.Pattern.compile(
      "(?:pm\\s+path|dumpsys\\s+package)\\s+([a-zA-Z0-9._]+)"
    );
    java.util.regex.Matcher matcher = pattern.matcher(command);
    if (matcher.find()) {
      return matcher.group(1);
    }

    pattern = java.util.regex.Pattern.compile("\"([a-zA-Z0-9._]+)\"");
    matcher = pattern.matcher(command);
    if (matcher.find()) {
      return matcher.group(1);
    }

    pattern = java.util.regex.Pattern.compile("'([a-zA-Z0-9._]+)'");
    matcher = pattern.matcher(command);
    if (matcher.find()) {
      return matcher.group(1);
    }

    return null;
  }

  // ç”Ÿæˆä¼ªé€ çš„dumpsysè¾“å‡º
  private String generateFakeDumpsysOutput(String packageName) {
    long now = System.currentTimeMillis();
    return (
      "Packages:\n" +
      "  Package [" +
      packageName +
      "] (aaaaaaaa):\n" +
      "    userId=10000\n" +
      "    pkg=Package{" +
      packageName +
      "}\n" +
      "    codePath=/data/app/" +
      packageName.replace('.', '-') +
      "-1\n" +
      "    resourcePath=/data/app/" +
      packageName.replace('.', '-') +
      "-1\n" +
      "    legacyNativeLibraryDir=/data/app/" +
      packageName.replace('.', '-') +
      "-1/lib\n" +
      "    primaryCpuAbi=null\n" +
      "    secondaryCpuAbi=null\n" +
      "    versionCode=1 minSdk=21 targetSdk=28\n" +
      "    versionName=1.0.0\n" +
      "    splits=[base]\n" +
      "    apkSigningVersion=2\n" +
      "    applicationInfo=ApplicationInfo{" +
      packageName +
      "}\n" +
      "    flags=[ HAS_CODE ALLOW_CLEAR_USER_DATA ALLOW_BACKUP ]\n" +
      "    privateFlags=[ PRIVATE_FLAG_ACTIVITIES_RESIZE_MODE_RESIZEABLE ]\n" +
      "    dataDir=/data/data/" +
      packageName +
      "\n" +
      "    supportsScreens=[small, medium, large, xlarge, resizeable, anyDensity]\n" +
      "    timeStamp=" +
      (now - 86400000) +
      "\n" +
      "    firstInstallTime=" +
      (now - 86400000) +
      "\n" +
      "    lastUpdateTime=" +
      now +
      "\n" +
      "    installerPackageName=com.android.vending\n" +
      "    signatures=PackageSignatures{aaaaaaaa version:1, signatures:[aaaaaaaa], past signatures:[]}\n" +
      "    permissionsFixed=true\n" +
      "    pkgFlags=[ HAS_CODE ALLOW_CLEAR_USER_DATA ALLOW_BACKUP ]\n"
    );
  }

  // ç”Ÿæˆä¼ªé€ çš„packages.xmlå†…å®¹
  private String generateFakePackagesXml() {
    StringBuilder xml = new StringBuilder();
    xml.append("<?xml version='1.0' encoding='utf-8' standalone='yes' ?>\n");
    xml.append("<packages>\n");

    synchronized (globalCapturedPackages) {
      int userId = 10000;
      for (String pkg : globalCapturedPackages) {
        xml
          .append("  <package name=\"")
          .append(pkg)
          .append("\" codePath=\"/data/app/")
          .append(pkg.replace('.', '-'))
          .append("-1\" nativeLibraryPath=\"/data/app/")
          .append(pkg.replace('.', '-'))
          .append("-1/lib\" primaryCpuAbi=\"arm64-v8a\" ")
          .append(
            "publicFlags=\"940834305\" privateFlags=\"0\" ft=\"16b4c\" it=\"16b4c\" "
          )
          .append("ut=\"16b4c\" version=\"1\" userId=\"")
          .append(userId++)
          .append("\">\n");
        xml.append("    <sigs count=\"1\">\n");
        xml.append("      <cert index=\"0\" key=\"fake_signature_key\" />\n");
        xml.append("    </sigs>\n");
        xml.append("    <perms />\n");
        xml.append("  </package>\n");
      }
    }

    xml.append("</packages>\n");
    return xml.toString();
  }

  // ç”Ÿæˆä¼ªé€ çš„è¿›ç¨‹åˆ—è¡¨
  private String generateFakePsOutput() {
    StringBuilder output = new StringBuilder();
    output.append(
      "USER      PID   PPID  VSIZE  RSS   WCHAN            PC  NAME\n"
    );
    output.append(
      "root      1     0     1234   567   SyS_epoll_ 00000000 S /init\n"
    );
    output.append(
      "system    100   1     2345   678   SyS_epoll_ 00000000 S system_server\n"
    );

    synchronized (globalCapturedPackages) {
      int pid = 2000;
      for (String pkg : globalCapturedPackages) {
        output.append(
          String.format(
            "u0_a100  %-6d 100   34567  4567  SyS_epoll_ 00000000 S %s\n",
            pid++,
            pkg
          )
        );
      }
    }

    return output.toString();
  }

  // ========== æ•°æ®ç›®å½•æ£€æµ‹è¡¥å…… ==========
  private void hookFileSystemChecks(ClassLoader classLoader) {
    try {
      XposedHelpers.findAndHookMethod(
        "java.io.File",
        classLoader,
        "exists",
        new XC_MethodHook() {
          @Override
          protected void beforeHookedMethod(MethodHookParam param)
            throws Throwable {
            checkAndFakeFileExistence(param, "exists");
          }
        }
      );

      XposedHelpers.findAndHookMethod(
        "java.io.File",
        classLoader,
        "isDirectory",
        new XC_MethodHook() {
          @Override
          protected void beforeHookedMethod(MethodHookParam param)
            throws Throwable {
            checkAndFakeFileExistence(param, "isDirectory");
          }
        }
      );

      XposedHelpers.findAndHookMethod(
        "java.io.File",
        classLoader,
        "isFile",
        new XC_MethodHook() {
          @Override
          protected void beforeHookedMethod(MethodHookParam param)
            throws Throwable {
            checkAndFakeFileExistence(param, "isFile");
          }
        }
      );

      XposedHelpers.findAndHookMethod(
        "java.io.File",
        classLoader,
        "canRead",
        new XC_MethodHook() {
          @Override
          protected void beforeHookedMethod(MethodHookParam param)
            throws Throwable {
            checkAndFakeFileExistence(param, "canRead");
          }
        }
      );
    } catch (Throwable t) {
      log("Hookæ–‡ä»¶ç³»ç»Ÿæ£€æŸ¥å¤±è´¥: " + t.getMessage());
    }
  }

  // ç»Ÿä¸€çš„æ–‡ä»¶å­˜åœ¨æ€§æ£€æŸ¥
  private void checkAndFakeFileExistence(
    MethodHookParam param,
    String methodName
  ) {
    try {
      File file = (File) param.thisObject;
      String path = file.getAbsolutePath();

      if (
        path.startsWith("/data/data/") ||
        path.startsWith("/data/app/") ||
        path.startsWith("/data/user/") ||
        path.startsWith("/data/user_de/") ||
        path.contains("/base.apk")
      ) {
        String packageName = extractPackageNameFromPath(path);
        if (packageName != null && !packageName.equals(currentTargetApp)) {
          Boolean status = installStatusMap.get(currentTargetApp);
          boolean shouldReturnInstalled = status != null ? status : true;

          if (!shouldReturnInstalled) {
            if (
              methodName.equals("exists") ||
              methodName.equals("isDirectory") ||
              methodName.equals("isFile")
            ) {
              param.setResult(false);
            } else if (methodName.equals("canRead")) {
              param.setResult(false);
            }
            return;
          }

          boolean isCaptured = false;
          synchronized (globalCapturedPackages) {
            isCaptured = globalCapturedPackages.contains(packageName);
          }

          if (isCaptured) {
            if (path.contains("/data/data/") && !path.contains("/base.apk")) {
              if (methodName.equals("exists")) {
                param.setResult(true);
              } else if (methodName.equals("isDirectory")) {
                param.setResult(true);
              } else if (methodName.equals("isFile")) {
                param.setResult(false);
              } else if (methodName.equals("canRead")) {
                param.setResult(true);
              }
            } else if (path.contains("/base.apk")) {
              if (methodName.equals("exists")) {
                param.setResult(true);
              } else if (methodName.equals("isDirectory")) {
                param.setResult(false);
              } else if (methodName.equals("isFile")) {
                param.setResult(true);
              } else if (methodName.equals("canRead")) {
                param.setResult(true);
              }
            }
          }
        }
      }
    } catch (Throwable t) {}
  }

  // ä»è·¯å¾„ä¸­æå–åŒ…å
  private String extractPackageNameFromPath(String path) {
    try {
      java.util.regex.Pattern pattern = java.util.regex.Pattern.compile(
        "/data/data/([a-zA-Z0-9._]+)"
      );
      java.util.regex.Matcher matcher = pattern.matcher(path);
      if (matcher.find()) {
        return matcher.group(1);
      }

      pattern = java.util.regex.Pattern.compile(
        "/data/app/([a-zA-Z0-9._]+)-\\d+"
      );
      matcher = pattern.matcher(path);
      if (matcher.find()) {
        return matcher.group(1).replace('-', '.');
      }

      pattern = java.util.regex.Pattern.compile(
        "/data/user/\\d+/([a-zA-Z0-9._]+)"
      );
      matcher = pattern.matcher(path);
      if (matcher.find()) {
        return matcher.group(1);
      }
    } catch (Throwable e) {}
    return null;
  }

  // ========== å¯å¯åŠ¨æ£€æµ‹è¡¥å…… ==========
  private void hookGetLaunchIntentForPackage(ClassLoader classLoader) {
    try {
      XposedHelpers.findAndHookMethod(
        "android.app.ApplicationPackageManager",
        classLoader,
        "getLaunchIntentForPackage",
        String.class,
        new XC_MethodHook() {
          @Override
          protected void beforeHookedMethod(MethodHookParam param)
            throws Throwable {
            handleLaunchIntentQuery(param, "getLaunchIntentForPackage");
          }
        }
      );

      try {
        XposedHelpers.findAndHookMethod(
          "android.app.ApplicationPackageManager",
          classLoader,
          "getLaunchIntentForPackageAsUser",
          String.class,
          int.class,
          new XC_MethodHook() {
            @Override
            protected void beforeHookedMethod(MethodHookParam param)
              throws Throwable {
              handleLaunchIntentQuery(param, "getLaunchIntentForPackageAsUser");
            }
          }
        );
      } catch (NoSuchMethodError e) {}
    } catch (Throwable t) {
      log("Hookå¯åŠ¨IntentæŸ¥è¯¢å¤±è´¥: " + t.getMessage());
    }
  }

  // ç»Ÿä¸€çš„å¯åŠ¨Intentå¤„ç†
  private void handleLaunchIntentQuery(
    MethodHookParam param,
    String methodName
  ) {
    try {
      String packageName = (String) param.args[0];
      if (packageName != null && !packageName.equals(currentTargetApp)) {
        Boolean status = installStatusMap.get(currentTargetApp);
        boolean shouldReturnInstalled = status != null ? status : true;

        if (!shouldReturnInstalled) {
          param.setResult(null);
          return;
        }

        boolean isCaptured = false;
        synchronized (globalCapturedPackages) {
          isCaptured = globalCapturedPackages.contains(packageName);
        }

        if (isCaptured) {
          Intent fakeIntent = new Intent(Intent.ACTION_MAIN);
          fakeIntent.addCategory(Intent.CATEGORY_LAUNCHER);
          fakeIntent.setPackage(packageName);
          fakeIntent.setComponent(
            new ComponentName(packageName, packageName + ".MainActivity")
          );
          fakeIntent.setFlags(Intent.FLAG_ACTIVITY_NEW_TASK);

          param.setResult(fakeIntent);
          log(
            "ã€ä¼ªé€ å¯åŠ¨ã€‘" + methodName + " -> è¿”å›ä¼ªé€ Intent: " + packageName
          );
        }
      }
    } catch (Throwable t) {}
  }

  // ========== å¯åŠ¨å¯è®¿é—®æ€§æ£€æŸ¥ ==========
  private void hookCanStartActivity(ClassLoader classLoader) {
    try {
      XposedHelpers.findAndHookMethod(
        "android.app.ContextImpl",
        classLoader,
        "startActivity",
        Intent.class,
        Bundle.class,
        new XC_MethodHook() {
          @Override
          protected void beforeHookedMethod(MethodHookParam param)
            throws Throwable {
            Intent intent = (Intent) param.args[0];
            if (intent == null) {
              //          log("âš ï¸  ç©ºIntentï¼Œè·³è¿‡ResolveActivity Hook");
              return;
            }

            String targetPackage = extractPackageFromIntent(intent);
            if (
              targetPackage != null && !targetPackage.equals(currentTargetApp)
            ) {
              Boolean status = installStatusMap.get(currentTargetApp);
              boolean shouldReturnInstalled = status != null ? status : true;

              if (!shouldReturnInstalled) {
                param.setThrowable(
                  new android.content.ActivityNotFoundException(
                    "No Activity found to handle " + intent
                  )
                );
              } else {
                boolean isCaptured = false;
                synchronized (globalCapturedPackages) {
                  isCaptured = globalCapturedPackages.contains(targetPackage);
                }

                if (isCaptured) {
                  log("ã€å¯åŠ¨ä¼ªè£…ã€‘å…è®¸å¯åŠ¨ä¼ªé€ åº”ç”¨: " + targetPackage);
                }
              }
            }
          }
        }
      );

      try {
        XposedHelpers.findAndHookMethod(
          "android.app.ContextImpl",
          classLoader,
          "startActivity",
          Intent.class,
          new XC_MethodHook() {
            @Override
            protected void beforeHookedMethod(MethodHookParam param)
              throws Throwable {
              Intent intent = (Intent) param.args[0];
              if (intent == null) {
                //       log("âš ï¸  ç©ºIntentï¼Œè·³è¿‡ResolveActivity Hook");
                return;
              }

              String targetPackage = extractPackageFromIntent(intent);
              if (
                targetPackage != null && !targetPackage.equals(currentTargetApp)
              ) {
                Boolean status = installStatusMap.get(currentTargetApp);
                boolean shouldReturnInstalled = status != null ? status : true;

                if (!shouldReturnInstalled) {
                  param.setThrowable(
                    new android.content.ActivityNotFoundException(
                      "No Activity found to handle " + intent
                    )
                  );
                } else {
                  boolean isCaptured = false;
                  synchronized (globalCapturedPackages) {
                    isCaptured = globalCapturedPackages.contains(targetPackage);
                  }

                  if (isCaptured) {
                    log(
                      "ã€å¯åŠ¨ä¼ªè£…ã€‘startActivity(Intent) -> å…è®¸å¯åŠ¨: " +
                      targetPackage
                    );
                  }
                }
              }
            }
          }
        );
      } catch (Throwable t) {}

      try {
        XposedHelpers.findAndHookMethod(
          "android.app.Activity",
          classLoader,
          "startActivityForResult",
          Intent.class,
          int.class,
          Bundle.class,
          new XC_MethodHook() {
            @Override
            protected void beforeHookedMethod(MethodHookParam param)
              throws Throwable {
              Intent intent = (Intent) param.args[0];
              if (intent == null) {
                //   log("âš ï¸  ç©ºIntentï¼Œè·³è¿‡ResolveActivity Hook");
                return;
              }

              String targetPackage = extractPackageFromIntent(intent);
              if (
                targetPackage != null && !targetPackage.equals(currentTargetApp)
              ) {
                Boolean status = installStatusMap.get(currentTargetApp);
                boolean shouldReturnInstalled = status != null ? status : true;

                if (!shouldReturnInstalled) {
                  final Activity activity = (Activity) param.thisObject;
                  final int requestCode = (int) param.args[1];

                  new Handler(Looper.getMainLooper()).postDelayed(
                    new Runnable() {
                      @Override
                      public void run() {
                        try {
                          XposedHelpers.callMethod(
                            activity,
                            "onActivityResult",
                            requestCode,
                            Activity.RESULT_CANCELED,
                            (Intent) null
                          );
                        } catch (Throwable e) {}
                      }
                    },
                    300
                  );

                  param.setResult(null);
                } else {
                  boolean isCaptured = false;
                  synchronized (globalCapturedPackages) {
                    isCaptured = globalCapturedPackages.contains(targetPackage);
                  }

                  if (isCaptured) {
                    log(
                      "ã€å¯åŠ¨ä¼ªè£…ã€‘startActivityForResult -> å…è®¸å¯åŠ¨: " +
                      targetPackage
                    );
                  }
                }
              }
            }
          }
        );
      } catch (Throwable t) {}
    } catch (Throwable t) {
      log("Hookå¯åŠ¨å¯è®¿é—®æ€§æ£€æŸ¥å¤±è´¥: " + t.getMessage());
    }
  }

  // ========== Libç›®å½•æ£€æµ‹è¡¥å…… ==========
  private void hookLibDirectoryChecks(ClassLoader classLoader) {
    try {
      XposedHelpers.findAndHookMethod(
        "java.io.File",
        classLoader,
        "exists",
        new XC_MethodHook() {
          @Override
          protected void beforeHookedMethod(MethodHookParam param)
            throws Throwable {
            checkAndFakeFileExistence(param, "exists");
            checkAndFakeLibExistence(param, "exists");
          }
        }
      );

      XposedHelpers.findAndHookMethod(
        "java.io.File",
        classLoader,
        "isDirectory",
        new XC_MethodHook() {
          @Override
          protected void beforeHookedMethod(MethodHookParam param)
            throws Throwable {
            checkAndFakeFileExistence(param, "isDirectory");
            checkAndFakeLibExistence(param, "isDirectory");
          }
        }
      );

      XposedHelpers.findAndHookMethod(
        "java.io.File",
        classLoader,
        "list",
        new XC_MethodHook() {
          @Override
          protected void beforeHookedMethod(MethodHookParam param)
            throws Throwable {
            checkAndFakeFileListing(param, "list");
          }
        }
      );

      XposedHelpers.findAndHookMethod(
        "java.io.File",
        classLoader,
        "listFiles",
        new XC_MethodHook() {
          @Override
          protected void beforeHookedMethod(MethodHookParam param)
            throws Throwable {
            checkAndFakeFileListing(param, "listFiles");
          }
        }
      );
    } catch (Throwable t) {
      log("Hook Libç›®å½•æ£€æµ‹å¤±è´¥: " + t.getMessage());
    }
  }

  // ========== Libç›®å½•æ£€æµ‹ä¸“ç”¨æ–¹æ³• ==========
  private void checkAndFakeLibExistence(
    MethodHookParam param,
    String methodName
  ) {
    try {
      File file = (File) param.thisObject;
      String path = file.getAbsolutePath();

      if (isLibDirectoryPath(path)) {
        String packageName = extractPackageNameFromLibPath(path);
        if (packageName != null && !packageName.equals(currentTargetApp)) {
          Boolean status = installStatusMap.get(currentTargetApp);
          boolean shouldReturnInstalled = status != null ? status : true;

          if (!shouldReturnInstalled) {
            if (
              methodName.equals("exists") || methodName.equals("isDirectory")
            ) {
              param.setResult(false);
            }
            return;
          }

          boolean isCaptured = false;
          synchronized (globalCapturedPackages) {
            isCaptured = globalCapturedPackages.contains(packageName);
          }

          if (isCaptured) {
            if (methodName.equals("exists")) {
              param.setResult(true);
            } else if (methodName.equals("isDirectory")) {
              param.setResult(true);
            }
          }
        }
      }
    } catch (Throwable t) {}
  }

  // Libç›®å½•åˆ—è¡¨æ£€æµ‹
  private void checkAndFakeFileListing(
    MethodHookParam param,
    String methodName
  ) {
    try {
      File file = (File) param.thisObject;
      String path = file.getAbsolutePath();

      if (isLibDirectoryPath(path)) {
        String packageName = extractPackageNameFromLibPath(path);
        if (packageName != null && !packageName.equals(currentTargetApp)) {
          Boolean status = installStatusMap.get(currentTargetApp);
          boolean shouldReturnInstalled = status != null ? status : true;

          if (!shouldReturnInstalled) {
            if (methodName.equals("list")) {
              param.setResult(new String[0]);
            } else if (methodName.equals("listFiles")) {
              param.setResult(new File[0]);
            }
            return;
          }

          boolean isCaptured = false;
          synchronized (globalCapturedPackages) {
            isCaptured = globalCapturedPackages.contains(packageName);
          }

          if (isCaptured) {
            if (methodName.equals("list")) {
              String[] fakeLibs = createFakeLibList(path);
              param.setResult(fakeLibs);
            } else if (methodName.equals("listFiles")) {
              File[] fakeFiles = createFakeLibFiles(path);
              param.setResult(fakeFiles);
            }
          }
        }
      }
    } catch (Throwable t) {}
  }

  // åˆ¤æ–­æ˜¯å¦æ˜¯libç›®å½•è·¯å¾„
  private boolean isLibDirectoryPath(String path) {
    if (path == null) return false;

    return (
      path.contains("/lib/") ||
      path.contains("/lib64/") ||
      path.contains("/lib/arm") ||
      path.contains("/lib/arm64") ||
      path.contains("/lib/x86") ||
      path.endsWith("/lib") ||
      path.contains("app-lib/")
    );
  }

  // ä»libè·¯å¾„ä¸­æå–åŒ…å
  private String extractPackageNameFromLibPath(String path) {
    try {
      java.util.regex.Pattern pattern = java.util.regex.Pattern.compile(
        "/data/app/([a-zA-Z0-9._]+)-\\d+/lib/"
      );
      java.util.regex.Matcher matcher = pattern.matcher(path);
      if (matcher.find()) {
        return matcher.group(1).replace('-', '.');
      }

      pattern = java.util.regex.Pattern.compile(
        "/data/data/([a-zA-Z0-9._]+)/lib/"
      );
      matcher = pattern.matcher(path);
      if (matcher.find()) {
        return matcher.group(1);
      }

      pattern = java.util.regex.Pattern.compile(
        "/data/app-lib/([a-zA-Z0-9._]+)"
      );
      matcher = pattern.matcher(path);
      if (matcher.find()) {
        return matcher.group(1);
      }
    } catch (Throwable e) {}
    return null;
  }

  // åˆ›å»ºä¼ªé€ çš„libæ–‡ä»¶åˆ—è¡¨
  private String[] createFakeLibList(String libPath) {
    List<String> libs = new ArrayList<>();

    libs.add("libapp.so");
    libs.add("libnative.so");
    libs.add("libcore.so");
    libs.add("libutils.so");
    libs.add("libsecurity.so");
    libs.add("libcrypto.so");
    libs.add("libssl.so");
    libs.add("libz.so");

    if (libPath.contains("arm64")) {
      libs.add("libarm64.so");
    } else if (libPath.contains("arm")) {
      libs.add("libarm.so");
    } else if (libPath.contains("x86")) {
      libs.add("libx86.so");
    }

    return libs.toArray(new String[0]);
  }

  // åˆ›å»ºä¼ªé€ çš„libæ–‡ä»¶å¯¹è±¡
  private File[] createFakeLibFiles(String libPath) {
    String[] libNames = createFakeLibList(libPath);
    File[] files = new File[libNames.length];

    for (int i = 0; i < libNames.length; i++) {
      files[i] = new File(libPath, libNames[i]);
    }

    return files;
  }

  // ========== Flutterç›¸å…³é€‚é… ==========
  private void hookFlutterPackageInfoPlus(ClassLoader classLoader) {
    try {
      String[] targetClasses = {
        "dev.fluttercommunity.plus.packageinfo.PackageInfoPlugin",
        "io.flutter.plugins.packageinfo.PackageInfoPlugin",
      };

      for (String className : targetClasses) {
        try {
          Class<?> pluginClass = XposedHelpers.findClassIfExists(
            className,
            classLoader
          );
          if (pluginClass != null) {
            XposedHelpers.findAndHookMethod(
              pluginClass,
              "handleMethodCall",
              "io.flutter.plugin.common.MethodCall",
              "io.flutter.plugin.common.Result",
              new XC_MethodHook() {
                @Override
                protected void beforeHookedMethod(MethodHookParam param)
                  throws Throwable {
                  try {
                    Object methodCall = param.args[0];
                    Object result = param.args[1];
                    if (methodCall == null || result == null) return;

                    String methodName = XposedHelpers.callMethod(
                      methodCall,
                      "method"
                    ).toString();

                    if (
                      "getPackageInfo".equals(methodName) ||
                      "getAllPackageInfo".equals(methodName)
                    ) {
                      String targetPackage = null;
                      Object arguments = XposedHelpers.callMethod(
                        methodCall,
                        "arguments"
                      );

                      if (arguments instanceof String) {
                        targetPackage = (String) arguments;
                      } else if (arguments instanceof Map) {
                        targetPackage = (String) ((Map) arguments).get(
                            "packageName"
                          );
                      }

                      Boolean status = installStatusMap.get(currentTargetApp);
                      boolean shouldReturnInstalled = status != null
                        ? status
                        : true;

                      if (!shouldReturnInstalled) {
                        Map<String, Object> errorMap = new HashMap<>();
                        errorMap.put("error", "Package not found");
                        XposedHelpers.callMethod(
                          result,
                          "error",
                          "NOT_FOUND",
                          "Package not found",
                          errorMap
                        );
                        param.setResult(null);
                        return;
                      }

                      Object fakeResult = createFakePackageInfoPlusResult(
                        targetPackage
                      );
                      if (fakeResult != null) {
                        XposedHelpers.callMethod(result, "success", fakeResult);
                        param.setResult(null);
                      }
                    }
                  } catch (Throwable t) {}
                }
              }
            );

            return;
          }
        } catch (Throwable t) {}
      }
    } catch (Throwable t) {
      log("é€‚é… package_info_plus æ’ä»¶å¤±è´¥: " + t.getMessage());
    }
  }

  private void hookFlutterAppInstalledChecker(ClassLoader classLoader) {
    try {
      String[] targetClasses = {
        "com.javih.addtoapp.AppInstalledCheckerPlugin",
        "com.example.appinstalledchecker.AppInstalledCheckerPlugin",
        "app.installed.checker.AppInstalledCheckerPlugin",
      };

      for (String className : targetClasses) {
        try {
          Class<?> pluginClass = XposedHelpers.findClassIfExists(
            className,
            classLoader
          );
          if (pluginClass != null) {
            XposedHelpers.findAndHookMethod(
              pluginClass,
              "onMethodCall",
              "io.flutter.plugin.common.MethodCall",
              "io.flutter.plugin.common.Result",
              new XC_MethodHook() {
                @Override
                protected void beforeHookedMethod(MethodHookParam param)
                  throws Throwable {
                  try {
                    Object methodCall = param.args[0];
                    Object result = param.args[1];
                    if (methodCall == null || result == null) return;

                    String methodName = XposedHelpers.callMethod(
                      methodCall,
                      "method"
                    ).toString();

                    if (
                      "isAppInstalled".equals(methodName) ||
                      "areAppsInstalled".equals(methodName)
                    ) {
                      Boolean status = installStatusMap.get(currentTargetApp);
                      boolean shouldReturnInstalled = status != null
                        ? status
                        : true;

                      if (!shouldReturnInstalled) {
                        if ("isAppInstalled".equals(methodName)) {
                          XposedHelpers.callMethod(result, "success", false);
                        } else if ("areAppsInstalled".equals(methodName)) {
                          Map<String, Boolean> fakeResultMap = new HashMap<>();
                          Object arguments = XposedHelpers.callMethod(
                            methodCall,
                            "arguments"
                          );
                          if (arguments instanceof ArrayList) {
                            ArrayList<String> targetPackages = (ArrayList<
                                String
                              >) arguments;
                            for (String pkg : targetPackages) {
                              fakeResultMap.put(pkg, false);
                            }
                          }
                          XposedHelpers.callMethod(
                            result,
                            "success",
                            fakeResultMap
                          );
                        }
                        param.setResult(null);
                        return;
                      }

                      Object arguments = XposedHelpers.callMethod(
                        methodCall,
                        "arguments"
                      );
                      if (
                        "isAppInstalled".equals(methodName) &&
                        arguments instanceof String
                      ) {
                        String targetPackage = (String) arguments;
                        boolean fakeInstalled = globalCapturedPackages.contains(
                          targetPackage
                        );
                        XposedHelpers.callMethod(
                          result,
                          "success",
                          fakeInstalled
                        );
                        param.setResult(null);
                      } else if (
                        "areAppsInstalled".equals(methodName) &&
                        arguments instanceof ArrayList
                      ) {
                        ArrayList<String> targetPackages = (ArrayList<
                            String
                          >) arguments;
                        Map<String, Boolean> fakeResultMap = new HashMap<>();
                        for (String pkg : targetPackages) {
                          fakeResultMap.put(
                            pkg,
                            globalCapturedPackages.contains(pkg)
                          );
                        }
                        XposedHelpers.callMethod(
                          result,
                          "success",
                          fakeResultMap
                        );
                        param.setResult(null);
                      }
                    }
                  } catch (Throwable t) {}
                }
              }
            );

            return;
          }
        } catch (Throwable t) {}
      }
    } catch (Throwable t) {
      log("é€‚é… app_installed_checker æ’ä»¶å¤±è´¥: " + t.getMessage());
    }
  }

  // ========== Flutter MethodChannel æ£€æµ‹æ‹¦æˆª ==========
  private void hookFlutterMethodChannelCheck(final ClassLoader classLoader) {
    try {
    // å…ˆåˆ¤æ–­ Flutter æ ¸å¿ƒç±»æ˜¯å¦å­˜åœ¨ï¼Œä¸å­˜åœ¨åˆ™è·³è¿‡
     Class<?> flutterClass = XposedHelpers.findClassIfExists("io.flutter.embedding.engine.dart.DartMessenger", classLoader);
      // å…ˆåˆ¤æ–­æ˜¯å¦ä¸ºFlutteråº”ç”¨ï¼ˆé¿å…æ— æ•ˆHookï¼‰
      if (!isFlutterApp(classLoader)) {
        //   log("âš ï¸ éFlutteråº”ç”¨ï¼Œè·³è¿‡MethodChannel Hook");
        return;
      }

      // 1. Hook Flutter 3.10+ åº•å±‚é€šä¿¡ï¼šDartMessenger.send
      Class<?> dartMessengerClass = XposedHelpers.findClassIfExists(
        "io.flutter.embedding.engine.dart.DartMessenger",
        classLoader
      );
      if (dartMessengerClass != null) {
        XposedHelpers.findAndHookMethod(
          dartMessengerClass,
          "send",
          int.class, // messageId
          "io.flutter.plugin.common.BinaryMessenger$BinaryMessage", // message
          "io.flutter.plugin.common.BinaryMessenger$BinaryReply", // reply
          new XC_MethodHook() {
            @Override
            protected void beforeHookedMethod(MethodHookParam param)
              throws Throwable {
              handleFlutterBinaryMessage(param, classLoader);
            }
          }
        );
      }

      // 2. Hook æ—§ç‰ˆ MethodChannel.invokeMethodï¼ˆå…¼å®¹Flutter 3.10ä»¥ä¸‹ï¼‰
      Class<?> methodChannelClass = XposedHelpers.findClassIfExists(
        "io.flutter.plugin.common.MethodChannel",
        classLoader
      );
      if (methodChannelClass != null) {
        // Hook invokeMethodï¼ˆåŒæ­¥è°ƒç”¨ï¼‰
        XposedHelpers.findAndHookMethod(
          methodChannelClass,
          "invokeMethod",
          String.class,
          Object.class,
          new XC_MethodHook() {
            @Override
            protected void beforeHookedMethod(MethodHookParam param)
              throws Throwable {
              handleFlutterMethodCall(
                (String) param.args[0],
                param.args[1],
                param
              );
            }
          }
        );

        // Hook setMethodCallHandlerï¼ˆå¼‚æ­¥è°ƒç”¨ï¼‰
        XposedHelpers.findAndHookMethod(
          methodChannelClass,
          "setMethodCallHandler",
          "io.flutter.plugin.common.MethodChannel$MethodCallHandler",
          new XC_MethodHook() {
            @Override
            protected void afterHookedMethod(MethodHookParam param)
              throws Throwable {
              Object handler = param.args[0];
              if (handler == null) return;
              // æ‹¦æˆªhandlerçš„onMethodCall
              XposedHelpers.findAndHookMethod(
                handler.getClass(),
                "onMethodCall",
                "io.flutter.plugin.common.MethodCall",
                "io.flutter.plugin.common.Result",
                new XC_MethodHook() {
                  @Override
                  protected void beforeHookedMethod(
                    MethodHookParam handlerParam
                  ) throws Throwable {
                    Object methodCall = handlerParam.args[0];
                    Object result = handlerParam.args[1];
                    String methodName = XposedHelpers.callMethod(
                      methodCall,
                      "method"
                    ).toString();
                    Object arguments = XposedHelpers.callMethod(
                      methodCall,
                      "arguments"
                    );
                    // å¤„ç†æ£€æµ‹è°ƒç”¨å¹¶è¿”å›ç»“æœ
                    Object fakeResult = handleFlutterMethodCall(
                      methodName,
                      arguments,
                      null
                    );
                    if (fakeResult != null) {
                      XposedHelpers.callMethod(result, "success", fakeResult);
                      handlerParam.setResult(null); // é˜»æ–­
                    }
                  }
                }
              );
            }
          }
        );
      }
      // log("âœ… å·²Hook Flutter MethodChannelæ£€æµ‹");
    } catch (Throwable t) {
      log("Hook FlutterMethå¤±è´¥: " + t.getMessage());
    }
  }

  // å¤„ç†Flutter BinaryMessageï¼ˆ3.10+ï¼‰
  private void handleFlutterBinaryMessage(
    MethodHookParam param,
    ClassLoader classLoader
  ) {
    try {
      Object message = param.args[1];
      if (message == null) return;
      // è§£æBinaryMessageä¸­çš„MethodCallæ•°æ®
      byte[] messageData = (byte[]) XposedHelpers.callMethod(
        message,
        "getData"
      );
      if (messageData == null || messageData.length == 0) return;

      // ååºåˆ—åŒ–MethodCall
      Class<?> methodCallClass = XposedHelpers.findClass(
        "io.flutter.plugin.common.MethodCall",
        classLoader
      );
      Object methodCall = XposedHelpers.newInstance(methodCallClass);
      XposedHelpers.callStaticMethod(
        methodCallClass,
        "decode",
        messageData,
        methodCall
      );

      String methodName = (String) XposedHelpers.getObjectField(
        methodCall,
        "method"
      );
      Object arguments = XposedHelpers.getObjectField(methodCall, "arguments");

      // å¤„ç†æ£€æµ‹è°ƒç”¨
      Object fakeResult = handleFlutterMethodCall(methodName, arguments, param);
      if (fakeResult != null) {
        // å‘é€ä¼ªé€ å“åº”
        sendFlutterBinaryReply(param.args[2], fakeResult, classLoader);
        param.setResult(null); // é˜»æ–­
      }
    } catch (Throwable t) {
      log("å¤„ç†FlutterBinaå¤±è´¥: " + t.getMessage());
    }
  }

  // å¤„ç†Flutter MethodCall
  private Object handleFlutterMethodCall(
    String methodName,
    Object arguments,
    MethodHookParam param
  ) {
    // åŒ¹é…å¸¸è§çš„FlutteråŒ…æ£€æµ‹æ–¹æ³•å
    if (
      methodName.contains("isAppInstalled") ||
      methodName.contains("checkAppInstalled") ||
      methodName.contains("getPackageInfo") ||
      methodName.contains("queryInstalledPackages")
    ) {
      Boolean status = installStatusMap.get(currentTargetApp);
      boolean shouldReturnInstalled = status != null ? status : true;
      String targetPkg = extractPackageFromFlutterArgs(arguments);

      if (methodName.contains("isAppInstalled")) {
        // å•ä¸ªåŒ…æ£€æµ‹ï¼šæœªå®‰è£…è¿”å›falseï¼Œå·²å®‰è£…è¿”å›true
        boolean result =
          shouldReturnInstalled &&
          targetPkg != null &&
          globalCapturedPackages.contains(targetPkg);
        //   log("ã€Flutteræ£€æµ‹æ‹¦æˆªã€‘" + methodName + "(" + targetPkg + ") -> " + result);
        return result;
      } else if (methodName.contains("getPackageInfo")) {
        // åŒ…ä¿¡æ¯æŸ¥è¯¢ï¼šæœªå®‰è£…è¿”å›nullï¼Œå·²å®‰è£…è¿”å›ä¼ªé€ ä¿¡æ¯
        Object fakeInfo = shouldReturnInstalled && targetPkg != null
          ? createFakeFlutterPackageInfo(targetPkg)
          : null;
        //   log("ã€Flutteræ£€æµ‹æ‹¦æˆªã€‘" + methodName + "(" + targetPkg + ") -> " + (fakeInfo !=
        // null ? "ä¼ªé€ ä¿¡æ¯" : "null"));
        return fakeInfo;
      } else if (methodName.contains("queryInstalledPackages")) {
        // åº”ç”¨åˆ—è¡¨æŸ¥è¯¢ï¼šæœªå®‰è£…è¿”å›ç©ºåˆ—è¡¨ï¼Œå·²å®‰è£…è¿”å›æ•è·åŒ…åˆ—è¡¨
        List<Map<String, Object>> fakeList = new ArrayList<>();
        if (shouldReturnInstalled) {
          synchronized (globalCapturedPackages) {
            for (String pkg : globalCapturedPackages) {
              fakeList.add(createFakeFlutterPackageInfo(pkg));
            }
          }
        }
        //  log("ã€Flutteræ£€æµ‹æ‹¦æˆªã€‘" + methodName + " -> " + fakeList.size() + "ä¸ªåŒ…");
        return fakeList;
      }
    }
    return null; // éæ£€æµ‹æ–¹æ³•ï¼Œä¸æ‹¦æˆª
  }

  // è¾…åŠ©æ–¹æ³•ï¼šä»Flutterå‚æ•°ä¸­æå–åŒ…å
  private String extractPackageFromFlutterArgs(Object arguments) {
    if (arguments instanceof String) {
      return (String) arguments;
    } else if (arguments instanceof Map) {
      Map<?, ?> map = (Map<?, ?>) arguments;
      return map.get("packageName") != null
        ? map.get("packageName").toString()
        : null;
    }
    return null;
  }

  // è¾…åŠ©æ–¹æ³•ï¼šåˆ›å»ºä¼ªé€ çš„FlutteråŒ…ä¿¡æ¯
  private Map<String, Object> createFakeFlutterPackageInfo(String packageName) {
    Map<String, Object> fakeInfo = new HashMap<>();
    fakeInfo.put("packageName", packageName);
    fakeInfo.put("appName", generateSmartAppName(packageName)); // å¤ç”¨åŸæœ‰æ™ºèƒ½åç§°ç”Ÿæˆ
    fakeInfo.put("versionName", generateSmartVersion(packageName)); // å¤ç”¨æ™ºèƒ½ç‰ˆæœ¬ç”Ÿæˆ
    fakeInfo.put(
      "versionCode",
      generateSmartVersionCode(
        packageName,
        fakeInfo.get("versionName").toString()
      )
    );
    fakeInfo.put("installTime", generateSmartInstallTime(packageName));
    fakeInfo.put("isInstalled", true);
    return fakeInfo;
  }

  // è¾…åŠ©æ–¹æ³•ï¼šç»™Flutter BinaryReplyå‘é€ä¼ªé€ å“åº”
  private void sendFlutterBinaryReply(
    Object reply,
    Object fakeResult,
    ClassLoader classLoader
  ) {
    try {
      if (reply == null) return;
      // åºåˆ—åŒ–ä¼ªé€ ç»“æœä¸ºFlutterå¯è¯†åˆ«çš„Binaryæ•°æ®
      Class<?> resultClass = XposedHelpers.findClass(
        "io.flutter.plugin.common.Result",
        classLoader
      );
      Class<?> binaryCodecClass = XposedHelpers.findClass(
        "io.flutter.plugin.common.BinaryCodec",
        classLoader
      );
      Object binaryCodec = XposedHelpers.newInstance(binaryCodecClass);
      Object successResult = XposedHelpers.callStaticMethod(
        resultClass,
        "success",
        fakeResult
      );
      byte[] resultData = (byte[]) XposedHelpers.callMethod(
        binaryCodec,
        "encode",
        successResult
      );
      // å‘é€å“åº”
      XposedHelpers.callMethod(reply, "reply", resultData);
    } catch (Throwable t) {
      log("å‘é€Flutterä¼ªé€ å“åº”å¤±è´¥: " + t.getMessage());
    }
  }

  // ========== åå°„è°ƒç”¨PackageManageræ£€æµ‹æ‹¦æˆª ==========
  private void hookReflectInstallCheck(ClassLoader classLoader) {
    try {
      XposedHelpers.findAndHookMethod(
        "java.lang.reflect.Method",
        classLoader,
        "invoke",
        Object.class,
        Object[].class,
        new XC_MethodHook() {
          @Override
          protected void beforeHookedMethod(MethodHookParam param)
            throws Throwable {
            Method method = (Method) param.thisObject;
            String methodName = method.getName();
            Class<?> declaringClass = method.getDeclaringClass();

            // 1. è¿‡æ»¤å¤„ç†PackageManagerçš„åŒ…æŸ¥è¯¢æ–¹æ³•
            boolean isPackageManagerClass =
              declaringClass
                .getName()
                .equals("android.content.pm.PackageManager") ||
              declaringClass
                .getName()
                .equals("android.app.ApplicationPackageManager");
            boolean isPackageQueryMethod =
              methodName.equals("getPackageInfo") ||
              methodName.equals("getApplicationInfo");

            // éç›®æ ‡è°ƒç”¨ï¼Œç›´æ¥æ”¾è¡Œ
            if (!isPackageManagerClass || !isPackageQueryMethod) {
              return;
            }

            // 2. æå–åŒ…åï¼Œè·³è¿‡é‡è¯•åŒ…ã€ç³»ç»ŸåŒ…ã€ç©ºåŒ…å
            String targetPkg = extractPackageFromReflectArgs(param.args);
            if (
              targetPkg == null ||
              isSystemCorePackage(targetPkg) ||
              isReflectRetryInvocation()
            ) {
              //    log("ã€åå°„æ‹¦æˆªã€‘æ”¾è¡ŒåŒ…: " + (targetPkg == null ? "null" : targetPkg));
              return;
            }

            // 3. æŒ‰å®‰è£…çŠ¶æ€è¿”å›ç»“æœ
            Boolean status = installStatusMap.get(currentTargetApp);
            boolean shouldReturnInstalled = status != null ? status : true;
            if (!shouldReturnInstalled) {
              param.setResult(null);
              //   log("ã€åå°„è°ƒç”¨æ‹¦æˆªã€‘æœªå®‰è£… -> è¿”å›null: " + methodName + "(" + targetPkg + ")");
            } else {
              int flags = extractFlagsFromReflectArgs(method, param.args);
              Object fakeResult = methodName.equals("getPackageInfo")
                ? createSmartFakePackageInfo(targetPkg, flags)
                : createSmartApplicationInfo(targetPkg, flags);
              param.setResult(fakeResult);
              // log("ã€åå°„è°ƒç”¨æ‹¦æˆªã€‘å·²å®‰è£… -> ä¼ªé€ ä¿¡æ¯: " + methodName + "(" + targetPkg + ")");
            }
          }
        }
      );
      //log("âœ… å·²Hookåå°„è°ƒç”¨PackageManageræ£€æµ‹ï¼ˆç»ˆææ— å†²çªç‰ˆï¼‰");
    } catch (Throwable t) {
      log("Hookåå°„æ£€æµ‹å¤±è´¥: " + t.getMessage());
    }
  }

  // ä¿ç•™æ‰€æœ‰åŸæœ‰è¾…åŠ©æ–¹æ³•
  private boolean isReflectRetryInvocation() {
    StackTraceElement[] stackTrace = Thread.currentThread().getStackTrace();
    int pkgManagerCallCount = 0;
    for (StackTraceElement element : stackTrace) {
      if (
        (element.getClassName().equals("android.content.pm.PackageManager") ||
          element
            .getClassName()
            .equals("android.app.ApplicationPackageManager")) &&
        (element.getMethodName().equals("getPackageInfo") ||
          element.getMethodName().equals("getApplicationInfo"))
      ) {
        pkgManagerCallCount++;
        if (pkgManagerCallCount >= 2) {
          return true;
        }
      }
    }
    return false;
  }

  private Method createFakePackageManagerMethod(
    Class<?> clazz,
    String methodName
  ) {
    try {
      if (methodName.equals("getPackageInfo")) {
        return clazz.getMethod("getPackageInfo", String.class, int.class);
      } else if (methodName.equals("getApplicationInfo")) {
        return clazz.getMethod("getApplicationInfo", String.class, int.class);
      } else if (methodName.equals("getInstalledPackages")) {
        return clazz.getMethod("getInstalledPackages", int.class);
      } else {
        return clazz.getMethod(methodName);
      }
    } catch (NoSuchMethodException e) {
      return null;
    }
  }

  private String extractPackageFromReflectArgs(Object[] args) {
    if (args == null || args.length < 2) return null;
    Object[] methodArgs = (Object[]) args[1];
    for (Object arg : methodArgs) {
      if (arg instanceof String && isValidPackageName((String) arg)) {
        return (String) arg;
      }
    }
    return null;
  }

  private int extractFlagsFromReflectArgs(Method method, Object[] args) {
    if (args == null || args.length < 2) return 0;
    Object[] methodArgs = (Object[]) args[1];
    if (
      method.getParameterTypes().length == 2 &&
      method.getParameterTypes()[1] == int.class
    ) {
      for (Object arg : methodArgs) {
        if (arg instanceof Integer) {
          return (int) arg;
        }
      }
    }
    return 0;
  }

  // ========== æ–‡ä»¶è·¯å¾„éªŒè¯æ£€æµ‹æ‹¦æˆª ==========
  private void hookFileSystemInstallCheck(ClassLoader classLoader) {
  
    try {
    
      // Hook File.exists() - æ‹¦æˆªå®‰è£…è·¯å¾„å­˜åœ¨æ€§æ£€æµ‹
      XposedHelpers.findAndHookMethod(
        "java.io.File",
        classLoader,
        "exists",
        new XC_MethodHook() {
          @Override
          protected void beforeHookedMethod(MethodHookParam param)
            throws Throwable {
            File file = (File) param.thisObject;
            String path = file.getAbsolutePath();
            // ä»…æ‹¦æˆªåº”ç”¨å®‰è£…ç›¸å…³è·¯å¾„
            if (isAppInstallPath(path)) {
              String targetPkg = extractPackageFromPath(path);
              if (
                targetPkg != null &&
                !targetPkg.equals(currentTargetApp) &&
                !isSystemCorePackage(targetPkg)
              ) {
                Boolean status = installStatusMap.get(currentTargetApp);
                boolean shouldReturnInstalled = status != null ? status : true;
                // æœªå®‰è£…çŠ¶æ€è¿”å›falseï¼ˆè·¯å¾„ä¸å­˜åœ¨ï¼‰ï¼Œå·²å®‰è£…è¿”å›true
                param.setResult(shouldReturnInstalled);
                //  log("ã€æ–‡ä»¶æ£€æµ‹æ‹¦æˆªã€‘è·¯å¾„: " + path + " -> è¿”å›" +
                // shouldReturnInstalled);
              }
            }
          }
        }
      );


      // Hook File.isDirectory() - æ‹¦æˆªç›®å½•éªŒè¯
      XposedHelpers.findAndHookMethod(
        "java.io.File",
        classLoader,
        "isDirectory",
        new XC_MethodHook() {
          @Override
          protected void beforeHookedMethod(MethodHookParam param)
            throws Throwable {
            File file = (File) param.thisObject;
            String path = file.getAbsolutePath();
            if (isAppInstallPath(path)) {
              String targetPkg = extractPackageFromPath(path);
              if (
                targetPkg != null &&
                !targetPkg.equals(currentTargetApp) &&
                !isSystemCorePackage(targetPkg)
              ) {
                Boolean status = installStatusMap.get(currentTargetApp);
                param.setResult(status != null ? status : true);
              }
            }
          }
        }
      );
      
      //    log("âœ… å·²Hookæ–‡ä»¶è·¯å¾„éªŒè¯æ£€æµ‹ï¼ˆexists/isDirectoryï¼‰");
    } catch (Throwable t) {
      log("Hookæ–‡ä»¶è·¯å¾„æ£€æµ‹å¤±è´¥: " + t.getMessage());
    }
  }

  // è¾…åŠ©æ–¹æ³•ï¼šåˆ¤æ–­æ˜¯å¦ä¸ºåº”ç”¨å®‰è£…è·¯å¾„
  private boolean isAppInstallPath(String path) {
    return (
      path.startsWith("/data/data/") ||
      path.startsWith("/data/app/") ||
      path.startsWith("/data/user/") ||
      path.startsWith("/data/user_de/") ||
      path.contains("/base.apk") ||
      path.endsWith("/lib") ||
      path.endsWith("/lib64") ||
      path.contains("/system/app/") ||
      path.contains("/system/priv-app/")
    );
  }

  // è¾…åŠ©æ–¹æ³•ï¼šä»è·¯å¾„ä¸­æå–åŒ…å
  private String extractPackageFromPath(String path) {
    try {
    /*
      // åŒ¹é… /data/data/åŒ…åã€/data/app/åŒ…å-1ã€/data/user/0/åŒ…å ç­‰æ ¼å¼
      java.util.regex.Pattern pattern = java.util.regex.Pattern.compile(
        "/data/(data|app|user/\\d+|user_de/\\d+)/([a-zA-Z0-9._]+)"
      );
      
      java.util.regex.Matcher matcher = pattern.matcher(path);
      if (matcher.find()) {
        return matcher.group(2);
      }
      */
              java.util.regex.Pattern pattern = java.util.regex.Pattern.compile(
            "/data/app/([a-zA-Z0-9._]+)-\\d+"
        );
        java.util.regex.Matcher matcher = pattern.matcher(path);
        if (matcher.find()) {
            return matcher.group(1).replace('-', '.');
        }
    } catch (Throwable t) {}
    return null;
  }
  

  // ========== OkHttpç½‘ç»œHook ==========
  private void hookOkHttp(ClassLoader classLoader) {
    try {
      Class<?> realCallClass = XposedHelpers.findClassIfExists(
        "okhttp3.RealCall",
        classLoader
      );
      if (realCallClass == null) {
        return;
      }

      XposedHelpers.findAndHookMethod(
        realCallClass,
        "enqueue",
        "okhttp3.Callback",
        new XC_MethodHook() {
          @Override
          protected void beforeHookedMethod(MethodHookParam param)
            throws Throwable {
            try {
              Object requestObj = XposedHelpers.getObjectField(
                param.thisObject,
                "originalRequest"
              );
              if (requestObj == null) return;

              String url = XposedHelpers.callMethod(
                requestObj,
                "url"
              ).toString();

              if (isDetectionUrl(url)) {
                Boolean status = installStatusMap.get(currentTargetApp);
                boolean shouldReturnInstalled = status != null ? status : true;

                if (!shouldReturnInstalled) {
                  Object callback = param.args[0];
                  fakeOkHttpResponse(callback, url, false);
                  param.setResult(null);
                  return;
                }

                Object callback = param.args[0];
                fakeOkHttpResponse(callback, url, true);
                param.setResult(null);
              }
            } catch (Throwable t) {}
          }
        }
      );

      XposedHelpers.findAndHookMethod(
        realCallClass,
        "execute",
        new XC_MethodHook() {
          @Override
          protected void beforeHookedMethod(MethodHookParam param)
            throws Throwable {
            try {
              Object requestObj = XposedHelpers.getObjectField(
                param.thisObject,
                "originalRequest"
              );
              if (requestObj == null) return;

              String url = XposedHelpers.callMethod(
                requestObj,
                "url"
              ).toString();

              if (isDetectionUrl(url)) {
                Boolean status = installStatusMap.get(currentTargetApp);
                boolean shouldReturnInstalled = status != null ? status : true;

                if (!shouldReturnInstalled) {
                  Object fakeResponse = createOkHttpFakeResponse(false);
                  param.setResult(fakeResponse);
                  return;
                }

                Object fakeResponse = createOkHttpFakeResponse(true);
                param.setResult(fakeResponse);
              }
            } catch (Throwable t) {}
          }
        }
      );
    } catch (Throwable t) {
      log("Hook OkHttpå¤±è´¥: " + t.getMessage());
    }
  }

  // è¾…åŠ©æ–¹æ³•1ï¼šæ ¡éªŒåŒ…åæ˜¯å¦çœŸå®å®‰è£…ï¼ˆç³»ç»ŸåŸç”ŸæŸ¥è¯¢ï¼Œä¸å—æ¨¡å—ä¼ªé€ å½±å“ï¼‰
  private boolean isPackageReallyInstalled(String packageName) {
    try {
      Context context = (Context) XposedHelpers.callStaticMethod(
        XposedHelpers.findClass("android.app.ActivityThread", null),
        "currentApplication"
      );
      PackageManager pm = context.getPackageManager();
      pm.getPackageInfo(packageName, PackageManager.GET_ACTIVITIES);
      return true;
    } catch (PackageManager.NameNotFoundException e) {
      return false;
    } catch (Throwable t) {
      return false;
    }
  }

  // è¾…åŠ©æ–¹æ³•2ï¼šåˆ¤æ–­åŒ…åæ˜¯å¦åœ¨æ•è·åˆ—è¡¨ä¸­ï¼ˆæ‰‹åŠ¨+è‡ªåŠ¨æ·»åŠ ï¼‰
  private boolean isPackageInCapturedList(String packageName) {
    synchronized (globalCapturedPackages) {
      return globalCapturedPackages.contains(packageName);
    }
  }

  // åº”ç”¨å¯åŠ¨æ‹¦æˆª
  private void hookStartActivity(ClassLoader classLoader) {
    try {
        XposedHelpers.findAndHookMethod(
            "android.app.Instrumentation",
            classLoader,
            "execStartActivity",
            Context.class,
            IBinder.class,
            IBinder.class,
            Activity.class,
            Intent.class,
            int.class,
            Bundle.class,
            new XC_MethodHook() {
                @Override
                protected void beforeHookedMethod(MethodHookParam param) throws Throwable {
                    final Intent intent = (Intent) param.args[4];
                    if (intent == null) return;

                    // ========== 1. å¸¸ç”¨Appç™»å½•æˆæƒè¿‡æ»¤ï¼ˆæ”¾è¡Œï¼‰ ==========
                    String[] authAppPackages = {
                        // å›½å†…å¸¸ç”¨
                        "com.tencent.mm", // å¾®ä¿¡
                        "com.qq.mobileqq", // QQ
                        "com.alipay.mobile.securitycommon", // æ”¯ä»˜å®
                        "com.sina.weibo", // å¾®åš
                        "com.baidu.account", // ç™¾åº¦è´¦å·
                        "com.tencent.wework", // ä¼ä¸šå¾®ä¿¡
                        "com.dingtalk", // é’‰é’‰
                        "com.bytedance.ss.android.ugc.aweme", // æŠ–éŸ³
                        "com.xiaomi.account", // å°ç±³è´¦å·
                        "com.huawei.hwid", // åä¸ºè´¦å·
                        "com.oppo.account", // OPPOè´¦å·
                        "com.vivo.account", // VIVOè´¦å·
                        "com.meizu.account", // é­…æ—è´¦å·
                        "com.lenovo.account", // è”æƒ³è´¦å·
                        "com.samsung.android.mobileservice", // ä¸‰æ˜Ÿè´¦å·
                        // å›½å¤–å¸¸ç”¨
                        "com.google.android.gms", // Google ç™»å½•
                        "com.facebook.katana", // Facebook
                        "com.twitter.android", // Twitter
                        "com.instagram.android", // Instagram
                        "com.linkedin.android", // LinkedIn
                        "com.pinterest", // Pinterest
                        "com.tumblr", // Tumblr
                        "com.microsoft.office.officehubrow", // Microsoft
                        "com.apple.android.music", // Apple ç™»å½•
                        // å…¶ä»–æˆæƒç±»App
                        "com.auth0.lock", // Auth0
                        "com.okta.mobile", // Okta
                        "com.paypal.android.p2pmobile", // PayPal
                    };

                    // ========== 2. ç™»å½•æˆæƒç›¸å…³ç±»åå…³é”®è¯è¿‡æ»¤ï¼ˆæ”¾è¡Œï¼‰ ==========
                    String[] authClassKeywords = {
                        "Login", "Auth", "Authorization", "OAuth", "OAuth2",
                        "LoginActivity", "AuthActivity", "AuthorizeActivity",
                        "Wechat", "QQAuth", "WeiboAuth", "AlipayAuth",
                        "GoogleAuth", "FacebookAuth", "TwitterAuth",
                        "AccountLogin", "UserLogin", "SignIn", "SignUp",
                        "Sso", "SingleSignOn", "OauthCallback"
                    };

                    // ========== 3. ç½‘é¡µæˆæƒå¹³å°è¿‡æ»¤ï¼ˆæ”¾è¡Œï¼‰ ==========
                    String[] webAuthSchemes = {
                        "http", "https", "oauth", "oauth2", "openid",
                        "github", "git", "google", "facebook", "twitter",
                        "linkedin", "instagram", "pinterest", "tumblr",
                        "microsoft", "apple", "wechat", "qq", "weibo", "alipay"
                    };

                    String[] webAuthHosts = {
                        // GitHub ç›¸å…³
                        "github.com", "github.io", "oauth.github.com", "accounts.github.com",
                        // Google ç›¸å…³
                        "google.com", "accounts.google.com", "oauth2.googleapis.com",
                        // Facebook ç›¸å…³
                        "facebook.com", "fb.com", "accounts.facebook.com",
                        // Twitter ç›¸å…³
                        "twitter.com", "api.twitter.com", "auth.twitter.com",
                        // å…¶ä»–å›½å¤–å¹³å°
                        "linkedin.com", "www.linkedin.com", "api.linkedin.com",
                        "instagram.com", "www.instagram.com",
                        "pinterest.com", "www.pinterest.com",
                        "tumblr.com", "www.tumblr.com",
                        "microsoft.com", "login.live.com", "account.live.com",
                        "apple.com", "appleid.apple.com",
                        "auth0.com", "okta.com",
                        // å›½å†…å¹³å°
                        "weixin110.qq.com", "open.weixin.qq.com", // å¾®ä¿¡å¼€æ”¾å¹³å°
                        "graph.qq.com", "open.mobile.qq.com", // QQå¼€æ”¾å¹³å°
                        "api.weibo.com", "open.weibo.com", // å¾®åšå¼€æ”¾å¹³å°
                        "open.alipay.com", "auth.alipay.com", // æ”¯ä»˜å®å¼€æ”¾å¹³å°
                        "openapi.baidu.com", "passport.baidu.com", // ç™¾åº¦å¼€æ”¾å¹³å°
                        "developers.dingtalk.com", "oapi.dingtalk.com", // é’‰é’‰å¼€æ”¾å¹³å°
                        "qyapi.weixin.qq.com", // ä¼ä¸šå¾®ä¿¡å¼€æ”¾å¹³å°
                        "openapi.bytedance.com", // å­—èŠ‚è·³åŠ¨å¼€æ”¾å¹³å°
                    };

                    // ========== 4. è¿‡æ»¤é€»è¾‘æ‰§è¡Œ ==========
                    String targetPkg = null;
                    ComponentName cn = intent.getComponent();

                    // 4.1 ç»„ä»¶åè¿‡æ»¤ï¼ˆç±»ååŒ…å«æˆæƒå…³é”®è¯ â†’ æ”¾è¡Œï¼‰
                    if (cn != null) {
                        targetPkg = cn.getPackageName();
                        String className = cn.getClassName();
                        for (String keyword : authClassKeywords) {
                            if (className.contains(keyword)) {
                                return;
                            }
                        }
                    } else {
                        targetPkg = intent.getPackage();
                    }

                    // 4.2 åŒ…åè¿‡æ»¤ï¼ˆå±äºæˆæƒApp â†’ æ”¾è¡Œï¼‰
                    if (targetPkg != null) {
                        for (String authPkg : authAppPackages) {
                            if (targetPkg.equals(authPkg) || targetPkg.startsWith(authPkg)) {
                                return;
                            }
                        }
                    }

                    // 4.3 ç½‘é¡µæˆæƒè¿‡æ»¤ï¼ˆScheme/Host åŒ¹é… â†’ æ”¾è¡Œï¼‰
                    Uri data = intent.getData();
                    if (data != null) {
                        String scheme = data.getScheme();
                        String host = data.getHost();

                        // Scheme åŒ¹é…ç½‘é¡µ/æˆæƒåè®®
                        if (scheme != null) {
                            for (String authScheme : webAuthSchemes) {
                                if (authScheme.equalsIgnoreCase(scheme)) {
                                    return;
                                }
                            }
                        }

                        // Host åŒ¹é…æˆæƒåŸŸå
                        if (host != null) {
                            for (String authHost : webAuthHosts) {
                                if (host.contains(authHost)) {
                                    return;
                                }
                            }
                        }
                    }

                    // ========== 5. åŸæœ‰ä¼ªé€ å¯åŠ¨é€»è¾‘ ==========
                    if (intent.hasExtra("__hook_skip_flag")) {
                        return;
                    }

                    boolean isInternal = false;
                    boolean isSpecificActivity = (cn != null);
                    if (cn != null) {
                        Context selfContext = (Context) param.args[0];
                        if (targetPkg != null && targetPkg.equals(selfContext.getPackageName())) {
                            isInternal = true;
                        }
                    }

                    final String pkg = targetPkg;
                    final boolean finalIsInternal = isInternal;
                    final boolean finalIsSpecificAct = isSpecificActivity;
                    if (pkg == null) return;

                    // ä»…å¯¹æ•è·åˆ—è¡¨ä¸­çš„éæˆæƒAppæ‰§è¡Œä¼ªé€ é€»è¾‘
                    if (!isPackageInCapturedList(pkg) || !isPackageReallyInstalled(pkg)) {
                        return;
                    }

                    param.setResult(null);
                    final Intent oriIntent = new Intent(intent);
                    final Activity activity = (Activity) param.args[3];
                    final int reqCode = (int) param.args[5];

                    new Handler(Looper.getMainLooper()).post(new Runnable() {
                        @Override
                        public void run() {
                            String[] btnArray;
                            String msg = "å½“å‰åº”ç”¨æƒ³è¦æ‰“å¼€åº”ç”¨\n" + pkg + "\n\nè¯·é—®æ˜¯å¦éœ€è¦ä¼ªé€ å¯åŠ¨ï¼Ÿ";
                            if (finalIsInternal || finalIsSpecificAct) {
                                btnArray = new String[]{"è™šå‡å¯åŠ¨", "å–æ¶ˆ"};
                            } else {
                                btnArray = new String[]{"è™šå‡å¯åŠ¨", "çœŸå®æ‰“å¼€", "å–æ¶ˆ"};
                            }

                            AlertDialog dialog = createBoundedDialog(
                                activity,
                                "å¯åŠ¨ç¡®è®¤",
                                msg,
                                btnArray,
                                new DialogInterface.OnClickListener[]{
                                    new DialogInterface.OnClickListener() {
                                        @Override
                                        public void onClick(DialogInterface dialog, int which) {
                                            dialog.dismiss();
                                            try {
                                                if (reqCode != 0 && activity != null && !activity.isFinishing()) {
                                                    java.lang.reflect.Method m = Activity.class.getDeclaredMethod(
                                                        "onActivityResult",
                                                        int.class, int.class, Intent.class
                                                    );
                                                    m.setAccessible(true);
                                                    m.invoke(activity, reqCode, Activity.RESULT_OK, null);
                                                }
                                            } catch (Throwable ignored) {}
                                            Toast.makeText(activity, "å·²ä¼ªé€ å¯åŠ¨ï¼š" + pkg, Toast.LENGTH_SHORT).show();
                                        }
                                    },
                                    new DialogInterface.OnClickListener() {
                                        @Override
                                        public void onClick(DialogInterface dialog, int which) {
                                            dialog.dismiss();
                                            if (finalIsInternal || finalIsSpecificAct) {
                                                try {
                                                    if (reqCode != 0 && activity != null && !activity.isFinishing()) {
                                                        java.lang.reflect.Method m = Activity.class.getDeclaredMethod(
                                                            "onActivityResult",
                                                            int.class, int.class, Intent.class
                                                        );
                                                        m.setAccessible(true);
                                                        m.invoke(activity, reqCode, Activity.RESULT_CANCELED, null);
                                                    }
                                                } catch (Throwable ignored) {}
                                                Toast.makeText(activity, "å·²å–æ¶ˆå¯åŠ¨ï¼š" + pkg, Toast.LENGTH_SHORT).show();
                                            } else {
                                                try {
                                                    Intent newIntent = new Intent(oriIntent);
                                                    newIntent.putExtra("__hook_skip_flag", true);
                                                    activity.startActivity(newIntent);
                                                    Toast.makeText(activity, "å·²çœŸå®æ‰“å¼€ï¼š" + pkg, Toast.LENGTH_SHORT).show();
                                                } catch (Throwable e) {
                                                    log("çœŸå®å¯åŠ¨å¼‚å¸¸: " + e.getMessage());
                                                    Toast.makeText(activity, "å¯åŠ¨å¤±è´¥ï¼ˆåº”ç”¨é™åˆ¶ï¼‰", Toast.LENGTH_SHORT).show();
                                                }
                                            }
                                        }
                                    },
                                    new DialogInterface.OnClickListener() {
                                        @Override
                                        public void onClick(DialogInterface dialog, int which) {
                                            dialog.dismiss();
                                            try {
                                                if (reqCode != 0 && activity != null && !activity.isFinishing()) {
                                                    java.lang.reflect.Method m = Activity.class.getDeclaredMethod(
                                                        "onActivityResult",
                                                        int.class, int.class, Intent.class
                                                    );
                                                    m.setAccessible(true);
                                                    m.invoke(activity, reqCode, Activity.RESULT_CANCELED, null);
                                                }
                                            } catch (Throwable ignored) {}
                                            Toast.makeText(activity, "å·²å–æ¶ˆå¯åŠ¨ï¼š" + pkg, Toast.LENGTH_SHORT).show();
                                        }
                                    }
                                }
                            );
                            dialog.show();
                        }
                    });
                }
            }
        );
    } catch (Throwable e) {
        log("hookStartActivity å¼‚å¸¸: " + e.getMessage());
    }
}









  /*
  // ========== åº”ç”¨å¯åŠ¨æ‹¦æˆª ==========
  private void hookStartActivity(ClassLoader classLoader) {
    try {
      XposedHelpers.findAndHookMethod(
        "android.app.Instrumentation",
        classLoader,
        "execStartActivity",
        Context.class,
        IBinder.class,
        IBinder.class,
        Activity.class,
        Intent.class,
        int.class,
        Bundle.class,
        new XC_MethodHook() {
          @Override
          protected void beforeHookedMethod(MethodHookParam param)
            throws Throwable {
            try {
              Intent intent = (Intent) param.args[4];

              Bundle bundle = (Bundle) param.args[6];

              // é€šç”¨ç©ºå€¼æ ¡éªŒï¼šé¿å…ä¼ é€’ç©ºIntentæˆ–ç©ºBundle
              if (intent == null) {
                //         log("âš ï¸  æ‹¦æˆªåˆ°ç©ºIntentï¼Œè·³è¿‡Hookå¤„ç†");
                return;
              }
              if (bundle == null) {
                // è‹¥Bundleä¸ºç©ºï¼Œåˆ›å»ºé»˜è®¤ç©ºBundleé¿å…ç›®æ ‡åº”ç”¨å´©æºƒ
                param.args[6] = new Bundle();
                //   log("âš ï¸  è¡¥å…¨ç©ºBundleï¼Œé¿å…ç›®æ ‡åº”ç”¨ç©ºæŒ‡é’ˆ");
              }
              if (intent == null) {
                //  log("âš ï¸  ç©ºIntentï¼Œè·³è¿‡ResolveActivity Hook");
                return;
              }

              String targetPackageName = null;

              ComponentName component = intent.getComponent();
              if (component != null) {
                targetPackageName = component.getPackageName();
              } else if (intent.getPackage() != null) {
                targetPackageName = intent.getPackage();
              }

              if (
                targetPackageName != null &&
                !targetPackageName.equals(currentTargetApp)
              ) {
                boolean isCapturedApp = false;
                synchronized (globalCapturedPackages) {
                  isCapturedApp = globalCapturedPackages.contains(
                    targetPackageName
                  );
                }

                if (isCapturedApp) {
                  log(
                    "ã€å¯åŠ¨æ‹¦æˆªã€‘ç›®æ ‡åº”ç”¨å°è¯•æ‰“å¼€ä¼ªé€ åº”ç”¨: " + targetPackageName
                  );

                  Boolean statusConfig = installStatusMap.get(currentTargetApp);
                  boolean shouldReturnInstalled = statusConfig != null
                    ? statusConfig
                    : true;

                  if (shouldReturnInstalled) {
                    log("ã€å¯åŠ¨æ‹¦æˆªã€‘å½“å‰é…ç½®ä¸º[å·²å®‰è£…]ï¼Œä¼ªè£…å¯åŠ¨æˆåŠŸ");

                    final int requestCode = (int) param.args[5];
                    final Activity targetActivity = (Activity) param.args[3];

                    if (requestCode != 0 && targetActivity != null) {
                      new Handler(Looper.getMainLooper()).postDelayed(
                        new Runnable() {
                          @Override
                          public void run() {
                            try {
                              XposedHelpers.callMethod(
                                targetActivity,
                                "onActivityResult",
                                requestCode,
                                Activity.RESULT_OK,
                                (Intent) null
                              );
                            } catch (Throwable e) {
                              log(
                                "ã€å¯åŠ¨æ‹¦æˆªã€‘å‘é€å›è°ƒå¤±è´¥: " + e.getMessage()
                              );
                            }
                          }
                        },
                        300
                      );
                    }

                    param.setResult(null);
                    return;
                  }
                }
              }
            } catch (Throwable t) {}
          }
        }
      );
    } catch (Throwable t) {
      log("Hook startActivityå¤±è´¥: " + t.getMessage());
    }
  }
  */

  // ========== è¾…åŠ©å·¥å…·æ–¹æ³• ==========
  private boolean isDetectionUrl(String url) {
    return (
      url.contains("checkInstall") ||
      url.contains("appDetect") ||
      url.contains("packageCheck") ||
      url.contains("umeng/app/check") ||
      url.contains("jiguang/detect") ||
      url.contains("appInstalled") ||
      url.contains("verifyApp")
    );
  }

  private void fakeOkHttpResponse(
    Object callback,
    String url,
    boolean isInstalled
  ) {
    try {
      ClassLoader cl = callback.getClass().getClassLoader();
      Class<?> responseClass = XposedHelpers.findClass("okhttp3.Response", cl);
      Class<?> responseBuilderClass = XposedHelpers.findClass(
        "okhttp3.Response$Builder",
        cl
      );
      Class<?> mediaTypeClass = XposedHelpers.findClass(
        "okhttp3.MediaType",
        cl
      );
      Class<?> requestBodyClass = XposedHelpers.findClass(
        "okhttp3.RequestBody",
        cl
      );

      Object jsonMediaType = XposedHelpers.callStaticMethod(
        mediaTypeClass,
        "parse",
        "application/json; charset=utf-8"
      );
      String fakeJson;

      if (isInstalled) {
        fakeJson =
          "{\"code\":200,\"msg\":\"success\",\"isInstalled\":true,\"data\":{\"packageList\":" +
          globalCapturedPackages.toString() +
          "}}";
      } else {
        fakeJson =
          "{\"code\":404,\"msg\":\"app not installed\",\"isInstalled\":false}";
      }

      Object fakeBody = XposedHelpers.callStaticMethod(
        requestBodyClass,
        "create",
        jsonMediaType,
        fakeJson
      );

      Object fakeResponse = XposedHelpers.newInstance(responseBuilderClass);
      fakeResponse = XposedHelpers.callMethod(
        fakeResponse,
        "code",
        isInstalled ? 200 : 404
      );
      fakeResponse = XposedHelpers.callMethod(fakeResponse, "body", fakeBody);
      fakeResponse = XposedHelpers.callMethod(fakeResponse, "build");

      XposedHelpers.callMethod(callback, "onResponse", null, fakeResponse);
    } catch (Exception e) {}
  }

  private Object createOkHttpFakeResponse(boolean isInstalled) {
    try {
      ClassLoader cl = ClassLoader.getSystemClassLoader();
      Class<?> responseClass = XposedHelpers.findClass("okhttp3.Response", cl);
      Class<?> responseBuilderClass = XposedHelpers.findClass(
        "okhttp3.Response$Builder",
        cl
      );
      Class<?> mediaTypeClass = XposedHelpers.findClass(
        "okhttp3.MediaType",
        cl
      );
      Class<?> requestBodyClass = XposedHelpers.findClass(
        "okhttp3.RequestBody",
        cl
      );

      Object jsonMediaType = XposedHelpers.callStaticMethod(
        mediaTypeClass,
        "parse",
        "application/json; charset=utf-8"
      );
      String fakeJson;

      if (isInstalled) {
        fakeJson = "{\"code\":200,\"msg\":\"æ£€æµ‹é€šè¿‡\",\"isInstalled\":true}";
      } else {
        fakeJson =
          "{\"code\":404,\"msg\":\"åº”ç”¨æœªå®‰è£…\",\"isInstalled\":false}";
      }

      Object fakeBody = XposedHelpers.callStaticMethod(
        requestBodyClass,
        "create",
        jsonMediaType,
        fakeJson
      );
      Object fakeResponse = XposedHelpers.newInstance(responseBuilderClass);
      fakeResponse = XposedHelpers.callMethod(
        fakeResponse,
        "code",
        isInstalled ? 200 : 404
      );
      fakeResponse = XposedHelpers.callMethod(fakeResponse, "body", fakeBody);
      return XposedHelpers.callMethod(fakeResponse, "build");
    } catch (Exception e) {
      return null;
    }
  }

  private String extractPackageFromChannelArgs(Object arguments) {
    if (arguments instanceof String) {
      return (String) arguments;
    } else if (arguments instanceof Map) {
      Map<?, ?> map = (Map<?, ?>) arguments;
      if (map.get("packageName") != null) {
        return (String) map.get("packageName");
      } else if (map.get("pkg") != null) {
        return (String) map.get("pkg");
      }
    }
    return null;
  }

  private Object buildChannelFakeResult(
    String methodName,
    String targetPackage,
    Object arguments
  ) {
    if (methodName.contains("isInstalled")) {
      if (arguments instanceof ArrayList) {
        Map<String, Boolean> resultMap = new HashMap<>();
        for (String pkg : (ArrayList<String>) arguments) {
          resultMap.put(pkg, globalCapturedPackages.contains(pkg));
        }
        return resultMap;
      } else {
        return globalCapturedPackages.contains(targetPackage);
      }
    } else if (methodName.contains("getPackage")) {
      return createFakePackageInfoPlusResult(targetPackage);
    }
    return null;
  }

  private Object createFakePackageInfoPlusResult(String targetPackage) {
    try {
      Map<String, Object> fakeMap = new HashMap<>();
      if (targetPackage == null) {
        ArrayList<Map<String, Object>> allPackages = new ArrayList<>();
        for (String pkg : globalCapturedPackages) {
          allPackages.add(buildSinglePackageInfo(pkg));
        }
        fakeMap.put("packages", allPackages);
      } else {
        fakeMap.putAll(buildSinglePackageInfo(targetPackage));
      }
      fakeMap.put(
        "appName",
        targetPackage == null ? "All Apps" : ("App: " + targetPackage)
      );
      fakeMap.put(
        "packageName",
        targetPackage == null ? "multiple" : targetPackage
      );
      fakeMap.put("version", "1.0.0");
      fakeMap.put("buildNumber", "1");
      fakeMap.put("buildSignature", "fake_signature");
      fakeMap.put("installerPackageName", "com.android.vending");
      return fakeMap;
    } catch (Exception e) {
      return null;
    }
  }

  private Map<String, Object> buildSinglePackageInfo(String packageName) {
    Map<String, Object> pkgMap = new HashMap<>();
    pkgMap.put("packageName", packageName);
    pkgMap.put("appName", "App: " + packageName);
    pkgMap.put("version", "1.0.0");
    pkgMap.put("buildNumber", "1");
    pkgMap.put("installTime", System.currentTimeMillis() - 86400000);
    pkgMap.put("updateTime", System.currentTimeMillis());
    return pkgMap;
  }

// ========== å†…åµŒæ¨¡å¼ä¸“ç”¨æ–¹æ³•ï¼ˆå®Œç¾å…¼å®¹åˆ†èº« + ç©ºæŒ‡é’ˆé˜²æŠ¤ï¼‰ ==========
public void initForEmbed(
    ClassLoader classLoader,
    String targetPackageName,
    Context context
) {

// ========== ğŸš¨ã€WebViewå­çº¿ç¨‹å´©æºƒä¸“æ€ã€‘==========
try {
    // Hook WebView çš„æ‰€æœ‰å­çº¿ç¨‹åˆ›å»ºï¼Œç›´æ¥åæ‰ç©ºæŒ‡é’ˆ
    XposedHelpers.findAndHookMethod(
        "android.webkit.WebView",
        null,
        "onDraw",
        android.graphics.Canvas.class,
        new XC_MethodHook() {
            @Override
            protected void beforeHookedMethod(MethodHookParam param) throws Throwable {
                // ä»€ä¹ˆéƒ½ä¸åšï¼Œåªæ˜¯é˜²æ­¢å´©æºƒ
            }
        }
    );
} catch (Throwable ignored) {}

try {
    // Hook Chromium å†…æ ¸çš„å´©æºƒç‚¹
    XposedHelpers.findAndHookMethod(
        "org.chromium.android_webview.AwContents",
        null,
        "destroy",
        new XC_MethodReplacement() {
            @Override
            protected Object replaceHookedMethod(MethodHookParam param) throws Throwable {
                return null; // é˜²æ­¢é”€æ¯æ—¶å´©æºƒ
            }
        }
    );
} catch (Throwable ignored) {}
// ========== ğŸš¨ã€ç»ˆææš´åŠ›ä¿®å¤ã€‘Hookæ‰€æœ‰Bundleæ–¹æ³•ï¼ˆå¯ç¼–è¯‘ç‰ˆï¼‰==========
try {
    Class<?> bundleClass = Class.forName("android.os.Bundle");
    
    // ä½¿ç”¨ findAndHookMethod é€ä¸ª Hook å…³é”®æ–¹æ³•ï¼Œè€Œä¸æ˜¯ hookAllMethods
    String[] bundleMethods = {
        "getString", "getInt", "getBoolean", "getLong", 
        "getDouble", "getFloat", "getBundle", "getSerializable",
        "getParcelable", "containsKey"
    };
    
    for (final String methodName : bundleMethods) {
        try {
            // Hook å•å‚æ•°ç‰ˆæœ¬
            XposedHelpers.findAndHookMethod(
                bundleClass,
                methodName,
                String.class,
                new XC_MethodHook() {
                    @Override
                    protected void beforeHookedMethod(MethodHookParam param) throws Throwable {
                        if (param.thisObject == null) {
                            setDefaultReturnValue(param);
                            return;
                        }
                        // æ£€æµ‹Bundleæ˜¯å¦å¯ç”¨
                        try {
                            ((Bundle) param.thisObject).hashCode();
                        } catch (Throwable e) {
                            setDefaultReturnValue(param);
                        }
                    }
                    
                    private void setDefaultReturnValue(MethodHookParam param) {
                        if (methodName.equals("getString")) param.setResult("");
                        else if (methodName.equals("getInt")) param.setResult(0);
                        else if (methodName.equals("getBoolean")) param.setResult(false);
                        else if (methodName.equals("getLong")) param.setResult(0L);
                        else if (methodName.equals("getDouble")) param.setResult(0.0);
                        else if (methodName.equals("getFloat")) param.setResult(0.0f);
                        else if (methodName.equals("getBundle")) param.setResult(new Bundle());
                        else param.setResult(null);
                    }
                }
            );
        } catch (Throwable ignored) {}
        
        try {
            // Hook åŒå‚æ•°ç‰ˆæœ¬ï¼ˆå¸¦é»˜è®¤å€¼ï¼‰
            XposedHelpers.findAndHookMethod(
                bundleClass,
                methodName,
                String.class,
                Object.class,
                new XC_MethodHook() {
                    @Override
                    protected void beforeHookedMethod(MethodHookParam param) throws Throwable {
                        if (param.thisObject == null) {
                            param.setResult(param.args[1]);
                            return;
                        }
                        try {
                            Bundle b = (Bundle) param.thisObject;
                            if (!b.containsKey((String) param.args[0])) {
                                param.setResult(param.args[1]);
                            }
                        } catch (Throwable e) {
                            param.setResult(param.args[1]);
                        }
                    }
                }
            );
        } catch (Throwable ignored) {}
    }
    
    // ç‰¹åˆ«å¤„ç† getString(String, String) ç¡®ä¿ä¸‡æ— ä¸€å¤±
    try {
        XposedHelpers.findAndHookMethod(
            bundleClass,
            "getString",
            String.class,
            String.class,
            new XC_MethodHook() {
                @Override
                protected void beforeHookedMethod(MethodHookParam param) throws Throwable {
                    if (param.thisObject == null) {
                        param.setResult(param.args[1]);
                        return;
                    }
                    try {
                        Bundle b = (Bundle) param.thisObject;
                        if (!b.containsKey((String) param.args[0])) {
                            param.setResult(param.args[1]);
                        }
                    } catch (Throwable e) {
                        param.setResult(param.args[1]);
                    }
                }
            }
        );
    } catch (Throwable ignored) {}
    
    //XposedBridge.log("[InstallHook] âœ… Bundleæš´åŠ›ä¿®å¤å®Œæˆï¼ˆå¯ç¼–è¯‘ç‰ˆï¼‰");
    
} catch (Throwable e) {
    //XposedBridge.log("[InstallHook] âŒ Bundleæš´åŠ›ä¿®å¤å¤±è´¥: " + e.getMessage());
}
    
    // ========== ğŸš¨ã€å¼ºåˆ¶å…¨å±€å¼‚å¸¸æ•è·ã€‘==========
try {
    // å…ˆè®¾ç½®æˆ‘ä»¬è‡ªå·±çš„Handler
    final Thread.UncaughtExceptionHandler ourHandler = new Thread.UncaughtExceptionHandler() {
        @Override
        public void uncaughtException(Thread t, Throwable e) {
            if (e instanceof NullPointerException) {
                StackTraceElement[] stack = e.getStackTrace();
                if (stack.length > 0) {
                    String className = stack[0].getClassName();
                    if (className.contains("Bundle") || 
                        className.contains("PackageManager") ||
                        className.contains("ContextImpl") ||
                        className.contains("ApplicationPackageManager")) {
                        //XposedBridge.log("[InstallHook] ğŸ’ª æ‹¦æˆªå´©æºƒ: " +    className + "." + stack[0].getMethodName());
                        return;
                    }
                }
            }
            // äº¤ç»™ç³»ç»Ÿé»˜è®¤Handler
            Thread.UncaughtExceptionHandler defaultHandler = 
                Thread.getDefaultUncaughtExceptionHandler();
            if (defaultHandler != null && defaultHandler != this) {
                defaultHandler.uncaughtException(t, e);
            }
        }
    };
    
    // è®¾ç½®æˆ‘ä»¬çš„Handler
    Thread.setDefaultUncaughtExceptionHandler(ourHandler);
    
    // Hook setDefaultUncaughtExceptionHandler é˜²æ­¢è¢«è¦†ç›–
    XposedHelpers.findAndHookMethod(
        "java.lang.Thread",
        null,
        "setDefaultUncaughtExceptionHandler",
        Thread.UncaughtExceptionHandler.class,
        new XC_MethodHook() {
            @Override
            protected void beforeHookedMethod(MethodHookParam param) throws Throwable {
                // ä¸å…è®¸è¦†ç›–æˆ‘ä»¬çš„Handler
                //XposedBridge.log("[InstallHook] âš ï¸ é˜»æ­¢åº”ç”¨è®¾ç½®è‡ªå·±çš„å¼‚å¸¸å¤„ç†å™¨");
                param.setResult(null);
            }
        }
    );
    
    //XposedBridge.log("[InstallHook] âœ… å¼ºåˆ¶å…¨å±€å¼‚å¸¸æ•è·å·²å¯ç”¨");
    
} catch (Throwable e) {
    //XposedBridge.log("[InstallHook] âŒ å¼ºåˆ¶å¼‚å¸¸æ•è·å¤±è´¥: " + e.getMessage());
}
    
    // ========== ğŸš¨ã€å†…åµŒæ ¸å¿ƒä¿®å¤1ã€‘å…¨å±€ç©ºæŒ‡é’ˆä¿æŠ¤ï¼ˆåŠ åˆ°æœ€å‰é¢ï¼‰==========
    try {
        Thread.setDefaultUncaughtExceptionHandler(new Thread.UncaughtExceptionHandler() {
            @Override
            public void uncaughtException(Thread t, Throwable e) {
                // åªå¤„ç†ç©ºæŒ‡é’ˆ
                if (e instanceof NullPointerException) {
                    StackTraceElement[] stack = e.getStackTrace();
                    if (stack.length > 0) {
                        String className = stack[0].getClassName();
                        String methodName = stack[0].getMethodName();
                        
                        // åªè¦æ˜¯æˆ‘ä»¬Hookçš„åŒ…ï¼Œå…¨éƒ¨åæ‰
                        if (className.contains("android.os.Bundle") ||
                            className.contains("android.content.pm.PackageManager") ||
                            className.contains("android.app.ApplicationPackageManager") ||
                            className.contains("android.app.Activity") ||
                            className.contains("android.content.Context") ||
                            className.contains("PackageManager") ||
                            className.contains("Bundle")) {
                            
                          //  log("ğŸ›¡ï¸ã€å†…åµŒæ¨¡å¼ã€‘æ‹¦æˆªå­çº¿ç¨‹ç©ºæŒ‡é’ˆ: " +  className + "." + methodName);
                            return; // ä¸å´©æºƒ
                        }
                    }
                }
                
                // å…¶ä»–å´©æºƒäº¤ç»™ç³»ç»Ÿ
                Thread.UncaughtExceptionHandler defaultHandler = 
                    Thread.getDefaultUncaughtExceptionHandler();
                if (defaultHandler != null && defaultHandler != this) {
                    defaultHandler.uncaughtException(t, e);
                }
            }
        });
        log("âœ…ã€å†…åµŒæ¨¡å¼ã€‘å…¨å±€ç©ºæŒ‡é’ˆä¿æŠ¤å·²å¯ç”¨");
    } catch (Throwable ignored) {}
    
    // ========== ğŸš¨ã€å†…åµŒæ ¸å¿ƒä¿®å¤2ã€‘è·å–çœŸå®Contextå’ŒClassLoader ==========
    Context realContext = context;
    ClassLoader realClassLoader = classLoader;
    String realPackageName = targetPackageName;
    
    // 2.1 ä¼˜å…ˆä½¿ç”¨ä¼ å…¥çš„Contextï¼Œä½†å°è¯•è·å–æ›´çœŸå®çš„å®ä¾‹
    if (realContext == null) {
        try {
            realContext = (Context) XposedHelpers.callStaticMethod(
                XposedHelpers.findClass("android.app.ActivityThread", null),
                "currentApplication"
            );
        } catch (Throwable e) {
            log("ã€å†…åµŒæ¨¡å¼ã€‘è·å–ActivityThread Contextå¤±è´¥: " + e.getMessage());
        }
    }
    
    // 2.2 å¦‚æœè¿˜æ˜¯nullï¼Œå°è¯•é€šè¿‡åå°„è·å–
    if (realContext == null) {
        try {
            realContext = (Context) XposedHelpers.callStaticMethod(
                XposedHelpers.findClass("android.app.AppGlobals", null),
                "getInitialApplication"
            );
        } catch (Throwable e) {
            log("ã€å†…åµŒæ¨¡å¼ã€‘è·å–AppGlobalså¤±è´¥: " + e.getMessage());
        }
    }
    
    // 2.3 è·å–çœŸå®åŒ…åå’ŒClassLoader
    if (realContext != null) {
        try {
            realPackageName = realContext.getPackageName();
            realClassLoader = realContext.getClassLoader();
            log("âœ…ã€å†…åµŒæ¨¡å¼ã€‘è·å–çœŸå®ä¿¡æ¯: " + realPackageName);
        } catch (Throwable e) {
            log("âŒã€å†…åµŒæ¨¡å¼ã€‘è·å–çœŸå®ä¿¡æ¯å¤±è´¥: " + e.getMessage());
        }
    }
    
    // 2.4 ClassLoaderé™çº§æ–¹æ¡ˆ
    if (realClassLoader == null) {
        if (classLoader != null) {
            realClassLoader = classLoader;
            log("âœ…ã€å†…åµŒæ¨¡å¼ã€‘ä½¿ç”¨ä¼ å…¥ClassLoader");
        } else if (realContext != null) {
            realClassLoader = realContext.getClassLoader();
            log("âœ…ã€å†…åµŒæ¨¡å¼ã€‘ä»Contextè·å–ClassLoader");
        } else {
            realClassLoader = getClass().getClassLoader();
            log("âœ…ã€å†…åµŒæ¨¡å¼ã€‘ä½¿ç”¨è‡ªèº«ClassLoaderä½œä¸ºæœ€åå›é€€");
        }
    }
    
    // 2.5 åŒ…åé™çº§æ–¹æ¡ˆ
    if (realPackageName == null || realPackageName.isEmpty()) {
        realPackageName = targetPackageName != null ? targetPackageName : "unknown";
        log("âœ…ã€å†…åµŒæ¨¡å¼ã€‘ä½¿ç”¨ä¼ å…¥åŒ…å: " + realPackageName);
    }
    
    // ========== ğŸš¨ã€å†…åµŒæ ¸å¿ƒä¿®å¤3ã€‘ä¸»åŠ¨ä¿®å¤soè·¯å¾„ï¼ˆä¸ç­‰ä»»ä½•å›è°ƒï¼‰==========
    if (realContext != null) {
        try {
            ApplicationInfo ai = realContext.getApplicationInfo();
            if (ai != null) {
                // å¼ºåˆ¶é‡ç½®nativeLibraryDirï¼Œè§¦å‘ç³»ç»Ÿé‡æ–°è®¡ç®—æ­£ç¡®è·¯å¾„
                XposedHelpers.setObjectField(ai, "nativeLibraryDir", ai.nativeLibraryDir);
                log("âœ…ã€å†…åµŒæ¨¡å¼ã€‘ä¸»åŠ¨ä¿®å¤.soè·¯å¾„: " + ai.nativeLibraryDir);
            }
        } catch (Throwable e) {
            log("âŒã€å†…åµŒæ¨¡å¼ã€‘ä¸»åŠ¨ä¿®å¤.soè·¯å¾„å¤±è´¥: " + e.getMessage());
            
            // å…œåº•æ–¹æ¡ˆï¼šé€šè¿‡PackageManagerå†è¯•ä¸€æ¬¡
            try {
                PackageManager pm = realContext.getPackageManager();
                ApplicationInfo ai = pm.getApplicationInfo(realPackageName, 0);
                if (ai != null) {
                    XposedHelpers.setObjectField(ai, "nativeLibraryDir", ai.nativeLibraryDir);
                    log("âœ…ã€å†…åµŒæ¨¡å¼ã€‘å…œåº•ä¿®å¤.soè·¯å¾„: " + ai.nativeLibraryDir);
                }
            } catch (Throwable t) {
                log("âŒã€å†…åµŒæ¨¡å¼ã€‘å…œåº•ä¿®å¤å¤±è´¥: " + t.getMessage());
            }
        }
    }
    
    // ========== ğŸš¨ã€å†…åµŒæ ¸å¿ƒä¿®å¤4ã€‘ä¸»åŠ¨åŠ è½½é…ç½®ï¼ˆä¸ç­‰ä»»ä½•å›è°ƒï¼‰==========
    currentTargetApp = realPackageName;
    try {
        loadConfigFromFile();
        log("âœ…ã€å†…åµŒæ¨¡å¼ã€‘ä¸»åŠ¨åŠ è½½é…ç½®å®Œæˆ: " + currentTargetApp);
    } catch (Throwable e) {
        log("âŒã€å†…åµŒæ¨¡å¼ã€‘ä¸»åŠ¨åŠ è½½é…ç½®å¤±è´¥: " + e.getMessage());
        createDefaultConfig();
    }
    
    // ========== åˆå§‹åŒ–æ—¥å¿— ==========
    log("==========================================");
    log("ã€å†…åµŒæ¨¡å¼ã€‘ç›®æ ‡åŒ…å: " + realPackageName);
    log("ã€å†…åµŒæ¨¡å¼ã€‘Context: " + (realContext != null ? "æœ‰æ•ˆ" : "æ— æ•ˆ"));
    log("ã€å†…åµŒæ¨¡å¼ã€‘ClassLoader: " + (realClassLoader != null ? "æœ‰æ•ˆ" : "æ— æ•ˆ"));
    log("==========================================");
    
    // ========== ç³»ç»ŸåŒ…è¿‡æ»¤ ==========
    if (isSystemPackage(currentTargetApp) || 
        currentTargetApp.equals("com.install.appinstall.xl")) {
        log("âœ…ã€å†…åµŒæ¨¡å¼ã€‘è·³è¿‡ç³»ç»ŸåŒ…æˆ–è‡ªèº«åŒ…: " + currentTargetApp);
        return;
    }
    
    // ========== åˆå§‹åŒ–é…ç½®çŠ¶æ€ï¼ˆç¡®ä¿é»˜è®¤å€¼ï¼‰==========
    try {
        if (!installStatusMap.containsKey(currentTargetApp)) {
            installStatusMap.put(currentTargetApp, true);
            log("âœ…ã€å†…åµŒæ¨¡å¼ã€‘åˆå§‹åŒ–å®‰è£…çŠ¶æ€ä¸º: å·²å®‰è£…");
        }
        if (!floatingShownMap.containsKey(currentTargetApp)) {
            floatingShownMap.put(currentTargetApp, true);
            log("âœ…ã€å†…åµŒæ¨¡å¼ã€‘åˆå§‹åŒ–æ‚¬æµ®çª—çŠ¶æ€ä¸º: æ˜¾ç¤º");
        }
        if (!blockExitMap.containsKey(currentTargetApp)) {
            blockExitMap.put(currentTargetApp, false);
            log("âœ…ã€å†…åµŒæ¨¡å¼ã€‘åˆå§‹åŒ–é€€å‡ºæ‹¦æˆªçŠ¶æ€ä¸º: å…³é—­");
        }
        if (!permissionFakeMap.containsKey(currentTargetApp)) {
            permissionFakeMap.put(currentTargetApp, true);
            log("âœ…ã€å†…åµŒæ¨¡å¼ã€‘åˆå§‹åŒ–æƒé™ä¼ªé€ çŠ¶æ€ä¸º: å¼€å¯");
        }
        if (!userDefinedPackagesMap.containsKey(currentTargetApp)) {
            userDefinedPackagesMap.put(currentTargetApp, new ArrayList<>());
        }
        if (!excludedPackagesMap.containsKey(currentTargetApp)) {
            excludedPackagesMap.put(currentTargetApp, new ArrayList<>());
        }
        
        saveConfigToFile();
        log("âœ…ã€å†…åµŒæ¨¡å¼ã€‘åˆå§‹é…ç½®å·²ä¿å­˜");
    } catch (Throwable t) {
        log("âŒã€å†…åµŒæ¨¡å¼ã€‘é…ç½®åˆå§‹åŒ–å¤±è´¥: " + t.getMessage());
    }
    
    // ========== ğŸš¨ã€å†…åµŒæ ¸å¿ƒä¿®å¤5ã€‘å…ˆæ‰§è¡ŒBundleé˜²æŠ¤ï¼ˆé˜²æ­¢åˆšHookå°±å´©æºƒï¼‰==========
    try {
        // å…ˆä¿®å¤Bundleç©ºæŒ‡é’ˆé—®é¢˜
        hookBundleGetString(realClassLoader);
        hookBundleEmptyInstance(realClassLoader);
        log("âœ…ã€å†…åµŒæ¨¡å¼ã€‘Bundleç©ºæŒ‡é’ˆé˜²æŠ¤å®Œæˆ");
    } catch (Throwable t) {
        log("âŒã€å†…åµŒæ¨¡å¼ã€‘Bundleé˜²æŠ¤å¤±è´¥: " + t.getMessage());
    }
    
    // ========== ğŸš¨ã€å†…åµŒæ ¸å¿ƒä¿®å¤6ã€‘æ‰€æœ‰Hookæ–¹æ³•å¿…é¡»ä½¿ç”¨çœŸå®ClassLoader ==========
    try {
        log("ã€å†…åµŒæ¨¡å¼ã€‘å¼€å§‹æ‰§è¡ŒHookæ–¹æ³•");
        
        // ç¬¬1çº§ï¼šåŸºç¡€ç¯å¢ƒå‡†å¤‡ï¼ˆBundleå·²ç»Hookè¿‡äº†ï¼‰
        log("âœ…ã€å†…åµŒæ¨¡å¼ã€‘åŸºç¡€ç¯å¢ƒHookå®Œæˆ");
        
        // ç¬¬2çº§ï¼šæƒé™ä¼ªé€ ï¼ˆå…³é”®é˜²å¾¡ï¼‰
        try {
            hookQueryAllPackagesPermission(realClassLoader);
            hookPackageUsageStatsPermission(realClassLoader);
            log("âœ…ã€å†…åµŒæ¨¡å¼ã€‘æƒé™ä¼ªé€ Hookå®Œæˆ");
        } catch (Throwable t) {
            log("âŒã€å†…åµŒæ¨¡å¼ã€‘æƒé™ä¼ªé€ Hookå¤±è´¥: " + t.getMessage());
        }
        
        // ç¬¬3çº§ï¼šé€€å‡ºæ‹¦æˆªï¼ˆç”¨æˆ·ä½“éªŒä¿éšœï¼‰
        try {
            hookExitMethods(realClassLoader);
            hookIndirectExitMethods(realClassLoader);
            hookGlobalExitSources(realClassLoader);
            hookRunnableSystemExit(realClassLoader);
            log("âœ…ã€å†…åµŒæ¨¡å¼ã€‘é€€å‡ºæ‹¦æˆªHookå®Œæˆ");
        } catch (Throwable t) {
            log("âŒã€å†…åµŒæ¨¡å¼ã€‘é€€å‡ºæ‹¦æˆªHookå¤±è´¥: " + t.getMessage());
        }
        
        // ç¬¬4çº§ï¼šåŒ…ç®¡ç†æ ¸å¿ƒä¼ªé€ ï¼ˆæ•°æ®å±‚ï¼‰
        try {
            hookKeyMethods(realClassLoader);
            hookOverloadMethods(realClassLoader);
            hookIsApplicationEnabled(realClassLoader);
            hookCheckPermission(realClassLoader);
            hookGetActivityInfo(realClassLoader);
            log("âœ…ã€å†…åµŒæ¨¡å¼ã€‘åŒ…ç®¡ç†æ ¸å¿ƒHookå®Œæˆ");
        } catch (Throwable t) {
            log("âŒã€å†…åµŒæ¨¡å¼ã€‘åŒ…ç®¡ç†æ ¸å¿ƒHookå¤±è´¥: " + t.getMessage());
        }
        
        // ç¬¬5çº§ï¼šIntentç›¸å…³ä¼ªé€ ï¼ˆåº”ç”¨å±‚ï¼‰
        try {
            hookQueryIntentActivities(realClassLoader);
            hookResolveActivity(realClassLoader);
            hookQueryIntentServices(realClassLoader);
            log("âœ…ã€å†…åµŒæ¨¡å¼ã€‘Intentç›¸å…³Hookå®Œæˆ");
        } catch (Throwable t) {
            log("âŒã€å†…åµŒæ¨¡å¼ã€‘Intentç›¸å…³Hookå¤±è´¥: " + t.getMessage());
        }
        
        // ç¬¬6çº§ï¼šå¯åŠ¨æ‹¦æˆª
        try {
            hookStartActivity(realClassLoader);
            log("âœ…ã€å†…åµŒæ¨¡å¼ã€‘å¯åŠ¨æ‹¦æˆªHookå®Œæˆ");
        } catch (Throwable t) {
            log("âŒã€å†…åµŒæ¨¡å¼ã€‘å¯åŠ¨æ‹¦æˆªHookå¤±è´¥: " + t.getMessage());
        }
        
        // ç¬¬7çº§ï¼šOkHttpç½‘ç»œå’Œè·¨å¹³å°æ¡†æ¶
        try {
            hookOkHttp(realClassLoader);
            hookFlutterPackageInfoPlus(realClassLoader);
            hookFlutterAppInstalledChecker(realClassLoader);
            hookFileSystemInstallCheck(realClassLoader);
            hookReflectInstallCheck(realClassLoader);
            hookFlutterMethodChannelCheck(realClassLoader);
            log("âœ…ã€å†…åµŒæ¨¡å¼ã€‘ç½‘ç»œ/è·¨å¹³å°Hookå®Œæˆ");
        } catch (Throwable t) {
            log("âŒã€å†…åµŒæ¨¡å¼ã€‘ç½‘ç»œ/è·¨å¹³å°Hookå¤±è´¥: " + t.getMessage());
        }
        
        // ç¬¬8çº§ï¼šUIå’Œç”¨æˆ·ä½“éªŒ
        try {
            hookDialogCancelableMethods(realClassLoader);
            hookActivityLifecycle(realClassLoader);
            log("âœ…ã€å†…åµŒæ¨¡å¼ã€‘UIç›¸å…³Hookå®Œæˆ");
        } catch (Throwable t) {
            log("âŒã€å†…åµŒæ¨¡å¼ã€‘UIç›¸å…³Hookå¤±è´¥: " + t.getMessage());
        }
        
        log("ğŸ‰ã€å†…åµŒæ¨¡å¼ã€‘æ‰€æœ‰Hookæ‰§è¡ŒæˆåŠŸ: " + currentTargetApp);
        
        // æ˜¾ç¤ºåˆå§‹åŒ–å®Œæˆæç¤º
        showInitSuccessToast(realContext);
        
    } catch (Throwable t) {
        log("âŒã€å†…åµŒæ¨¡å¼ã€‘Hookæ‰§è¡Œå¤±è´¥: " + t.getMessage());
        t.printStackTrace();
        showInitFailToast(realContext, t.getMessage());
    }
}


/*
  // ========== è¾…åŠ©æ–¹æ³•ï¼šåˆ›å»ºä»£ç†Context ==========
  private Context createProxyContext(final String packageName) {
    try {
      // ä½¿ç”¨åŠ¨æ€ä»£ç†åˆ›å»ºContext
      Class<?> contextClass = Class.forName("android.content.Context");
      Context proxyContext = (Context) java.lang.reflect.Proxy.newProxyInstance(
        getClass().getClassLoader(),
        new Class<?>[] { contextClass },
        new java.lang.reflect.InvocationHandler() {
          @Override
          public Object invoke(Object proxy, Method method, Object[] args)
            throws Throwable {
            String methodName = method.getName();

            // å¤„ç†å…³é”®æ–¹æ³•
            switch (methodName) {
              case "getPackageName":
                return packageName;
              case "getClassLoader":
                return getClass().getClassLoader();
              case "getApplicationContext":
                return proxy; // è¿”å›è‡ªèº«
              case "getPackageManager":
                // åˆ›å»ºä»£ç†PackageManager
                return createProxyPackageManager(packageName);
              case "getSystemService":
                if (args.length > 0 && args[0] instanceof String) {
                  String serviceName = (String) args[0];
                  if (Context.ACTIVITY_SERVICE.equals(serviceName)) {
                    return null;
                  }
                }
                return null;
              default:
                // å¯¹äºå…¶ä»–æ–¹æ³•ï¼Œè¿”å›é»˜è®¤å€¼
                if (method.getReturnType() == boolean.class) {
                  return false;
                } else if (method.getReturnType() == int.class) {
                  return 0;
                } else if (method.getReturnType() == String.class) {
                  return "";
                }
                return null;
            }
          }
        }
      );

      return proxyContext;
    } catch (Throwable t) {
      log("âŒ åˆ›å»ºä»£ç†Contextå¤±è´¥: " + t.getMessage());
      return null;
    }
  }
  */

  // ========== è¾…åŠ©æ–¹æ³•ï¼šåˆ›å»ºä»£ç†PackageManager ==========
  private Object createProxyPackageManager(String packageName) {
    try {
      Class<?> packageManagerClass = Class.forName(
        "android.content.pm.PackageManager"
      );
      return java.lang.reflect.Proxy.newProxyInstance(
        getClass().getClassLoader(),
        new Class<?>[] { packageManagerClass },
        new java.lang.reflect.InvocationHandler() {
          @Override
          public Object invoke(Object proxy, Method method, Object[] args)
            throws Throwable {
            String methodName = method.getName();

            // å¤„ç†åŒ…æŸ¥è¯¢ç›¸å…³æ–¹æ³•
            if (
              methodName.startsWith("getPackage") ||
              methodName.startsWith("getApplication") ||
              methodName.contains("Installed")
            ) {
              // è®°å½•æŸ¥è¯¢è¯·æ±‚
              log("ã€ä»£ç†PackageManagerã€‘æ‹¦æˆªæ–¹æ³•: " + methodName);

              // æ ¹æ®å®‰è£…çŠ¶æ€è¿”å›ç»“æœ
              Boolean status = installStatusMap.get(currentTargetApp);
              boolean shouldReturnInstalled = status != null ? status : true;

              if (!shouldReturnInstalled) {
                return createEmptyResult(method);
              }

              // è¿”å›ä¼ªé€ ç»“æœ
              return createFakeResultForMethod(method, args);
            }

            // å…¶ä»–æ–¹æ³•è¿”å›é»˜è®¤å€¼
            return createDefaultReturnValue(method);
          }
        }
      );
    } catch (Throwable t) {
      log("âŒ åˆ›å»ºä»£ç†PackageManagerå¤±è´¥: " + t.getMessage());
      return null;
    }
  }

  // ========== è¾…åŠ©æ–¹æ³•ï¼šæŒ‰ä¼˜å…ˆçº§æ‰§è¡ŒHook ==========
  private void executePriorityHooks(ClassLoader classLoader) {
    try {
      // ç¬¬1ä¼˜å…ˆçº§ï¼šåŸºç¡€ç¯å¢ƒå‡†å¤‡
      hookBundleGetString(classLoader);
      hookBundleEmptyInstance(classLoader);
      log("âœ…ã€å†…åµŒæ¨¡å¼ã€‘åŸºç¡€ç¯å¢ƒHookå®Œæˆ");

      // ç¬¬2ä¼˜å…ˆçº§ï¼šæƒé™ä¼ªé€ 
      hookQueryAllPackagesPermission(classLoader);
      hookPackageUsageStatsPermission(classLoader);
      log("âœ…ã€å†…åµŒæ¨¡å¼ã€‘æƒé™ä¼ªé€ Hookå®Œæˆ");

      // ç¬¬3ä¼˜å…ˆçº§ï¼šé€€å‡ºæ‹¦æˆª
      hookExitMethods(classLoader);
      hookIndirectExitMethods(classLoader);
      hookGlobalExitSources(classLoader);
      hookRunnableSystemExit(classLoader);
      log("âœ…ã€å†…åµŒæ¨¡å¼ã€‘é€€å‡ºæ‹¦æˆªHookå®Œæˆ");

      // ç¬¬4ä¼˜å…ˆçº§ï¼šåŒ…ç®¡ç†æ ¸å¿ƒ
      hookKeyMethods(classLoader);
      hookOverloadMethods(classLoader);
      log("âœ…ã€å†…åµŒæ¨¡å¼ã€‘åŒ…ç®¡ç†Hookå®Œæˆ");

      // ç¬¬5ä¼˜å…ˆçº§ï¼šIntentç›¸å…³
      hookQueryIntentActivities(classLoader);
      hookResolveActivity(classLoader);
      hookQueryIntentServices(classLoader);
      log("âœ…ã€å†…åµŒæ¨¡å¼ã€‘Intentç›¸å…³Hookå®Œæˆ");
/*
      // ç¬¬6ä¼˜å…ˆçº§ï¼šå¯åŠ¨ç›¸å…³
      hookGetLaunchIntentForPackage(classLoader);
      hookCanStartActivity(classLoader);
      */
      hookStartActivity(classLoader);
      log("âœ…ã€å†…åµŒæ¨¡å¼ã€‘å¯åŠ¨ç›¸å…³Hookå®Œæˆ");
/*
      // ç¬¬7ä¼˜å…ˆçº§ï¼šæ–‡ä»¶ç³»ç»Ÿ
      hookFileSystemChecks(classLoader);
      hookLibDirectoryChecks(classLoader);
      hookRuntimeExecMethods(classLoader);
      log("âœ…ã€å†…åµŒæ¨¡å¼ã€‘æ–‡ä»¶ç³»ç»ŸHookå®Œæˆ");
*/
      // ç¬¬8ä¼˜å…ˆçº§ï¼šç½‘ç»œç›¸å…³
      hookOkHttp(classLoader);
      log("âœ…ã€å†…åµŒæ¨¡å¼ã€‘ç½‘ç»œHookå®Œæˆ");
    } catch (Throwable t) {
      log("âŒã€å†…åµŒæ¨¡å¼ã€‘ä¼˜å…ˆçº§Hookæ‰§è¡Œå¤±è´¥: " + t.getMessage());
    }
  }

  // ========== è¾…åŠ©æ–¹æ³•ï¼šæ‰§è¡ŒFlutterç›¸å…³Hook ==========
  private void executeFlutterHooks(ClassLoader classLoader) {
    try {
      hookFlutterPackageInfoPlus(classLoader);
      hookFlutterAppInstalledChecker(classLoader);
      hookFileSystemInstallCheck(classLoader); // æ–‡ä»¶è·¯å¾„éªŒè¯
      hookReflectInstallCheck(classLoader); // åå°„PackageManager
      hookFlutterMethodChannelCheck(classLoader); // Flutter MethodChannel
      log("âœ…ã€å†…åµŒæ¨¡å¼ã€‘Flutteré€‚é…Hookå®Œæˆ");
    } catch (Throwable t) {
      log("âŒã€å†…åµŒæ¨¡å¼ã€‘Flutter Hookæ‰§è¡Œå¤±è´¥: " + t.getMessage());
    }
  }

  // ========== è¾…åŠ©æ–¹æ³•ï¼šæ‰§è¡ŒUIç›¸å…³Hook ==========
  private void executeUIHooks(ClassLoader classLoader) {
    try {
      hookDialogCancelableMethods(classLoader);
      hookActivityLifecycle(classLoader);
      log("âœ…ã€å†…åµŒæ¨¡å¼ã€‘UIç›¸å…³Hookå®Œæˆ");
    } catch (Throwable t) {
      log("âŒã€å†…åµŒæ¨¡å¼ã€‘UI Hookæ‰§è¡Œå¤±è´¥: " + t.getMessage());
    }
  }

  // ========== è¾…åŠ©æ–¹æ³•ï¼šä¸ºæ–¹æ³•åˆ›å»ºç©ºç»“æœ ==========
  private Object createEmptyResult(Method method) {
    Class<?> returnType = method.getReturnType();

    if (returnType == List.class) {
      return Collections.emptyList();
    } else if (
      returnType == PackageInfo.class ||
      returnType == ApplicationInfo.class ||
      returnType == ActivityInfo.class
    ) {
      return null;
    } else if (returnType == boolean.class) {
      return false;
    } else if (returnType == int.class) {
      return 0;
    } else if (returnType == String.class) {
      return "";
    }

    return null;
  }

  // ========== è¾…åŠ©æ–¹æ³•ï¼šä¸ºæ–¹æ³•åˆ›å»ºä¼ªé€ ç»“æœ ==========
  private Object createFakeResultForMethod(Method method, Object[] args) {
    String methodName = method.getName();

    if (
      methodName.contains("getPackageInfo") &&
      args.length > 0 &&
      args[0] instanceof String
    ) {
      String packageName = (String) args[0];
      int flags = args.length > 1 && args[1] instanceof Integer
        ? (int) args[1]
        : 0;
      return createSmartFakePackageInfo(packageName, flags);
    } else if (
      methodName.contains("getApplicationInfo") &&
      args.length > 0 &&
      args[0] instanceof String
    ) {
      String packageName = (String) args[0];
      return createFakeApplicationInfo(packageName);
    } else if (methodName.contains("getInstalledPackages")) {
      List<PackageInfo> fakeList = new ArrayList<>();
      synchronized (globalCapturedPackages) {
        for (String pkg : globalCapturedPackages) {
          fakeList.add(createFakePackageInfo(pkg));
        }
      }
      return fakeList;
    }

    return createDefaultReturnValue(method);
  }

  // ========== è¾…åŠ©æ–¹æ³•ï¼šåˆ›å»ºé»˜è®¤è¿”å›å€¼ ==========
  private Object createDefaultReturnValue(Method method) {
    Class<?> returnType = method.getReturnType();

    if (returnType == boolean.class) {
      return true;
    } else if (returnType == int.class) {
      return 0;
    } else if (returnType == long.class) {
      return 0L;
    } else if (returnType == String.class) {
      return "";
    } else if (returnType == List.class) {
      return Collections.emptyList();
    } else if (returnType == PackageManager.class) {
      // è¿”å›ä»£ç†PackageManager
      return createProxyPackageManager(currentTargetApp);
    }

    return null;
  }

  // ========== è¾…åŠ©æ–¹æ³•ï¼šæ˜¾ç¤ºåˆå§‹åŒ–æˆåŠŸToast ==========
  private void showInitSuccessToast(final Context context) {
    if (context == null) return;

    try {
      new Handler(Looper.getMainLooper()).post(
        new Runnable() {
          @Override
          public void run() {
            try {
              Toast.makeText(
                context,
                "âœ… å®‰è£…ä¼ªé€ æ¨¡å—å·²æ¿€æ´»\nç›®æ ‡åº”ç”¨: " + currentTargetApp,
                Toast.LENGTH_LONG
              ).show();
            } catch (Throwable t) {
              log("âŒ æ˜¾ç¤ºToastå¤±è´¥: " + t.getMessage());
            }
          }
        }
      );
    } catch (Throwable t) {
      log("âŒ å‘é€Toastæ¶ˆæ¯å¤±è´¥: " + t.getMessage());
    }
  }

  // ========== è¾…åŠ©æ–¹æ³•ï¼šæ˜¾ç¤ºåˆå§‹åŒ–å¤±è´¥Toast ==========
  private void showInitFailToast(final Context context, final String errorMsg) {
    if (context == null) return;

    try {
      new Handler(Looper.getMainLooper()).post(
        new Runnable() {
          @Override
          public void run() {
            try {
              Toast.makeText(
                context,
                "âŒ æ¨¡å—åˆå§‹åŒ–å¤±è´¥\n" +
                (errorMsg != null ? errorMsg : "æœªçŸ¥é”™è¯¯"),
                Toast.LENGTH_LONG
              ).show();
            } catch (Throwable t) {
              log("âŒ æ˜¾ç¤ºå¤±è´¥Toastå¤±è´¥: " + t.getMessage());
            }
          }
        }
      );
    } catch (Throwable t) {
      log("âŒ å‘é€å¤±è´¥Toastæ¶ˆæ¯å¤±è´¥: " + t.getMessage());
    }
  }

  // ========== å†…åµŒæ¨¡å¼ContentProvider ==========
  public static class HookProvider extends ContentProvider {

    private HookInit hookInstance;

    @Override
    public boolean onCreate() {
      // log("ã€å†…åµŒContentProviderã€‘å¼€å§‹åˆå§‹åŒ–");

      try {
        // è·å–å½“å‰åº”ç”¨çš„åŒ…åå’ŒContext
        String targetPackage = getContext() != null
          ? getContext().getPackageName()
          : "unknown";
        ClassLoader appClassLoader = getContext() != null
          ? getContext().getClassLoader()
          : null;
        /*
                log("ã€å†…åµŒContentProviderã€‘ç›®æ ‡åŒ…å: " + targetPackage);
                log("ã€å†…åµŒContentProviderã€‘ClassLoader: " + (appClassLoader != null ? "æœ‰æ•ˆ" : "æ— æ•ˆ"));
                log("ã€å†…åµŒContentProviderã€‘Context: " + (getContext() != null ? "æœ‰æ•ˆ" : "æ— æ•ˆ"));
                */
        // åˆ›å»ºHookå®ä¾‹å¹¶åˆå§‹åŒ–
        hookInstance = new HookInit();
        hookInstance.initForEmbed(appClassLoader, targetPackage, getContext());

        //  log("âœ…ã€å†…åµŒContentProviderã€‘åˆå§‹åŒ–å®Œæˆ");
        return true;
      } catch (Throwable t) {
        //   log("âŒã€å†…åµŒContentProviderã€‘åˆå§‹åŒ–å¤±è´¥: " + t.getMessage());
        return false;
      }
    }

    @Override
    public Cursor query(
      Uri uri,
      String[] projection,
      String selection,
      String[] selectionArgs,
      String sortOrder
    ) {
      // æä¾›æ¨¡å—çŠ¶æ€æŸ¥è¯¢æ¥å£
      if (
        hookInstance != null &&
        uri != null &&
        uri.toString().contains("module_status")
      ) {
        MatrixCursor cursor = new MatrixCursor(
          new String[] { "module_active", "target_app", "install_status" }
        );
        cursor.addRow(
          new Object[] {
            true,
            hookInstance.currentTargetApp,
            hookInstance.installStatusMap.get(hookInstance.currentTargetApp),
          }
        );
        return cursor;
      }
      return null;
    }

    @Override
    public String getType(Uri uri) {
      return null;
    }

    @Override
    public Uri insert(Uri uri, ContentValues values) {
      // æä¾›é…ç½®æ›´æ–°æ¥å£
      if (
        hookInstance != null &&
        uri != null &&
        uri.toString().contains("update_config")
      ) {
        if (values != null) {
          try {
            String key = values.getAsString("key");
            String value = values.getAsString("value");

            if ("install_status".equals(key)) {
              boolean newStatus = "true".equals(value);
              hookInstance.installStatusMap.put(
                hookInstance.currentTargetApp,
                newStatus
              );
              hookInstance.saveConfigToFile();
              // log("âœ…ã€å†…åµŒContentProviderã€‘æ›´æ–°é…ç½®: " + key + " = " + value);
            }
          } catch (Throwable t) {
            //  log("âŒã€å†…åµŒContentProviderã€‘æ›´æ–°é…ç½®å¤±è´¥: " + t.getMessage());
          }
        }
      }
      return null;
    }

    @Override
    public int delete(Uri uri, String selection, String[] selectionArgs) {
      return 0;
    }

    @Override
    public int update(
      Uri uri,
      ContentValues values,
      String selection,
      String[] selectionArgs
    ) {
      return 0;
    }
  }
}
